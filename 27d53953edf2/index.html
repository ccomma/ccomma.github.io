<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width">
<meta name="theme-color" content="#222"><meta name="generator" content="Hexo 7.0.0">

  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16.png">
  <link rel="mask-icon" href="/images/safari-pinned-tab.svg" color="#222">
  <meta name="google-site-verification" content="5K7puGkNbKLWhZTmZZm6haOpSbJ-oOvUQFYJeMFBJSk">
  <meta name="baidu-site-verification" content="codeva-3O8Y6jTFCL">

<link rel="stylesheet" href="/css/main.css">

<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Monaco:300,300italic,400,400italic,700,700italic&display=swap&subset=latin,latin-ext">

<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" integrity="sha256-yIDrPSXHZdOZhAqiBP7CKzIwMQmRCJ8UeB8Jo17YC4o=" crossorigin="anonymous">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/3.1.1/animate.min.css" integrity="sha256-PR7ttpcvz8qrF57fur/yAx1qXMFJeJFiA6pSzWi0OIE=" crossorigin="anonymous">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/pace/1.2.4/themes/blue/pace-theme-minimal.css">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/pace/1.2.4/pace.min.js" integrity="sha256-gqd7YTjg/BtfqWSwsJOvndl0Bxc8gFImLEkXQT8+qj0=" crossorigin="anonymous"></script>

<script class="next-config" data-name="main" type="application/json">{"hostname":"ccomma.cn","root":"/","images":"/images","scheme":"Muse","darkmode":false,"version":"8.19.1","exturl":false,"sidebar":{"position":"left","display":"post","padding":18,"offset":12},"copycode":{"enable":true,"style":"mac"},"fold":{"enable":true,"height":500},"bookmark":{"enable":false,"color":"#222","save":"auto"},"mediumzoom":true,"lazyload":true,"pangu":true,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"stickytabs":false,"motion":{"enable":true,"async":false,"transition":{"menu_item":"fadeInDown","post_block":"fadeIn","post_header":"fadeInDown","post_body":"fadeInDown","coll_header":"fadeInLeft","sidebar":"fadeInUp"}},"prism":false,"i18n":{"placeholder":"Searching...","empty":"We didn't find any results for the search: ${query}","hits_time":"${hits} results found in ${time} ms","hits":"${hits} results found"},"path":"/search.xml","localsearch":{"enable":true,"trigger":"auto","top_n_per_article":1,"unescape":false,"preload":false}}</script><script src="/js/config.js"></script>

    <meta name="description" content="Java 从编码到执行 -Xmixed：混合模式 使用解释器 + 热点代码编译 起始阶段采用解释执行 热点代码检测 多次被调用的方法（使用 方法计数器 检测方法执行频率） 多次被调用的循环（使用 循环计数器 检测循环执行频率） 进行编译      -Xint：解释模式，启动快，执行慢  -Xcomp：编译模式，启动慢，执行快   Class 文件结构Class 文件实际上是二进制字节流，JVM 定">
<meta property="og:type" content="article">
<meta property="og:title" content="JVM">
<meta property="og:url" content="https://ccomma.cn/27d53953edf2/">
<meta property="og:site_name" content="CComma&#39;s Blog">
<meta property="og:description" content="Java 从编码到执行 -Xmixed：混合模式 使用解释器 + 热点代码编译 起始阶段采用解释执行 热点代码检测 多次被调用的方法（使用 方法计数器 检测方法执行频率） 多次被调用的循环（使用 循环计数器 检测循环执行频率） 进行编译      -Xint：解释模式，启动快，执行慢  -Xcomp：编译模式，启动慢，执行快   Class 文件结构Class 文件实际上是二进制字节流，JVM 定">
<meta property="og:locale" content="en_US">
<meta property="og:image" content="https://ccomma-pic-storage.oss-cn-hangzhou.aliyuncs.com/img/7e3de546edf8e39f3f1c842a023a4488.png">
<meta property="og:image" content="https://ccomma-pic-storage.oss-cn-hangzhou.aliyuncs.com/img/a674107c0061ef04a64e2a055e14be96.png">
<meta property="og:image" content="https://ccomma-pic-storage.oss-cn-hangzhou.aliyuncs.com/img/e56706305d2071f14ae691dfa66393f6.png">
<meta property="og:image" content="https://ccomma-pic-storage.oss-cn-hangzhou.aliyuncs.com/img/9c7016ea0849b42824754e2c05d703be.png">
<meta property="og:image" content="https://ccomma-pic-storage.oss-cn-hangzhou.aliyuncs.com/img/12c42883b5bc0dbef7942aa7513744d8.png">
<meta property="og:image" content="https://ccomma-pic-storage.oss-cn-hangzhou.aliyuncs.com/img/ae1579b82e4c9a00ebd22d577c5ed5a7.png">
<meta property="og:image" content="https://ccomma-pic-storage.oss-cn-hangzhou.aliyuncs.com/img/dbb80dce45a2038379a95a181acf60fd.png">
<meta property="og:image" content="https://ccomma-pic-storage.oss-cn-hangzhou.aliyuncs.com/img/8c6e173b742392ca93cbb591d6045819.png">
<meta property="og:image" content="https://ccomma-pic-storage.oss-cn-hangzhou.aliyuncs.com/img/8e9b9db2bd428ecd3e1e8c1b2b173d4e.png">
<meta property="og:image" content="https://ccomma-pic-storage.oss-cn-hangzhou.aliyuncs.com/img/73a0bb354657280d028c0005ede1125f.png">
<meta property="og:image" content="https://ccomma-pic-storage.oss-cn-hangzhou.aliyuncs.com/img/a0d446091f82ab3ceb874f33de885a69.png">
<meta property="og:image" content="https://ccomma-pic-storage.oss-cn-hangzhou.aliyuncs.com/img/29bb86a6e6a00811b70fbb320972c200.png">
<meta property="og:image" content="https://ccomma-pic-storage.oss-cn-hangzhou.aliyuncs.com/img/d1725fefe349ee3b824ed3ac303df63e.png">
<meta property="og:image" content="https://ccomma-pic-storage.oss-cn-hangzhou.aliyuncs.com/img/d91d2c4aa4efc43bf1c527817e9379ee.png">
<meta property="og:image" content="https://ccomma-pic-storage.oss-cn-hangzhou.aliyuncs.com/img/e3191ffe79b85e1818e79653a761dbb7.png">
<meta property="og:image" content="https://ccomma-pic-storage.oss-cn-hangzhou.aliyuncs.com/img/7f8078dc240be61d59fbabe554422f76.png">
<meta property="og:image" content="https://ccomma-pic-storage.oss-cn-hangzhou.aliyuncs.com/img/0a3771f5524d1ecef45ba10c2518dfe5.png">
<meta property="og:image" content="https://ccomma-pic-storage.oss-cn-hangzhou.aliyuncs.com/img/4ad59ef5e3736678f5da98683650a3db.png">
<meta property="og:image" content="https://ccomma-pic-storage.oss-cn-hangzhou.aliyuncs.com/img/ce3e51425ea1c0e8ec7df5ea77b23b5d.png">
<meta property="og:image" content="https://ccomma-pic-storage.oss-cn-hangzhou.aliyuncs.com/img/d0c48c5f7e1089ce05031c847478e918.png">
<meta property="og:image" content="https://ccomma-pic-storage.oss-cn-hangzhou.aliyuncs.com/img/31f6dcd971788dc021c5aaf4f67f99bc.png">
<meta property="og:image" content="https://ccomma-pic-storage.oss-cn-hangzhou.aliyuncs.com/img/012b5391c527342861d9f55c59a907f7.png">
<meta property="og:image" content="https://ccomma-pic-storage.oss-cn-hangzhou.aliyuncs.com/img/aaa5c8687b39ad7fb3ccca97c2bfaa87.png">
<meta property="og:image" content="https://ccomma-pic-storage.oss-cn-hangzhou.aliyuncs.com/img/9fa3d91b3a2dcc7a97df297037107732.png">
<meta property="og:image" content="https://ccomma-pic-storage.oss-cn-hangzhou.aliyuncs.com/img/4c4ea9f436123e32405a3d5968b8b25f.png">
<meta property="og:image" content="https://ccomma-pic-storage.oss-cn-hangzhou.aliyuncs.com/img/1796989f83d1e64eddebc8f83871fcea.png">
<meta property="og:image" content="https://ccomma-pic-storage.oss-cn-hangzhou.aliyuncs.com/img/52d4d0716d23c88b12178ad78e59253b.png">
<meta property="og:image" content="https://ccomma-pic-storage.oss-cn-hangzhou.aliyuncs.com/img/6e30320b5571257235fcd22548c61a4c.png">
<meta property="og:image" content="https://ccomma-pic-storage.oss-cn-hangzhou.aliyuncs.com/img/18373e80319f93e9ddf9a0b988cc032b.png">
<meta property="article:published_time" content="2023-03-20T06:45:36.000Z">
<meta property="article:modified_time" content="2024-04-02T03:56:26.608Z">
<meta property="article:author" content="CComma">
<meta property="article:tag" content="编程技术、Java">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://ccomma-pic-storage.oss-cn-hangzhou.aliyuncs.com/img/7e3de546edf8e39f3f1c842a023a4488.png">


<link rel="canonical" href="https://ccomma.cn/27d53953edf2/">



<script class="next-config" data-name="page" type="application/json">{"sidebar":"","isHome":false,"isPost":true,"lang":"en","comments":true,"permalink":"https://ccomma.cn/27d53953edf2/","path":"27d53953edf2/","title":"JVM"}</script>

<script class="next-config" data-name="calendar" type="application/json">""</script>
<title>JVM | CComma's Blog</title>
  
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-GS592DM662"></script>
  <script class="next-config" data-name="google_analytics" type="application/json">{"tracking_id":"G-GS592DM662","only_pageview":false,"measure_protocol_api_secret":null}</script>
  <script src="/js/third-party/analytics/google-analytics.js"></script>

  <script src="/js/third-party/analytics/baidu-analytics.js"></script>
  <script async src="https://hm.baidu.com/hm.js?152282c2c823c1e5ab34c577ba338801"></script>







  <noscript>
    <link rel="stylesheet" href="/css/noscript.css">
  </noscript>
<link rel="alternate" href="/atom.xml" title="CComma's Blog" type="application/atom+xml">
</head>

<body itemscope itemtype="http://schema.org/WebPage" class="use-motion">
  <div class="headband"></div>

  <main class="main">
    <div class="column">
      <header class="header" itemscope itemtype="http://schema.org/WPHeader"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="Toggle navigation bar" role="button">
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
    </div>
  </div>

  <div class="site-meta">
      <img class="custom-logo-image" src="/images/ccomma.png" alt="CComma's Blog">

    <a href="/" class="brand" rel="start">
      <i class="logo-line"></i>
      <p class="site-title">CComma's Blog</p>
      <i class="logo-line"></i>
    </a>
      <p class="site-subtitle" itemprop="description">Connect the world</p>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger" aria-label="Search" role="button">
        <i class="fa fa-search fa-fw fa-lg"></i>
    </div>
  </div>
</div>



<nav class="site-nav">
  <ul class="main-menu menu"><li class="menu-item menu-item-home"><a href="/" rel="section"><i class="fa fa-home fa-fw"></i>Home</a></li><li class="menu-item menu-item-categories"><a href="/categories/" rel="section"><i class="fa fa-th fa-fw"></i>Categories<span class="badge">20</span></a></li><li class="menu-item menu-item-tags"><a href="/tags/" rel="section"><i class="fa fa-tags fa-fw"></i>Tags<span class="badge">9</span></a></li><li class="menu-item menu-item-archives"><a href="/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>Archives<span class="badge">83</span></a></li><li class="menu-item menu-item-about"><a href="/about/" rel="section"><i class="fa fa-user fa-fw"></i>About</a></li>
      <li class="menu-item menu-item-search">
        <a role="button" class="popup-trigger"><i class="fa fa-search fa-fw"></i>Search
        </a>
      </li>
  </ul>
</nav>



  <div class="search-pop-overlay">
    <div class="popup search-popup"><div class="search-header">
  <span class="search-icon">
    <i class="fa fa-search"></i>
  </span>
  <div class="search-input-container">
    <input autocomplete="off" autocapitalize="off" maxlength="80"
           placeholder="Searching..." spellcheck="false"
           type="search" class="search-input">
  </div>
  <span class="popup-btn-close" role="button">
    <i class="fa fa-times-circle"></i>
  </span>
</div>
<div class="search-result-container no-result">
  <div class="search-result-icon">
    <i class="fa fa-spinner fa-pulse fa-5x"></i>
  </div>
</div>

    </div>
  </div>

</header>
        
  
  <aside class="sidebar">

    <div class="sidebar-inner sidebar-nav-active sidebar-toc-active">
      <ul class="sidebar-nav">
        <li class="sidebar-nav-toc">
          Table of Contents
        </li>
        <li class="sidebar-nav-overview">
          Overview
        </li>
      </ul>

      <div class="sidebar-panel-container">
        <!--noindex-->
        <div class="post-toc-wrap sidebar-panel">
            <div class="post-toc animated"><ol class="nav"><li class="nav-item nav-level-1"><a class="nav-link" href="#Java-%E4%BB%8E%E7%BC%96%E7%A0%81%E5%88%B0%E6%89%A7%E8%A1%8C"><span class="nav-number">1.</span> <span class="nav-text">Java 从编码到执行</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#Class-%E6%96%87%E4%BB%B6%E7%BB%93%E6%9E%84"><span class="nav-number">2.</span> <span class="nav-text">Class 文件结构</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#1-%E6%9F%A5%E7%9C%8B-16-%E8%BF%9B%E5%88%B6%E5%AD%97%E8%8A%82%E7%A0%81"><span class="nav-number">2.1.</span> <span class="nav-text">1. 查看 16 进制字节码</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#2-Class-%E6%96%87%E4%BB%B6%E6%9E%84%E6%88%90"><span class="nav-number">2.2.</span> <span class="nav-text">2. Class 文件构成</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#%E7%B1%BB%E5%8A%A0%E8%BD%BD%E8%BF%87%E7%A8%8B"><span class="nav-number">3.</span> <span class="nav-text">类加载过程</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#%E5%86%85%E5%AD%98%E5%8A%A0%E8%BD%BD%E8%BF%87%E7%A8%8B"><span class="nav-number">4.</span> <span class="nav-text">内存加载过程</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#%E7%BC%93%E5%AD%98%E8%A1%8C"><span class="nav-number">4.1.</span> <span class="nav-text">缓存行</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E6%8C%87%E4%BB%A4%E9%87%8D%E6%8E%92"><span class="nav-number">4.2.</span> <span class="nav-text">指令重排</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#volatile-%E5%AE%9E%E7%8E%B0%E7%BB%86%E8%8A%82"><span class="nav-number">4.3.</span> <span class="nav-text">volatile 实现细节</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#synchronized-%E5%AE%9E%E7%8E%B0%E7%BB%86%E8%8A%82"><span class="nav-number">4.4.</span> <span class="nav-text">synchronized 实现细节</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#happens-before-%E5%8E%9F%E5%88%99"><span class="nav-number">4.5.</span> <span class="nav-text">happens-before 原则</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#%E5%AF%B9%E8%B1%A1%E5%B8%83%E5%B1%80"><span class="nav-number">5.</span> <span class="nav-text">对象布局</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%AF%B9%E8%B1%A1%E5%A4%A7%E5%B0%8F%EF%BC%8864%E4%BD%8D%E6%9C%BA%EF%BC%89"><span class="nav-number">5.1.</span> <span class="nav-text">对象大小（64 位机）</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E8%A7%82%E5%AF%9F%E8%99%9A%E6%8B%9F%E6%9C%BA%E9%85%8D%E7%BD%AE"><span class="nav-number">5.1.1.</span> <span class="nav-text">观察虚拟机配置</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%99%AE%E9%80%9A%E5%AF%B9%E8%B1%A1"><span class="nav-number">5.1.2.</span> <span class="nav-text">普通对象</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%95%B0%E7%BB%84%E5%AF%B9%E8%B1%A1"><span class="nav-number">5.1.3.</span> <span class="nav-text">数组对象</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%AE%9E%E9%AA%8C"><span class="nav-number">5.1.4.</span> <span class="nav-text">实验</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#markword"><span class="nav-number">5.2.</span> <span class="nav-text">markword</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#IdentityHashCode"><span class="nav-number">5.3.</span> <span class="nav-text">IdentityHashCode</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%AF%B9%E8%B1%A1%E5%AE%9A%E4%BD%8D"><span class="nav-number">5.4.</span> <span class="nav-text">对象定位</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#%E5%BC%95%E7%94%A8%E7%B1%BB%E5%9E%8B"><span class="nav-number">6.</span> <span class="nav-text">引用类型</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%BC%BA%E5%BC%95%E7%94%A8"><span class="nav-number">6.1.</span> <span class="nav-text">强引用</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E8%BD%AF%E5%BC%95%E7%94%A8"><span class="nav-number">6.2.</span> <span class="nav-text">软引用</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%BC%B1%E5%BC%95%E7%94%A8"><span class="nav-number">6.3.</span> <span class="nav-text">弱引用</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E8%99%9A%E5%BC%95%E7%94%A8"><span class="nav-number">6.4.</span> <span class="nav-text">虚引用</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#JVM-%E7%BB%84%E6%88%90"><span class="nav-number">7.</span> <span class="nav-text">JVM 组成</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#%E8%BF%90%E8%A1%8C%E6%97%B6%E6%95%B0%E6%8D%AE%E5%8C%BA%E5%9F%9F"><span class="nav-number">8.</span> <span class="nav-text">运行时数据区域</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#PC-%E7%A8%8B%E5%BA%8F%E8%AE%A1%E6%95%B0%E5%99%A8"><span class="nav-number">8.1.</span> <span class="nav-text">PC 程序计数器</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E6%A0%88"><span class="nav-number">8.2.</span> <span class="nav-text">栈</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E6%9C%AC%E5%9C%B0%E6%96%B9%E6%B3%95%E6%A0%88"><span class="nav-number">8.3.</span> <span class="nav-text">本地方法栈</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%A0%86"><span class="nav-number">8.4.</span> <span class="nav-text">堆</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%96%B0%E7%94%9F%E4%BB%A3%EF%BC%88Young-Generation%EF%BC%89"><span class="nav-number">8.4.1.</span> <span class="nav-text">新生代（Young Generation）</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E8%80%81%E5%B9%B4%E4%BB%A3%EF%BC%88Old-Generation%EF%BC%89"><span class="nav-number">8.4.2.</span> <span class="nav-text">老年代（Old Generation）</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E6%96%B9%E6%B3%95%E5%8C%BA"><span class="nav-number">8.5.</span> <span class="nav-text">方法区</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%86%85%E5%AD%98%E5%88%86%E9%85%8D%E7%AD%96%E7%95%A5"><span class="nav-number">8.6.</span> <span class="nav-text">内存分配策略</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Full-GC-%E7%9A%84%E8%A7%A6%E5%8F%91%E6%9D%A1%E4%BB%B6"><span class="nav-number">8.7.</span> <span class="nav-text">Full GC 的触发条件</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#GC"><span class="nav-number">9.</span> <span class="nav-text">GC</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#1-%E5%AE%9A%E4%BD%8D%E5%9E%83%E5%9C%BE"><span class="nav-number">9.1.</span> <span class="nav-text">1. 定位垃圾</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%BC%95%E7%94%A8%E8%AE%A1%E6%95%B0%E7%AE%97%E6%B3%95%EF%BC%88ReferenceCount%EF%BC%89"><span class="nav-number">9.1.1.</span> <span class="nav-text">引用计数算法（ReferenceCount）</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%8F%AF%E8%BE%BE%E6%80%A7%E5%88%86%E6%9E%90%E7%AE%97%E6%B3%95%EF%BC%88RootSearching%EF%BC%89"><span class="nav-number">9.1.2.</span> <span class="nav-text">可达性分析算法（RootSearching）</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#2-%E5%B8%B8%E8%A7%81%E7%9A%84%E5%9E%83%E5%9C%BE%E5%9B%9E%E6%94%B6%E7%AE%97%E6%B3%95"><span class="nav-number">9.2.</span> <span class="nav-text">2. 常见的垃圾回收算法</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#2-1-%E6%A0%87%E8%AE%B0%E6%B8%85%E9%99%A4%EF%BC%88mark-sweep%EF%BC%89%EF%BC%9A"><span class="nav-number">9.2.1.</span> <span class="nav-text">2.1. 标记清除（mark sweep）：</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#2-2-%E6%8B%B7%E8%B4%9D%E7%AE%97%E6%B3%95%EF%BC%88copying%EF%BC%89"><span class="nav-number">9.2.2.</span> <span class="nav-text">2.2. 拷贝算法（copying）</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#2-3-%E6%A0%87%E8%AE%B0%E5%8E%8B%E7%BC%A9%EF%BC%88mark-compact%EF%BC%89"><span class="nav-number">9.2.3.</span> <span class="nav-text">2.3. 标记压缩（mark compact）</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#2-4-%E5%88%86%E4%BB%A3%E6%94%B6%E9%9B%86"><span class="nav-number">9.2.4.</span> <span class="nav-text">2.4. 分代收集</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#3-%E5%B8%B8%E8%A7%81%E7%9A%84%E5%9E%83%E5%9C%BE%E5%9B%9E%E6%94%B6%E5%99%A8"><span class="nav-number">9.3.</span> <span class="nav-text">3. 常见的垃圾回收器</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#Serial"><span class="nav-number">9.3.1.</span> <span class="nav-text">Serial</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Parallel-Scavenge"><span class="nav-number">9.3.2.</span> <span class="nav-text">Parallel Scavenge</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#ParNew"><span class="nav-number">9.3.3.</span> <span class="nav-text">ParNew</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Serial-Old"><span class="nav-number">9.3.4.</span> <span class="nav-text">Serial Old</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Parallel-Old"><span class="nav-number">9.3.5.</span> <span class="nav-text">Parallel Old</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#ConcurrentMarkSweep"><span class="nav-number">9.3.6.</span> <span class="nav-text">ConcurrentMarkSweep</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#G1"><span class="nav-number">9.3.7.</span> <span class="nav-text">G1</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%85%B6%E4%BB%96"><span class="nav-number">9.3.8.</span> <span class="nav-text">其他</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#4-%E5%B8%B8%E8%A7%81%E5%9E%83%E5%9C%BE%E5%9B%9E%E6%94%B6%E5%99%A8%E7%BB%84%E5%90%88"><span class="nav-number">9.4.</span> <span class="nav-text">4. 常见垃圾回收器组合</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#GC-%E6%97%A5%E5%BF%97"><span class="nav-number">10.</span> <span class="nav-text">GC 日志</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#PS-GC-%E6%97%A5%E5%BF%97%E8%AF%A6%E8%A7%A3"><span class="nav-number">10.1.</span> <span class="nav-text">PS GC 日志详解</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#CMS-%E6%97%A5%E5%BF%97%E5%88%86%E6%9E%90"><span class="nav-number">10.2.</span> <span class="nav-text">CMS 日志分析</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#G1-%E6%97%A5%E5%BF%97%E8%AF%A6%E8%A7%A3"><span class="nav-number">10.3.</span> <span class="nav-text">G1 日志详解</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#GC-%E8%B0%83%E4%BC%98"><span class="nav-number">11.</span> <span class="nav-text">GC 调优</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%9F%BA%E7%A1%80%E6%A6%82%E5%BF%B5"><span class="nav-number">11.1.</span> <span class="nav-text">基础概念</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E8%B0%83%E4%BC%98%E8%A7%84%E5%88%92"><span class="nav-number">11.2.</span> <span class="nav-text">调优规划</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E4%BC%98%E5%8C%96%E6%AD%A5%E9%AA%A4"><span class="nav-number">11.3.</span> <span class="nav-text">优化步骤</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E8%A7%A3%E5%86%B3-JVM-%E8%BF%90%E8%A1%8C%E4%B8%AD%E7%9A%84%E9%97%AE%E9%A2%98"><span class="nav-number">11.4.</span> <span class="nav-text">解决 JVM 运行中的问题</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E4%B8%80%E4%B8%AA%E6%A1%88%E4%BE%8B%E7%90%86%E8%A7%A3%E5%B8%B8%E7%94%A8%E5%B7%A5%E5%85%B7"><span class="nav-number">11.4.1.</span> <span class="nav-text">一个案例理解常用工具</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#jconsole-%E8%BF%9C%E7%A8%8B%E8%BF%9E%E6%8E%A5"><span class="nav-number">11.4.2.</span> <span class="nav-text">jconsole 远程连接</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#jvisualvm-%E8%BF%9C%E7%A8%8B%E8%BF%9E%E6%8E%A5"><span class="nav-number">11.4.3.</span> <span class="nav-text">jvisualvm 远程连接</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#jprofiler%EF%BC%88%E6%94%B6%E8%B4%B9%EF%BC%89"><span class="nav-number">11.4.4.</span> <span class="nav-text">jprofiler（收费）</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#arthas-%E5%9C%A8%E7%BA%BF%E6%8E%92%E6%9F%A5%E5%B7%A5%E5%85%B7"><span class="nav-number">11.4.5.</span> <span class="nav-text">arthas 在线排查工具</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E4%BA%A7%E7%94%9F%E5%8E%9F%E5%9B%A0%E6%A1%88%E4%BE%8B"><span class="nav-number">11.4.6.</span> <span class="nav-text">产生原因案例</span></a></li></ol></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#GC-%E5%8F%82%E6%95%B0"><span class="nav-number">12.</span> <span class="nav-text">GC 参数</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%B8%B8%E7%94%A8%E5%8F%82%E6%95%B0"><span class="nav-number">12.1.</span> <span class="nav-text">常用参数</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Parallel-%E5%B8%B8%E7%94%A8%E5%8F%82%E6%95%B0"><span class="nav-number">12.2.</span> <span class="nav-text">Parallel 常用参数</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#CMS-%E5%B8%B8%E7%94%A8%E5%8F%82%E6%95%B0"><span class="nav-number">12.3.</span> <span class="nav-text">CMS 常用参数</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#G1-%E5%B8%B8%E7%94%A8%E5%8F%82%E6%95%B0"><span class="nav-number">12.4.</span> <span class="nav-text">G1 常用参数</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#%E5%8F%82%E8%80%83%E8%B5%84%E6%96%99"><span class="nav-number">13.</span> <span class="nav-text">参考资料</span></a></li></ol></div>
        </div>
        <!--/noindex-->

        <div class="site-overview-wrap sidebar-panel">
          <div class="site-author animated" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <img class="site-author-image" itemprop="image" alt="CComma"
      src="/images/ccomma.png">
  <p class="site-author-name" itemprop="name">CComma</p>
  <div class="site-description" itemprop="description">下一个目标：改变世界！</div>
</div>
<div class="site-state-wrap animated">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
        <a href="/archives/">
          <span class="site-state-item-count">83</span>
          <span class="site-state-item-name">posts</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
          <a href="/categories/">
        <span class="site-state-item-count">20</span>
        <span class="site-state-item-name">categories</span></a>
      </div>
      <div class="site-state-item site-state-tags">
          <a href="/tags/">
        <span class="site-state-item-count">9</span>
        <span class="site-state-item-name">tags</span></a>
      </div>
  </nav>
</div>
  <div class="links-of-author animated">
      <span class="links-of-author-item">
        <a href="https://github.com/ccomma" title="GitHub → https:&#x2F;&#x2F;github.com&#x2F;ccomma" rel="noopener me" target="_blank"><i class="fab fa-github fa-fw"></i>GitHub</a>
      </span>
      <span class="links-of-author-item">
        <a href="https://twitter.com/ccomma_cat" title="Twitter → https:&#x2F;&#x2F;twitter.com&#x2F;ccomma_cat" rel="noopener me" target="_blank"><i class="fab fa-twitter fa-fw"></i>Twitter</a>
      </span>
      <span class="links-of-author-item">
        <a href="/atom.xml" title="RSS → &#x2F;atom.xml" rel="noopener me"><i class="fa fa-rss fa-fw"></i>RSS</a>
      </span>
  </div>
  <div class="cc-license animated" itemprop="license">
    <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/deed.zh" class="cc-opacity" rel="noopener" target="_blank"><img src="https://cdnjs.cloudflare.com/ajax/libs/creativecommons-vocabulary/2020.11.3/assets/license_badges/small/by_nc_sa.svg" alt="Creative Commons"></a>
  </div>

        </div>
      </div>
    </div>

    
        <div class="pjax">
        </div>
  </aside>


    </div>

    <div class="main-inner post posts-expand">


  


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="en">
    <link itemprop="mainEntityOfPage" href="https://ccomma.cn/27d53953edf2/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/ccomma.png">
      <meta itemprop="name" content="CComma">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="CComma's Blog">
      <meta itemprop="description" content="下一个目标：改变世界！">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="JVM | CComma's Blog">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          JVM
        </h1>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>

      <time title="Created: 2023-03-20 14:45:36" itemprop="dateCreated datePublished" datetime="2023-03-20T14:45:36+08:00">2023-03-20</time>
    </span>

  
    <span class="post-meta-item" title="Views" id="busuanzi_container_page_pv">
      <span class="post-meta-item-icon">
        <i class="far fa-eye"></i>
      </span>
      <span class="post-meta-item-text">Views: </span>
      <span id="busuanzi_value_page_pv"></span>
    </span>
  
  <span class="post-meta-item">
    
      <span class="post-meta-item-icon">
        <i class="far fa-comment"></i>
      </span>
      <span class="post-meta-item-text">Disqus: </span>
    
    <a title="disqus" href="/27d53953edf2/#disqus_thread" itemprop="discussionUrl">
      <span class="post-comments-count disqus-comment-count" data-disqus-identifier="27d53953edf2/" itemprop="commentCount"></span>
    </a>
  </span>
  
  
    <span class="post-meta-item" title="Reading time">
      <span class="post-meta-item-icon">
        <i class="far fa-clock"></i>
      </span>
      <span class="post-meta-item-text">Reading time &asymp;</span>
      <span>40 mins.</span>
    </span>
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody"><h1 id="Java-从编码到执行"><a href="#Java-从编码到执行" class="headerlink" title="Java 从编码到执行"></a>Java 从编码到执行</h1><ul>
<li>-Xmixed：混合模式<ul>
<li>使用解释器 + 热点代码编译</li>
<li>起始阶段采用解释执行</li>
<li>热点代码检测<ul>
<li>多次被调用的方法（使用 <em>方法计数器</em> 检测方法执行频率）</li>
<li>多次被调用的循环（使用 <em>循环计数器</em> 检测循环执行频率）</li>
<li>进行编译</li>
</ul>
</li>
</ul>
</li>
<li> -Xint：解释模式，启动快，执行慢</li>
<li> -Xcomp：编译模式，启动慢，执行快</li>
</ul>
<p><img data-src="https://ccomma-pic-storage.oss-cn-hangzhou.aliyuncs.com/img/7e3de546edf8e39f3f1c842a023a4488.png"></p>
<h1 id="Class-文件结构"><a href="#Class-文件结构" class="headerlink" title="Class 文件结构"></a>Class 文件结构</h1><p>Class 文件实际上是二进制字节流，JVM 定义了一系列规范，用把 Class 文件 “翻译” 成 Class 类</p>
<blockquote>
<p>逻辑上划分的数据类型：u1（1 字节）、u2（2 字节）、u4（4 字节）、u8（8 字节）和 _info（表类型）<br>_info 的来源是 hotspot 源码中的写法</p>
</blockquote>
<h2 id="1-查看-16-进制字节码"><a href="#1-查看-16-进制字节码" class="headerlink" title="1. 查看 16 进制字节码"></a>1. 查看 16 进制字节码</h2><p>.java 文件使用 javac 命令进行编译后得到 .class 文件<br>可以使用 BinEd（IDEA 插件）查看 .class 文件的 16 进制字节码</p>
<p><strong>ByteCode 类：</strong></p>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.test.jvm.bytecode;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ByteCode</span> {</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<p><strong>对应 .class 文件的编码：</strong><br><img data-src="https://ccomma-pic-storage.oss-cn-hangzhou.aliyuncs.com/img/a674107c0061ef04a64e2a055e14be96.png"></p>
<h2 id="2-Class-文件构成"><a href="#2-Class-文件构成" class="headerlink" title="2. Class 文件构成"></a>2. Class 文件构成</h2><p>使用 JClassLib（IDEA 插件）查看 ByteCode<br><img data-src="https://ccomma-pic-storage.oss-cn-hangzhou.aliyuncs.com/img/e56706305d2071f14ae691dfa66393f6.png"></p>
<p><strong>classfile 构成：</strong><br><img data-src="https://ccomma-pic-storage.oss-cn-hangzhou.aliyuncs.com/img/9c7016ea0849b42824754e2c05d703be.png" alt="image.png"></p>
<p>对应关系<br><img data-src="https://ccomma-pic-storage.oss-cn-hangzhou.aliyuncs.com/img/12c42883b5bc0dbef7942aa7513744d8.png"></p>
<p>常量：</p>
<ul>
<li>常量池 #1 号标记： <ul>
<li>标记位 07（1 字节），表明了常量类型</li>
<li>索引 00 0e（2 字节），代表指向常量池 #14 号标记</li>
</ul>
</li>
</ul>
<h1 id="类加载过程"><a href="#类加载过程" class="headerlink" title="类加载过程"></a>类加载过程</h1><p>类是在 <strong>运行期间第一次使用</strong> 时动态加载的，而不是编译时期一次性加载。因为如果在编译时期一次性加载，那么会占用很多的内存。<br><img data-src="https://ccomma-pic-storage.oss-cn-hangzhou.aliyuncs.com/img/ae1579b82e4c9a00ebd22d577c5ed5a7.png"></p>
<p>loadClass () 中实现了双亲委派机制，委托给父加载器去执行，父加载器没找到则会调用自己的 findClass () 去找</p>
<ul>
<li>自定义类加载器：重写 findClass () </li>
<li>打破双亲委派机制：重写 loadClass ()</li>
</ul>
<h1 id="内存加载过程"><a href="#内存加载过程" class="headerlink" title="内存加载过程"></a>内存加载过程</h1><p><img data-src="https://ccomma-pic-storage.oss-cn-hangzhou.aliyuncs.com/img/dbb80dce45a2038379a95a181acf60fd.png"></p>
<p><img data-src="https://ccomma-pic-storage.oss-cn-hangzhou.aliyuncs.com/img/8c6e173b742392ca93cbb591d6045819.png"></p>
<h2 id="缓存行"><a href="#缓存行" class="headerlink" title="缓存行"></a>缓存行</h2><p>内存数据放入高速缓存中时是以缓存行的形式放入的，多数情况把内存中连续的 64 字节的数据作为一个缓存行加入高速缓存，不会只单独放入几个字节的数据</p>
<p><strong>伪共享问题：</strong> 位于同一缓存行的两个不同数据，被两个不同 CPU 锁定，产生互相影响的伪共享问题</p>
<p>缓存行对齐</p>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">CacheLinePadding</span> {</span><br><span class="line">    <span class="comment">// 加上 padding，使 arr[0] 和 arr[1] 在两个不同的缓存行中</span></span><br><span class="line">    <span class="comment">// 使运行速度提升</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">class</span> <span class="title class_">Padding</span> {</span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">volatile</span> <span class="type">long</span> p1, p2, p3, p4, p5, p6, p7;</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">class</span> <span class="title class_">T</span> <span class="keyword">extends</span> <span class="title class_">Padding</span> {</span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">volatile</span> <span class="type">long</span> <span class="variable">x</span> <span class="operator">=</span> <span class="number">0L</span>;</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> T[] arr = <span class="keyword">new</span> <span class="title class_">T</span>[<span class="number">2</span>];</span><br><span class="line"></span><br><span class="line">    <span class="keyword">static</span> {</span><br><span class="line">        arr[<span class="number">0</span>] = <span class="keyword">new</span> <span class="title class_">T</span>();</span><br><span class="line">        arr[<span class="number">1</span>] = <span class="keyword">new</span> <span class="title class_">T</span>();</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception {</span><br><span class="line">        <span class="type">Thread</span> <span class="variable">t1</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Thread</span>(() -&gt; {</span><br><span class="line">            <span class="keyword">for</span> (<span class="type">long</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; <span class="number">10000_0000L</span>; i++) {</span><br><span class="line">                arr[<span class="number">0</span>].x = i;</span><br><span class="line">            }</span><br><span class="line">        });</span><br><span class="line"></span><br><span class="line">        <span class="type">Thread</span> <span class="variable">t2</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Thread</span>(() -&gt; {</span><br><span class="line">            <span class="keyword">for</span> (<span class="type">long</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; <span class="number">10000_0000L</span>; i++) {</span><br><span class="line">                arr[<span class="number">1</span>].x = i;</span><br><span class="line">            }</span><br><span class="line">        });</span><br><span class="line"></span><br><span class="line">        <span class="keyword">final</span> <span class="type">long</span> <span class="variable">start</span> <span class="operator">=</span> System.nanoTime();</span><br><span class="line">        t1.start();</span><br><span class="line">        t2.start();</span><br><span class="line">        t1.join();</span><br><span class="line">        t2.join();</span><br><span class="line">        System.out.println((System.nanoTime() - start) / <span class="number">100_0000</span> + <span class="string">" ms"</span>);</span><br><span class="line">    }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<p><strong>缓存锁：</strong> MESI<br><a target="_blank" rel="noopener" href="https://www.cnblogs.com/z00377750/p/9180644.html">【并发编程】MESI–CPU 缓存一致性协议</a></p>
<p><strong>总线锁：</strong> 有些无法被缓存的数据或者跨越多个缓存行的数据还是得使用总线锁</p>
<h2 id="指令重排"><a href="#指令重排" class="headerlink" title="指令重排"></a>指令重排</h2><blockquote>
<p>验证 <strong>JVM/jmm/Disorder.java</strong><br><a target="_blank" rel="noopener" href="https://www.cnblogs.com/liushaodong/p/4777308.html">现代 cpu 的合并写技术对程序的影响</a></p>
</blockquote>
<p>CPU 为了提高指令执行效率，会在一条指令执行过程中（比如去内存读数据，慢 100 倍），去同时执行另一条指令，前提是两条指令没有依赖关系</p>
<ul>
<li>读指令的同时可以执行不影响的其他指令 </li>
<li>写指令的同时可以进行合并写<br>WCBuffers（Write Combining Buffers），只能存放 4 字节的数据。用于写指令合并缓存。 <figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">class</span> <span class="title class_">WriteCombining</span> {</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">int</span> <span class="variable">ITERATIONS</span> <span class="operator">=</span> Integer.MAX_VALUE;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">int</span> <span class="variable">ITEMS</span> <span class="operator">=</span> <span class="number">1</span> &lt;&lt; <span class="number">24</span>;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">int</span> <span class="variable">MASK</span> <span class="operator">=</span> ITEMS - <span class="number">1</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">byte</span>[] arrayA = <span class="keyword">new</span> <span class="title class_">byte</span>[ITEMS];</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">byte</span>[] arrayB = <span class="keyword">new</span> <span class="title class_">byte</span>[ITEMS];</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">byte</span>[] arrayC = <span class="keyword">new</span> <span class="title class_">byte</span>[ITEMS];</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">byte</span>[] arrayD = <span class="keyword">new</span> <span class="title class_">byte</span>[ITEMS];</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">byte</span>[] arrayE = <span class="keyword">new</span> <span class="title class_">byte</span>[ITEMS];</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">byte</span>[] arrayF = <span class="keyword">new</span> <span class="title class_">byte</span>[ITEMS];</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(<span class="keyword">final</span> String[] args)</span> {</span><br><span class="line"></span><br><span class="line">        <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">1</span>; i &lt;= <span class="number">3</span>; i++) {</span><br><span class="line">            System.out.println(i + <span class="string">" SingleLoop duration (ns) = "</span> + runCaseOne());</span><br><span class="line">            System.out.println(i + <span class="string">" SplitLoop  duration (ns) = "</span> + runCaseTwo());</span><br><span class="line">        }</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="type">long</span> <span class="title function_">runCaseOne</span><span class="params">()</span> {</span><br><span class="line">        <span class="type">long</span> <span class="variable">start</span> <span class="operator">=</span> System.nanoTime();</span><br><span class="line">        <span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> ITERATIONS;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">while</span> (--i != <span class="number">0</span>) {</span><br><span class="line">            <span class="type">int</span> <span class="variable">slot</span> <span class="operator">=</span> i &amp; MASK;</span><br><span class="line">            <span class="type">byte</span> <span class="variable">b</span> <span class="operator">=</span> (<span class="type">byte</span>) i;</span><br><span class="line">            arrayA[slot] = b;</span><br><span class="line">            arrayB[slot] = b;</span><br><span class="line">            arrayC[slot] = b;</span><br><span class="line">            arrayD[slot] = b;</span><br><span class="line">            arrayE[slot] = b;</span><br><span class="line">            arrayF[slot] = b;</span><br><span class="line">        }</span><br><span class="line">        <span class="keyword">return</span> System.nanoTime() - start;</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="type">long</span> <span class="title function_">runCaseTwo</span><span class="params">()</span> {</span><br><span class="line">        <span class="type">long</span> <span class="variable">start</span> <span class="operator">=</span> System.nanoTime();</span><br><span class="line">        <span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> ITERATIONS;</span><br><span class="line">        <span class="keyword">while</span> (--i != <span class="number">0</span>) {</span><br><span class="line">            <span class="type">int</span> <span class="variable">slot</span> <span class="operator">=</span> i &amp; MASK;</span><br><span class="line">            <span class="type">byte</span> <span class="variable">b</span> <span class="operator">=</span> (<span class="type">byte</span>) i;</span><br><span class="line">            arrayA[slot] = b;</span><br><span class="line">            arrayB[slot] = b;</span><br><span class="line">            arrayC[slot] = b;</span><br><span class="line">        }</span><br><span class="line">        i = ITERATIONS;</span><br><span class="line">        <span class="keyword">while</span> (--i != <span class="number">0</span>) {</span><br><span class="line">            <span class="type">int</span> <span class="variable">slot</span> <span class="operator">=</span> i &amp; MASK;</span><br><span class="line">            <span class="type">byte</span> <span class="variable">b</span> <span class="operator">=</span> (<span class="type">byte</span>) i;</span><br><span class="line">            arrayD[slot] = b;</span><br><span class="line">            arrayE[slot] = b;</span><br><span class="line">            arrayF[slot] = b;</span><br><span class="line">        }</span><br><span class="line">        <span class="keyword">return</span> System.nanoTime() - start;</span><br><span class="line">    }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure></li>
</ul>
<p><strong>如何保证不重排：</strong></p>
<ul>
<li>CPU 内存屏障（硬件方面实现）：Inter X86 <ul>
<li>sfence：在 sfence 指令前的写操作必须在 sfence 指令后的写操作前完成</li>
<li> lfence：在 lfence 指令前的读操作必须在 lfence 指令后的读操作前完成</li>
<li> mfence：在 mfence 指令前的写操作必须在 mfence 指令后的读操作前完成</li>
</ul>
</li>
<li> CPU lock 原子汇编指令（硬件方面实现）：Full Barrier，执行时会锁住内存子系统来确保执行顺序，甚至跨多个 CPU </li>
<li>JVM 规范（JSR 133）：依赖于硬件实现 <ul>
<li><p>LoadLoad 屏障：<br>保证读操作 Load1 先于读操作 Load2 执行 </p>
<figure class="highlight plaintext"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">Load1 操作</span><br><span class="line">LoadLoad 屏障</span><br><span class="line">Load2 操作</span><br></pre></td></tr></tbody></table></figure>
</li>
<li><p>StoreStore 屏障：<br>保证写操作 Store1 先于写操作 Store2 执行</p>
</li>
</ul>
</li>
</ul>
<figure class="highlight plaintext"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">Store1 操作</span><br><span class="line">StoreStore 屏障</span><br><span class="line">Store2 操作</span><br></pre></td></tr></tbody></table></figure>

<ul>
<li><p>LoadStore 屏障：<br>保证读操作 Load1 先于写操作 Store2 执行 </p>
<figure class="highlight plaintext"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">Load1 操作</span><br><span class="line">LoadStore 屏障</span><br><span class="line">Store2 操作</span><br></pre></td></tr></tbody></table></figure>
</li>
<li><p>StoreLoad 屏障：<br>保证写操作 Store1 先于读操作 Load2 执行 </p>
<figure class="highlight plaintext"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">Store1 操作</span><br><span class="line">StoreLoad 屏障</span><br><span class="line">Load2 操作</span><br></pre></td></tr></tbody></table></figure></li>
</ul>
<h2 id="volatile-实现细节"><a href="#volatile-实现细节" class="headerlink" title="volatile 实现细节"></a>volatile 实现细节</h2><ol>
<li><p>字节码层面：<code>ACC_VOLATILE</code> 编码 </p>
</li>
<li><p>JVM 层面： </p>
</li>
<li><p>写操作</p>
<figure class="highlight plaintext"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">StoreStore 屏障</span><br><span class="line">volatile 写操作</span><br><span class="line">StoreLoad 屏障</span><br></pre></td></tr></tbody></table></figure>
</li>
<li><p>读操作 </p>
<figure class="highlight plaintext"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">LoadLoad 屏障</span><br><span class="line">volatile 读操作</span><br><span class="line">LoadStore 屏障</span><br></pre></td></tr></tbody></table></figure>
</li>
<li><p>OS 和硬件层面：<br><a target="_blank" rel="noopener" href="https://blog.csdn.net/qq_26222859/article/details/52235930">volatile 与 lock 前缀指令</a></p>
</li>
</ol>
<h2 id="synchronized-实现细节"><a href="#synchronized-实现细节" class="headerlink" title="synchronized 实现细节"></a>synchronized 实现细节</h2><ol>
<li><p>字节码层面<br>ACC_SYNCHRONIZED </p>
<figure class="highlight plaintext"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">; 加锁</span><br><span class="line">monitorenter</span><br><span class="line">...</span><br><span class="line">; 释放锁</span><br><span class="line">monitorexit</span><br><span class="line">...</span><br><span class="line">; 异常后释放锁</span><br><span class="line">monitorexit</span><br></pre></td></tr></tbody></table></figure>
</li>
<li><p>JVM 层面<br>C C++ 调用了操作系统提供的同步机制 </p>
</li>
<li><p>OS 和硬件层面<br>X86 : lock cmpxchg / xxx<br><a target="_blank" rel="noopener" href="https://blog.csdn.net/21aspnet/article/details/88571740">Java 使用字节码和汇编语言同步分析 volatile，synchronized 的底层实现</a></p>
</li>
</ol>
<h2 id="happens-before-原则"><a href="#happens-before-原则" class="headerlink" title="happens-before 原则"></a>happens-before 原则</h2><p><img data-src="https://ccomma-pic-storage.oss-cn-hangzhou.aliyuncs.com/img/8e9b9db2bd428ecd3e1e8c1b2b173d4e.png"></p>
<h1 id="对象布局"><a href="#对象布局" class="headerlink" title="对象布局"></a>对象布局</h1><p>关于对象面试题：<br><img data-src="https://ccomma-pic-storage.oss-cn-hangzhou.aliyuncs.com/img/73a0bb354657280d028c0005ede1125f.png"></p>
<h2 id="对象大小（64位机）"><a href="#对象大小（64位机）" class="headerlink" title="对象大小（64位机）"></a>对象大小（64 位机）</h2><h3 id="观察虚拟机配置"><a href="#观察虚拟机配置" class="headerlink" title="观察虚拟机配置"></a>观察虚拟机配置</h3><p>java -XX:+PrintCommandLineFlags -version<br><img data-src="https://ccomma-pic-storage.oss-cn-hangzhou.aliyuncs.com/img/a0d446091f82ab3ceb874f33de885a69.png"></p>
<h3 id="普通对象"><a href="#普通对象" class="headerlink" title="普通对象"></a>普通对象</h3><ol>
<li>对象头：markword &nbsp;8 字节</li>
<li> ClassPointer 指针：-XX:+UseCompressedClassPointers 压缩打开为 4 字节，不开启为 8 字节</li>
<li>实例数据 <ol>
<li>引用类型：-XX:+UseCompressedOops 为 4 字节 不开启为 8 字节<br>Oops Ordinary Object Pointers</li>
</ol>
</li>
<li>Padding 对齐，8 的倍数</li>
</ol>
<h3 id="数组对象"><a href="#数组对象" class="headerlink" title="数组对象"></a>数组对象</h3><ol>
<li>对象头：markword 8 字节</li>
<li> ClassPointer 指针同上</li>
<li>数组长度：4 字节</li>
<li>数组数据</li>
<li>对齐 8 的倍数</li>
</ol>
<h3 id="实验"><a href="#实验" class="headerlink" title="实验"></a>实验</h3><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.mashibing.jvm.c3_jmm;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.mashibing.jvm.agent.ObjectSizeAgent;</span><br><span class="line"></span><br><span class="line"><span class="comment">// -XX:+UseCompressedClassPointers：类型指针压缩</span></span><br><span class="line"><span class="comment">// -XX:+UseCompressedOops：对象引用指针压缩</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">T03_SizeOfAnObject</span> {</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> {</span><br><span class="line">        System.out.println(ObjectSizeAgent.sizeOf(<span class="keyword">new</span> <span class="title class_">Object</span>())); <span class="comment">// 16=8+4+4(补齐)</span></span><br><span class="line">        System.out.println(ObjectSizeAgent.sizeOf(<span class="keyword">new</span> <span class="title class_">int</span>[] {})); <span class="comment">// 16=8+4+4</span></span><br><span class="line">        System.out.println(ObjectSizeAgent.sizeOf(<span class="keyword">new</span> <span class="title class_">P</span>()));      <span class="comment">// 32</span></span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">class</span> <span class="title class_">P</span> {</span><br><span class="line">        				<span class="comment">//8 _markword</span></span><br><span class="line">        				<span class="comment">//4 _class pointer -XX:+UseCompressedClassPointers</span></span><br><span class="line">        <span class="type">int</span> id;         <span class="comment">//4</span></span><br><span class="line">        String name;    <span class="comment">//4 _oops pointer -XX:+UseCompressedOops</span></span><br><span class="line">        <span class="type">int</span> age;        <span class="comment">//4</span></span><br><span class="line"></span><br><span class="line">        <span class="type">byte</span> b1;        <span class="comment">//1</span></span><br><span class="line">        <span class="type">byte</span> b2;        <span class="comment">//1</span></span><br><span class="line"></span><br><span class="line">        Object o;       <span class="comment">//4</span></span><br><span class="line">        <span class="type">byte</span> b3;        <span class="comment">//1</span></span><br><span class="line"></span><br><span class="line">    }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<h2 id="markword"><a href="#markword" class="headerlink" title="markword"></a>markword</h2><p><img data-src="https://ccomma-pic-storage.oss-cn-hangzhou.aliyuncs.com/img/29bb86a6e6a00811b70fbb320972c200.png"></p>
<p><img data-src="https://ccomma-pic-storage.oss-cn-hangzhou.aliyuncs.com/img/d1725fefe349ee3b824ed3ac303df63e.png"></p>
<p><img data-src="https://ccomma-pic-storage.oss-cn-hangzhou.aliyuncs.com/img/d91d2c4aa4efc43bf1c527817e9379ee.png"></p>
<h2 id="IdentityHashCode"><a href="#IdentityHashCode" class="headerlink" title="IdentityHashCode"></a>IdentityHashCode</h2><p><img data-src="https://ccomma-pic-storage.oss-cn-hangzhou.aliyuncs.com/img/e3191ffe79b85e1818e79653a761dbb7.png"></p>
<p><a target="_blank" rel="noopener" href="https://cloud.tencent.com/developer/article/1480590">死磕 Synchronized 底层实现，面试你还怕什么？</a><br><a target="_blank" rel="noopener" href="https://cloud.tencent.com/developer/article/1484167">面试题深入解析：Synchronized 底层实现</a><br><a target="_blank" rel="noopener" href="https://cloud.tencent.com/developer/article/1485795">死磕 Synchronized 底层实现 – 重量级锁</a><br><a target="_blank" rel="noopener" href="https://cloud.tencent.com/developer/article/1482500">一文让你读懂 Synchronized 底层实现，秒杀面试官</a></p>
<h2 id="对象定位"><a href="#对象定位" class="headerlink" title="对象定位"></a>对象定位</h2><p><a target="_blank" rel="noopener" href="https://blog.csdn.net/clover_lily/article/details/80095580">访问对象两种方式 – 句柄和直接指针</a></p>
<ol>
<li>句柄池</li>
<li>直接指针</li>
</ol>
<h1 id="引用类型"><a href="#引用类型" class="headerlink" title="引用类型"></a>引用类型</h1><h2 id="强引用"><a href="#强引用" class="headerlink" title="强引用"></a>强引用</h2><p>被强引用关联的对象不会被回收。</p>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">Object</span> <span class="variable">obj</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Object</span>();</span><br></pre></td></tr></tbody></table></figure>

<h2 id="软引用"><a href="#软引用" class="headerlink" title="软引用"></a>软引用</h2><p>被软引用关联的对象只有在内存不够的情况下才会被回收。<br><strong>作用：</strong> 缓存</p>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">Object</span> <span class="variable">obj</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Object</span>();</span><br><span class="line">SoftReference&lt;Object&gt; sf = <span class="keyword">new</span> <span class="title class_">SoftReference</span>&lt;Object&gt;(obj);</span><br><span class="line">obj = <span class="literal">null</span>;  <span class="comment">// 使对象只被软引用关联</span></span><br></pre></td></tr></tbody></table></figure>
<blockquote>
<p>// ===== 软引用测试（-Xms:20M -Xmx20M） =====</p>
<p>SoftReference&lt;byte[]&gt; m = new SoftReference&lt;&gt;(new byte[1024<em>1024</em>10]);<br>System.out.println(m.get());</p>
<p>// 再分配一个数组，heap 将装不下，这时候系统会垃圾回收，先回收一次，如果不够，会把软引用干掉<br>byte[] b = new byte[1024<em>1024</em>15];<br>System.out.println(m.get()); // null</p>
</blockquote>
<h2 id="弱引用"><a href="#弱引用" class="headerlink" title="弱引用"></a>弱引用</h2><p>被弱引用关联的对象一定会被回收，也就是说它只能存活到下一次垃圾回收发生之前。</p>
<p><strong>作用：</strong> 一般用在容器里。强引用和弱引用同时指向某个对象，当强引用不再指向该对象时，该对象就该被回收</p>
<p>例：ThreadLocal 对象 new 后有强引用，而当前线程中的 ThreadLocalMap 对象的键也有 ThreadLocal 对象的弱引用，所以当 ThreadLocal 对象失去强引用时 ThreadLocalMap 中对应的键也会变为 null，防止了内存泄露。虽然 ThreadLocalMap 的键为 null 了，但是其 value 值还存在所以依然会有内存泄露，所以需要执行 ThreadLocal#remove 方法</p>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">Object</span> <span class="variable">obj</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Object</span>();</span><br><span class="line">WeakReference&lt;Object&gt; wf = <span class="keyword">new</span> <span class="title class_">WeakReference</span>&lt;Object&gt;(obj);</span><br><span class="line">obj = <span class="literal">null</span>;</span><br></pre></td></tr></tbody></table></figure>

<blockquote>
<p>WeakReference<m> m = new WeakReference&lt;&gt;(new M());</m></p>
<p>System.out.println(m.get());<br>System.gc();<br>System.out.println(m.get()); // null</p>
<p>ThreadLocal<m> tl = new ThreadLocal&lt;&gt;();<br>tl.set(new M());<br>tl.remove();</m></p>
</blockquote>
<h2 id="虚引用"><a href="#虚引用" class="headerlink" title="虚引用"></a>虚引用</h2><p>又称为幽灵引用或者幻影引用。一个对象是否有虚引用的存在，完全不会对其生存时间构成影响，也无法通过虚引用取得一个对象。</p>
<p><em>作用：</em></p>
<ul>
<li>为一个对象设置虚引用关联的唯一目的就是能在这个对象被回收时收到一个系统通知。 </li>
<li>管理堆外内存（通常给编写 JVM 的人使用）：DirectByteBuffer 对象指向堆外内存。当 DirectByteBuffer 被回收时，可以通过队列检测到，然后清理堆外内存 </li>
</ul>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 关联了对象和队列</span></span><br><span class="line"><span class="comment">// 当对象被回收引用会放入队列中</span></span><br><span class="line">ReferenceQueue&lt;Object&gt; queue = <span class="keyword">new</span> <span class="title class_">ReferenceQueue</span>&lt;&gt;();</span><br><span class="line">PhantomReference&lt;Object&gt; pf = <span class="keyword">new</span> <span class="title class_">PhantomReference</span>&lt;Object&gt;(<span class="keyword">new</span> <span class="title class_">Object</span>(), queue);</span><br><span class="line"><span class="comment">// 不能通过 get() 拿到里面的值</span></span><br><span class="line">pf.get();</span><br><span class="line">...</span><br><span class="line"><span class="comment">// 对象被回收后，通过 poll() 方法可以拿出</span></span><br><span class="line">Reference&lt;? <span class="keyword">extends</span> <span class="title class_">Object</span>&gt; poll = queue.poll();</span><br><span class="line"><span class="keyword">if</span> (poll != <span class="literal">null</span>) {</span><br><span class="line">    System.out.println(<span class="string">"--- 虚引用对象被jvm回收了 ---- "</span> + poll);</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<h1 id="JVM-组成"><a href="#JVM-组成" class="headerlink" title="JVM 组成"></a>JVM 组成</h1><p><img data-src="https://ccomma-pic-storage.oss-cn-hangzhou.aliyuncs.com/img/7f8078dc240be61d59fbabe554422f76.png"></p>
<p><strong>JVM 的结构基本上由 4 部分组成：</strong></p>
<ul>
<li>_类加载器：_在 JVM 启动时或者类运行时将需要的 class 加载到 JVM 中</li>
<li>_运行时数据区：_将内存划分成若干个区以模拟实际机器上的存储、记录和调度功能模块</li>
<li><strong>执行引擎：</strong>执行引擎的任务是负责执行 class 文件中包含的字节码指令，相当于实际机器上的 CPU</li>
<li><strong> 本地方法调用：</strong>调用 C 或 C++ 实现的本地方法的代码返回结果</li>
</ul>
<h1 id="运行时数据区域"><a href="#运行时数据区域" class="headerlink" title="运行时数据区域"></a>运行时数据区域</h1><p><img data-src="https://ccomma-pic-storage.oss-cn-hangzhou.aliyuncs.com/img/0a3771f5524d1ecef45ba10c2518dfe5.png"></p>
<h2 id="PC-程序计数器"><a href="#PC-程序计数器" class="headerlink" title="PC 程序计数器"></a>PC 程序计数器</h2><p>记录正在执行的虚拟机字节码指令的地址（如果正在执行的是本地方法则为空）<br>用于存放指令位置<br>虚拟机的运行，类似于这样的循环：</p>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">while</span> (not end) {</span><br><span class="line"></span><br><span class="line">	取 PC 中的位置，找到对应位置的指令；</span><br><span class="line"></span><br><span class="line">	执行该指令；</span><br><span class="line"></span><br><span class="line">	PC ++;</span><br><span class="line"></span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<h2 id="栈"><a href="#栈" class="headerlink" title="栈"></a>栈</h2><ul>
<li><a target="_blank" rel="noopener" href="https://blog.csdn.net/jt781861965/article/details/114957201?utm_medium=distribute.pc_relevant.none-task-blog-2~default~BlogCommendFromMachineLearnPai2~default-1.control&amp;depth_1-utm_source=distribute.pc_relevant.none-task-blog-2~default~BlogCommendFromMachineLearnPai2~default-1.control">变量定义在 for 循环外面还是里面</a></li>
</ul>
<p>Java 方法在执行的同时会创建一个栈帧用于存储局部变量表、操作数栈、常量池引用等信息<br>从方法调用直至执行完成的过程，就对应着一个栈帧在 Java 虚拟机栈中入栈和出栈的过程</p>
<p><strong>栈结构：</strong><br><img data-src="https://ccomma-pic-storage.oss-cn-hangzhou.aliyuncs.com/img/4ad59ef5e3736678f5da98683650a3db.png"></p>
<p>Frame：每个方法对应一个栈帧</p>
<ol>
<li>Local Variable Table </li>
<li>Operand Stack<br>对于 long 的处理（store and load），多数虚拟机的实现都是原子的<br>jls 17.7，没必要加 volatile </li>
<li>Dynamic Linking<br><a target="_blank" rel="noopener" href="https://blog.csdn.net/qq_41813060/article/details/88379473">java Dynamic Linking</a><br>jvms 2.6.3 </li>
<li>return address<br>a () -&gt; b ()，方法 a 调用了方法 b，b 方法的返回值放在什么地方</li>
</ol>
<p>例：<code>i = i++;</code> 的栈实现</p>
<p><strong>常用字节码指令：</strong><br>store、load、pop、mul、sub<br>invoke：</p>
<ol>
<li>InvokeStatic：调用静态方法</li>
<li> InvokeVirtual：普通方法，自带多态</li>
<li> InvokeInterface：调用接口的方法</li>
<li> InovkeSpecial：<br>可以直接定位，不需要多态的方法<br>private 方法 ， 构造方法</li>
<li> InvokeDynamic：<br>lambda 表达式或者反射或者其他动态语言 scala kotlin，或者 CGLib ASM，动态产生的 class，会用到的指令</li>
</ol>
<h2 id="本地方法栈"><a href="#本地方法栈" class="headerlink" title="本地方法栈"></a>本地方法栈</h2><p>本地方法栈与 Java 虚拟机栈类似，它们之间的区别只不过是本地方法栈为本地方法服务。</p>
<p>本地方法一般是用其它语言（C、C++ 或汇编语言等）编写的，并且被编译为基于本机硬件和操作系统的程序，对待这些方法需要特别处理。</p>
<h2 id="堆"><a href="#堆" class="headerlink" title="堆"></a>堆</h2><p><strong>所有对象都在这里分配内存</strong>，是垃圾收集的主要区域<br>堆不需要连续内存，并且可以动态增加其内存，增加失败会抛出 OutOfMemoryError 异常</p>
<p>堆是所有 <strong>线程共享</strong> 的<br>默认新生代：老年代 = 1 : 2</p>
<h3 id="新生代（Young-Generation）"><a href="#新生代（Young-Generation）" class="headerlink" title="新生代（Young Generation）"></a>新生代（Young Generation）</h3><p>分为 伊甸园（Edne）和两个 幸存区（Survival），默认比例为 Eden：from：to = 8：1：1，保证了内存的利用率达到 90%</p>
<p><strong>Eden：</strong></p>
<ul>
<li><strong>线程共享：</strong> 由于堆是所有线程共享的，因此在堆上分配内存 <strong>需要加锁</strong> </li>
<li><strong> TLAB：</strong> 为提升效率，每个新建的线程在 Eden 上分配了一块独立的空间由该线程独享，这块空间称为 <strong>TLAB</strong>（Thread Local Allocation Buffer） </li>
<li>在 TLAB 上分配内存 <strong>不需要加锁</strong>，因此 JVM 在给线程中的对象分配内存时会尽量在 TLAB 上分配 <ul>
<li>如果对象过大或 TLAB 用完，则仍然在堆上进行分配。如果 Eden 区内存也用完了，则会进行一次 Minor GC（young GC）</li>
</ul>
</li>
</ul>
<p><strong>Survival（from &amp; to）：</strong><br><a target="_blank" rel="noopener" href="https://www.jianshu.com/p/989d3b06a49d">jvm 误区 – 动态对象年龄判定</a></p>
<ul>
<li>在发生 Minor GC 时，Eden 区和 Survival from 区会把一些仍然存活的对象复制进 Survival to 区，并清除内存 <ul>
<li>将此时在 Survivor to 区存活下来的对象的年龄设置为 1，以后这些对象每在 Survivor 区熬过一次 GC，它们的年龄就加 1，当对象年龄达到某个年龄（默认值为 15）时，就会把它们移到老年代中<br><strong>调整年龄：</strong> -XX:MaxTenuringThreshold<br><strong>默认年龄：</strong> <ul>
<li>·Parallel Scavenge 15</li>
<li>CMS 6</li>
<li>G1 15</li>
</ul>
</li>
<li>s1 -&gt; s2 超过 50%：把年龄最大的放入老年代</li>
</ul>
</li>
<li>在发生一次 Minor GC 后，from 区就会和 to 区互换</li>
</ul>
<p><strong>分配担保：</strong><br><a target="_blank" rel="noopener" href="https://cloud.tencent.com/developer/article/1082730">JVM 内存分配担保机制</a><br>如果每次回收有多于 10% 的对象存活，那么一块 Survivor 空间就不够用了，此时需要依赖于老年代进行分配担保，也就是借用老年代的空间存储放不下的对象</p>
<h3 id="老年代（Old-Generation）"><a href="#老年代（Old-Generation）" class="headerlink" title="老年代（Old Generation）"></a>老年代（Old Generation）</h3><p>年老代里存放的都是存活时间较久的，大小较大的对象。<br><strong>Full GC：</strong> 当年老代容量满的时候，会触发一次 Major GC（Full GC），回收年老代和年轻代中不再被使用的对象资源</p>
<h2 id="方法区"><a href="#方法区" class="headerlink" title="方法区"></a>方法区</h2><p>用于存放已被加载的类信息、常量、静态变量、即时编译器编译后的代码等数据。<br>不需要连续的内存，并且可以动态扩展，动态扩展失败一样会抛出 OutOfMemoryError 异常。</p>
<p><strong>垃圾回收：</strong> 对这块区域进行垃圾回收的主要目标是对常量池的回收和对类的卸载，但是一般比较难实现。</p>
<p><strong>永久代（PermSpace）：</strong><br>JDK &lt; 1.8<br>方法区是 Java 虚拟机规范中的定义，是一种规范，而永久代是 Hotspot 虚拟机对其的一种实现。</p>
<p>永久代的大小受到很多因素影响，并且每次 Full GC 之后永久代的大小都会改变</p>
<ul>
<li>字符串常量位于 PermSpace</li>
<li>FGC 不会清理</li>
<li>大小启动的时候指定，不能变</li>
</ul>
<p><strong>元空间（MetaSpace）：</strong><br>JDK &gt;= 1.8</p>
<ul>
<li>移除永久代，并把方法区移至元空间（位于本地内存中，而不是虚拟机内存中）</li>
<li>字符串常量存放到堆内存中</li>
<li>会触发 FGC 清理</li>
<li>元空间大小默认没有限制，一般根据系统内存的大小。JVM 会动态改变此值。</li>
</ul>
<h2 id="内存分配策略"><a href="#内存分配策略" class="headerlink" title="内存分配策略"></a>内存分配策略</h2><ol>
<li><strong>栈上分配：</strong> 无需手动调整<ul>
<li>线程私有小对象</li>
<li>无逃逸</li>
<li>支持标量替换</li>
</ul>
</li>
<li><strong>线程本地分配 TLAB（Thread Local Allocation Buffer）：</strong> 无需手动调整</li>
</ol>
<ul>
<li>占用 Eden，默认 1%</li>
<li> 多线程的时候不用竞争 Eden 就可以申请空间，提高效率</li>
<li>小对象</li>
</ul>
<ol start="3">
<li><strong>大对象直接进入老年代：</strong></li>
</ol>
<ul>
<li>大对象是指需要连续内存空间的对象，最典型的大对象是那种很长的字符串以及数组</li>
<li>经常出现大对象会提前触发垃圾收集以获取足够的连续空间分配给大对象</li>
<li> XX:PretenureSizeThreshold，大于此值的对象直接在老年代分配，避免在 Eden 区和 Survivor 区之间的大量内存复制</li>
</ul>
<ol start="4">
<li><strong>对象优先在 Eden 分配：</strong> 大多数情况下，对象在新生代 Eden 区分配，当 Eden 区空间不够时，发起 Minor GC </li>
<li><strong>长期存活的对象进入老年代：</strong> 为对象定义年龄计数器，对象在 Eden 出生并经过 Minor GC 依然存活，将移动到 Survivor 中，年龄就增加 1 岁，增加到一定年龄则移动到老年代中 </li>
<li><strong>空间分配担保：</strong></li>
</ol>
<ul>
<li>在发生 Minor GC 之前，虚拟机先检查老年代最大可用的连续空间是否大于新生代所有对象总空间，如果条件成立的话，那么 Minor GC 可以确认是安全的 </li>
<li>如果不成立的话虚拟机会查看 HandlePromotionFailure 设置值是否允许担保失败 <ul>
<li>如果允许那么就会继续检查老年代最大可用的连续空间是否大于历次晋升到老年代对象的平均大小</li>
<li>如果大于，将尝试着进行一次 Minor GC；如果小于，或者 HandlePromotionFailure 设置不允许冒险，那么就要进行一次 Full GC</li>
</ul>
</li>
</ul>
<h2 id="Full-GC-的触发条件"><a href="#Full-GC-的触发条件" class="headerlink" title="Full GC 的触发条件"></a>Full GC 的触发条件</h2><ul>
<li><strong>调用 System.gc ()：</strong> 只是建议虚拟机执行 Full GC，但是虚拟机不一定真正去执行。不建议使用这种方式，而是让虚拟机管理内存 </li>
<li><strong>老年代空间不足：</strong> <ul>
<li>老年代空间不足的常见场景为前文所讲的大对象直接进入老年代、长期存活的对象进入老年代等</li>
<li>为了避免以上原因引起的 Full GC，应当尽量不要创建过大的对象以及数组。除此之外，可以通过 -Xmn 虚拟机参数调大新生代的大小，让对象尽量在新生代被回收掉，不进入老年代。还可以通过 -XX:MaxTenuringThreshold 调大对象进入老年代的年龄，让对象在新生代多存活一段时间。</li>
</ul>
</li>
<li><strong>空间分配担保失败：</strong> 使用复制算法的 Minor GC 需要老年代的内存空间作担保，如果担保失败会执行一次 Full GC </li>
<li><strong>JDK 1.7 及以前的永久代空间不足：</strong> <ul>
<li>当系统中要加载的类、反射的类和调用的方法较多时，永久代可能会被占满，在未配置为采用 CMS GC 的情况下也会执行 Full GC。如果经过 Full GC 仍然回收不了，那么虚拟机会抛出 java.lang.OutOfMemoryError。</li>
<li>为避免以上原因引起的 Full GC，可采用的方法为增大永久代空间或转为使用 CMS GC。</li>
</ul>
</li>
<li><strong>Concurrent Mode Failure：</strong> 执行 CMS GC 的过程中同时有对象要放入老年代，而此时老年代空间不足（可能是 GC 过程中浮动垃圾过多导致暂时性的空间不足），便会报 Concurrent Mode Failure 错误，并触发 Full GC。</li>
</ul>
<h1 id="GC"><a href="#GC" class="headerlink" title="GC"></a>GC</h1><p><a target="_blank" rel="noopener" href="https://my.oschina.net/wenbo123/blog/1822414">深入学习 JVM-JVM 安全点和安全区域</a><br>垃圾收集主要是针对 <strong>堆</strong> 和 <strong>方法区</strong> 进行<br>程序计数器、虚拟机栈和本地方法栈这三个区域属于线程私有的，只存在于线程的生命周期内，线程结束之后也会消失，因此不需要对这三个区域进行垃圾回收</p>
<blockquote>
<p>简历：熟悉 GC 常用算法，熟悉常见垃圾回收器，具有实际 JVM 调优实战经验</p>
</blockquote>
<h2 id="1-定位垃圾"><a href="#1-定位垃圾" class="headerlink" title="1. 定位垃圾"></a>1. 定位垃圾</h2><h3 id="引用计数算法（ReferenceCount）"><a href="#引用计数算法（ReferenceCount）" class="headerlink" title="引用计数算法（ReferenceCount）"></a>引用计数算法（ReferenceCount）</h3><p>给对象添加一个引用计数器，当对象增加一个引用时计数器加 1，引用失效时计数器减 1。引用计数为 0 的对象可被回收。</p>
<p><strong>缺点：</strong> 两个对象出现循环引用的情况下，此时引用计数器永远不为 0，导致无法对它们进行回收。<br>正因为循环引用的存在，因此 Java 虚拟机不使用引用计数算法。</p>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ReferenceCountingGC</span> {</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="type">Object</span> <span class="variable">instance</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> {</span><br><span class="line">        <span class="type">ReferenceCountingGC</span> <span class="variable">objectA</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ReferenceCountingGC</span>();</span><br><span class="line">        <span class="type">ReferenceCountingGC</span> <span class="variable">objectB</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ReferenceCountingGC</span>();</span><br><span class="line">        objectA.instance = objectB;</span><br><span class="line">        objectB.instance = objectA;</span><br><span class="line">    }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<h3 id="可达性分析算法（RootSearching）"><a href="#可达性分析算法（RootSearching）" class="headerlink" title="可达性分析算法（RootSearching）"></a>可达性分析算法（RootSearching）</h3><p>通过 GC Roots 作为起始点进行搜索，能够到达到的对象都是存活的，不可达的对象可被回收<br><img data-src="https://ccomma-pic-storage.oss-cn-hangzhou.aliyuncs.com/img/ce3e51425ea1c0e8ec7df5ea77b23b5d.png"></p>
<p><strong>GC Roots 一般包含以下内容：</strong></p>
<ul>
<li>虚拟机栈中局部变量表中引用的对象</li>
<li>本地方法栈中 JNI 中引用的对象</li>
<li>方法区中类静态属性引用的对象</li>
<li>方法区中的常量引用的对象</li>
</ul>
<h2 id="2-常见的垃圾回收算法"><a href="#2-常见的垃圾回收算法" class="headerlink" title="2. 常见的垃圾回收算法"></a>2. 常见的垃圾回收算法</h2><h3 id="2-1-标记清除（mark-sweep）："><a href="#2-1-标记清除（mark-sweep）：" class="headerlink" title="2.1. 标记清除（mark sweep）："></a>2.1. 标记清除（mark sweep）：</h3><p>将存活的对象进行标记，然后清理掉未被标记的对象<br><img data-src="https://ccomma-pic-storage.oss-cn-hangzhou.aliyuncs.com/img/d0c48c5f7e1089ce05031c847478e918.png"></p>
<p><strong>扫描两次：</strong></p>
<ol>
<li>一次扫描先标记存活对象</li>
<li>再一次扫描清除未被标记对象</li>
</ol>
<p><strong>缺点：</strong> 扫描两次，位置不连续，产生碎片<br>存活对象比较多的情况下效率较高</p>
<h3 id="2-2-拷贝算法（copying）"><a href="#2-2-拷贝算法（copying）" class="headerlink" title="2.2. 拷贝算法（copying）"></a>2.2. 拷贝算法（copying）</h3><p>将内存划分为大小相等的两块，每次只使用其中一块，当这一块内存用完了就将还存活的对象复制到另一块上面，然后再把使用过的内存空间进行一次清理<br><img data-src="https://ccomma-pic-storage.oss-cn-hangzhou.aliyuncs.com/img/31f6dcd971788dc021c5aaf4f67f99bc.png"></p>
<p>缺点：需移动对象，浪费空间<br>优点：扫描一次，没有碎片<br>适用于存活对象比较少的情况</p>
<h3 id="2-3-标记压缩（mark-compact）"><a href="#2-3-标记压缩（mark-compact）" class="headerlink" title="2.3. 标记压缩（mark compact）"></a>2.3. 标记压缩（mark compact）</h3><p>让所有存活的对象都向一端移动，然后直接清理掉端边界以外的内存<br><img data-src="https://ccomma-pic-storage.oss-cn-hangzhou.aliyuncs.com/img/012b5391c527342861d9f55c59a907f7.png"></p>
<p>缺点：扫描两次，需移动对象，效率低下<br>优点：没有碎片，方便对象分配，不会产生内存减半</p>
<h3 id="2-4-分代收集"><a href="#2-4-分代收集" class="headerlink" title="2.4. 分代收集"></a>2.4. 分代收集</h3><p>现在的商业虚拟机采用分代收集算法，它根据对象存活周期将内存划分为几块，不同块采用适当的收集算法</p>
<ul>
<li><strong>新生代使用：</strong> 复制算法</li>
<li><strong>老年代使用：</strong> <em>标记 - 清除</em> 或者 <em>标记 - 整理</em> 算法</li>
</ul>
<blockquote>
<p>除 Epsilon ZGC Shenandoah 之外的 GC 都是使用逻辑分代模型<br>G1 是逻辑分代，物理不分代<br>除此之外的不仅逻辑分代，而且物理分代</p>
</blockquote>
<h2 id="3-常见的垃圾回收器"><a href="#3-常见的垃圾回收器" class="headerlink" title="3. 常见的垃圾回收器"></a>3. 常见的垃圾回收器</h2><p><strong>Card Table</strong><br>由于做 YGC 时，需要扫描整个 OLD 区，效率非常低，所以 JVM 设计了 CardTable， 如果一个 OLD 区 CardTable 中有对象指向 Y 区，就将它设为 Dirty，下次扫描时，只需要扫描 Dirty Card<br>在结构上，Card Table 用 BitMap 来实现</p>
<p><strong>垃圾回收器：</strong><br><img data-src="https://ccomma-pic-storage.oss-cn-hangzhou.aliyuncs.com/img/aaa5c8687b39ad7fb3ccca97c2bfaa87.png"></p>
<p>连线表示垃圾收集器可以配合使用</p>
<p><strong>垃圾收集器跟内存大小的关系：</strong></p>
<ol>
<li>Serial 几十兆</li>
<li> PS 上百兆 - 几个 G</li>
<li>CMS - 20G</li>
<li>G1 - 上百 G</li>
<li>ZGC - 4T - 16T（JDK13）</li>
</ol>
<p><strong>STW：</strong> stop the world。指 GC 中让用户线程全部暂停而产生的停顿。任何一个垃圾回收器都有 STW，减少 STW 能提升用户响应时间，但也会减少吞吐量。</p>
<h3 id="Serial"><a href="#Serial" class="headerlink" title="Serial"></a>Serial</h3><p><img data-src="https://ccomma-pic-storage.oss-cn-hangzhou.aliyuncs.com/img/9fa3d91b3a2dcc7a97df297037107732.png"><br>用于收集年轻代垃圾的收集器，只会使用 <strong>一个 GC 线程</strong> 进行垃圾收集工作。</p>
<h3 id="Parallel-Scavenge"><a href="#Parallel-Scavenge" class="headerlink" title="Parallel Scavenge"></a>Parallel Scavenge</h3><p><img data-src="https://ccomma-pic-storage.oss-cn-hangzhou.aliyuncs.com/img/4c4ea9f436123e32405a3d5968b8b25f.png"></p>
<p>用于收集年轻代垃圾的收集器，使用多个 GC 线程收集垃圾</p>
<p>关注吞吐量，目标是 <strong>达到一个可控制的吞吐量</strong>，它被称为 “吞吐量优先” 收集器</p>
<ul>
<li>高吞吐量则可以高效率地利用 CPU 时间，尽快完成程序的运算任务，适合在后台运算而不需要太多交互的任务</li>
<li>缩短停顿时间是以牺牲吞吐量和新生代空间来换取的：新生代空间变小，垃圾回收变得频繁，导致吞吐量下降</li>
</ul>
<h3 id="ParNew"><a href="#ParNew" class="headerlink" title="ParNew"></a>ParNew</h3><p>用于收集年轻代垃圾的收集器。新版本的 Parallel Scavenge，与其相比做了增强以便能与 CMS 配合使用</p>
<p><a target="_blank" rel="noopener" href="https://docs.oracle.com/en/java/javase/13/gctuning/ergonomics.html#GUID-DB4CAE94-2041-4A16-90EC-6AE3D91EC1F1">HotSpot Virtual Machine Garbage Collection Tuning Guide</a></p>
<ul>
<li>ParNew 响应时间优先（配合 CMS）</li>
<li>Parallel Scavenge 吞吐量优先</li>
</ul>
<h3 id="Serial-Old"><a href="#Serial-Old" class="headerlink" title="Serial Old"></a>Serial Old</h3><p>用于收集老年代垃圾的收集器。Serial 收集器的老年代版本。</p>
<ul>
<li>在 JDK 1.5 以及之前版本（Parallel Old 诞生以前）中与 Parallel Scavenge 收集器搭配使用</li>
<li>作为 CMS 收集器的后备预案，在并发收集发生 Concurrent Mode Failure 时使用（效率低下）</li>
</ul>
<h3 id="Parallel-Old"><a href="#Parallel-Old" class="headerlink" title="Parallel Old"></a>Parallel Old</h3><p>用于收集老年代垃圾的收集器。Parallel Scavenge 收集器的老年代版本。</p>
<h3 id="ConcurrentMarkSweep"><a href="#ConcurrentMarkSweep" class="headerlink" title="ConcurrentMarkSweep"></a>ConcurrentMarkSweep</h3><p><img data-src="https://ccomma-pic-storage.oss-cn-hangzhou.aliyuncs.com/img/1796989f83d1e64eddebc8f83871fcea.png"></p>
<p>用于收集老年代垃圾的收集器。垃圾回收和应用程序同时运行，降低 STW 的时间。</p>
<p><strong>流程：</strong><br>在整个过程中耗时最长的并发标记和并发清除过程中，收集器线程都可以与用户线程一起工作，不需要进行停顿</p>
<ol>
<li><strong>初始标记：</strong> 仅仅只是标记一下 GC Roots 能直接关联到的对象，速度很快，需要停顿</li>
<li><strong>并发标记：</strong> 进行 GC Roots Tracing 的过程，它在整个回收过程中耗时最长，不需要停顿</li>
<li><strong>重新标记：</strong> 为了修正并发标记期间因用户程序继续运作而导致标记产生变动的那一部分对象的标记记录，需要停顿</li>
<li><strong>并发清除：</strong> 不需要停顿</li>
</ol>
<p><strong>CMS 的问题：</strong><br>CMS 问题比较多，所以现在没有一个版本默认是 CMS，只能手工指定<br>CMS 既然是 MarkSweep，就一定会有碎片化的问题，碎片到达一定程度，CMS 的老年代分配对象分配不下的时候，使用 SerialOld 进行老年代回收</p>
<ul>
<li><em>吞吐量低：</em> 低停顿时间是以牺牲吞吐量为代价的，导致 CPU 利用率不够高 </li>
<li><em>无法处理浮动垃圾：</em> </li>
<li><ul>
<li><em>浮动垃圾：</em> 指并发清除阶段由于用户线程继续运行而产生的垃圾。这部分垃圾只能到下一次 GC 时才能进行回收 </li>
<li><em>需预留内存：</em> 由于浮动垃圾的存在，因此需要预留出一部分内存。这意味着 CMS 收集不能像其它收集器那样等待老年代快满的时候再回收 </li>
<li><em>Concurrent Mode Failure：</em> 如果预留的内存不够存放浮动垃圾，就会出现 Concurrent Mode Failure，这时虚拟机将临时启用 Serial Old 来替代 CMS </li>
<li>解决方案：<br>降低触发 CMS 的阈值<br>–XX:CMSInitiatingOccupancyFraction 92%：内存打到 92% 时才会触发 CMS。可以降低这个值，让 CMS 保持老年代足够的空间</li>
</ul>
</li>
<li><em>空间碎片：</em> 标记 - 清除算法导致的空间碎片，往往出现老年代空间剩余，但无法找到足够大连续空间来分配当前对象，不得不提前触发一次 Full GC<br>-XX:+UseCMSCompactAtFullCollection<br>-XX:CMSFullGCsBeforeCompaction 默认为 0 指的是经过多少次 FGC 才进行压缩</li>
</ul>
<p>算法：三色标记 + Incremental Update</p>
<h3 id="G1"><a href="#G1" class="headerlink" title="G1"></a>G1</h3><p><strong>特点：</strong></p>
<ul>
<li>并发收集</li>
<li>压缩空间，不会延长 GC 的暂停时间</li>
<li>更容易预测 GC 的暂停时间</li>
<li>适用不需要实现很高吞吐量的场景</li>
<li>每个内存区域不是固定的，可能这次存放新生代下次就存放老年代了</li>
<li>新老年代比例： 5%-60%。不用手工指定，G1 以此作为预测停顿时间的基准</li>
</ul>
<p>Edne、Survivor、Old、Humongous（超过单个 Region 的 50%）<br><img data-src="https://ccomma-pic-storage.oss-cn-hangzhou.aliyuncs.com/img/52d4d0716d23c88b12178ad78e59253b.png"></p>
<p><strong>CSet（Collection Set）：</strong></p>
<ul>
<li>一组可被回收的分区的集合 </li>
<li>在 CSet 中存活的数据会在 GC 过程中被移动到另一个可用分区 </li>
<li>CSet 中的分区可以来自 Eden 空间、Survivor 空间或老年代 </li>
<li>CSet 占用不到整个堆空间的 1% 大小</li>
</ul>
<p><strong>RSet（Remembered Set）：</strong></p>
<ul>
<li>是一块存放在 Region 内部的 Map，记录了其他 Region 中的对象到本 Region 的引用</li>
<li>使垃圾回收器不用去扫描整个堆来获取引用了当前分区的对象，只需要扫描 RSet 即可</li>
</ul>
<p><strong>当对象无法分配时也会产生 FullGC，如何解决：</strong></p>
<ul>
<li>扩内存 </li>
<li>提高 CPU 性能（回收的快，业务逻辑产生对象的速度固定，垃圾回收越快，内存空间越大） </li>
<li>降低 MixedGC 触发的阈值，让 MixedGC 提早发生（默认是 45%） <blockquote>
<p>MixedGC：类似 CMS<br>XX:InitiatingHeapOccupacyPercent</p>
<ul>
<li>默认值 45%</li>
<li> 当分配堆空间超过这个值，启动 MixedGC</li>
</ul>
</blockquote>
</li>
</ul>
<p>算法：三色标记 + SATB<br><strong>三色标记：</strong></p>
<ul>
<li>黑色：自身和成员变量均已标记完成</li>
<li>灰色：自身被标记，成员变量未被标记</li>
<li>白色：未被标记的对象</li>
</ul>
<p><strong>漏标：</strong><br>当一个黑色的对象引用了一个白色对象，且这个白色对象只被这个黑色对象引用时会漏标<br>该白色对象已无法被遍历到了</p>
<p><strong>解决漏标的方案：</strong></p>
<ul>
<li>Incremental update：关注引用的增加。黑色的对象引用白色对象时把黑色对象重新标记为灰色，下次重新扫描属性，CMS 使用</li>
<li> SATB（snapshot at the beginning）：关注引用的删除。当引用消失时把这个引用推到 GC 的堆栈，保证引用的对象还能被 GC 扫描到。</li>
</ul>
<p>G1 使用 SATB，Incremental update 把黑色对象变为灰色对象后，后续还得对其成员变量进行扫描，效率不高。<br>SATB 配合 RSet 判断记录的白色对象是否为漏标对象<br><a target="_blank" rel="noopener" href="https://www.oracle.com/cn/technical-resources/articles/java/g1gc.html">垃圾优先型垃圾回收器调优</a></p>
<h3 id="其他"><a href="#其他" class="headerlink" title="其他"></a>其他</h3><ol>
<li>ZGC (1ms) PK C++<br>算法：ColoredPointers + LoadBarrier </li>
<li>Shenandoah<br>算法：ColoredPointers + WriteBarrier </li>
<li>Epsilon</li>
</ol>
<h2 id="4-常见垃圾回收器组合"><a href="#4-常见垃圾回收器组合" class="headerlink" title="4. 常见垃圾回收器组合"></a>4. 常见垃圾回收器组合</h2><ul>
<li><p>-XX:+UseSerialGC = Serial New (DefNew) + Serial Old：小型程序。默认情况下不会是这种选项，HotSpot 会根据计算及配置和 JDK 版本自动选择收集器 </p>
</li>
<li><p>-XX:+UseParNewGC = ParNew + SerialOld：这个组合已经很少用（在某些版本中已经废弃） </p>
<blockquote>
<p><a target="_blank" rel="noopener" href="https://stackoverflow.com/questions/34962257/why-remove-support-for-parnewserialold-anddefnewcms-in-the-future">Why Remove support for ParNew+SerialOld and	DefNew+CMS in the future？</a></p>
</blockquote>
</li>
<li><p>-XX:+UseConc(urrent)MarkSweepGC = ParNew + CMS + Serial Old </p>
</li>
<li><p>-XX:+UseParallelGC = Parallel Scavenge + Parallel Old (1.8 默认) 【PS + SerialOld】 </p>
</li>
<li><p>-XX:+UseParallelOldGC = Parallel Scavenge + Parallel Old </p>
</li>
<li><p>-XX:+UseG1GC = G1</p>
</li>
</ul>
<p>Linux 中没找到默认 GC 的查看方法，而 windows 中会打印 UseParallelGC</p>
<ul>
<li>java +XX:+PrintCommandLineFlags -version</li>
<li> 通过 GC 的日志来分辨</li>
</ul>
<h1 id="GC-日志"><a href="#GC-日志" class="headerlink" title="GC 日志"></a>GC 日志</h1><h2 id="PS-GC-日志详解"><a href="#PS-GC-日志详解" class="headerlink" title="PS GC 日志详解"></a>PS GC 日志详解</h2><p>PS 日志格式：<br><img data-src="https://ccomma-pic-storage.oss-cn-hangzhou.aliyuncs.com/img/6e30320b5571257235fcd22548c61a4c.png"></p>
<p>heap dump 部分：</p>
<figure class="highlight plaintext"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">eden space 5632K, 94% used [0x00000000ff980000,0x00000000ffeb3e28,0x00000000fff00000)</span><br><span class="line">                            后面的内存地址指的是，起始地址，使用空间结束地址，整体空间结束地址</span><br></pre></td></tr></tbody></table></figure>

<p><img data-src="https://ccomma-pic-storage.oss-cn-hangzhou.aliyuncs.com/img/18373e80319f93e9ddf9a0b988cc032b.png"></p>
<h2 id="CMS-日志分析"><a href="#CMS-日志分析" class="headerlink" title="CMS 日志分析"></a>CMS 日志分析</h2><p>执行命令：java -Xms20M -Xmx20M -XX:+PrintGCDetails -XX:+UseConcMarkSweepGC com.mashibing.jvm.gc.T15_FullGC_Problem01</p>
<p>[GC (Allocation Failure) [ParNew: 6144K-&gt;640K(6144K), 0.0265885 secs] 6585K-&gt;2770K(19840K), 0.0268035 secs] [Times: user=0.02 sys=0.00, real=0.02 secs]</p>
<blockquote>
<p>ParNew：年轻代收集器<br>6144-&gt;640：收集前后的对比<br>（6144）：整个年轻代容量<br>6585 -&gt; 2770：整个堆的情况<br>（19840）：整个堆大小</p>
</blockquote>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">[GC (CMS Initial Mark) [<span class="number">1</span> CMS-initial-mark: 8511K(13696K)] 9866K(19840K), <span class="number">0.0040321</span> secs] [Times: user=<span class="number">0.01</span> sys=<span class="number">0.00</span>, real=<span class="number">0.00</span> secs] </span><br><span class="line">	<span class="comment">//8511 (13696) : 老年代使用（最大）</span></span><br><span class="line">	<span class="comment">//9866 (19840) : 整个堆使用（最大）</span></span><br><span class="line">[CMS-concurrent-mark-start]</span><br><span class="line">[CMS-concurrent-mark: <span class="number">0.018</span>/<span class="number">0.018</span> secs] [Times: user=<span class="number">0.01</span> sys=<span class="number">0.00</span>, real=<span class="number">0.02</span> secs] </span><br><span class="line">	<span class="comment">//这里的时间意义不大，因为是并发执行</span></span><br><span class="line">[CMS-concurrent-preclean-start]</span><br><span class="line">[CMS-concurrent-preclean: <span class="number">0.000</span>/<span class="number">0.000</span> secs] [Times: user=<span class="number">0.00</span> sys=<span class="number">0.00</span>, real=<span class="number">0.00</span> secs] </span><br><span class="line">	<span class="comment">//标记Card为Dirty，也称为Card Marking</span></span><br><span class="line">[GC (CMS Final Remark) [YG occupancy: <span class="number">1597</span> K (<span class="number">6144</span> K)][Rescan (parallel) , <span class="number">0.0008396</span> secs][weak refs processing, <span class="number">0.0000138</span> secs][<span class="keyword">class</span> <span class="title class_">unloading</span>, <span class="number">0.0005404</span> secs][scrub symbol table, <span class="number">0.0006169</span> secs][scrub string table, <span class="number">0.0004903</span> secs][<span class="number">1</span> CMS-remark: 8511K(13696K)] 10108K(19840K), <span class="number">0.0039567</span> secs] [Times: user=<span class="number">0.00</span> sys=<span class="number">0.00</span>, real=<span class="number">0.00</span> secs] </span><br><span class="line">	<span class="comment">//STW阶段，YG occupancy:年轻代占用及容量</span></span><br><span class="line">	<span class="comment">//[Rescan (parallel)：STW下的存活对象标记</span></span><br><span class="line">	<span class="comment">//weak refs processing: 弱引用处理</span></span><br><span class="line">	<span class="comment">//class unloading: 卸载用不到的class</span></span><br><span class="line">	<span class="comment">//scrub symbol(string) table: </span></span><br><span class="line">		<span class="comment">//cleaning up symbol and string tables which hold class-level metadata and </span></span><br><span class="line">		<span class="comment">//internalized string respectively</span></span><br><span class="line">	<span class="comment">//CMS-remark: 8511K(13696K): 阶段过后的老年代占用及容量</span></span><br><span class="line">	<span class="comment">//10108K(19840K): 阶段过后的堆占用及容量</span></span><br><span class="line"></span><br><span class="line">[CMS-concurrent-sweep-start]</span><br><span class="line">[CMS-concurrent-sweep: <span class="number">0.005</span>/<span class="number">0.005</span> secs] [Times: user=<span class="number">0.00</span> sys=<span class="number">0.00</span>, real=<span class="number">0.01</span> secs] </span><br><span class="line">	<span class="comment">//标记已经完成，进行并发清理</span></span><br><span class="line">[CMS-concurrent-reset-start]</span><br><span class="line">[CMS-concurrent-reset: <span class="number">0.000</span>/<span class="number">0.000</span> secs] [Times: user=<span class="number">0.00</span> sys=<span class="number">0.00</span>, real=<span class="number">0.00</span> secs]</span><br><span class="line">	<span class="comment">//重置内部结构，为下次GC做准备</span></span><br></pre></td></tr></tbody></table></figure>

<h2 id="G1-日志详解"><a href="#G1-日志详解" class="headerlink" title="G1 日志详解"></a>G1 日志详解</h2><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line">[GC <span class="title function_">pause</span> <span class="params">(G1 Evacuation Pause)</span> (young) (initial-mark), <span class="number">0.0015790</span> secs]</span><br><span class="line"><span class="comment">//young -&gt; 年轻代 Evacuation-&gt; 复制存活对象 </span></span><br><span class="line"><span class="comment">//initial-mark 混合回收的阶段，这里是YGC混合老年代回收</span></span><br><span class="line">   [Parallel Time: <span class="number">1.5</span> ms, GC Workers: <span class="number">1</span>] <span class="comment">//一个GC线程</span></span><br><span class="line">      [GC Worker <span class="title function_">Start</span> <span class="params">(ms)</span>:  <span class="number">92635.7</span>]</span><br><span class="line">      [Ext Root <span class="title function_">Scanning</span> <span class="params">(ms)</span>:  <span class="number">1.1</span>]</span><br><span class="line">      [Update <span class="title function_">RS</span> <span class="params">(ms)</span>:  <span class="number">0.0</span>]</span><br><span class="line">         [Processed Buffers:  <span class="number">1</span>]</span><br><span class="line">      [Scan <span class="title function_">RS</span> <span class="params">(ms)</span>:  <span class="number">0.0</span>]</span><br><span class="line">      [Code Root <span class="title function_">Scanning</span> <span class="params">(ms)</span>:  <span class="number">0.0</span>]</span><br><span class="line">      [Object <span class="title function_">Copy</span> <span class="params">(ms)</span>:  <span class="number">0.1</span>]</span><br><span class="line">      [Termination (ms):  <span class="number">0.0</span>]</span><br><span class="line">         [Termination Attempts:  <span class="number">1</span>]</span><br><span class="line">      [GC Worker <span class="title function_">Other</span> <span class="params">(ms)</span>:  <span class="number">0.0</span>]</span><br><span class="line">      [GC Worker <span class="title function_">Total</span> <span class="params">(ms)</span>:  <span class="number">1.2</span>]</span><br><span class="line">      [GC Worker <span class="title function_">End</span> <span class="params">(ms)</span>:  <span class="number">92636.9</span>]</span><br><span class="line">   [Code Root Fixup: <span class="number">0.0</span> ms]</span><br><span class="line">   [Code Root Purge: <span class="number">0.0</span> ms]</span><br><span class="line">   [Clear CT: <span class="number">0.0</span> ms]</span><br><span class="line">   [Other: <span class="number">0.1</span> ms]</span><br><span class="line">      [Choose CSet: <span class="number">0.0</span> ms]</span><br><span class="line">      [Ref Proc: <span class="number">0.0</span> ms]</span><br><span class="line">      [Ref Enq: <span class="number">0.0</span> ms]</span><br><span class="line">      [Redirty Cards: <span class="number">0.0</span> ms]</span><br><span class="line">      [Humongous Register: <span class="number">0.0</span> ms]</span><br><span class="line">      [Humongous Reclaim: <span class="number">0.0</span> ms]</span><br><span class="line">      [Free CSet: <span class="number">0.0</span> ms]</span><br><span class="line">   [Eden: <span class="number">0.</span>0B(<span class="number">1024.</span>0K)-&gt;<span class="number">0.</span>0B(<span class="number">1024.</span>0K) Survivors: <span class="number">0.</span>0B-&gt;<span class="number">0.</span>0B Heap: <span class="number">18.</span>8M(<span class="number">20.</span>0M)-&gt;<span class="number">18.</span>8M(<span class="number">20.</span>0M)]</span><br><span class="line"> [Times: user=<span class="number">0.00</span> sys=<span class="number">0.00</span>, real=<span class="number">0.00</span> secs] </span><br><span class="line"><span class="comment">//以下是混合回收其他阶段</span></span><br><span class="line">[GC concurrent-root-region-scan-start]</span><br><span class="line">[GC concurrent-root-region-scan-end, <span class="number">0.0000078</span> secs]</span><br><span class="line">[GC concurrent-mark-start]</span><br><span class="line"><span class="comment">//无法 evacuation，进行 FGC</span></span><br><span class="line">[Full <span class="title function_">GC</span> <span class="params">(Allocation Failure)</span>  18M-&gt;18M(20M), <span class="number">0.0719656</span> secs]</span><br><span class="line">   [Eden: <span class="number">0.</span>0B(<span class="number">1024.</span>0K)-&gt;<span class="number">0.</span>0B(<span class="number">1024.</span>0K) Survivors: <span class="number">0.</span>0B-&gt;<span class="number">0.</span>0B Heap: <span class="number">18.</span>8M(<span class="number">20.</span>0M)-&gt;<span class="number">18.</span>8M(<span class="number">20.</span>0M)], [Metaspace: <span class="number">38</span></span><br><span class="line">76K-&gt;3876K(1056768K)] [Times: user=<span class="number">0.07</span> sys=<span class="number">0.00</span>, real=<span class="number">0.07</span> secs]</span><br></pre></td></tr></tbody></table></figure>

<h1 id="GC-调优"><a href="#GC-调优" class="headerlink" title="GC 调优"></a>GC 调优</h1><h2 id="基础概念"><a href="#基础概念" class="headerlink" title="基础概念"></a>基础概念</h2><ol>
<li>吞吐量：用户代码时间 /（用户代码执行时间 + 垃圾回收时间）</li>
<li>响应时间：STW 越短，响应时间越好</li>
</ol>
<p>所谓调优，首先确定，追求啥？吞吐量优先，还是响应时间优先？还是在满足一定的响应时间的情况下，要求达到多大的吞吐量…</p>
<p>问题：<br>科学计算，吞吐量。数据挖掘，thrput。吞吐量优先的一般：（PS + PO）</p>
<p>响应时间：网站 GUI API （1.8 G1）</p>
<p><strong>什么是调优？</strong></p>
<ol>
<li>根据需求进行 JVM 规划和预调优</li>
<li>优化运行 JVM 运行环境（慢，卡顿）</li>
<li>解决 JVM 运行过程中出现的各种问题（OOM）</li>
</ol>
<h2 id="调优规划"><a href="#调优规划" class="headerlink" title="调优规划"></a>调优规划</h2><ul>
<li><p>调优，从业务场景开始，没有业务场景的调优都是耍流氓 </p>
</li>
<li><p>监控（压力测试，能看到结果） </p>
</li>
<li><p>步骤： </p>
<ol>
<li>熟悉业务场景（没有最好的垃圾回收器，只有最合适的垃圾回收器） <ol>
<li>响应时间、停顿时间 [CMS G1 ZGC] （需要给用户作响应）</li>
<li>吞吐量 = 用户时间 /(用户时间 + GC 时间) [PS]</li>
</ol>
</li>
<li> 选择回收器组合</li>
<li>计算内存需求（经验值 1.5G 16G）</li>
<li>选定 CPU（越高越好）</li>
<li>设定年代大小、升级年龄</li>
<li>设定日志参数 <ol>
<li>-Xloggc:/opt/xxx/logs/xxx-xxx-gc-%t.log -XX:+UseGCLogFileRotation -XX:NumberOfGCLogFiles=5 -XX:GCLogFileSize=20M -XX:+PrintGCDetails -XX:+PrintGCDateStamps -XX:+PrintGCCause</li>
<li> 或者每天产生一个日志文件</li>
</ol>
</li>
<li>观察日志情况</li>
</ol>
</li>
<li><p>案例 1：垂直电商，最高每日百万订单，处理订单系统需要什么样的服务器配置？ </p>
<blockquote>
<p>这个问题比较业余，因为很多不同的服务器配置都能支撑（1.5G 16G）<br>1 小时 360000 集中时间段， 100 个订单 / 秒，（找一小时内的高峰期，1000 订单 / 秒）<br>经验值，<br>非要计算：一个订单产生需要多少内存？512K * 1000 500M 内存<br>专业一点儿问法：要求响应时间 100ms<br>压测！</p>
</blockquote>
</li>
<li><p>案例 2：12306 遭遇春节大规模抢票应该如何支撑？ </p>
<blockquote>
<p>12306 应该是中国并发量最大的秒杀网站：<br>号称并发量 100W 最高<br> CDN -&gt; LVS -&gt; NGINX -&gt; 业务系统 -&gt; 每台机器 1W 并发（10K 问题） 100 台机器<br>普通电商订单 -&gt; 下单 -&gt; 订单系统（IO）减库存 -&gt; 等待用户付款<br>12306 的一种可能的模型： 下单 -&gt; 减库存 和 订单 (redis kafka) 同时异步进行 -&gt; 等付款<br>减库存最后还会把压力压到一台服务器<br>可以做分布式本地库存 + 单独服务器做库存均衡<br>大流量的处理方法：分而治之</p>
</blockquote>
</li>
<li><p>怎么得到一个事务会消耗多少内存？ </p>
<blockquote>
<ol>
<li>弄台机器，看能承受多少 TPS？是不是达到目标？扩容或调优，让它达到 </li>
<li>用压测来确定</li>
</ol>
</blockquote>
</li>
</ul>
<h2 id="优化步骤"><a href="#优化步骤" class="headerlink" title="优化步骤"></a>优化步骤</h2><ol>
<li>有一个 50 万 PV 的资料类网站（从磁盘提取文档到内存）原服务器 32 位，1.5G<br>的堆，用户反馈网站比较缓慢，因此公司决定升级，新的服务器为 64 位，16G<br>的堆内存，结果用户反馈卡顿十分严重，反而比以前效率更低了 <ol>
<li>为什么原网站慢？<br>很多用户浏览数据，很多数据 load 到内存，内存不足，频繁 GC，STW 长，响应时间变慢</li>
<li>为什么会更卡顿？<br>内存越大，FGC 时间越长</li>
<li>解决方案：PS -&gt; PN + CMS 或者 G1</li>
</ol>
</li>
<li> 系统 CPU 经常 100%，如何调优？(面试高频)<br>CPU 100% 那么一定有线程在占用系统资源， <ol>
<li>找出哪个进程 cpu 高（top）</li>
<li>该进程中的哪个线程 cpu 高（top -Hp）</li>
<li>导出该线程的堆栈（jstack）</li>
<li>查找哪个方法（栈帧）消耗时间（jstack）</li>
<li>工作线程占比高 | 垃圾回收线程占比高</li>
</ol>
</li>
<li>系统内存飙高，如何查找问题？（面试高频） <ol>
<li>导出堆内存（jmap）</li>
<li>分析（jhat jvisualvm mat jprofiler … ）</li>
</ol>
</li>
<li>如何监控 JVM <ol>
<li>jstat jvisualvm jprofiler arthas top…</li>
</ol>
</li>
</ol>
<h2 id="解决-JVM-运行中的问题"><a href="#解决-JVM-运行中的问题" class="headerlink" title="解决 JVM 运行中的问题"></a>解决 JVM 运行中的问题</h2><h3 id="一个案例理解常用工具"><a href="#一个案例理解常用工具" class="headerlink" title="一个案例理解常用工具"></a>一个案例理解常用工具</h3><ol>
<li><p>测试代码： </p>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 从数据库中读取信用数据，套用模型，并把结果进行记录和传输</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">T15_FullGC_Problem01</span> {</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">class</span> <span class="title class_">CardInfo</span> {</span><br><span class="line">        <span class="type">BigDecimal</span> <span class="variable">price</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">BigDecimal</span>(<span class="number">0.0</span>);</span><br><span class="line">        <span class="type">String</span> <span class="variable">name</span> <span class="operator">=</span> <span class="string">"张三"</span>;</span><br><span class="line">        <span class="type">int</span> <span class="variable">age</span> <span class="operator">=</span> <span class="number">5</span>;</span><br><span class="line">        <span class="type">Date</span> <span class="variable">birthdate</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Date</span>();</span><br><span class="line"></span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">m</span><span class="params">()</span> {}</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="type">ScheduledThreadPoolExecutor</span> <span class="variable">executor</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ScheduledThreadPoolExecutor</span>(<span class="number">50</span>,</span><br><span class="line">            <span class="keyword">new</span> <span class="title class_">ThreadPoolExecutor</span>.DiscardOldestPolicy());</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception {</span><br><span class="line">        executor.setMaximumPoolSize(<span class="number">50</span>);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">for</span> (;;){</span><br><span class="line">            modelFit();</span><br><span class="line">            Thread.sleep(<span class="number">100</span>);</span><br><span class="line">        }</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">modelFit</span><span class="params">()</span>{</span><br><span class="line">        List&lt;CardInfo&gt; taskList = getAllCardInfo();</span><br><span class="line">        taskList.forEach(info -&gt; {</span><br><span class="line">            <span class="comment">// do something</span></span><br><span class="line">            executor.scheduleWithFixedDelay(() -&gt; {</span><br><span class="line">                <span class="comment">//do sth with info</span></span><br><span class="line">                info.m();</span><br><span class="line"></span><br><span class="line">            }, <span class="number">2</span>, <span class="number">3</span>, TimeUnit.SECONDS);</span><br><span class="line">        });</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> List&lt;CardInfo&gt; <span class="title function_">getAllCardInfo</span><span class="params">()</span>{</span><br><span class="line">        List&lt;CardInfo&gt; taskList = <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;&gt;();</span><br><span class="line"></span><br><span class="line">        <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; <span class="number">100</span>; i++) {</span><br><span class="line">            <span class="type">CardInfo</span> <span class="variable">ci</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">CardInfo</span>();</span><br><span class="line">            taskList.add(ci);</span><br><span class="line">        }</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> taskList;</span><br><span class="line">    }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

</li>
<li><p>java -Xms200M -Xmx200M -XX:+PrintGC com.mashibing.jvm.gc.T15_FullGC_Problem01 </p>
</li>
<li><p>运维团队首先受到报警信息（CPU Memory） </p>
</li>
<li><p>top 命令观察到问题：内存不断增长 CPU 占用率居高不下 </p>
</li>
<li><p>top -Hp 观察进程中的线程，哪个线程 CPU 和内存占比高 </p>
</li>
<li><p>jps 定位具体 java 进程<br>jstack 定位线程状况，重点关注：WAITING BLOCKED<br>eg.<br>waiting on &lt;0x0000000088ca3310&gt; （a java.lang.Object）<br>假如有一个进程中 100 个线程，很多线程都在 waiting on <xx> ，一定要找到是哪个线程持有这把锁<br>怎么找？搜索 jstack dump 的信息，找<xx> ，看哪个线程持有这把锁 RUNNABLE </xx></xx></p>
</li>
<li><p>线程的名称（尤其是线程池）都要写有意义的名称 </p>
</li>
<li><p>jinfo pid </p>
</li>
<li><p>jstat -gc 动态观察 gc 情况 / 阅读 GC 日志发现频繁 GC /arthas 观察 /jconsole/jvisualVM/ Jprofiler（最好用）<br>jstat -gc 4655 500 : 每个 500 个毫秒打印 GC 的情况<br>如果面试官问你是怎么定位 OOM 问题的？如果你回答用图形界面（错误）<br>1：已经上线的系统不用图形界面用什么？（cmdline arthas）<br>2：图形界面到底用在什么地方？测试！测试的时候进行监控！（压测观察） </p>
</li>
<li><p>jmap - histo 4655 | head -20，查找有多少对象产生 </p>
</li>
<li><p>jmap -dump:format=b,file=xxx pid ：<br>线上系统，内存特别大，jmap 执行期间会对进程产生很大影响，甚至卡顿（电商不适合）<br>1：设定了参数 HeapDump，OOM 的时候会自动产生堆转储文件<br>2：很多服务器备份（高可用），停掉这台服务器对其他服务器不影响<br>3：在线定位（一般小点儿公司用不到） </p>
</li>
<li><p>java -Xms20M -Xmx20M -XX:+UseParallelGC -XX:+HeapDumpOnOutOfMemoryError com.mashibing.jvm.gc.T15_FullGC_Problem01 </p>
</li>
<li><p>使用 MAT /jhat/jvisualvm 进行 dump 文件分析<br><a target="_blank" rel="noopener" href="https://www.cnblogs.com/baihuitestsoftware/articles/6406271.html">java 命令 –jhat 命令使用</a><br>jhat -J-mx512M xxx.dump<br><a target="_blank" rel="noopener" href="http://192.168.17.11:7000/">http://192.168.17.11:7000</a><br>拉到最后：找到对应链接<br>可以使用 OQL 查找特定问题对象 </p>
</li>
<li><p>找到代码的问题</p>
</li>
</ol>
<h3 id="jconsole-远程连接"><a href="#jconsole-远程连接" class="headerlink" title="jconsole 远程连接"></a>jconsole 远程连接</h3><ol>
<li><p>程序启动加入参数： </p>
<figure class="highlight shell"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">java -Djava.rmi.server.hostname=192.168.17.11 -Dcom.sun.management.jmxremote -Dcom.sun.management.jmxremote.port=11111 -Dcom.sun.management.jmxremote.authenticate=false -Dcom.sun.management.jmxremote.ssl=false XXX</span><br></pre></td></tr></tbody></table></figure>
</li>
<li><p>如果遭遇 Local host name unknown：XXX 的错误，修改 /etc/hosts 文件，把 XXX 加入进去 </p>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">192.168</span><span class="number">.17</span><span class="number">.11</span> basic localhost localhost.localdomain localhost4 localhost4.localdomain4</span><br><span class="line">::<span class="number">1</span>         localhost localhost.localdomain localhost6 localhost6.localdomain6</span><br></pre></td></tr></tbody></table></figure>
</li>
<li><p>关闭 linux 防火墙（实战中应该打开对应端口） </p>
<figure class="highlight shell"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">service iptables stop</span><br><span class="line">chkconfig iptables off #永久关闭</span><br></pre></td></tr></tbody></table></figure>
</li>
<li><p>windows 上打开 jconsole 远程连接 192.168.17.11:11111</p>
</li>
</ol>
<h3 id="jvisualvm-远程连接"><a href="#jvisualvm-远程连接" class="headerlink" title="jvisualvm 远程连接"></a>jvisualvm 远程连接</h3><p>简单做法：<a target="_blank" rel="noopener" href="https://www.cnblogs.com/liugh/p/7620336.html">使用 jvisualvm 的 jstatd 方式远程监控 Java 程序</a></p>
<h3 id="jprofiler（收费）"><a href="#jprofiler（收费）" class="headerlink" title="jprofiler（收费）"></a>jprofiler（收费）</h3><h3 id="arthas-在线排查工具"><a href="#arthas-在线排查工具" class="headerlink" title="arthas 在线排查工具"></a>arthas 在线排查工具</h3><ul>
<li>为什么需要在线排查？<br>在生产上我们经常会碰到一些不好排查的问题，例如线程安全问题，用最简单的 threaddump 或者 heapdump 不好查到问题原因。为了排查这些问题，有时我们会临时加一些日志，比如在一些关键的函数里打印出入参，然后重新打包发布，如果打了日志还是没找到问题，继续加日志，重新打包发布。对于上线流程复杂而且审核比较严的公司，从改代码到上线需要层层的流转，会大大影响问题排查的进度。</li>
<li>jvm 观察 jvm 信息</li>
<li> thread &nbsp;定位线程问题</li>
<li> dashboard 观察系统情况</li>
<li> heapdump + jhat 分析</li>
<li> jad 反编译<br>动态代理生成类的问题定位<br>第三方的类（观察代码）<br>版本问题（确定自己最新提交的版本是不是被使用）</li>
<li>redefine 热替换<br>目前有些限制条件：只能改方法实现（方法已经运行完成），不能改方法名， 不能改属性<br>m() -&gt; mm()</li>
<li>sc &nbsp;- search class</li>
<li>watch &nbsp;- watch method</li>
<li> 没有包含的功能：jmap</li>
</ul>
<h3 id="产生原因案例"><a href="#产生原因案例" class="headerlink" title="产生原因案例"></a>产生原因案例</h3><p>OOM 产生的原因多种多样，有些程序未必产生 OOM，不断 FGC（CPU 飙高，但内存回收特别少）（上面案例）</p>
<ol>
<li><p>硬件升级系统反而卡顿的问题（见上） </p>
</li>
<li><p>线程池不当运用产生 OOM 问题（见上）<br>不断的往 List 里加对象（实在太 LOW） </p>
</li>
<li><p>jira 问题<br>实际生产参数案例： </p>
<figure class="highlight plaintext"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">-Xms9216m -Xmx9216m </span><br><span class="line">-XX:-OmitStackTraceInFastThrow </span><br><span class="line">-Xloggc:/opt/xxx/logs/xxx-gc-%t.log </span><br><span class="line">-XX:+UseGCLogFileRotation</span><br><span class="line">-XX:NumberOfGCLogFiles=5</span><br><span class="line">-XX:GCLogFileSize=20M</span><br><span class="line">-XX:+PrintGCDetails</span><br><span class="line">-XX:+PrintGCDateStamps</span><br><span class="line">-XX:+PrintGCTimeStamps</span><br><span class="line">-XX:+PrintGCCause -classpath /opt/xxx/bin/...jar</span><br></pre></td></tr></tbody></table></figure>
<p><br>实际系统不断重启<br>解决问题 加内存 + 更换垃圾回收器 G1<br>真正问题在哪儿？不知道 </p>
</li>
<li><p>tomcat http-header-size 过大问题（Hector） </p>
</li>
<li><p>lambda 表达式导致方法区溢出问题（MethodArea / Perm Metaspace）<br>LambdaGC.java &nbsp; &nbsp; -XX:MaxMetaspaceSize=9M -XX:+PrintGCDetails </p>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">"C:\Program Files\Java\jdk1.8.0_181\bin\java.exe"</span> -XX:MaxMetaspaceSize=9M -XX:+PrintGCDetails <span class="string">"-javaagent:C:\Program Files\JetBrains\IntelliJ IDEA Community Edition 2019.1\lib\idea_rt.jar=49316:C:\Program Files\JetBrains\IntelliJ IDEA Community Edition 2019.1\bin"</span> -Dfile.encoding=UTF-<span class="number">8</span> -classpath <span class="string">"C:\Program Files\Java\jdk1.8.0_181\jre\lib\charsets.jar;C:\Program Files\Java\jdk1.8.0_181\jre\lib\deploy.jar;C:\Program Files\Java\jdk1.8.0_181\jre\lib\ext\access-bridge-64.jar;C:\Program Files\Java\jdk1.8.0_181\jre\lib\ext\cldrdata.jar;C:\Program Files\Java\jdk1.8.0_181\jre\lib\ext\dnsns.jar;C:\Program Files\Java\jdk1.8.0_181\jre\lib\ext\jaccess.jar;C:\Program Files\Java\jdk1.8.0_181\jre\lib\ext\jfxrt.jar;C:\Program Files\Java\jdk1.8.0_181\jre\lib\ext\localedata.jar;C:\Program Files\Java\jdk1.8.0_181\jre\lib\ext\nashorn.jar;C:\Program Files\Java\jdk1.8.0_181\jre\lib\ext\sunec.jar;C:\Program Files\Java\jdk1.8.0_181\jre\lib\ext\sunjce_provider.jar;C:\Program Files\Java\jdk1.8.0_181\jre\lib\ext\sunmscapi.jar;C:\Program Files\Java\jdk1.8.0_181\jre\lib\ext\sunpkcs11.jar;C:\Program Files\Java\jdk1.8.0_181\jre\lib\ext\zipfs.jar;C:\Program Files\Java\jdk1.8.0_181\jre\lib\javaws.jar;C:\Program Files\Java\jdk1.8.0_181\jre\lib\jce.jar;C:\Program Files\Java\jdk1.8.0_181\jre\lib\jfr.jar;C:\Program Files\Java\jdk1.8.0_181\jre\lib\jfxswt.jar;C:\Program Files\Java\jdk1.8.0_181\jre\lib\jsse.jar;C:\Program Files\Java\jdk1.8.0_181\jre\lib\management-agent.jar;C:\Program Files\Java\jdk1.8.0_181\jre\lib\plugin.jar;C:\Program Files\Java\jdk1.8.0_181\jre\lib\resources.jar;C:\Program Files\Java\jdk1.8.0_181\jre\lib\rt.jar;C:\work\ijprojects\JVM\out\production\JVM;C:\work\ijprojects\ObjectSize\out\artifacts\ObjectSize_jar\ObjectSize.jar"</span> com.mashibing.jvm.gc.LambdaGC</span><br><span class="line">[GC (Metadata GC Threshold) [PSYoungGen: 11341K-&gt;1880K(38400K)] 11341K-&gt;1888K(125952K), <span class="number">0.0022190</span> secs] [Times: user=<span class="number">0.00</span> sys=<span class="number">0.00</span>, real=<span class="number">0.00</span> secs] </span><br><span class="line">[Full <span class="title function_">GC</span> <span class="params">(Metadata GC Threshold)</span> [PSYoungGen: 1880K-&gt;0K(38400K)] [ParOldGen: 8K-&gt;1777K(35328K)] 1888K-&gt;1777K(73728K), [Metaspace: 8164K-&gt;8164K(1056768K)], <span class="number">0.0100681</span> secs] [Times: user=<span class="number">0.02</span> sys=<span class="number">0.00</span>, real=<span class="number">0.01</span> secs] </span><br><span class="line">[GC (Last ditch collection) [PSYoungGen: 0K-&gt;0K(38400K)] 1777K-&gt;1777K(73728K), <span class="number">0.0005698</span> secs] [Times: user=<span class="number">0.00</span> sys=<span class="number">0.00</span>, real=<span class="number">0.00</span> secs] </span><br><span class="line">[Full <span class="title function_">GC</span> <span class="params">(Last ditch collection)</span> [PSYoungGen: 0K-&gt;0K(38400K)] [ParOldGen: 1777K-&gt;1629K(67584K)] 1777K-&gt;1629K(105984K), [Metaspace: 8164K-&gt;8156K(1056768K)], <span class="number">0.0124299</span> secs] [Times: user=<span class="number">0.06</span> sys=<span class="number">0.00</span>, real=<span class="number">0.01</span> secs] </span><br><span class="line">java.lang.reflect.InvocationTargetException</span><br><span class="line">	at sun.reflect.NativeMethodAccessorImpl.invoke0(Native Method)</span><br><span class="line">	at sun.reflect.NativeMethodAccessorImpl.invoke(NativeMethodAccessorImpl.java:<span class="number">62</span>)</span><br><span class="line">	at sun.reflect.DelegatingMethodAccessorImpl.invoke(DelegatingMethodAccessorImpl.java:<span class="number">43</span>)</span><br><span class="line">	at java.lang.reflect.Method.invoke(Method.java:<span class="number">498</span>)</span><br><span class="line">	at sun.instrument.InstrumentationImpl.loadClassAndStartAgent(InstrumentationImpl.java:<span class="number">388</span>)</span><br><span class="line">	at sun.instrument.InstrumentationImpl.loadClassAndCallAgentmain(InstrumentationImpl.java:<span class="number">411</span>)</span><br><span class="line">Caused by: java.lang.OutOfMemoryError: Compressed <span class="keyword">class</span> <span class="title class_">space</span></span><br><span class="line">	at sun.misc.Unsafe.defineClass(Native Method)</span><br><span class="line">	at sun.reflect.ClassDefiner.defineClass(ClassDefiner.java:<span class="number">63</span>)</span><br><span class="line">	at sun.reflect.MethodAccessorGenerator$<span class="number">1.</span>run(MethodAccessorGenerator.java:<span class="number">399</span>)</span><br><span class="line">	at sun.reflect.MethodAccessorGenerator$<span class="number">1.</span>run(MethodAccessorGenerator.java:<span class="number">394</span>)</span><br><span class="line">	at java.security.AccessController.doPrivileged(Native Method)</span><br><span class="line">	at sun.reflect.MethodAccessorGenerator.generate(MethodAccessorGenerator.java:<span class="number">393</span>)</span><br><span class="line">	at sun.reflect.MethodAccessorGenerator.generateSerializationConstructor(MethodAccessorGenerator.java:<span class="number">112</span>)</span><br><span class="line">	at sun.reflect.ReflectionFactory.generateConstructor(ReflectionFactory.java:<span class="number">398</span>)</span><br><span class="line">	at sun.reflect.ReflectionFactory.newConstructorForSerialization(ReflectionFactory.java:<span class="number">360</span>)</span><br><span class="line">	at java.io.ObjectStreamClass.getSerializableConstructor(ObjectStreamClass.java:<span class="number">1574</span>)</span><br><span class="line">	at java.io.ObjectStreamClass.access$<span class="number">1500</span>(ObjectStreamClass.java:<span class="number">79</span>)</span><br><span class="line">	at java.io.ObjectStreamClass$<span class="number">3.</span>run(ObjectStreamClass.java:<span class="number">519</span>)</span><br><span class="line">	at java.io.ObjectStreamClass$<span class="number">3.</span>run(ObjectStreamClass.java:<span class="number">494</span>)</span><br><span class="line">	at java.security.AccessController.doPrivileged(Native Method)</span><br><span class="line">	at java.io.ObjectStreamClass.&lt;init&gt;(ObjectStreamClass.java:<span class="number">494</span>)</span><br><span class="line">	at java.io.ObjectStreamClass.lookup(ObjectStreamClass.java:<span class="number">391</span>)</span><br><span class="line">	at java.io.ObjectOutputStream.writeObject0(ObjectOutputStream.java:<span class="number">1134</span>)</span><br><span class="line">	at java.io.ObjectOutputStream.defaultWriteFields(ObjectOutputStream.java:<span class="number">1548</span>)</span><br><span class="line">	at java.io.ObjectOutputStream.writeSerialData(ObjectOutputStream.java:<span class="number">1509</span>)</span><br><span class="line">	at java.io.ObjectOutputStream.writeOrdinaryObject(ObjectOutputStream.java:<span class="number">1432</span>)</span><br><span class="line">	at java.io.ObjectOutputStream.writeObject0(ObjectOutputStream.java:<span class="number">1178</span>)</span><br><span class="line">	at java.io.ObjectOutputStream.writeObject(ObjectOutputStream.java:<span class="number">348</span>)</span><br><span class="line">	at javax.management.remote.rmi.RMIConnectorServer.encodeJRMPStub(RMIConnectorServer.java:<span class="number">727</span>)</span><br><span class="line">	at javax.management.remote.rmi.RMIConnectorServer.encodeStub(RMIConnectorServer.java:<span class="number">719</span>)</span><br><span class="line">	at javax.management.remote.rmi.RMIConnectorServer.encodeStubInAddress(RMIConnectorServer.java:<span class="number">690</span>)</span><br><span class="line">	at javax.management.remote.rmi.RMIConnectorServer.start(RMIConnectorServer.java:<span class="number">439</span>)</span><br><span class="line">	at sun.management.jmxremote.ConnectorBootstrap.startLocalConnectorServer(ConnectorBootstrap.java:<span class="number">550</span>)</span><br><span class="line">	at sun.management.Agent.startLocalManagementAgent(Agent.java:<span class="number">137</span>)</span><br></pre></td></tr></tbody></table></figure>
</li>
<li><p>直接内存溢出问题（少见）<br>《深入理解 Java 虚拟机》P59，使用 Unsafe 分配直接内存，或者使用 NIO 的问题 </p>
</li>
<li><p>栈溢出问题<br>-Xss 设定太小 </p>
</li>
<li><p>比较一下这两段程序的异同，分析哪一个是更优的写法： </p>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">Object</span> <span class="variable">o</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line"><span class="keyword">for</span>(<span class="type">int</span> i=<span class="number">0</span>; i&lt;<span class="number">100</span>; i++) {</span><br><span class="line">    o = <span class="keyword">new</span> <span class="title class_">Object</span>();</span><br><span class="line">    <span class="comment">// 业务处理</span></span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
</li>
<li><p>重写 finalize 引发频繁 GC<br>小米云，HBase 同步系统，系统通过 nginx 访问超时报警，最后排查，C++ 程序员重写 finalize 引发频繁 GC 问题<br>为什么 C++ 程序员会重写 finalize？（new delete）<br>finalize 耗时比较长（200ms） </p>
</li>
<li><p>如果有一个系统，内存一直消耗不超过 10%，但是观察 GC 日志，发现 FGC 总是频繁产生，会是什么引起的？<br>System.gc () (这个比较 Low) </p>
</li>
<li><p>Distuptor 有个可以设置链的长度，如果过大，然后对象大，消费完不主动释放，会溢出 (来自 死物风情) </p>
</li>
<li><p>用 jvm 都会溢出，mycat 用崩过，1.6.5 某个临时版本解析 sql 子查询算法有问题，9 个 exists 的联合 sql 就导致生成几百万的对象（来自 死物风情） </p>
</li>
<li><p>new 大量线程，会产生 native thread OOM，（low）应该用线程池，<br>解决方案：减少堆空间（太 TM low 了），预留更多内存产生 native thread<br>JVM 内存占物理内存比例 50% - 80%</p>
</li>
</ol>
<h1 id="GC-参数"><a href="#GC-参数" class="headerlink" title="GC 参数"></a>GC 参数</h1><p><a target="_blank" rel="noopener" href="https://docs.oracle.com/javase/8/docs/technotes/tools/unix/java.html">JVM 的命令行参数参考</a><br>HotSpot 参数分类</p>
<ul>
<li>标准： - 开头，所有的 HotSpot 都支持 </li>
<li>非标准：-X 开头，特定版本 HotSpot 支持特定命令 </li>
<li>不稳定：-XX 开头，下个版本可能取消</li>
</ul>
<h2 id="常用参数"><a href="#常用参数" class="headerlink" title="常用参数"></a>常用参数</h2><ul>
<li>-Xmn -Xms -Xmx -Xss<br>年轻代 最小堆 最大堆 栈空间</li>
<li> -XX:+UseTLAB<br>使用 TLAB，默认打开</li>
<li> -XX:+PrintTLAB<br>打印 TLAB 的使用情况</li>
<li> -XX:TLABSize<br>设置 TLAB 大小</li>
<li> -XX:+DisableExplictGC<br>System.gc () 不管用 ，FGC</li>
<li>-XX:+PrintGC</li>
<li>-XX:+PrintGCDetails</li>
<li>-XX:+PrintHeapAtGC</li>
<li>-XX:+PrintGCTimeStamps</li>
<li>-XX:+PrintGCCauses</li>
<li>-XX:+PrintGCApplicationConcurrentTime（低）<br>打印应用程序时间</li>
<li> -XX:+PrintGCApplicationStoppedTime （低）<br>打印暂停时长</li>
<li> -XX:+PrintReferenceGC （重要性低）<br>记录回收了多少种不同引用类型的引用</li>
<li> -verbose:class<br>类加载详细过程</li>
<li> -XX:+PrintVMOptions</li>
<li>-XX:+PrintFlagsFinal</li>
<li>-XX:+PrintFlagsInitial：查看所有 JVM 参数启动的初始值</li>
<li> -XX:+PrintCommandLineFlags：默认的参数</li>
<li> -Xloggc:opt/log/gc.log</li>
<li>-XX:MaxTenuringThreshold<br>升代年龄，最大值 15</li>
<li> 锁自旋次数 -XX:PreBlockSpin 热点代码检测参数 -XX:CompileThreshold 逃逸分析 标量替换 …<br>这些不建议设置</li>
</ul>
<h2 id="Parallel-常用参数"><a href="#Parallel-常用参数" class="headerlink" title="Parallel 常用参数"></a>Parallel 常用参数</h2><ul>
<li>-XX:SurvivorRatio</li>
<li>-XX:PreTenureSizeThreshold<br>大对象到底多大</li>
<li> -XX:MaxTenuringThreshold</li>
<li>-XX:+ParallelGCThreads<br>并行收集器的线程数，同样适用于 CMS，一般设为和 CPU 核数相同</li>
<li> -XX:+UseAdaptiveSizePolicy<br>自动选择各区大小比例</li>
</ul>
<h2 id="CMS-常用参数"><a href="#CMS-常用参数" class="headerlink" title="CMS 常用参数"></a>CMS 常用参数</h2><ul>
<li>-XX:+UseConcMarkSweepGC</li>
<li>-XX:ParallelCMSThreads<br>CMS 线程数量</li>
<li> -XX:CMSInitiatingOccupancyFraction<br>使用多少比例的老年代后开始 CMS 收集，默认是 68%（近似值），如果频繁发生 SerialOld 卡顿，应该调小，（频繁 CMS 回收）</li>
<li>-XX:+UseCMSCompactAtFullCollection<br>在 FGC 时进行压缩</li>
<li> -XX:CMSFullGCsBeforeCompaction<br>多少次 FGC 之后进行压缩</li>
<li> -XX:+CMSClassUnloadingEnabled</li>
<li>-XX:CMSInitiatingPermOccupancyFraction<br>达到什么比例时进行 Perm 回收</li>
<li> GCTimeRatio<br>设置 GC 时间占用程序运行时间的百分比</li>
<li> -XX:MaxGCPauseMillis<br>停顿时间，是一个建议时间，GC 会尝试用各种手段达到这个时间，比如减小年轻代</li>
</ul>
<h2 id="G1-常用参数"><a href="#G1-常用参数" class="headerlink" title="G1 常用参数"></a>G1 常用参数</h2><ul>
<li>-XX:+UseG1GC</li>
<li>-XX:MaxGCPauseMillis<br>建议值，G1 会尝试调整 Young 区的块数来达到这个值</li>
<li> -XX:GCPauseIntervalMillis<br>？GC 的间隔时间</li>
<li> -XX:+G1HeapRegionSize<br>分区大小，建议逐渐增大该值，1 2 4 8 16 32。<br>随着 size 增加，垃圾的存活时间更长，GC 间隔更长，但每次 GC 的时间也会更长<br>ZGC 做了改进（动态区块大小）</li>
<li>G1NewSizePercent<br>新生代最小比例，默认为 5%</li>
<li>G1MaxNewSizePercent<br>新生代最大比例，默认为 60%</li>
<li>GCTimeRatio<br>GC 时间建议比例，G1 会根据这个值调整堆空间</li>
<li> ConcGCThreads<br>线程数量</li>
<li> InitiatingHeapOccupancyPercent<br>启动 G1 的堆空间占用比例</li>
</ul>
<h1 id="参考资料"><a href="#参考资料" class="headerlink" title="参考资料"></a>参考资料</h1><ol>
<li><a target="_blank" rel="noopener" href="https://blogs.oracle.com/jonthecollector/our-collectors">Our Collectors</a></li>
<li><a target="_blank" rel="noopener" href="https://docs.oracle.com/javase/8/docs/technotes/tools/unix/java.html">Java Platform, Standard Edition Tools Reference</a></li>
<li><a target="_blank" rel="noopener" href="http://java.sun.com/javase/technologies/hotspot/vmoptions.jsp">Java HotSpot VM Options</a></li>
<li>JVM 调优参考文档： <a target="_blank" rel="noopener" href="https://docs.oracle.com/en/java/javase/13/gctuning/introduction-garbage-collection-tuning.html#GUID-8A443184-7E07-4B71-9777-4F12947C8184">HotSpot Virtual Machine Garbage Collection Tuning Guide</a></li>
<li><a target="_blank" rel="noopener" href="https://www.cnblogs.com/nxlhero/p/11660854.html">利用 JVM 在线调试工具排查线上问题</a></li>
<li><a target="_blank" rel="noopener" href="https://www.jianshu.com/p/507f7e0cc3a3">Arthas 使用</a>：arthas 常用命令</li>
<li> Arthas 手册： <ol>
<li>启动 arthas java -jar arthas-boot.jar</li>
<li> 绑定 java 进程</li>
<li> dashboard 命令观察系统整体情况</li>
<li> help 查看帮助</li>
<li> help xx 查看具体命令帮助</li>
</ol>
</li>
<li> jmap 命令参考： <a target="_blank" rel="noopener" href="https://www.jianshu.com/p/507f7e0cc3a3">https://www.jianshu.com/p/507f7e0cc3a3</a> <ol>
<li>jmap -heap pid</li>
<li>jmap -histo pid</li>
<li>jmap -clstats pid</li>
</ol>
</li>
</ol>

    </div>

    
    
    

    <footer class="post-footer">
          <div class="followme">
  <span>Welcome to my other publishing channels</span>

  <div class="social-list">

      <div class="social-item">
          <a target="_blank" class="social-link" href="https://twitter.com/ccomma_cat">
            <span class="icon">
              <i class="fab fa-twitter"></i>
            </span>

            <span class="label">Twitter</span>
          </a>
      </div>

      <div class="social-item">
          <a target="_blank" class="social-link" href="/atom.xml">
            <span class="icon">
              <i class="fa fa-rss"></i>
            </span>

            <span class="label">RSS</span>
          </a>
      </div>
  </div>
</div>


        

          <div class="post-nav">
            <div class="post-nav-item">
                <a href="/b4ce99d25d0d/" rel="prev" title="Redis 从入门到入土⑧：常用命令">
                  <i class="fa fa-angle-left"></i> Redis 从入门到入土⑧：常用命令
                </a>
            </div>
            <div class="post-nav-item">
                <a href="/fb2b1fd4b701/" rel="next" title="类型转换异常 sun.reflect.generics.reflectiveObjects.TypeVariableImpl cannot be cast to java.lang.Class">
                  类型转换异常 sun.reflect.generics.reflectiveObjects.TypeVariableImpl cannot be cast to java.lang.Class <i class="fa fa-angle-right"></i>
                </a>
            </div>
          </div>
    </footer>
  </article>
</div>






    
  <div class="comments" id="disqus_thread">
    <noscript>Please enable JavaScript to view the comments powered by Disqus.</noscript>
  </div>
  
</div>
  </main>

  <footer class="footer">
    <div class="footer-inner">

  <div class="copyright">
    &copy; 
    <span itemprop="copyrightYear">2024</span>
    <span class="with-love">
      <i class="fa fa-heart"></i>
    </span>
    <span class="author" itemprop="copyrightHolder">CComma</span>
  </div>
<div class="busuanzi-count">
    <span class="post-meta-item" id="busuanzi_container_site_uv">
      <span class="post-meta-item-icon">
        <i class="fa fa-user"></i>
      </span>
      <span class="site-uv" title="Total Visitors">
        <span id="busuanzi_value_site_uv"></span>
      </span>
    </span>
    <span class="post-meta-item" id="busuanzi_container_site_pv">
      <span class="post-meta-item-icon">
        <i class="fa fa-eye"></i>
      </span>
      <span class="site-pv" title="Total Views">
        <span id="busuanzi_value_site_pv"></span>
      </span>
    </span>
</div>

    </div>
  </footer>

  
  <div class="toggle sidebar-toggle" role="button">
    <span class="toggle-line"></span>
    <span class="toggle-line"></span>
    <span class="toggle-line"></span>
  </div>
  <div class="sidebar-dimmer"></div>
  <div class="back-to-top" role="button" aria-label="Back to top">
    <i class="fa fa-arrow-up fa-lg"></i>
    <span>0%</span>
  </div>
  <div class="reading-progress-bar"></div>

  <a href="https://github.com/ccomma" class="github-corner" title="Follow me on GitHub" aria-label="Follow me on GitHub" rel="noopener" target="_blank"><svg width="80" height="80" viewBox="0 0 250 250" aria-hidden="true"><path d="M0,0 L115,115 L130,115 L142,142 L250,250 L250,0 Z"></path><path d="M128.3,109.0 C113.8,99.7 119.0,89.6 119.0,89.6 C122.0,82.7 120.5,78.6 120.5,78.6 C119.2,72.0 123.4,76.3 123.4,76.3 C127.3,80.9 125.5,87.3 125.5,87.3 C122.9,97.6 130.6,101.9 134.4,103.2" fill="currentColor" style="transform-origin: 130px 106px;" class="octo-arm"></path><path d="M115.0,115.0 C114.9,115.1 118.7,116.5 119.8,115.4 L133.7,101.6 C136.9,99.2 139.9,98.4 142.2,98.6 C133.8,88.0 127.5,74.4 143.8,58.0 C148.5,53.4 154.0,51.2 159.7,51.0 C160.3,49.4 163.2,43.6 171.4,40.1 C171.4,40.1 176.1,42.5 178.8,56.2 C183.1,58.6 187.2,61.8 190.9,65.4 C194.5,69.0 197.7,73.2 200.1,77.6 C213.8,80.2 216.3,84.9 216.3,84.9 C212.7,93.1 206.9,96.0 205.4,96.6 C205.1,102.4 203.0,107.8 198.3,112.5 C181.9,128.9 168.3,122.5 157.7,114.1 C157.9,116.9 156.7,120.9 152.7,124.9 L141.0,136.5 C139.8,137.7 141.6,141.9 141.8,141.8 Z" fill="currentColor" class="octo-body"></path></svg></a>

<noscript>
  <div class="noscript-warning">Theme NexT works best with JavaScript enabled</div>
</noscript>


  
  <script src="https://cdnjs.cloudflare.com/ajax/libs/animejs/3.2.1/anime.min.js" integrity="sha256-XL2inqUJaslATFnHdJOi9GfQ60on8Wx1C2H8DYiN1xY=" crossorigin="anonymous"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/next-theme-pjax/0.6.0/pjax.min.js" integrity="sha256-vxLn1tSKWD4dqbMRyv940UYw4sXgMtYcK6reefzZrao=" crossorigin="anonymous"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/medium-zoom/1.1.0/medium-zoom.min.js" integrity="sha256-ZgMyDAIYDYGxbcpJcfUnYwNevG/xi9OHKaR/8GK+jWc=" crossorigin="anonymous"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/lozad.js/1.16.0/lozad.min.js" integrity="sha256-mOFREFhqmHeQbXpK2lp4nA3qooVgACfh88fpJftLBbc=" crossorigin="anonymous"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/pangu/4.0.7/pangu.min.js" integrity="sha256-j+yj56cdEY2CwkVtGyz18fNybFGpMGJ8JxG3GSyO2+I=" crossorigin="anonymous"></script>
<script src="/js/comments.js"></script><script src="/js/utils.js"></script><script src="/js/motion.js"></script><script src="/js/schemes/muse.js"></script><script src="/js/next-boot.js"></script><script src="/js/pjax.js"></script>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/hexo-generator-searchdb/1.4.1/search.js" integrity="sha256-1kfA5uHPf65M5cphT2dvymhkuyHPQp5A53EGZOnOLmc=" crossorigin="anonymous"></script>
<script src="/js/third-party/search/local-search.js"></script>





  <script src="/js/third-party/pace.js"></script>


  
  <script data-pjax async src="https://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>




  <script src="https://cdnjs.cloudflare.com/ajax/libs/quicklink/2.3.0/quicklink.umd.js" integrity="sha256-yvJQOINiH9fWemHn0vCA5lsHWJaHs6/ZmO+1Ft04SvM=" crossorigin="anonymous"></script>
  <script class="next-config" data-name="quicklink" type="application/json">{"enable":true,"home":true,"archive":true,"delay":true,"timeout":3000,"priority":true,"url":"https://ccomma.cn/27d53953edf2/"}</script>
  <script src="/js/third-party/quicklink.js"></script>
<script class="next-config" data-name="disqus" type="application/json">{"enable":true,"shortname":"ccomma","count":true,"i18n":{"disqus":"disqus"}}</script>
<script src="/js/third-party/comments/disqus.js"></script>

</body>
</html>
