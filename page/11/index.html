<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width">
<meta name="theme-color" content="#222"><meta name="generator" content="Hexo 7.0.0">

  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16.png">
  <link rel="mask-icon" href="/images/safari-pinned-tab.svg" color="#222">
  <meta name="google-site-verification" content="5K7puGkNbKLWhZTmZZm6haOpSbJ-oOvUQFYJeMFBJSk">
  <meta name="baidu-site-verification" content="codeva-3O8Y6jTFCL">

<link rel="stylesheet" href="/css/main.css">

<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Monaco:300,300italic,400,400italic,700,700italic&display=swap&subset=latin,latin-ext">

<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" integrity="sha256-yIDrPSXHZdOZhAqiBP7CKzIwMQmRCJ8UeB8Jo17YC4o=" crossorigin="anonymous">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/3.1.1/animate.min.css" integrity="sha256-PR7ttpcvz8qrF57fur/yAx1qXMFJeJFiA6pSzWi0OIE=" crossorigin="anonymous">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/pace/1.2.4/themes/blue/pace-theme-minimal.css">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/pace/1.2.4/pace.min.js" integrity="sha256-gqd7YTjg/BtfqWSwsJOvndl0Bxc8gFImLEkXQT8+qj0=" crossorigin="anonymous"></script>

<script class="next-config" data-name="main" type="application/json">{"hostname":"ccomma.cn","root":"/","images":"/images","scheme":"Muse","darkmode":false,"version":"8.19.1","exturl":false,"sidebar":{"position":"left","display":"post","padding":18,"offset":12},"copycode":{"enable":true,"style":"mac"},"fold":{"enable":true,"height":500},"bookmark":{"enable":false,"color":"#222","save":"auto"},"mediumzoom":true,"lazyload":true,"pangu":true,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"stickytabs":false,"motion":{"enable":true,"async":false,"transition":{"menu_item":"fadeInDown","post_block":"fadeIn","post_header":"fadeInDown","post_body":"fadeInDown","coll_header":"fadeInLeft","sidebar":"fadeInUp"}},"prism":false,"i18n":{"placeholder":"Searching...","empty":"We didn't find any results for the search: ${query}","hits_time":"${hits} results found in ${time} ms","hits":"${hits} results found"},"path":"/search.xml","localsearch":{"enable":true,"trigger":"auto","top_n_per_article":1,"unescape":false,"preload":false}}</script><script src="/js/config.js"></script>

    <meta name="description" content="下一个目标：改变世界！">
<meta property="og:type" content="website">
<meta property="og:title" content="CComma&#39;s Blog">
<meta property="og:url" content="https://ccomma.cn/page/11/">
<meta property="og:site_name" content="CComma&#39;s Blog">
<meta property="og:description" content="下一个目标：改变世界！">
<meta property="og:locale" content="en_US">
<meta property="article:author" content="CComma">
<meta property="article:tag" content="编程技术、Java">
<meta name="twitter:card" content="summary">


<link rel="canonical" href="https://ccomma.cn/page/11/">



<script class="next-config" data-name="page" type="application/json">{"sidebar":"","isHome":true,"isPost":false,"lang":"en","comments":"","permalink":"","path":"page/11/index.html","title":""}</script>

<script class="next-config" data-name="calendar" type="application/json">""</script>
<title>CComma's Blog</title>
  
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-GS592DM662"></script>
  <script class="next-config" data-name="google_analytics" type="application/json">{"tracking_id":"G-GS592DM662","only_pageview":false,"measure_protocol_api_secret":null}</script>
  <script src="/js/third-party/analytics/google-analytics.js"></script>

  <script src="/js/third-party/analytics/baidu-analytics.js"></script>
  <script async src="https://hm.baidu.com/hm.js?152282c2c823c1e5ab34c577ba338801"></script>







  <noscript>
    <link rel="stylesheet" href="/css/noscript.css">
  </noscript>
<link rel="alternate" href="/atom.xml" title="CComma's Blog" type="application/atom+xml">
</head>

<body itemscope itemtype="http://schema.org/WebPage" class="use-motion">
  <div class="headband"></div>

  <main class="main">
    <div class="column">
      <header class="header" itemscope itemtype="http://schema.org/WPHeader"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="Toggle navigation bar" role="button">
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
    </div>
  </div>

  <div class="site-meta">
      <img class="custom-logo-image" src="/images/ccomma.png" alt="CComma's Blog">

    <a href="/" class="brand" rel="start">
      <i class="logo-line"></i>
      <h1 class="site-title">CComma's Blog</h1>
      <i class="logo-line"></i>
    </a>
      <p class="site-subtitle" itemprop="description">Connect the world</p>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger" aria-label="Search" role="button">
        <i class="fa fa-search fa-fw fa-lg"></i>
    </div>
  </div>
</div>



<nav class="site-nav">
  <ul class="main-menu menu"><li class="menu-item menu-item-home"><a href="/" rel="section"><i class="fa fa-home fa-fw"></i>Home</a></li><li class="menu-item menu-item-categories"><a href="/categories/" rel="section"><i class="fa fa-th fa-fw"></i>Categories<span class="badge">20</span></a></li><li class="menu-item menu-item-tags"><a href="/tags/" rel="section"><i class="fa fa-tags fa-fw"></i>Tags<span class="badge">9</span></a></li><li class="menu-item menu-item-archives"><a href="/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>Archives<span class="badge">118</span></a></li><li class="menu-item menu-item-about"><a href="/about/" rel="section"><i class="fa fa-user fa-fw"></i>About</a></li>
      <li class="menu-item menu-item-search">
        <a role="button" class="popup-trigger"><i class="fa fa-search fa-fw"></i>Search
        </a>
      </li>
  </ul>
</nav>



  <div class="search-pop-overlay">
    <div class="popup search-popup"><div class="search-header">
  <span class="search-icon">
    <i class="fa fa-search"></i>
  </span>
  <div class="search-input-container">
    <input autocomplete="off" autocapitalize="off" maxlength="80"
           placeholder="Searching..." spellcheck="false"
           type="search" class="search-input">
  </div>
  <span class="popup-btn-close" role="button">
    <i class="fa fa-times-circle"></i>
  </span>
</div>
<div class="search-result-container no-result">
  <div class="search-result-icon">
    <i class="fa fa-spinner fa-pulse fa-5x"></i>
  </div>
</div>

    </div>
  </div>

</header>
        
  
  <aside class="sidebar">

    <div class="sidebar-inner sidebar-overview-active">
      <ul class="sidebar-nav">
        <li class="sidebar-nav-toc">
          Table of Contents
        </li>
        <li class="sidebar-nav-overview">
          Overview
        </li>
      </ul>

      <div class="sidebar-panel-container">
        <!--noindex-->
        <div class="post-toc-wrap sidebar-panel">
        </div>
        <!--/noindex-->

        <div class="site-overview-wrap sidebar-panel">
          <div class="site-author animated" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <img class="site-author-image" itemprop="image" alt="CComma"
      src="/images/ccomma.png">
  <p class="site-author-name" itemprop="name">CComma</p>
  <div class="site-description" itemprop="description">下一个目标：改变世界！</div>
</div>
<div class="site-state-wrap animated">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
        <a href="/archives/">
          <span class="site-state-item-count">118</span>
          <span class="site-state-item-name">posts</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
          <a href="/categories/">
        <span class="site-state-item-count">20</span>
        <span class="site-state-item-name">categories</span></a>
      </div>
      <div class="site-state-item site-state-tags">
          <a href="/tags/">
        <span class="site-state-item-count">9</span>
        <span class="site-state-item-name">tags</span></a>
      </div>
  </nav>
</div>
  <div class="links-of-author animated">
      <span class="links-of-author-item">
        <a href="https://github.com/ccomma" title="GitHub → https:&#x2F;&#x2F;github.com&#x2F;ccomma" rel="noopener me" target="_blank"><i class="fab fa-github fa-fw"></i>GitHub</a>
      </span>
      <span class="links-of-author-item">
        <a href="https://twitter.com/ccomma_cat" title="Twitter → https:&#x2F;&#x2F;twitter.com&#x2F;ccomma_cat" rel="noopener me" target="_blank"><i class="fab fa-twitter fa-fw"></i>Twitter</a>
      </span>
      <span class="links-of-author-item">
        <a href="/atom.xml" title="RSS → &#x2F;atom.xml" rel="noopener me"><i class="fa fa-rss fa-fw"></i>RSS</a>
      </span>
  </div>
  <div class="cc-license animated" itemprop="license">
    <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/deed.zh" class="cc-opacity" rel="noopener" target="_blank"><img src="https://cdnjs.cloudflare.com/ajax/libs/creativecommons-vocabulary/2020.11.3/assets/license_badges/small/by_nc_sa.svg" alt="Creative Commons"></a>
  </div>

        </div>
      </div>
    </div>

    
        <div class="pjax">
        </div>
  </aside>


    </div>

    <div class="main-inner index posts-expand">

    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="https://ccomma.cn/2cf460af3028/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/ccomma.png">
      <meta itemprop="name" content="CComma">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="CComma's Blog">
      <meta itemprop="description" content="下一个目标：改变世界！">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | CComma's Blog">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2cf460af3028/" class="post-title-link" itemprop="url">git 常用配置记录</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>

      <time title="Created: 2020-04-17 16:53:55" itemprop="dateCreated datePublished" datetime="2020-04-17T16:53:55+08:00">2020-04-17</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">In</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/git/" itemprop="url" rel="index"><span itemprop="name">git</span></a>
        </span>
    </span>

  
  
  <span class="post-meta-item">
    
      <span class="post-meta-item-icon">
        <i class="far fa-comment"></i>
      </span>
      <span class="post-meta-item-text">Disqus: </span>
    
    <a title="disqus" href="/2cf460af3028/#disqus_thread" itemprop="discussionUrl">
      <span class="post-comments-count disqus-comment-count" data-disqus-identifier="2cf460af3028/" itemprop="commentCount"></span>
    </a>
  </span>
  
  
    <span class="post-meta-item" title="Reading time">
      <span class="post-meta-item-icon">
        <i class="far fa-clock"></i>
      </span>
      <span class="post-meta-item-text">Reading time &asymp;</span>
      <span>1 mins.</span>
    </span>
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h2 id="1-配置用户名"><a href="#1-配置用户名" class="headerlink" title="1. 配置用户名"></a>1. 配置用户名</h2><p><code>git config --global user.name "username"</code></p>
<h2 id="2-配置邮箱"><a href="#2-配置邮箱" class="headerlink" title="2. 配置邮箱"></a>2. 配置邮箱</h2><p><code>git config --global user.email "xxxx@xxxx.xx"</code></p>
<h2 id="3-其他配置"><a href="#3-其他配置" class="headerlink" title="3. 其他配置"></a>3. 其他配置</h2><figure class="highlight shell"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">#</span><span class="language-bash">让 Git 不要管 Windows/Unix 换行符转换的事</span></span><br><span class="line">git config --global core.autocrlf false</span><br></pre></td></tr></tbody></table></figure>
<h2 id="4-编码配置"><a href="#4-编码配置" class="headerlink" title="4. 编码配置"></a>4. 编码配置</h2><figure class="highlight shell"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">#</span><span class="language-bash">避免 git gui 中的中文乱码</span></span><br><span class="line">git config --global gui.encoding utf-8</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">避免 git status 显示的中文文件名乱码</span></span><br><span class="line">git config --global core.quotepath off</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">让 git 对大小写敏感</span></span><br><span class="line">git config --global core.ignorecase false</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">配置别名</span></span><br><span class="line">git config --global alias.lg "log --color --graph --pretty=format:'%Cred%h%Creset -%C(yellow)%d%Creset %s %Cgreen(%cr) %C(bold blue)&lt;%an&gt;%Creset' --abbrev-commit"</span><br></pre></td></tr></tbody></table></figure>
<p><strong>5. ssh key pair 配置</strong><br>SSH 是建立在应用层和传输层基础上的安全协议，其目的是专为远程登录会话和其他网络服务提供安全性的保障<br>SSH 密钥对可以让我们方便的登录到 SSH 服务器，而无需输入密码</p>
<ol>
<li>Windows 上 Git Bash 命令行窗口中输入：ssh-keygen -t rsa -C “<a href="mailto:xxx@xxx.com">xxx@xxx.com</a>“</li>
<li>接着一直回车生成 ssh key pair</li>
<li><code>ssh-add ~/.ssh/id_rsa</code>    #把专用密钥添加到 ssh-agent 的高速缓存中，ssh-agent 能避免这种反复输入私钥的烦恼</li>
<li><code>cat ~/.ssh/id_rsa.pub</code></li>
</ol>
<p><img data-src="https://ccomma-pic-storage.oss-cn-hangzhou.aliyuncs.com/img/e1edcae107e0bcbb1f409d558e1434a1.png" alt="image.png"></p>
<h2 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h2><ul>
<li><a target="_blank" rel="noopener" href="https://blog.csdn.net/upshi/article/details/78327125">(10 条消息) Git 多 SSH 账号管理_一黑到底 - CSDN 博客_git 多 ssh</a></li>
<li><a target="_blank" rel="noopener" href="https://www.cnblogs.com/popfisher/p/5731232.html">Windows 下 Git 多账号配置，同一电脑多个 ssh-key 的管理 - popfisher - 博客园 (cnblogs.com)</a></li>
</ul>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="https://ccomma.cn/b5a35826dc8c/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/ccomma.png">
      <meta itemprop="name" content="CComma">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="CComma's Blog">
      <meta itemprop="description" content="下一个目标：改变世界！">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | CComma's Blog">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/b5a35826dc8c/" class="post-title-link" itemprop="url">git 常用命令</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>

      <time title="Created: 2020-04-17 14:56:10" itemprop="dateCreated datePublished" datetime="2020-04-17T14:56:10+08:00">2020-04-17</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">In</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/git/" itemprop="url" rel="index"><span itemprop="name">git</span></a>
        </span>
    </span>

  
  
  <span class="post-meta-item">
    
      <span class="post-meta-item-icon">
        <i class="far fa-comment"></i>
      </span>
      <span class="post-meta-item-text">Disqus: </span>
    
    <a title="disqus" href="/b5a35826dc8c/#disqus_thread" itemprop="discussionUrl">
      <span class="post-comments-count disqus-comment-count" data-disqus-identifier="b5a35826dc8c/" itemprop="commentCount"></span>
    </a>
  </span>
  
  
    <span class="post-meta-item" title="Reading time">
      <span class="post-meta-item-icon">
        <i class="far fa-clock"></i>
      </span>
      <span class="post-meta-item-text">Reading time &asymp;</span>
      <span>2 mins.</span>
    </span>
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h2 id="1-提交和拉取"><a href="#1-提交和拉取" class="headerlink" title="1. 提交和拉取"></a>1. 提交和拉取</h2><figure class="highlight shell"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">暂存所有文件</span></span><br><span class="line">git add .</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">暂存并提交</span></span><br><span class="line">git commit -am</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">push 到远程 git</span></span><br><span class="line">git push</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">从远程 git 下拉到本地 git</span></span><br><span class="line">git pull</span><br></pre></td></tr></tbody></table></figure>
<p><a target="_blank" rel="noopener" href="https://segmentfault.com/a/1190000002783245">Git push 与 pull 的默认行为</a></p>
<h2 id="2-查看"><a href="#2-查看" class="headerlink" title="2. 查看"></a>2. 查看</h2><figure class="highlight shell"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">git status</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">查看不同</span></span><br><span class="line">git diff</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">查看日志</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">git <span class="built_in">log</span> --pretty=oneline --abbrev-commit</span></span><br><span class="line">git log</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">查看你的每一次命令</span></span><br><span class="line">git reflog</span><br></pre></td></tr></tbody></table></figure>
<h2 id="3-回退"><a href="#3-回退" class="headerlink" title="3. 回退"></a>3. 回退</h2><figure class="highlight shell"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">回退上一次提交，保留暂存区</span></span><br><span class="line">git reset --soft HEAD^</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">回退到指定版本</span></span><br><span class="line">git reset HEAD &lt;file&gt;</span><br></pre></td></tr></tbody></table></figure>
<h2 id="4-检出"><a href="#4-检出" class="headerlink" title="4. 检出"></a>4. 检出</h2><figure class="highlight shell"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">拉取暂存区文件到工作区</span></span><br><span class="line">git checkout -- &lt;file&gt;</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">切换分支</span></span><br><span class="line">git checkout branchName</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">新建并检出分支</span></span><br><span class="line">git checkout -b dev  =&gt;  git branch dev   &amp;   git checkout dev</span><br></pre></td></tr></tbody></table></figure>
<h2 id="5-远程"><a href="#5-远程" class="headerlink" title="5. 远程"></a>5. 远程</h2><figure class="highlight shell"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">查看远程库的信息</span></span><br><span class="line">git remote</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">显示了可以抓取和推送的 origin 的地址</span></span><br><span class="line">git remote -v</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">添加远程地址</span></span><br><span class="line">git remote add origin git@github.com:xxxxx</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">从远程 git 上 <span class="built_in">clone</span> 项目</span></span><br><span class="line">git clone git@github.com:xxxxx</span><br></pre></td></tr></tbody></table></figure>
<h2 id="6-分支"><a href="#6-分支" class="headerlink" title="6. 分支"></a>6. 分支</h2><figure class="highlight shell"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">查看分支</span></span><br><span class="line">git branch</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">创建 dev 分支</span></span><br><span class="line">git branch dev</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">删除 dev 分支</span></span><br><span class="line">git branch -d dev</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">强行删除 dev 分支</span></span><br><span class="line">git branch -D dev</span><br></pre></td></tr></tbody></table></figure>
<h2 id="7-合并"><a href="#7-合并" class="headerlink" title="7. 合并"></a>7. 合并</h2><figure class="highlight shell"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">合并 dev 分支到当前分支</span></span><br><span class="line">git merge dev</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">强制禁用 Fast forward</span></span><br><span class="line">git merge --no-ff -m "merge branch 'dev' into master" dev</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">变基</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">比较 git merge 合并整合得到的结果没有任何区别，但是通过 git rebase 衍合能产生一个更为整洁的提交历史。</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">把解决分支补丁同最新主干代码之间的冲突的责任，划转给由提交补丁的人来解决</span></span><br><span class="line">git rebase</span><br></pre></td></tr></tbody></table></figure>
<p><a target="_blank" rel="noopener" href="https://www.jianshu.com/p/4a8f4af4e803">rebase 用法小结</a><br><a target="_blank" rel="noopener" href="https://blog.csdn.net/wh_19910525/article/details/7554489">merge&nbsp;和&nbsp;rebase&nbsp;间的区别</a></p>
<h2 id="8-暂存"><a href="#8-暂存" class="headerlink" title="8. 暂存"></a>8. 暂存</h2><figure class="highlight shell"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">git stash</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">添加注释</span></span><br><span class="line">git stash save "message"</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">存储列表</span></span><br><span class="line">git stash list</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">使用某个存储，不删除</span></span><br><span class="line">git stash apply</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">删除某个存储</span></span><br><span class="line">git stash drop</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">使用并删除某个存储</span></span><br><span class="line">git stash pop</span><br></pre></td></tr></tbody></table></figure>
<h2 id="9-标签"><a href="#9-标签" class="headerlink" title="9. 标签"></a>9. 标签</h2><figure class="highlight shell"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">建一个新的标签</span></span><br><span class="line">git tag v1.0</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">对 <span class="built_in">id</span> 为 f52c633 的 commit 打标签</span></span><br><span class="line">git tag v0.9 f52c633</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">删除标签</span></span><br><span class="line">git tag -d v0.1</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">推送标签</span></span><br><span class="line">git push origin v1.0</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">推送全部标签</span></span><br><span class="line">git push origin --tags</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">删除远程标签</span></span><br><span class="line">git push origin :refs/tags/v0.9</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">查看所有标签</span></span><br><span class="line">git tag</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">带有说明的标签</span></span><br><span class="line">git tag -a v0.1 -m "version 0.1 released" 1094adb</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">查看标签信息</span></span><br><span class="line">git show v0.9</span><br></pre></td></tr></tbody></table></figure>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="https://ccomma.cn/42e07de1eb46/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/ccomma.png">
      <meta itemprop="name" content="CComma">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="CComma's Blog">
      <meta itemprop="description" content="下一个目标：改变世界！">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | CComma's Blog">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/42e07de1eb46/" class="post-title-link" itemprop="url">一文搞懂 Mybatis</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>

      <time title="Created: 2019-09-19 20:22:20" itemprop="dateCreated datePublished" datetime="2019-09-19T20:22:20+08:00">2019-09-19</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">In</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/MyBatis/" itemprop="url" rel="index"><span itemprop="name">MyBatis</span></a>
        </span>
    </span>

  
  
  <span class="post-meta-item">
    
      <span class="post-meta-item-icon">
        <i class="far fa-comment"></i>
      </span>
      <span class="post-meta-item-text">Disqus: </span>
    
    <a title="disqus" href="/42e07de1eb46/#disqus_thread" itemprop="discussionUrl">
      <span class="post-comments-count disqus-comment-count" data-disqus-identifier="42e07de1eb46/" itemprop="commentCount"></span>
    </a>
  </span>
  
  
    <span class="post-meta-item" title="Reading time">
      <span class="post-meta-item-icon">
        <i class="far fa-clock"></i>
      </span>
      <span class="post-meta-item-text">Reading time &asymp;</span>
      <span>8 mins.</span>
    </span>
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h1 id="一、配置-MyBatis（XML-形式）"><a href="#一、配置-MyBatis（XML-形式）" class="headerlink" title="一、配置 MyBatis（XML 形式）"></a>一、配置 MyBatis（XML 形式）</h1><p>src/main/resources/mybatis-config.xml：</p>
<figure class="highlight xml"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version=<span class="string">"1.0"</span> encoding=<span class="string">"UTF-8"</span> ?&gt;</span></span><br><span class="line"><span class="meta">&lt;!DOCTYPE <span class="keyword">configuration</span></span></span><br><span class="line"><span class="meta">    <span class="keyword">PUBLIC</span> <span class="string">"-//mybatis.org//DTD Config 3.0//EN"</span></span></span><br><span class="line"><span class="meta">    <span class="string">"http://mybatis.org/dtd/mybatis-3-config.dtd"</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">configuration</span>&gt;</span></span><br><span class="line">    <span class="comment">&lt;!--加载外部的properties文件，使用 ${jdbc.driver} 等形式注入--&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">properties</span> <span class="attr">resource</span>=<span class="string">"jdbc.properties"</span>&gt;</span><span class="tag">&lt;/<span class="name">properties</span>&gt;</span></span><br><span class="line">    </span><br><span class="line">    <span class="tag">&lt;<span class="name">settings</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">setting</span> <span class="attr">name</span>=<span class="string">"logImpl"</span> <span class="attr">value</span>=<span class="string">"LOG4J"</span> /&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">settings</span>&gt;</span></span><br><span class="line">    </span><br><span class="line">    <span class="tag">&lt;<span class="name">typeAliases</span>&gt;</span></span><br><span class="line">        <span class="comment">&lt;!--给单独的实体起别名--&gt;</span></span><br><span class="line">        <span class="comment">&lt;!--  &lt;typeAlias type="com.lagou.pojo.User" alias="user"&gt;&lt;/typeAlias&gt;--&gt;</span></span><br><span class="line">        <span class="comment">&lt;!--批量起别名：该包下所有的类的本身的类名：别名还不区分大小写--&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">package</span> <span class="attr">name</span>=<span class="string">"tk.mybatis.simple.model"</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">typeAliases</span>&gt;</span></span><br><span class="line">    </span><br><span class="line">    <span class="tag">&lt;<span class="name">environments</span> <span class="attr">default</span>=<span class="string">"development"</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">environment</span> <span class="attr">id</span>=<span class="string">"development"</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">transactionManager</span> <span class="attr">type</span>=<span class="string">"JDBC"</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">""</span> <span class="attr">value</span>=<span class="string">""</span>/&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">transactionManager</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">dataSource</span> <span class="attr">type</span>=<span class="string">"UNPOOLED"</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"driver"</span> <span class="attr">value</span>=<span class="string">"${jdbc.driver}"</span>/&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"url"</span> <span class="attr">value</span>=<span class="string">"${jdbc.url}"</span>/&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"username"</span> <span class="attr">value</span>=<span class="string">"${jdbc.username}"</span>/&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"password"</span> <span class="attr">value</span>=<span class="string">"${jdbc.password}"</span>/&gt;</span></span><br><span class="line">                <span class="comment">&lt;!--&lt;property name="driver" value="com.mysql.jdbc.Driver"/&gt;--&gt;</span></span><br><span class="line">                <span class="comment">&lt;!--&lt;property name="url" value="jdbc:mysql://localhost:3306/mybatis"/&gt;--&gt;</span></span><br><span class="line">                <span class="comment">&lt;!--&lt;property name="username" value="root"/&gt;--&gt;</span></span><br><span class="line">                <span class="comment">&lt;!--&lt;property name="password" value=""/&gt;--&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">dataSource</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">environment</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">environments</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">mappers</span>&gt;</span></span><br><span class="line">        <span class="comment">&lt;!-- &lt;package name="tk.mybatis.simple.mapper"/&gt; --&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">mapper</span> <span class="attr">resource</span>=<span class="string">"tk/mybatis/simple/mapper/CountryMapper.xml"</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">mappers</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">configuration</span>&gt;</span></span><br></pre></td></tr></tbody></table></figure>

<h1 id="二、具体语句"><a href="#二、具体语句" class="headerlink" title="二、具体语句"></a>二、具体语句</h1><h2 id="1-Insert"><a href="#1-Insert" class="headerlink" title="1. Insert"></a>1. Insert</h2><p>insert 返回主键</p>
<h3 id="1-1-只适用于支持主键自增的数据库"><a href="#1-1-只适用于支持主键自增的数据库" class="headerlink" title="1.1. 只适用于支持主键自增的数据库"></a>1.1. 只适用于支持主键自增的数据库</h3><figure class="highlight xml"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">insert</span> <span class="attr">id</span>=<span class="string">"insert2"</span> <span class="attr">useGeneratedKeys</span>=<span class="string">"true"</span> <span class="attr">keyProperty</span>=<span class="string">"id"</span>&gt;</span></span><br><span class="line">    insert into sys_user(</span><br><span class="line">        user_name, user_password)</span><br><span class="line">    values(</span><br><span class="line">        #{userName}, #{userPassword})</span><br><span class="line"><span class="tag">&lt;/<span class="name">insert</span>&gt;</span></span><br></pre></td></tr></tbody></table></figure>

<h3 id="1-2-使用-selectKey-返回主键的值"><a href="#1-2-使用-selectKey-返回主键的值" class="headerlink" title="1.2. 使用 selectKey 返回主键的值"></a>1.2. 使用 selectKey 返回主键的值</h3><figure class="highlight xml"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">insert</span> <span class="attr">id</span>=<span class="string">"insert2"</span> <span class="attr">useGeneratedKeys</span>=<span class="string">"true"</span> <span class="attr">keyProperty</span>=<span class="string">"id"</span>&gt;</span></span><br><span class="line">    insert into sys_user(</span><br><span class="line">        user_name, user_password)</span><br><span class="line">    values(</span><br><span class="line">        #{userName}, #{userPassword})</span><br><span class="line">    <span class="tag">&lt;<span class="name">selectKey</span> <span class="attr">keyColumn</span>=<span class="string">"id"</span> <span class="attr">resultType</span>=<span class="string">"long"</span> <span class="attr">keyProperty</span>=<span class="string">"id"</span> <span class="attr">order</span>=<span class="string">"AFTER"</span>&gt;</span></span><br><span class="line">        SELECT LAST_INSERT_ID()</span><br><span class="line">    <span class="tag">&lt;/<span class="name">selectKey</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">insert</span>&gt;</span></span><br></pre></td></tr></tbody></table></figure>

<p>Oracle：</p>
<figure class="highlight xml"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">selectKey</span> <span class="attr">keyColumn</span>=<span class="string">"id"</span> <span class="attr">result</span>=<span class="string">"long"</span> <span class="attr">keyProperty</span>=<span class="string">"id"</span> <span class="attr">order</span>=<span class="string">"BEFORE"</span>&gt;</span></span><br><span class="line">    SELECT SEQ_ID.nextval from dual</span><br><span class="line"><span class="tag">&lt;/<span class="name">selectKey</span>&gt;</span></span><br></pre></td></tr></tbody></table></figure>

<h2 id="2-select"><a href="#2-select" class="headerlink" title="2. select"></a>2. select</h2><figure class="highlight xml"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">select</span> <span class="attr">id</span>=<span class="string">"selectAll"</span> <span class="attr">resultType</span>=<span class="string">"tk.mybatis.simple.model.SysUser"</span>&gt;</span></span><br><span class="line">    select id,</span><br><span class="line">        user_name userName,</span><br><span class="line">        user_password userPassword</span><br><span class="line">    from sys_user</span><br><span class="line"><span class="tag">&lt;/<span class="name">select</span>&gt;</span></span><br></pre></td></tr></tbody></table></figure>

<p>使用 resultType 需要设置别名来实现自动映射</p>
<h1 id="三、注解方式"><a href="#三、注解方式" class="headerlink" title="三、注解方式"></a>三、注解方式</h1><h2 id="1-Select-注解"><a href="#1-Select-注解" class="headerlink" title="1. @Select  注解"></a>1. @Select  注解</h2><h3 id="1-1-通过别名自动映射"><a href="#1-1-通过别名自动映射" class="headerlink" title="1.1. 通过别名自动映射"></a>1.1. 通过别名自动映射</h3><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Select({"select id, role_name roleName ",</span></span><br><span class="line"><span class="meta">         "from sys_role ",</span></span><br><span class="line"><span class="meta">         "where id = #{id}"})</span></span><br><span class="line">SysRole <span class="title function_">selectById</span><span class="params">(Long id)</span>;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Select({"select id, role_name roleName </span></span><br><span class="line"><span class="meta">          from sys_role </span></span><br><span class="line"><span class="meta">          where id = #{id}"})</span></span><br><span class="line">SysRole <span class="title function_">selectById</span><span class="params">(Long id)</span>;</span><br></pre></td></tr></tbody></table></figure>

<h3 id="1-2-使用-resultMap-方式"><a href="#1-2-使用-resultMap-方式" class="headerlink" title="1.2. 使用 resultMap 方式"></a>1.2. 使用 resultMap 方式</h3><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 定义 id，实现共用</span></span><br><span class="line"><span class="meta">@Results(id = "roleResultMap", value = {</span></span><br><span class="line"><span class="meta">    @Result(property = "id", column = "id", id = true),</span></span><br><span class="line"><span class="meta">    @Result(property = "roleName", column = "role_name")</span></span><br><span class="line"><span class="meta">})</span></span><br><span class="line"></span><br><span class="line"><span class="meta">@Results({</span></span><br><span class="line"><span class="meta">    @Result(property = "id", column = "id", id = true),</span></span><br><span class="line"><span class="meta">    @Result(property = "roleName", column = "role_name")</span></span><br><span class="line"><span class="meta">})</span></span><br><span class="line"><span class="meta">@Select("select id, role_name from sys_role where id = #{id}")</span></span><br><span class="line">SysRole <span class="title function_">selectById2</span><span class="params">(Long id)</span>;</span><br><span class="line"></span><br><span class="line"><span class="meta">@ResultMap("roleResultMap")</span></span><br><span class="line"><span class="meta">@Select("select * from sys_role")</span></span><br><span class="line">List&lt;SysRole&gt; <span class="title function_">selectAll</span><span class="params">()</span>;</span><br></pre></td></tr></tbody></table></figure>

<h2 id="2-insert-注解"><a href="#2-insert-注解" class="headerlink" title="2. @insert  注解"></a>2. <a href="/insert">@insert </a> 注解</h2><h3 id="2-1-返回自增主键"><a href="#2-1-返回自增主键" class="headerlink" title="2.1. 返回自增主键"></a>2.1. 返回自增主键</h3><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Insert({"insert into sys_role(role_name)",</span></span><br><span class="line"><span class="meta">         "values(#{roleName})"})</span></span><br><span class="line"><span class="meta">@Options(useGeneratedKeys = true, keyProperty = "id")</span></span><br><span class="line"><span class="type">int</span> <span class="title function_">insert2</span><span class="params">(SysRole sysRole)</span>;</span><br></pre></td></tr></tbody></table></figure>

<h3 id="2-2-返回非自增主键"><a href="#2-2-返回非自增主键" class="headerlink" title="2.2. 返回非自增主键"></a>2.2. 返回非自增主键</h3><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Insert({"insert into sys_role(role_name)",</span></span><br><span class="line"><span class="meta">         "values(#{roleName})"})</span></span><br><span class="line"><span class="meta">@SelectKey(statement = "SELECT LAST_INSERT_ID()",</span></span><br><span class="line"><span class="meta">           keyProperty = "id",</span></span><br><span class="line"><span class="meta">           resultType = Long.class,</span></span><br><span class="line"><span class="meta">           before = false)</span></span><br><span class="line"><span class="type">int</span> <span class="title function_">insert3</span><span class="params">(SysRole sysRole)</span>;</span><br></pre></td></tr></tbody></table></figure>

<h2 id="3-Provider-注解"><a href="#3-Provider-注解" class="headerlink" title="3. Provider 注解"></a>3. Provider 注解</h2><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@SelectProvider(type = PrivilegeProvider.class, metod = "selectById")</span></span><br><span class="line">SysPrivilege <span class="title function_">selectById</span><span class="params">(Long id)</span>;</span><br></pre></td></tr></tbody></table></figure>

<p><em>PrivilegeProvider：</em></p>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">PrivilegeProvider</span> {</span><br><span class="line">    <span class="comment">// 直接返回字符串 sql 也行</span></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">selectById</span><span class="params">(<span class="keyword">final</span> Long id)</span> {</span><br><span class="line">        result <span class="keyword">new</span> <span class="title class_">SQL</span>() {</span><br><span class="line">            {</span><br><span class="line">                SELECT(<span class="string">"id, privilege_name, privilege_url"</span>);</span><br><span class="line">                FROM(<span class="string">"sys_privilege"</span>);</span><br><span class="line">                WHERE(<span class="string">"id = #{id}"</span>);</span><br><span class="line">            }</span><br><span class="line">        }.toString();</span><br><span class="line">    }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<h1 id="四、动态SQL"><a href="#四、动态SQL" class="headerlink" title="四、动态SQL"></a>四、动态 SQL</h1><h2 id="1-if-用法"><a href="#1-if-用法" class="headerlink" title="1. if 用法"></a>1. if 用法</h2><figure class="highlight xml"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">if</span> <span class="attr">test</span>=<span class="string">"userName != null and userName != ''"</span>&gt;</span></span><br><span class="line">    and user_name like concat('%', #{userName}, '%')</span><br><span class="line"><span class="tag">&lt;/<span class="name">if</span>&gt;</span></span><br></pre></td></tr></tbody></table></figure>

<h2 id="2-choose-用法"><a href="#2-choose-用法" class="headerlink" title="2. choose 用法"></a>2. choose 用法</h2><figure class="highlight xml"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">choose</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">when</span> <span class="attr">test</span>=<span class="string">"userName != null"</span>&gt;</span></span><br><span class="line">    ...</span><br><span class="line">    <span class="tag">&lt;/<span class="name">when</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">otherwhise</span>&gt;</span><span class="tag">&lt;/<span class="name">otherwhise</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">choose</span>&gt;</span></span><br></pre></td></tr></tbody></table></figure>

<h2 id="3-where-set-trim-用法"><a href="#3-where-set-trim-用法" class="headerlink" title="3. where set trim 用法"></a>3. where set trim 用法</h2><h3 id="3-1-where-用法"><a href="#3-1-where-用法" class="headerlink" title="3.1. where 用法"></a>3.1. where 用法</h3><figure class="highlight xml"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">where</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">if</span> <span class="attr">test</span>=<span class="string">"userName != null and userName != ''"</span>&gt;</span></span><br><span class="line">        and user_name like concat('%', #{userName}, '%')</span><br><span class="line">    <span class="tag">&lt;/<span class="name">if</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">where</span>&gt;</span></span><br></pre></td></tr></tbody></table></figure>

<h3 id="3-2-set-用法"><a href="#3-2-set-用法" class="headerlink" title="3.2. set 用法"></a>3.2. set 用法</h3><figure class="highlight xml"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">update</span> <span class="attr">id</span>=<span class="string">"updateByIdSelective"</span>&gt;</span></span><br><span class="line">    update sys_user</span><br><span class="line">    <span class="tag">&lt;<span class="name">set</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">if</span> <span class="attr">test</span>=<span class="string">"userName != null and userName != ''"</span>&gt;</span></span><br><span class="line">            user_name = #{userName},</span><br><span class="line">        <span class="tag">&lt;/<span class="name">if</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">if</span> <span class="attr">test</span>=<span class="string">"userPassword != null and userPassword != ''"</span>&gt;</span></span><br><span class="line">            user_password = #{userPassword},</span><br><span class="line">        <span class="tag">&lt;/<span class="name">if</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">set</span>&gt;</span></span><br><span class="line">    where id = #{id}</span><br><span class="line"><span class="tag">&lt;/<span class="name">update</span>&gt;</span></span><br></pre></td></tr></tbody></table></figure>

<h3 id="3-3-trim-用法"><a href="#3-3-trim-用法" class="headerlink" title="3.3. trim 用法"></a>3.3. trim 用法</h3><p>where 标签对应 trim 的实现：</p>
<figure class="highlight xml"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">trim</span> <span class="attr">prefix</span>=<span class="string">"WHERE"</span> <span class="attr">prefixOverrides</span>=<span class="string">"AND |OR"</span>&gt;</span></span><br><span class="line">    ...</span><br><span class="line"><span class="tag">&lt;/<span class="name">trim</span>&gt;</span></span><br></pre></td></tr></tbody></table></figure>

<p>set 标签对应的 trim 实现：</p>
<figure class="highlight xml"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">trim</span> <span class="attr">prefix</span>=<span class="string">"SET"</span> <span class="attr">suffixOverrides</span>=<span class="string">","</span>&gt;</span></span><br><span class="line">    ...</span><br><span class="line"><span class="tag">&lt;/<span class="name">trim</span>&gt;</span></span><br></pre></td></tr></tbody></table></figure>

<ul>
<li>prefix： 给内容增加 prefix 指定的前缀</li>
<li> prefixOverrides： 把内容中匹配的前缀字符串去掉</li>
<li> suffix： 给内容增加 suffix 指定的后缀</li>
<li> suffixOverrides： 把内容中匹配的后缀字符串去掉</li>
</ul>
<h2 id="4-foreach-用法"><a href="#4-foreach-用法" class="headerlink" title="4. foreach 用法"></a>4. foreach 用法</h2><figure class="highlight xml"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">where id in</span><br><span class="line"><span class="tag">&lt;<span class="name">foreach</span> <span class="attr">collection</span>=<span class="string">"list"</span> <span class="attr">open</span>=<span class="string">"("</span> <span class="attr">separator</span>=<span class="string">","</span> <span class="attr">close</span>=<span class="string">")"</span> <span class="attr">item</span>=<span class="string">"id"</span> <span class="attr">index</span>=<span class="string">"i"</span>&gt;</span></span><br><span class="line">    #{id}</span><br><span class="line"><span class="tag">&lt;/<span class="name">foreach</span>&gt;</span></span><br></pre></td></tr></tbody></table></figure>

<h2 id="5-bind-用法"><a href="#5-bind-用法" class="headerlink" title="5. bind 用法"></a>5. bind 用法</h2><figure class="highlight xml"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">if</span> <span class="attr">test</span>=<span class="string">"userName != null and userName != ''"</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">bind</span> <span class="attr">name</span>=<span class="string">"userNameLike"</span> <span class="attr">value</span>=<span class="string">"'%' + userName + '%'"</span>/&gt;</span></span><br><span class="line">    and user_name like #{userNameLike}</span><br><span class="line"><span class="tag">&lt;/<span class="name">if</span>&gt;</span></span><br></pre></td></tr></tbody></table></figure>

<h1 id="五、高级结果映射"><a href="#五、高级结果映射" class="headerlink" title="五、高级结果映射"></a>五、高级结果映射</h1><h2 id="1-一对一映射"><a href="#1-一对一映射" class="headerlink" title="1. 一对一映射"></a>1. 一对一映射</h2><h3 id="1-1-使用自动映射"><a href="#1-1-使用自动映射" class="headerlink" title="1.1. 使用自动映射"></a>1.1. 使用自动映射</h3><figure class="highlight xml"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">select</span> <span class="attr">id</span>=<span class="string">"selectUserAndRoleById"</span> <span class="attr">resultType</span>=<span class="string">"tk.mybatis.simple.model.SysUser"</span>&gt;</span></span><br><span class="line">    select u.id, u.user_name as userName, u.user_password as userPassword, </span><br><span class="line">           r.id as "role.id", r.role_name as "role.roleName"</span><br><span class="line">    from sys_user u</span><br><span class="line">    inner join sys_user_role ur on u.id = ur.user_id</span><br><span class="line">    inner join sys_role r on ur.role_id = r.id</span><br><span class="line">    where u.id = #{id}</span><br><span class="line"><span class="tag">&lt;/<span class="name">select</span>&gt;</span></span><br></pre></td></tr></tbody></table></figure>

<h3 id="1-2-使用-resultMap-配置一对一映射"><a href="#1-2-使用-resultMap-配置一对一映射" class="headerlink" title="1.2. 使用 resultMap 配置一对一映射"></a>1.2. 使用 resultMap 配置一对一映射</h3><figure class="highlight xml"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">resultMap</span> <span class="attr">id</span>=<span class="string">"userRoleMap"</span> <span class="attr">type</span>=<span class="string">"tk.mybatis.simple.model.SysUser"</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">result</span> <span class="attr">property</span>=<span class="string">"id"</span> <span class="attr">column</span>=<span class="string">"id"</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">result</span> <span class="attr">property</span>=<span class="string">"userName"</span> <span class="attr">column</span>=<span class="string">"user_name"</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">result</span> <span class="attr">property</span>=<span class="string">"userPassword"</span> <span class="attr">column</span>=<span class="string">"user_password"</span>/&gt;</span></span><br><span class="line">    </span><br><span class="line">    <span class="tag">&lt;<span class="name">result</span> <span class="attr">property</span>=<span class="string">"role.id"</span> <span class="attr">column</span>=<span class="string">"role_id"</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">result</span> <span class="attr">property</span>=<span class="string">"role.roleName"</span> <span class="attr">column</span>=<span class="string">"role_name"</span>/&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">resultMap</span>&gt;</span></span><br></pre></td></tr></tbody></table></figure>

<h3 id="1-3-使用-resultMap-的-association-标签配置一对一映射"><a href="#1-3-使用-resultMap-的-association-标签配置一对一映射" class="headerlink" title="1.3. 使用 resultMap 的 association 标签配置一对一映射"></a>1.3. 使用 resultMap 的 association 标签配置一对一映射</h3><figure class="highlight xml"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">resultMap</span> <span class="attr">id</span>=<span class="string">"userRoleMap"</span> <span class="attr">type</span>=<span class="string">"tk.mybatis.simple.model.SysUser"</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">association</span> <span class="attr">property</span>=<span class="string">"role"</span> <span class="attr">columnPrefix</span>=<span class="string">"role_"</span> <span class="attr">javaType</span>=<span class="string">"tk.mybatis.simple.model.SysRole"</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">result</span> <span class="attr">property</span>=<span class="string">"id"</span> <span class="attr">column</span>=<span class="string">"id"</span>/&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">result</span> <span class="attr">property</span>=<span class="string">"roleName"</span> <span class="attr">column</span>=<span class="string">"role_name"</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">association</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">resultMap</span>&gt;</span></span><br></pre></td></tr></tbody></table></figure>

<h2 id="2-一对多映射"><a href="#2-一对多映射" class="headerlink" title="2. 一对多映射"></a>2. 一对多映射</h2><figure class="highlight xml"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">resultMap</span> <span class="attr">id</span>=<span class="string">"userRoleListMap"</span> <span class="attr">extends</span>=<span class="string">"userMap"</span> <span class="attr">type</span>=<span class="string">"tk.mybatis.simple.model.SysUser"</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">id</span> <span class="attr">property</span>=<span class="string">"id"</span> <span class="attr">column</span>=<span class="string">"id"</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">result</span> <span class="attr">property</span>=<span class="string">"userName"</span> <span class="attr">column</span>=<span class="string">"user_name"</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">result</span> <span class="attr">property</span>=<span class="string">"userPassword"</span> <span class="attr">column</span>=<span class="string">"user_password"</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">collection</span> <span class="attr">property</span>=<span class="string">"roleList"</span> <span class="attr">columnPrefix</span>=<span class="string">"role_"</span> <span class="attr">javaType</span>=<span class="string">"tk.mybatis.simple.model.SysRole"</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">id</span> <span class="attr">property</span>=<span class="string">"id"</span> <span class="attr">column</span>=<span class="string">"id"</span>/&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">result</span> <span class="attr">property</span>=<span class="string">"roleName"</span> <span class="attr">column</span>=<span class="string">"role_name"</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">collection</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">resultMap</span>&gt;</span></span><br></pre></td></tr></tbody></table></figure>

<h2 id="3-返回-Map"><a href="#3-返回-Map" class="headerlink" title="3.返回 Map"></a>3. 返回 Map</h2><h3 id="3-1-map-的-value-为-java-类"><a href="#3-1-map-的-value-为-java-类" class="headerlink" title="3.1. map 的 value 为 java 类"></a>3.1. map 的 value 为 java 类</h3><p>mapper.java</p>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@MapKey("id")</span></span><br><span class="line">Map&lt;Long, UserInfo&gt; <span class="title function_">getUserInfoMap</span><span class="params">()</span>;</span><br></pre></td></tr></tbody></table></figure>

<p>mapper.xml</p>
<figure class="highlight xml"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">resultMap</span> <span class="attr">id</span>=<span class="string">"UserResultMap"</span> <span class="attr">type</span>=<span class="string">"com.xixicat.domain.UserInfo"</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">result</span> <span class="attr">property</span>=<span class="string">"id"</span> <span class="attr">column</span>=<span class="string">"id"</span> /&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">result</span> <span class="attr">property</span>=<span class="string">"username"</span> <span class="attr">column</span>=<span class="string">"username"</span> /&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">result</span> <span class="attr">property</span>=<span class="string">"sex"</span> <span class="attr">column</span>=<span class="string">"sex"</span> /&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">resultMap</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">select</span> <span class="attr">id</span>=<span class="string">"getUserInfoMap"</span> <span class="attr">resultMap</span>=<span class="string">"UserResultMap"</span>&gt;</span></span><br><span class="line">   select id,username,sex from user_info</span><br><span class="line"><span class="tag">&lt;/<span class="name">select</span>&gt;</span></span><br></pre></td></tr></tbody></table></figure>

<h3 id="3-2-map-的-value-为-map"><a href="#3-2-map-的-value-为-map" class="headerlink" title="3.2. map 的 value 为 map"></a>3.2. map 的 value 为 map</h3><p>mapper.java</p>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@MapKey("id")</span></span><br><span class="line">Map&lt;Long, Map&lt;String,Object&gt;&gt; <span class="title function_">getUserValueMap</span><span class="params">()</span>;</span><br></pre></td></tr></tbody></table></figure>

<p>mapper.xml</p>
<figure class="highlight xml"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">select</span> <span class="attr">id</span>=<span class="string">"getUserValueMap"</span> <span class="attr">resultType</span>=<span class="string">"map"</span> &gt;</span></span><br><span class="line">        select id,username,sex from user_info</span><br><span class="line">        from user_info</span><br><span class="line"><span class="tag">&lt;/<span class="name">select</span>&gt;</span></span><br></pre></td></tr></tbody></table></figure>

<h3 id="3-3-返回-List"><a href="#3-3-返回-List" class="headerlink" title="3.3. 返回 List<Map<key, value>>"></a>3.3. 返回 List&lt;Map&lt;key, value&gt;&gt;</h3><p>mapper.java</p>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">List&lt;Map&lt;String, Object&gt;&gt; <span class="title function_">countInquireForMobile</span><span class="params">()</span>;</span><br></pre></td></tr></tbody></table></figure>

<p>mapper.xml</p>
<figure class="highlight xml"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">select</span> <span class="attr">id</span>=<span class="string">"countInquireForMobile"</span> <span class="attr">resultType</span>=<span class="string">"map"</span>&gt;</span></span><br><span class="line">    select o.status as `status`, count(mc.id) as `count`</span><br><span class="line">    from mall_contract mc</span><br><span class="line">    join mall_order o on o.contract_no = mc.contract_no</span><br><span class="line">    where o.archive = false and o.flag = 0</span><br><span class="line">    and o.status in ('SUBMITTED', 'PAID', 'SHIPPED', 'SUCCESS') and o.refund_status = 'CREATE'</span><br><span class="line">    <span class="tag">&lt;<span class="name">if</span> <span class="attr">test</span>=<span class="string">"params.opUserType == 'BUYER'"</span>&gt;</span></span><br><span class="line">        and o.buyer_id = #{params.operatorId,typeHandler=idHandler}</span><br><span class="line">    <span class="tag">&lt;/<span class="name">if</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">if</span> <span class="attr">test</span>=<span class="string">"params.opUserType == 'SELLER'"</span>&gt;</span></span><br><span class="line">        and o.seller_id = #{params.operatorId,typeHandler=idHandler}</span><br><span class="line">    <span class="tag">&lt;/<span class="name">if</span>&gt;</span></span><br><span class="line">    group by o.status</span><br><span class="line"><span class="tag">&lt;/<span class="name">select</span>&gt;</span></span><br></pre></td></tr></tbody></table></figure>

<h2 id="4-鉴别器映射"><a href="#4-鉴别器映射" class="headerlink" title="4. 鉴别器映射"></a>4. 鉴别器映射</h2><p>类似于 switch</p>
<figure class="highlight xml"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">resultMap</span> <span class="attr">id</span>=<span class="string">"rolePrivilegeListMapChoose"</span> <span class="attr">type</span>=<span class="string">"tk.mybatis.simple.model.SysRole"</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">discriminator</span> <span class="attr">column</span>=<span class="string">"enabled"</span> <span class="attr">javaType</span>=<span class="string">"int"</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">case</span> <span class="attr">value</span>=<span class="string">"1"</span> <span class="attr">resultMap</span>=<span class="string">"rolePrivilegeListMapSelect"</span>/&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">case</span> <span class="attr">value</span>=<span class="string">"0"</span> <span class="attr">resultMap</span>=<span class="string">"roleMap"</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">discriminator</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">resultMap</span>&gt;</span></span><br></pre></td></tr></tbody></table></figure>

<h2 id="5-枚举处理器"><a href="#5-枚举处理器" class="headerlink" title="5. 枚举处理器"></a>5. 枚举处理器</h2><p>在 mybatis-config.xml 中添加配置：使用枚举的索引进行处理</p>
<figure class="highlight xml"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">typeHandlers</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">typeHandler</span> <span class="attr">javaType</span>=<span class="string">"tk.mybatis.simple.type.Enabled"</span> </span></span><br><span class="line"><span class="tag">                 <span class="attr">handler</span>=<span class="string">"org.apache.ibatis.type.EnumOrdinalTypeHandler"</span>/&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">typeHandlers</span>&gt;</span></span><br></pre></td></tr></tbody></table></figure>

<h2 id="6-自定义处理器"><a href="#6-自定义处理器" class="headerlink" title="6. 自定义处理器"></a>6. 自定义处理器</h2><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">EnabledTypeHandler</span> <span class="keyword">implements</span> <span class="title class_">TypeHanlder</span>&lt;Enabled&gt; {</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> Map&lt;Integer, Enabled&gt; enabledMap = <span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;Integer, Enabled&gt;();</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">EnabledTypeHandler</span><span class="params">()</span> {</span><br><span class="line">        <span class="keyword">for</span> (Enabled enabled : Enabled.values()) {</span><br><span class="line">            enabledMap.put(enabled.getValue(), enabled);</span><br><span class="line">        }</span><br><span class="line">    }</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setParameter</span><span class="params">(PreparedStatement ps, <span class="type">int</span> i, </span></span><br><span class="line"><span class="params">        Enabled parameter, JdbcType jdbcType)</span> <span class="keyword">throws</span> SQLException {</span><br><span class="line"></span><br><span class="line">        ps.setInt(i, parameter.getValue());</span><br><span class="line">    }</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> Enabled <span class="title function_">getResult</span><span class="params">(ResultSet rs, <span class="type">int</span> columnIndex)</span> <span class="keyword">throws</span> SQLException {</span><br><span class="line">        <span class="type">Integer</span> <span class="variable">value</span> <span class="operator">=</span> rs.getInt(columnIndex);</span><br><span class="line">        <span class="keyword">return</span> enabledMap.get(value);</span><br><span class="line">    }</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> Enabled <span class="title function_">getResult</span><span class="params">(CallableStatement cs, <span class="type">int</span> columnIndex)</span> <span class="keyword">throws</span> SQLException {</span><br><span class="line">        <span class="type">Integer</span> <span class="variable">value</span> <span class="operator">=</span> cs.getInt(columnIndex);</span><br><span class="line">        <span class="keyword">return</span> enabledMap.get(value);</span><br><span class="line">    }</span><br><span class="line">    </span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<p>在 mybatis-config.xml 中配置：</p>
<figure class="highlight xml"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">typeHandlers</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">typeHandler</span> <span class="attr">javaType</span>=<span class="string">"tk.mybatis.simple.type.Enabled"</span></span></span><br><span class="line"><span class="tag">                 <span class="attr">handler</span>=<span class="string">"tk.mybatis.simple.type.EnabledTypeHandler"</span>/&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">typeHandlers</span>&gt;</span></span><br></pre></td></tr></tbody></table></figure>

<h1 id="六、缓存"><a href="#六、缓存" class="headerlink" title="六、缓存"></a>六、缓存</h1><h2 id="1-一级缓存"><a href="#1-一级缓存" class="headerlink" title="1. 一级缓存"></a>1. 一级缓存</h2><p><strong><em>范围：</em></strong> SqlSession</p>
<p><strong><em>概述：</em></strong><br>MyBatis 的一级缓存存在于 SqlSession 的生命周期中，默认开启<br>在同一个 SqlSession 中查询时，MyBatis 会把执行的方法和参数通过算法生成缓存的键值，将键值和查询结果存入一个 Map 对象中</p>
<p><strong><em>清空缓存：</em></strong> 更新或删除操作会清空缓存，或使用 SqlSession#clearCache () 方法进行手动刷新</p>
<p><strong><em>flushCache=”true”：</em></strong> 查询数据前清空当前的一级缓存</p>
<figure class="highlight xml"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">select</span> <span class="attr">id</span>=<span class="string">"selectById"</span> <span class="attr">flushCache</span>=<span class="string">"true"</span> <span class="attr">resultMap</span>=<span class="string">"userMap"</span>&gt;</span></span><br><span class="line">    select * from sys_user where id = #{id}</span><br><span class="line"><span class="tag">&lt;/<span class="name">select</span>&gt;</span></span><br></pre></td></tr></tbody></table></figure>

<h2 id="2-二级缓存"><a href="#2-二级缓存" class="headerlink" title="2. 二级缓存"></a>2. 二级缓存</h2><p><strong><em>范围：</em></strong> Mapper(namespace)</p>
<p><strong><em>概述：</em></strong><br>默认不开启<br>会重新创建一个对象进行 copy<br>无法实现分布式缓存</p>
<h3 id="2-1-在-mapper-xml-中配置"><a href="#2-1-在-mapper-xml-中配置" class="headerlink" title="2.1. 在 mapper.xml 中配置"></a>2.1. 在 mapper.xml 中配置</h3><p>二级缓存全局开关： 不必配置，默认已为 true<br>mybatis-config.xml：</p>
<figure class="highlight xml"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">settings</span>&gt;</span></span><br><span class="line">    <span class="comment">&lt;!-- 其他配置 --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">setting</span> <span class="attr">name</span>=<span class="string">"cacheEnabled"</span> <span class="attr">value</span>=<span class="string">"true"</span>/&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">settings</span>&gt;</span></span><br></pre></td></tr></tbody></table></figure>

<p>开启二级缓存：</p>
<figure class="highlight xml"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">mapper</span> <span class="attr">namespace</span>=<span class="string">"tk.mybatis.simple.mapper.RoleMapper"</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">cache</span>/&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">mapper</span>&gt;</span></span><br></pre></td></tr></tbody></table></figure>

<p>默认的二级缓存会有如下效果</p>
<ul>
<li>所有的 select 语句将会被缓存</li>
<li>所有的 insert、update、delete 语句将会刷新缓存</li>
<li>缓存会使用 LRU 算法来回收</li>
<li>根据时间表（刷新间隔），缓存不会以任何时间顺序刷新</li>
<li>缓存会存储集合或对象 1024 个引用</li>
<li>缓存会被视为 可读可写 的，所以返回的对象不是共享的，可以安全的修改</li>
</ul>
<p>cache 可配置的属性：</p>
<figure class="highlight xml"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">cache</span> <span class="attr">eviction</span>=<span class="string">"FIFO"</span> <span class="attr">flushInterval</span>=<span class="string">"60000"</span> <span class="attr">size</span>=<span class="string">"512"</span> <span class="attr">readOnly</span>=<span class="string">"true"</span>/&gt;</span></span><br></pre></td></tr></tbody></table></figure>

<ul>
<li>eviction：收回策略</li>
<li> LRU（最近最少使用）：移除最长时间不被使用的对象，默认</li>
<li> FIFO（先进先出）：按对象进入缓存的顺序来移除它们</li>
<li> SOFT（软引用）：移除基于垃圾回收器状态和弱引用规则的对象</li>
<li> WEAK（弱引用）：更积极地移除基于垃圾收集器状态和弱引用规则的对象</li>
<li> flushInterval：刷新间隔。毫秒，默认不设置（没有刷新间隔，缓存仅在调用 sql 时刷新）。</li>
<li>size：引用数目。默认 1024</li>
<li>readOnly：只读。只读的缓存会给所有调用者返回缓存对象的相同实例，不能修改。默认 false</li>
</ul>
<h3 id="2-2-在-Mapper-接口中配置二级缓存"><a href="#2-2-在-Mapper-接口中配置二级缓存" class="headerlink" title="2.2. 在 Mapper 接口中配置二级缓存"></a>2.2. 在 Mapper 接口中配置二级缓存</h3><p><strong><em>当只使用注解方式配置二级缓存时：</em></strong></p>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@CacheNamespace</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">RoleMapper</span> {</span><br><span class="line">    ...</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<p><strong><em>配置属性：</em></strong></p>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@CacheNamespace(</span></span><br><span class="line"><span class="meta">    eviction = FifoCache.class,</span></span><br><span class="line"><span class="meta">    flushInterval = 60000,</span></span><br><span class="line"><span class="meta">    size = 512,</span></span><br><span class="line"><span class="meta">    readWrite = true</span></span><br><span class="line"><span class="meta">)</span></span><br></pre></td></tr></tbody></table></figure>

<p><strong><em>当同时使用注解方式和 &nbsp;XML 映射文件时：</em></strong> 使用参照缓存<br>这样就会使用命名空间为 tk.mybatis.simple.mapperRoleMapper 的缓存配置，即 RoleMapper.xml 中配置的缓存</p>
<p>引用 Mapp 接口中配置的二级缓存</p>
<figure class="highlight xml"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">cache-ref</span> <span class="attr">namespace</span>=<span class="string">"tk.mybatis.simple.mapper.RoleMapper"</span>/&gt;</span></span><br></pre></td></tr></tbody></table></figure>

<h3 id="2-3-使用二级缓存"><a href="#2-3-使用二级缓存" class="headerlink" title="2.3. 使用二级缓存"></a>2.3. 使用二级缓存</h3><p>使用可读写缓存，通过序列化和反序列化来保证通过缓存获取数据时，得到的是一个 <strong>新的实例</strong>。</p>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">sqlSession = getSqlSession();</span><br><span class="line"><span class="keyword">try</span> {</span><br><span class="line">    <span class="comment">// 获取 RoleMapper 接口</span></span><br><span class="line">    <span class="type">RoleMapper</span> <span class="variable">roleMapper</span> <span class="operator">=</span> sqlSession.getMapper(RoleMapper.class);</span><br><span class="line">    <span class="comment">// 调用 selectById 方法，查询 id = 1 的用户</span></span><br><span class="line">    <span class="type">SysRole</span> <span class="variable">role2</span> <span class="operator">=</span> roleMapper.selectById(<span class="number">1L</span>);</span><br><span class="line">    <span class="comment">// 第二个 session 获取的用户名是 New Nam</span></span><br><span class="line">    Assert.assertEquals(<span class="string">"New Name"</span>, role2.getRoleName());</span><br><span class="line">    <span class="comment">// 这里的 role2 和前一个 session 查询的结果是两个不同的实例</span></span><br><span class="line">    Assert.assertNotEquals(role1, role2);</span><br><span class="line">    <span class="comment">// 获取 role3</span></span><br><span class="line">    <span class="type">SysRole</span> <span class="variable">role3</span> <span class="operator">=</span> roleMapper.selectById(<span class="number">1L</span>);</span><br><span class="line">    <span class="comment">// 这里的 role2 和 role3 是两个不同的实例</span></span><br><span class="line">    Assert.assertNotEquals(role2, role3);</span><br><span class="line">} <span class="keyword">finally</span> {</span><br><span class="line">    <span class="comment">// 关闭 sqlSession</span></span><br><span class="line">    sqlSession.close();</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<h3 id="2-4-二级缓存适用场景"><a href="#2-4-二级缓存适用场景" class="headerlink" title="2.4. 二级缓存适用场景"></a>2.4. 二级缓存适用场景</h3><ul>
<li>以查询为主的应用中，只有尽可能少的 curd</li>
<li> 绝大多数以单表操作存在时，由于很少存在互相关联的情况，因此不会出现脏数据</li>
<li>分布式场景不能使用，需要借助第三方缓存中间件</li>
</ul>
<h3 id="2-5-使用-redis-实现二级缓存"><a href="#2-5-使用-redis-实现二级缓存" class="headerlink" title="2.5. 使用 redis 实现二级缓存"></a>2.5. 使用 redis 实现二级缓存</h3><ol>
<li><p>加入依赖 </p>
<figure class="highlight xml"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.mybatis.caches<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>mybatis-redis<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.0.0-beta2<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></tbody></table></figure>

</li>
<li><p>使用缓存 </p>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@CacheNamespace(implementation = RedisCache.class)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">IUserMapper</span> {</span><br><span class="line">    ...</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure></li>
</ol>
<h1 id="七、插件"><a href="#七、插件" class="headerlink" title="七、插件"></a>七、插件</h1><h2 id="1-概述"><a href="#1-概述" class="headerlink" title="1. 概述"></a>1. 概述</h2><p>对 mybatis 的扩展，其原理是拦截器，在四大组件（<code>Executor</code>、<code>StatementHandler</code>、<code>ParamterHandler</code>、<code>ResultSetHandler</code>）使用时拦截处理</p>
<p><img data-src="https://ccomma-pic-storage.oss-cn-hangzhou.aliyuncs.com/img/e3bcdaa2f4207b968a1d3ad28bf5504a.png" alt="image.png"></p>
<p><strong><em>允许拦截的方法：</em></strong></p>
<ul>
<li>Executor（执行器）：update、query、commit、rollback</li>
<li>StatementHandler（SQL 语句构建器）：prepare、parameterize、batch、update、query</li>
<li>ParameterHandler（参数处理器）：getParameterObject、setParameters</li>
<li>ResultSetHandler（结果集处理器）：handleResultSets、handleOutputParameters</li>
</ul>
<p><strong><em>原理：</em></strong><br>在四大组件对象创建时遍历所有的拦截器，每个拦截器都使用 interceptor.plugin (target) 方法对目标类进行增强</p>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> ParameterHandler <span class="title function_">newParameterHandler</span><span class="params">(MappedStatement mappedStatement, Object object, BoundSql sql, InterceptorChain interceptorChain)</span> {</span><br><span class="line">    <span class="type">ParameterHandler</span> <span class="variable">parameterHandler</span> <span class="operator">=</span> mappedStatement.getLang().createParameterHandler(mappedStatement,object,sql); </span><br><span class="line">    parameterHandler = (ParameterHandler) interceptorChain.pluginAll(parameterHandler); </span><br><span class="line">    <span class="keyword">return</span> parameterHandler;</span><br><span class="line">}</span><br><span class="line"><span class="keyword">public</span> Object <span class="title function_">pluginAll</span><span class="params">(Object target)</span> { </span><br><span class="line">    <span class="keyword">for</span> (Interceptor interceptor : interceptors) { </span><br><span class="line">        target = interceptor.plugin(target);</span><br><span class="line">    } </span><br><span class="line">    <span class="keyword">return</span> target; </span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<h2 id="2-自定义插件"><a href="#2-自定义插件" class="headerlink" title="2. 自定义插件"></a>2. 自定义插件</h2><ol>
<li><p>实现 Interceptor 并添加注解</p>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Intercepts({</span></span><br><span class="line"><span class="meta">    @Signature(</span></span><br><span class="line"><span class="meta">        // 指定组件</span></span><br><span class="line"><span class="meta">        type = Executor.class,</span></span><br><span class="line"><span class="meta">        // 指定方法</span></span><br><span class="line"><span class="meta">        method = "query",</span></span><br><span class="line"><span class="meta">        // 指定参数确定方法</span></span><br><span class="line"><span class="meta">        args = {MapperStatement.class, Object.class, RowBounds.class, ResultHandler.class}</span></span><br><span class="line"><span class="meta">    )</span></span><br><span class="line"><span class="meta">})</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ExamplePlugin</span> <span class="keyword">implements</span> <span class="title class_">Interceptor</span> {</span><br><span class="line">    <span class="comment">// 每次操作都会进入该方法</span></span><br><span class="line">    <span class="meta">@Override</span> </span><br><span class="line">    <span class="keyword">public</span> Object <span class="title function_">intercept</span><span class="params">(Invocation invocation)</span> <span class="keyword">throws</span> Throwable {</span><br><span class="line">        System.out.println(<span class="string">"对方法进行了增强...."</span>); </span><br><span class="line">        <span class="keyword">return</span> invocation.proceed();</span><br><span class="line">    }</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 把这个拦截器生成一个代理放到拦截器链中</span></span><br><span class="line">    <span class="meta">@Override</span> </span><br><span class="line">    <span class="keyword">public</span> Object <span class="title function_">plugin</span><span class="params">(Object target)</span> { </span><br><span class="line">        System.out.println(<span class="string">"将要包装的目标对象"</span> + target);</span><br><span class="line">        <span class="keyword">return</span> Plugin.wrap(target, <span class="built_in">this</span>);</span><br><span class="line">    }</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 插件初始化时调用一次，获取配置的属性，如下：&lt;name, Bob&gt;</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setProperties</span><span class="params">(Properties properties)</span> { </span><br><span class="line">        System.out.println(<span class="string">"初始化参数"</span> + properties);</span><br><span class="line">    }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

</li>
<li><p>配置到配置文件中</p>
<figure class="highlight xml"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">plugins</span>&gt;</span> </span><br><span class="line">    <span class="tag">&lt;<span class="name">plugin</span> <span class="attr">interceptor</span>=<span class="string">"com.xxx.plugin.ExamplePlugin"</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"name"</span> <span class="attr">value</span>=<span class="string">"Bob"</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">plugin</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">plugins</span>&gt;</span></span><br></pre></td></tr></tbody></table></figure></li>
</ol>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="https://ccomma.cn/167946db8cf4/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/ccomma.png">
      <meta itemprop="name" content="CComma">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="CComma's Blog">
      <meta itemprop="description" content="下一个目标：改变世界！">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | CComma's Blog">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/167946db8cf4/" class="post-title-link" itemprop="url">Spring 事务原理</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>

      <time title="Created: 2019-08-03 12:02:13" itemprop="dateCreated datePublished" datetime="2019-08-03T12:02:13+08:00">2019-08-03</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">In</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/Spring/" itemprop="url" rel="index"><span itemprop="name">Spring</span></a>
        </span>
    </span>

  
  
  <span class="post-meta-item">
    
      <span class="post-meta-item-icon">
        <i class="far fa-comment"></i>
      </span>
      <span class="post-meta-item-text">Disqus: </span>
    
    <a title="disqus" href="/167946db8cf4/#disqus_thread" itemprop="discussionUrl">
      <span class="post-comments-count disqus-comment-count" data-disqus-identifier="167946db8cf4/" itemprop="commentCount"></span>
    </a>
  </span>
  
  
    <span class="post-meta-item" title="Reading time">
      <span class="post-meta-item-icon">
        <i class="far fa-clock"></i>
      </span>
      <span class="post-meta-item-text">Reading time &asymp;</span>
      <span>2 mins.</span>
    </span>
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h1 id="一、事务管理器"><a href="#一、事务管理器" class="headerlink" title="一、事务管理器"></a>一、事务管理器</h1><p><strong>概述：</strong><br>Spring 提供了事务管理器的接口，具体实现由 ORM 框架提供</p>
<p>PlatformTransactionManager：事务管理器核⼼接⼝。提供标准</p>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">PlatformTransactionManager</span> { </span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 获取事务状态信息 </span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    TransactionStatus <span class="title function_">getTransaction</span><span class="params">(<span class="meta">@Nullable</span> TransactionDefinition definition)</span> <span class="keyword">throws</span> TransactionException;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">/** </span></span><br><span class="line"><span class="comment">     * 提交事务 </span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">void</span> <span class="title function_">commit</span><span class="params">(TransactionStatus status)</span> <span class="keyword">throws</span> TransactionException;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/** </span></span><br><span class="line"><span class="comment">     * 回滚事务</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">void</span> <span class="title function_">rollback</span><span class="params">(TransactionStatus status)</span> <span class="keyword">throws</span> TransactionException; </span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<h1 id="二、事务属性"><a href="#二、事务属性" class="headerlink" title="二、事务属性"></a>二、事务属性</h1><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">TransactionDefinition</span> {</span><br><span class="line">    <span class="comment">// 返回事务的传播行为</span></span><br><span class="line">    <span class="type">int</span> <span class="title function_">getPropagationBehavior</span><span class="params">()</span>;</span><br><span class="line">    <span class="comment">// 返回事务的隔离级别，事务管理器根据它来控制另外一个事务可以看到本事务内的哪些数据</span></span><br><span class="line">    <span class="type">int</span> <span class="title function_">getIsolationLevel</span><span class="params">()</span>;</span><br><span class="line">    <span class="comment">//返回事务的名字</span></span><br><span class="line">    String <span class="title function_">getName</span><span class="params">()</span>;</span><br><span class="line">    <span class="comment">// 返回事务超时时间</span></span><br><span class="line">    <span class="type">int</span> <span class="title function_">getTimeout</span><span class="params">()</span>;</span><br><span class="line">    <span class="comment">// 返回是否优化为只读事务</span></span><br><span class="line">    <span class="type">boolean</span> <span class="title function_">isReadOnly</span><span class="params">()</span>;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 隔离级别、传播行为</span></span><br><span class="line">    ...</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<h2 id="1-事务隔离级别"><a href="#1-事务隔离级别" class="headerlink" title="1. 事务隔离级别"></a>1. 事务隔离级别</h2><ul>
<li><p><strong>ISOLATION_DEFAULT：</strong> 使用后端数据库默认的隔离级别</p>
<blockquote>
<p>Mysql 默认采用的 REPEATABLE_READ 隔离级别<br>Oracle 默认采用的 READ_COMMITTED 隔离级别</p>
</blockquote>
</li>
<li><p><strong>ISOLATION_READ_UNCOMMITTED：</strong> 未提交读，允许读取尚未提交的数据变更，<em>可能会导致脏读、幻读或不可重复读</em></p>
</li>
<li><p><strong>ISOLATION_READ_COMMITTED：</strong> 已提交读，允许读取并发事务已经提交的数据，<em>可以阻止脏读，但是幻读或不可重复读仍有可能发生</em></p>
</li>
<li><p><strong>ISOLATION_REPEATABLE_READ：</strong> 可重复读，对同一字段的多次读取结果都是一致的，除非数据是被本身事务自己所修改，<em>可以阻止脏读和不可重复读，但幻读仍有可能发生</em></p>
</li>
<li><p><strong>ISOLATION_SERIALIZABLE：</strong> 可串行化，所有的事务依次逐个执行， _可以防止脏读、不可重复读以及幻读。_但是这将严重影响程序的性能。通常情况下也不会用到该级别</p>
</li>
</ul>
<h2 id="2-事务传播行为"><a href="#2-事务传播行为" class="headerlink" title="2. 事务传播行为"></a>2. 事务传播行为</h2><p><strong>概述：</strong>当事务方法被另一个事务方法调用时，必须指定事务应该如何传播</p>
<ul>
<li>支持当前事务：<ul>
<li><strong>PROPAGATION_REQUIRED：</strong> 如果当前存在事务，则加入该事务；如果当前没有事务，则创建一个新的事务</li>
<li><strong> PROPAGATION_SUPPORTS：</strong> 如果当前存在事务，则加入该事务；如果当前没有事务，则以非事务的方式继续运行</li>
<li><strong> PROPAGATION_MANDATORY：</strong> 如果当前存在事务，则加入该事务；如果当前没有事务，则抛出异常</li>
</ul>
</li>
<li>不支持当前事务：<ul>
<li><strong>PROPAGATION_REQUIRES_NEW：</strong> 如果当前存在事务，则把当前事务挂起；如果当前没有事务，则创建一个新的事务</li>
<li><strong> PROPAGATION_NOT_SUPPORTED：</strong> 如果当前存在事务，则把当前事务挂起；如果当前没有事务，则以非事务方式运行</li>
<li><strong> PROPAGATION_NEVER：</strong>如果当前存在事务，则抛出异常；如果当前没有事务，则以非事务方式运行</li>
</ul>
</li>
<li>其他情况：<ul>
<li><strong>PROPAGATION_NESTED：</strong> 如果当前存在事务，则创建一个事务作为当前事务的嵌套事务来运行；如果当前没有事务，则该取值等价于 PROPAGATION_REQUIRED</li>
</ul>
</li>
</ul>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="https://ccomma.cn/01a10f7c716a/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/ccomma.png">
      <meta itemprop="name" content="CComma">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="CComma's Blog">
      <meta itemprop="description" content="下一个目标：改变世界！">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | CComma's Blog">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/01a10f7c716a/" class="post-title-link" itemprop="url">Spring 事件原理</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>

      <time title="Created: 2019-07-16 22:12:47" itemprop="dateCreated datePublished" datetime="2019-07-16T22:12:47+08:00">2019-07-16</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">In</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/Spring/" itemprop="url" rel="index"><span itemprop="name">Spring</span></a>
        </span>
    </span>

  
  
  <span class="post-meta-item">
    
      <span class="post-meta-item-icon">
        <i class="far fa-comment"></i>
      </span>
      <span class="post-meta-item-text">Disqus: </span>
    
    <a title="disqus" href="/01a10f7c716a/#disqus_thread" itemprop="discussionUrl">
      <span class="post-comments-count disqus-comment-count" data-disqus-identifier="01a10f7c716a/" itemprop="commentCount"></span>
    </a>
  </span>
  
  
    <span class="post-meta-item" title="Reading time">
      <span class="post-meta-item-icon">
        <i class="far fa-clock"></i>
      </span>
      <span class="post-meta-item-text">Reading time &asymp;</span>
      <span>2 mins.</span>
    </span>
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h1 id="一、事件"><a href="#一、事件" class="headerlink" title="一、事件"></a>一、事件</h1><p><img data-src="https://ccomma-pic-storage.oss-cn-hangzhou.aliyuncs.com/img/77cdb749d6378906d4e03ee1f7fc911a.png" alt="image.png"><br>自定义事件继承 ApplicationEvent 即可</p>
<h1 id="二、事件监听者"><a href="#二、事件监听者" class="headerlink" title="二、事件监听者"></a>二、事件监听者</h1><p><img data-src="https://ccomma-pic-storage.oss-cn-hangzhou.aliyuncs.com/img/c32ab68e117b017b6d1c1e7608e3dfdb.png" alt="image.png"><br>SmartApplicationListener</p>
<h1 id="三、事件发布者"><a href="#三、事件发布者" class="headerlink" title="三、事件发布者"></a>三、事件发布者</h1><p><img data-src="https://ccomma-pic-storage.oss-cn-hangzhou.aliyuncs.com/img/e8556596c3e85d62d256a931620a50c4.png" alt="image.png"></p>
<h2 id="1-ApplicationEventPublisher"><a href="#1-ApplicationEventPublisher" class="headerlink" title="1. ApplicationEventPublisher"></a>1. ApplicationEventPublisher</h2><ul>
<li>publishEvent(ApplicationEvent)</li>
<li>publishEvent(Object)</li>
</ul>
<h3 id="1-1-AbstractApplicationContext"><a href="#1-1-AbstractApplicationContext" class="headerlink" title="1.1. AbstractApplicationContext"></a>1.1. AbstractApplicationContext</h3><p>调用了 ApplicationEventMulticaster 中的 multicastEvent 方法来具体实现发布事件给监听者的操作</p>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">publishEvent</span><span class="params">(Object event, <span class="meta">@Nullable</span> ResolvableType eventType)</span> {</span><br><span class="line">    Assert.notNull(event, <span class="string">"Event must not be null"</span>);</span><br><span class="line">    <span class="keyword">if</span> (<span class="built_in">this</span>.logger.isTraceEnabled()) {</span><br><span class="line">        <span class="built_in">this</span>.logger.trace(<span class="string">"Publishing event in "</span> + <span class="built_in">this</span>.getDisplayName() + <span class="string">": "</span> + event);</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    Object applicationEvent;</span><br><span class="line">    <span class="keyword">if</span> (event <span class="keyword">instanceof</span> ApplicationEvent) {</span><br><span class="line">        applicationEvent = (ApplicationEvent)event;</span><br><span class="line">    } <span class="keyword">else</span> {</span><br><span class="line">        applicationEvent = <span class="keyword">new</span> <span class="title class_">PayloadApplicationEvent</span>(<span class="built_in">this</span>, event);</span><br><span class="line">        <span class="keyword">if</span> (eventType == <span class="literal">null</span>) {</span><br><span class="line">            eventType = ((PayloadApplicationEvent)applicationEvent).getResolvableType();</span><br><span class="line">        }</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 调用了 ApplicationEventMulticaster 中的 multicastEvent 方法</span></span><br><span class="line">    <span class="keyword">if</span> (<span class="built_in">this</span>.earlyApplicationEvents != <span class="literal">null</span>) {</span><br><span class="line">        <span class="built_in">this</span>.earlyApplicationEvents.add(applicationEvent);</span><br><span class="line">    } <span class="keyword">else</span> {</span><br><span class="line">        <span class="built_in">this</span>.getApplicationEventMulticaster().multicastEvent((ApplicationEvent)applicationEvent, eventType);</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (<span class="built_in">this</span>.parent != <span class="literal">null</span>) {</span><br><span class="line">        <span class="keyword">if</span> (<span class="built_in">this</span>.parent <span class="keyword">instanceof</span> AbstractApplicationContext) {</span><br><span class="line">            ((AbstractApplicationContext)<span class="built_in">this</span>.parent).publishEvent(event, eventType);</span><br><span class="line">        } <span class="keyword">else</span> {</span><br><span class="line">            <span class="built_in">this</span>.parent.publishEvent(event);</span><br><span class="line">        }</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<h2 id="2-ApplicationEventMulticaster"><a href="#2-ApplicationEventMulticaster" class="headerlink" title="2. ApplicationEventMulticaster"></a>2. ApplicationEventMulticaster</h2><p>定义了对 ApplicationListener 的维护操作（比如新增、 移除等）<br>以及将 ApplicationEvent 多播给可用 ApplicationListener 的操作</p>
<ul>
<li>multicastEvent(ApplicationEvent)</li>
<li>multicastEvent(ApplicationEvent, ResolvableType)</li>
</ul>
<h3 id="2-1-SimpleApplicationEventMulticaster"><a href="#2-1-SimpleApplicationEventMulticaster" class="headerlink" title="2.1. SimpleApplicationEventMulticaster"></a>2.1. SimpleApplicationEventMulticaster</h3><p><strong>步骤：</strong></p>
<ol>
<li>调用父类中的 getApplicationListeners (ApplicationEvent, ResolvableType) 获取相关监听器</li>
<li>遍历并执行各个监听器 <figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">multicastEvent</span><span class="params">(<span class="keyword">final</span> ApplicationEvent event, <span class="meta">@Nullable</span> ResolvableType eventType)</span> {</span><br><span class="line">   <span class="type">ResolvableType</span> <span class="variable">type</span> <span class="operator">=</span> (eventType != <span class="literal">null</span> ? eventType : resolveDefaultEventType(event));</span><br><span class="line">   <span class="comment">// 执行所有监听器</span></span><br><span class="line">   <span class="keyword">for</span> (<span class="keyword">final</span> ApplicationListener&lt;?&gt; listener : getApplicationListeners(event, type)) {</span><br><span class="line">      <span class="type">Executor</span> <span class="variable">executor</span> <span class="operator">=</span> getTaskExecutor();</span><br><span class="line">      <span class="keyword">if</span> (executor != <span class="literal">null</span>) {</span><br><span class="line">         executor.execute(() -&gt; invokeListener(listener, event));</span><br><span class="line">      }</span><br><span class="line">      <span class="keyword">else</span> {</span><br><span class="line">         invokeListener(listener, event);</span><br><span class="line">      }</span><br><span class="line">   }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure></li>
</ol>
<h3 id="2-2-AbstractApplicationEventMulticaster"><a href="#2-2-AbstractApplicationEventMulticaster" class="headerlink" title="2.2. AbstractApplicationEventMulticaster"></a>2.2. AbstractApplicationEventMulticaster</h3><p><strong>步骤：</strong></p>
<ol>
<li>从缓存中取监听器集合（包括预加载的监听器）</li>
<li>若无则检索监听器并加入缓存</li>
</ol>
<p><strong>思考：</strong></p>
<ul>
<li>考虑并发（ConcurrentHashMap、synchronized）</li>
<li>利用 Map 进行缓存</li>
<li>对键和值分别进行包装（ListenerCacheKey、ListenerRetriever），可附加额外功能（可扩展性）<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 使用 ConcurrentHashMap 对监听器进行缓存</span></span><br><span class="line"><span class="keyword">final</span> Map&lt;ListenerCacheKey, ListenerRetriever&gt; retrieverCache = <span class="keyword">new</span> <span class="title class_">ConcurrentHashMap</span>&lt;&gt;(<span class="number">64</span>);</span><br><span class="line">...</span><br><span class="line"><span class="keyword">protected</span> Collection&lt;ApplicationListener&lt;?&gt;&gt; getApplicationListeners(</span><br><span class="line">      ApplicationEvent event, ResolvableType eventType) {</span><br><span class="line"></span><br><span class="line">   <span class="type">Object</span> <span class="variable">source</span> <span class="operator">=</span> event.getSource();</span><br><span class="line">   Class&lt;?&gt; sourceType = (source != <span class="literal">null</span> ? source.getClass() : <span class="literal">null</span>);</span><br><span class="line">   <span class="comment">// 以事件类型和源类型作为缓存的键</span></span><br><span class="line">   <span class="type">ListenerCacheKey</span> <span class="variable">cacheKey</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ListenerCacheKey</span>(eventType, sourceType);</span><br><span class="line"></span><br><span class="line">   <span class="comment">// Quick check for existing entry on ConcurrentHashMap...</span></span><br><span class="line">   <span class="type">ListenerRetriever</span> <span class="variable">retriever</span> <span class="operator">=</span> <span class="built_in">this</span>.retrieverCache.get(cacheKey);</span><br><span class="line">   <span class="keyword">if</span> (retriever != <span class="literal">null</span>) {</span><br><span class="line">      <span class="keyword">return</span> retriever.getApplicationListeners();</span><br><span class="line">   }</span><br><span class="line"></span><br><span class="line">   <span class="keyword">if</span> (<span class="built_in">this</span>.beanClassLoader == <span class="literal">null</span> ||</span><br><span class="line">         (ClassUtils.isCacheSafe(event.getClass(), <span class="built_in">this</span>.beanClassLoader) &amp;&amp;</span><br><span class="line">               (sourceType == <span class="literal">null</span> || ClassUtils.isCacheSafe(sourceType, <span class="built_in">this</span>.beanClassLoader)))) {</span><br><span class="line">      <span class="comment">// Fully synchronized building and caching of a ListenerRetriever</span></span><br><span class="line">      <span class="keyword">synchronized</span> (<span class="built_in">this</span>.retrievalMutex) {</span><br><span class="line">         retriever = <span class="built_in">this</span>.retrieverCache.get(cacheKey);</span><br><span class="line">         <span class="keyword">if</span> (retriever != <span class="literal">null</span>) {</span><br><span class="line">            <span class="keyword">return</span> retriever.getApplicationListeners();</span><br><span class="line">         }</span><br><span class="line">         retriever = <span class="keyword">new</span> <span class="title class_">ListenerRetriever</span>(<span class="literal">true</span>);</span><br><span class="line">         <span class="comment">// 检索监听器</span></span><br><span class="line">         Collection&lt;ApplicationListener&lt;?&gt;&gt; listeners =</span><br><span class="line">               retrieveApplicationListeners(eventType, sourceType, retriever);</span><br><span class="line">         <span class="built_in">this</span>.retrieverCache.put(cacheKey, retriever);</span><br><span class="line">         <span class="keyword">return</span> listeners;</span><br><span class="line">      }</span><br><span class="line">   }</span><br><span class="line">   <span class="keyword">else</span> {</span><br><span class="line">      <span class="comment">// No ListenerRetriever caching -&gt; no synchronization necessary</span></span><br><span class="line">      <span class="keyword">return</span> retrieveApplicationListeners(eventType, sourceType, <span class="literal">null</span>);</span><br><span class="line">   }</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 根据给出的事件类型和源类型检索相关监听器</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">private</span> Collection&lt;ApplicationListener&lt;?&gt;&gt; retrieveApplicationListeners(</span><br><span class="line">      ResolvableType eventType, <span class="meta">@Nullable</span> Class&lt;?&gt; sourceType, <span class="meta">@Nullable</span> ListenerRetriever retriever) {</span><br><span class="line"></span><br><span class="line">   LinkedList&lt;ApplicationListener&lt;?&gt;&gt; allListeners = <span class="keyword">new</span> <span class="title class_">LinkedList</span>&lt;&gt;();</span><br><span class="line">   Set&lt;ApplicationListener&lt;?&gt;&gt; listeners;</span><br><span class="line">   Set&lt;String&gt; listenerBeans;</span><br><span class="line">   <span class="keyword">synchronized</span> (<span class="built_in">this</span>.retrievalMutex) {</span><br><span class="line">      listeners = <span class="keyword">new</span> <span class="title class_">LinkedHashSet</span>&lt;&gt;(<span class="built_in">this</span>.defaultRetriever.applicationListeners);</span><br><span class="line">      listenerBeans = <span class="keyword">new</span> <span class="title class_">LinkedHashSet</span>&lt;&gt;(<span class="built_in">this</span>.defaultRetriever.applicationListenerBeans);</span><br><span class="line">   }</span><br><span class="line">   <span class="keyword">for</span> (ApplicationListener&lt;?&gt; listener : listeners) {</span><br><span class="line">      <span class="keyword">if</span> (supportsEvent(listener, eventType, sourceType)) {</span><br><span class="line">         <span class="keyword">if</span> (retriever != <span class="literal">null</span>) {</span><br><span class="line">            retriever.applicationListeners.add(listener);</span><br><span class="line">         }</span><br><span class="line">         allListeners.add(listener);</span><br><span class="line">      }</span><br><span class="line">   }</span><br><span class="line">   <span class="keyword">if</span> (!listenerBeans.isEmpty()) {</span><br><span class="line">      <span class="type">BeanFactory</span> <span class="variable">beanFactory</span> <span class="operator">=</span> getBeanFactory();</span><br><span class="line">      <span class="keyword">for</span> (String listenerBeanName : listenerBeans) {</span><br><span class="line">         <span class="keyword">try</span> {</span><br><span class="line">            Class&lt;?&gt; listenerType = beanFactory.getType(listenerBeanName);</span><br><span class="line">            <span class="keyword">if</span> (listenerType == <span class="literal">null</span> || supportsEvent(listenerType, eventType)) {</span><br><span class="line">               ApplicationListener&lt;?&gt; listener =</span><br><span class="line">                     beanFactory.getBean(listenerBeanName, ApplicationListener.class);</span><br><span class="line">               <span class="keyword">if</span> (!allListeners.contains(listener) &amp;&amp; supportsEvent(listener, eventType, sourceType)) {</span><br><span class="line">                  <span class="keyword">if</span> (retriever != <span class="literal">null</span>) {</span><br><span class="line">                     retriever.applicationListenerBeans.add(listenerBeanName);</span><br><span class="line">                  }</span><br><span class="line">                  allListeners.add(listener);</span><br><span class="line">               }</span><br><span class="line">            }</span><br><span class="line">         }</span><br><span class="line">         <span class="keyword">catch</span> (NoSuchBeanDefinitionException ex) {</span><br><span class="line">            <span class="comment">// Singleton listener instance (without backing bean definition) disappeared -</span></span><br><span class="line">            <span class="comment">// probably in the middle of the destruction phase</span></span><br><span class="line">         }</span><br><span class="line">      }</span><br><span class="line">   }</span><br><span class="line">   AnnotationAwareOrderComparator.sort(allListeners);</span><br><span class="line">   <span class="keyword">return</span> allListeners;</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure></li>
</ul>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="https://ccomma.cn/7f785420883c/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/ccomma.png">
      <meta itemprop="name" content="CComma">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="CComma's Blog">
      <meta itemprop="description" content="下一个目标：改变世界！">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | CComma's Blog">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/7f785420883c/" class="post-title-link" itemprop="url">Linux 安装 MySQL</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>

      <time title="Created: 2019-07-13 17:08:56" itemprop="dateCreated datePublished" datetime="2019-07-13T17:08:56+08:00">2019-07-13</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">In</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/MySQL/" itemprop="url" rel="index"><span itemprop="name">MySQL</span></a>
        </span>
          , 
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/MySQL/%E6%95%B0%E6%8D%AE%E5%BA%93/" itemprop="url" rel="index"><span itemprop="name">数据库</span></a>
        </span>
    </span>

  
  
  <span class="post-meta-item">
    
      <span class="post-meta-item-icon">
        <i class="far fa-comment"></i>
      </span>
      <span class="post-meta-item-text">Disqus: </span>
    
    <a title="disqus" href="/7f785420883c/#disqus_thread" itemprop="discussionUrl">
      <span class="post-comments-count disqus-comment-count" data-disqus-identifier="7f785420883c/" itemprop="commentCount"></span>
    </a>
  </span>
  
  
    <span class="post-meta-item" title="Reading time">
      <span class="post-meta-item-icon">
        <i class="far fa-clock"></i>
      </span>
      <span class="post-meta-item-text">Reading time &asymp;</span>
      <span>3 mins.</span>
    </span>
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <p><strong>1. 下载解压</strong><br><strong>1.1 下载</strong><br>wget mysql-5.7.21-linux-glibc2.12-x86_64.tar.gz<br><strong>1.2 解压到 /usr/local/ 下，并更名</strong><br>tar -zxvf /home/mysql-5.7.21-linux-glibc2.12-x86_64.tar.gz -C /usr/local<br>mv /usr/local/mysql-5.7.21-linux-glibc2.12-x86_64.tar.gz /usr/local/mysql<br><strong>1.3 创建 data 文件夹存放数据</strong><br>mkdir /usr/local/mysql/data<br><strong>2. 用户组</strong><br><strong>2.1 创建 用户 和 组</strong><br>groupadd mysql<br>useradd -r -g mysql mysql<br><strong>2.2 更改文件所属</strong><br>-R 表示递归<br>chown -R mysql:mysql /usr/local/mysql/<br>chown -R mysql:mysql /usr/local/mysql/data/<br>chown -R mysql /usr/local/mysql/<br>chown -R mysql /usr/local/mysql/data/<br><strong>2.3 更改权限</strong><br>755：rwxr-xr-x<br>chmod -R 755 /usr/local/mysql/<br><strong>3. 安装 libaio 依赖包</strong><br>yum install libaio<br><strong>4. 初始化</strong><br>cd /usr/local/mysql/bin<br>./mysqld –user=mysql –basedir=/usr/local/mysql –datadir=/usr/local/mysql/data –initialize<br>[Note] A temporary password is generated for root@localhost: o*s#gqh)F4Ck<br>得到随机的 初始密码<br><strong>5. 启动 mysql 服务</strong><br>sh /usr/local/mysql/support-files/mysql.server start<br><strong>6. 修改 my.cnf 文件</strong><br>cp /usr/local/mysql/support-files/mysql.server /etc/init.d/mysqld<br>chmod 755 /etc/init.d/mysqld<br>vim /etc/my.cnf<br>[client]<br>no-beep<br>socket =/usr/local/mysql/mysql.sock<br># pipe<br># socket=0.0<br>port=3306<br>[mysql]<br>default-character-set=utf8<br>[mysqld]<br>basedir=/usr/local/mysql<br>datadir=/usr/local/mysql/data<br>port=3306<br>pid-file=/usr/local/mysql/mysqld.pid<br>#skip-grant-tables<br>skip-name-resolve<br>socket = /usr/local/mysql/mysql.sock<br>character-set-server=utf8<br>default-storage-engine=INNODB<br>explicit_defaults_for_timestamp = true<br># Server Id.<br>server-id=1<br>max_connections=2000<br>query_cache_size=0<br>table_open_cache=2000<br>tmp_table_size=246M<br>thread_cache_size=300<br>#限定用于每个数据库线程的栈大小。默认设置足以满足大多数应用<br>thread_stack = 192k<br>key_buffer_size=512M<br>read_buffer_size=4M<br>read_rnd_buffer_size=32M<br>innodb_data_home_dir = /usr/local/mysql/data<br>innodb_flush_log_at_trx_commit=0<br>innodb_log_buffer_size=16M<br>innodb_buffer_pool_size=256M<br>innodb_log_file_size=128M<br>innodb_thread_concurrency=128<br>innodb_autoextend_increment=1000<br>innodb_buffer_pool_instances=8<br>innodb_concurrency_tickets=5000<br>innodb_old_blocks_time=1000<br>innodb_open_files=300<br>innodb_stats_on_metadata=0<br>innodb_file_per_table=1<br>innodb_checksum_algorithm=0<br>back_log=80<br>flush_time=0<br>join_buffer_size=128M<br>max_allowed_packet=1024M<br>max_connect_errors=2000<br>open_files_limit=4161<br>query_cache_type=0<br>sort_buffer_size=32M<br>table_definition_cache=1400<br>binlog_row_event_max_size=8K<br>sync_master_info=10000<br>sync_relay_log=10000<br>sync_relay_log_info=10000<br>#批量插入数据缓存大小，可以有效提高插入效率，默认为 8M<br>bulk_insert_buffer_size = 64M<br>interactive_timeout = 120<br>wait_timeout = 120<br>log-bin-trust-function-creators=1<br>sql_mode=NO_ENGINE_SUBSTITUTION,STRICT_TRANS_TABLES<br>#<br># include all files from the config directory<br>#<br>!includedir /etc/my.cnf.d<br><strong>7. 登录</strong><br>/usr/local/mysql/bin/mysql -u root –p</p>
<p>密码为之前的临时密码<br><strong>8. 修改密码 及 共享</strong><br>set password=password (‘密码’);<br>grant all privileges on 库名。表名 to ‘用户名‘@’IP 地址’ identified by ‘密码’ with grant option;<br>flush privileges;<br>库名：要远程访问的数据库名称，所有的数据库使用 “<em>” <br>表名：要远程访问的数据库下的表的名称，所有的表使用 “</em>” <br>用户名：要赋给远程访问权限的用户名称 <br>IP 地址：可以远程访问的电脑的 IP 地址，所有的地址使用 “%” <br>密码：要赋给远程访问权限的用户对应使用的密码<br><strong><em>例子：</em></strong><br># 所有的地址都可以使用 root 用户，密码为 lxh 远程访问所有的数据库<br>GRANT ALL PRIVILEGES ON <em>.</em> TO ‘root‘@’%’ IDENTIFIED BY ‘lxh’ WITH GRANT OPTION; <br># IP 为 172.16.52.225 的电脑可以使用 lxh 用户，密码为 lxh 远程访问数据库 testdb 的所有表<br>GRANT ALL PRIVILEGES ON testdb.* TO ‘lxh‘@’172.16.52.225’ IDENTIFIED BY ‘lxh’ WITH GRANT OPTION; <br><strong>9. 添加 环境变量</strong><br><strong>9.1 直接在命令行中设置 PATH</strong><br>PATH=$PATH:/usr/local/mysql/bin<br>使用这种方法，只对当前会话有效，也就是说每当登出或注销系统以后，PATH 设置就会失效。<br><strong>9.2 在 profile 中设置 PATH</strong><br>vim /etc/profile<br>export PATH=$PATH:/usr/local/apache/bin<br><strong>9.3 在当前用户的 profile 中设置 PATH</strong><br>vim ~/.bash_profile<br>PATH=$PATH:$HOME/bin:/usr/local/apache/bin<br>source ~/.bash_profile<br>这种方法只对当前用户起作用的，其他用户该修改无效。<br><strong>10. 阿里云设置安全组</strong><br><img data-src="https://ccomma-pic-storage.oss-cn-hangzhou.aliyuncs.com/img/3b66d3af9ad75ff18c49b57b367845a6.png" alt="image.png"><br><img data-src="https://ccomma-pic-storage.oss-cn-hangzhou.aliyuncs.com/img/acf9c36242e743914d261e0a63a9a15e.png" alt="image.png"></p>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="https://ccomma.cn/6a35083ca0bf/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/ccomma.png">
      <meta itemprop="name" content="CComma">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="CComma's Blog">
      <meta itemprop="description" content="下一个目标：改变世界！">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | CComma's Blog">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/6a35083ca0bf/" class="post-title-link" itemprop="url">Windows 安装 MySQL</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>

      <time title="Created: 2019-07-13 16:22:13" itemprop="dateCreated datePublished" datetime="2019-07-13T16:22:13+08:00">2019-07-13</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">In</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/MySQL/" itemprop="url" rel="index"><span itemprop="name">MySQL</span></a>
        </span>
          , 
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/MySQL/%E6%95%B0%E6%8D%AE%E5%BA%93/" itemprop="url" rel="index"><span itemprop="name">数据库</span></a>
        </span>
    </span>

  
  
  <span class="post-meta-item">
    
      <span class="post-meta-item-icon">
        <i class="far fa-comment"></i>
      </span>
      <span class="post-meta-item-text">Disqus: </span>
    
    <a title="disqus" href="/6a35083ca0bf/#disqus_thread" itemprop="discussionUrl">
      <span class="post-comments-count disqus-comment-count" data-disqus-identifier="6a35083ca0bf/" itemprop="commentCount"></span>
    </a>
  </span>
  
  
    <span class="post-meta-item" title="Reading time">
      <span class="post-meta-item-icon">
        <i class="far fa-clock"></i>
      </span>
      <span class="post-meta-item-text">Reading time &asymp;</span>
      <span>5 mins.</span>
    </span>
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <p><a target="_blank" rel="noopener" href="https://blog.csdn.net/qq_37350706/article/details/81707862">MySQL 8.0.18 安装教程 (windows 64 位)</a></p>
<p><a target="_blank" rel="noopener" href="https://www.cnblogs.com/xiaoran991/p/12343911.html">MySQL 5.7x 安装教程</a></p>
<p><strong>系列目录</strong><br>一、安装 MySql<br>二、安装并破解 Navicat<br>三、没有 my.in 配置文件怎么办<br>四、设置 MySql 的大小写敏感<br>五、重置 MySql 登陆密码</p>
<hr>
<p>&nbsp;<br>之前说过，Windows 操作系统中，我们安装 Mysql 有两个选择：一是下载 MSI 点击运行，利用 windows 系统安装程序的方法按部就班的来安装；二是下载 ZIP，解压出来就能立即使用。<br>在使用 ZIP 安装时，安装好之后默认是没有 my.ini 配置文件的：<br><img data-src="https://ccomma-pic-storage.oss-cn-hangzhou.aliyuncs.com/img/3c9424ffe1cccb3d4cf13cdf5fba1b12.png"><br> 当我们想修改数据库的配置信息如 wait_timeout、interactive_timeout、max_connections 或大小写敏感时，却找不到 my.ini 配置文件。<br>虽然这时，还可以通过命令行来修改配置信息，但重启 mysql 后修改会失效，配置会回归默认值，所以这种方式治标不治本。<br>这里提供了另一种方法，解决的基本思路是：先删除 Mysql 服务，然后自己新建一个 my.ini 文件，最后使用命令行重新初始化 mysql 服务，同时指定新建的 my.ini 作为服务默认的配置文件。<br>以下是详细步骤：</p>
<h2 id="1-删除-MySql-服务"><a href="#1-删除-MySql-服务" class="headerlink" title="1. 删除 MySql 服务"></a>1. 删除 MySql 服务</h2><p>打开 cmd（记得” 使用管理员身份 “打开），如果没有配置环境变量，请 cd（切换目录）到 mysql 程序下的 bin 文件夹下（详细步骤参见第一章～）：<br>运行命令：<br><img data-src="https://ccomma-pic-storage.oss-cn-hangzhou.aliyuncs.com/img/214e32b66097f62f2e6fcdc2a4d456c8.png"><br>“MySql” 为服务名称，你的 MysSql 服务不一定是这个名称，可以打开电脑的服务窗口查看。<br>删除完成之后，最好去电脑的服务窗口看下，如果找不到 MySql 服务，说明已经已经删除成功。<br>如果还能看到 MySql 服务，可以手动右击选择” 停止 “，服务停止之后就会自动消失了。</p>
<h2 id="2-新建-my-ini-配置文件"><a href="#2-新建-my-ini-配置文件" class="headerlink" title="2. 新建 my.ini 配置文件"></a>2. 新建 my.ini 配置文件</h2><p>在 mysql 程序的根目录下，新建一个 my.ini 空白文件，用记事本打开，将以下内容复制进去，保存：<br><img data-src="https://ccomma-pic-storage.oss-cn-hangzhou.aliyuncs.com/img/8f900a89c6347c561fdf2122f13be562.gif"><img data-src="https://ccomma-pic-storage.oss-cn-hangzhou.aliyuncs.com/img/961ddebeb323a10fe0623af514929fc1.gif"><img data-src="https://ccomma-pic-storage.oss-cn-hangzhou.aliyuncs.com/img/d2f7717359a727f8dee0391547dff4d1.gif"># For advice on how to change settings please see # <a target="_blank" rel="noopener" href="http://dev.mysql.com/doc/refman/5.6/en/server-configuration-defaults.html's">http://dev.mysql.com/doc/refman/5.6/en/server-configuration-defaults.html's</a> a template which will be copied to thedefaultif you #  upgrade to a newer version of MySQL. [client] defaultset utf8mb4 [mysql] defaultset utf8mb4 [mysqld] characterset FALSE characterset utf8mb4 collation utf8mb4_bin init_connect’SET NAMES utf8mb4’ # Remove leading # and setfor the most important data # cache in70forelse10. innodb_buffer_pool_size  128M # Remove leading # to turn on a very important data integrity option: logging # changes to the binary log between backups. # log_bin # These are commonly setsetas required. basedir  D:\MySQL datadir  D:\MySQL\data port 3306 # server_id  ….. # Remove leading # to setfor reporting servers. # The server defaults are faster for transactions and fast SELECTs. # Adjust sizes as needed, experiment to find the optimal values. join_buffer_size  128M sort_buffer_size  16M read_rnd_buffer_size  16M  sql_mode<img data-src="https://ccomma-pic-storage.oss-cn-hangzhou.aliyuncs.com/img/d2f7717359a727f8dee0391547dff4d1.gif">View Code<br><img data-src="https://ccomma-pic-storage.oss-cn-hangzhou.aliyuncs.com/img/d170ccbff7604b164f568b4f77f0cf3f.png"><br>其中 basedir 和 datadir 根据实际 MySql 安装的位置进行修改。</p>
<h2 id="3-重新生成-data-文件"><a href="#3-重新生成-data-文件" class="headerlink" title="3. 重新生成 data 文件"></a>3. 重新生成 data 文件</h2><p>删除之前生成的 data 文件，如果有重要的数据表，请先备份好。<br>回到 cmd，重新生成 data 文件。运行：<br>该命令需要执行大概一分钟左右，完成后会在 MySql 程序文件夹下重新生成名称为 data 的文件夹：<br><img data-src="https://ccomma-pic-storage.oss-cn-hangzhou.aliyuncs.com/img/2871ea1de0e1ea258bd39f113bf6302c.png"><br><img data-src="https://ccomma-pic-storage.oss-cn-hangzhou.aliyuncs.com/img/0c19aa129347bbc21afc48f5f809a79d.png"><br>&nbsp;</p>
<h2 id="4-重新安装-mysql-服务，同时绑定-my-ini-配置文件"><a href="#4-重新安装-mysql-服务，同时绑定-my-ini-配置文件" class="headerlink" title="4. 重新安装 mysql 服务，同时绑定 my.ini 配置文件"></a>4. 重新安装 mysql 服务，同时绑定 my.ini 配置文件</h2><p>安装 MySql 服务，同时设置绑定 my.ini 配置文件。命令：<br>“MySql80” –defaults-file=”d:/mysql/my.ini”<br>“MySql80” 是服务名称，80 表示 8.0 版本，当然，也可以自己取别的名字。<br>”..\my.ini“是新建的配置文件的位置，也可以写成绝对路径”D:\MySql\my.ini“。<br><img data-src="https://ccomma-pic-storage.oss-cn-hangzhou.aliyuncs.com/img/7c0eff842ce4139a3230795344806810.png"><br>如果提示安装成功，这时打开电脑的” 服务 “窗口，可以找到新添加的 MySql80 服务：<br><img data-src="https://ccomma-pic-storage.oss-cn-hangzhou.aliyuncs.com/img/b881a1e15afbadb0e900a9de4673de43.png"><br>&nbsp;</p>
<h2 id="5-启动服务"><a href="#5-启动服务" class="headerlink" title="5. 启动服务"></a>5. 启动服务</h2><p>这里有两种启动服务的方式：1）服务窗口启动；2）cmd 启动</p>
<h3 id="5-1-服务窗口启动"><a href="#5-1-服务窗口启动" class="headerlink" title="5.1 服务窗口启动"></a>5.1 服务窗口启动</h3><p>直接右击服务项，选择启动：<br><img data-src="https://ccomma-pic-storage.oss-cn-hangzhou.aliyuncs.com/img/95f42ae7e44b283aaf44eb616a0d73e6.png"><br>&nbsp;</p>
<h3 id="5-2-cmd-命令启动"><a href="#5-2-cmd-命令启动" class="headerlink" title="5.2 cmd 命令启动"></a>5.2 cmd 命令启动</h3><p>命令：<br>等待 20 秒左右，如果启动成功，是这样的：<br><img data-src="https://ccomma-pic-storage.oss-cn-hangzhou.aliyuncs.com/img/8b3f9d6c79a8350cfad64599feee15ee.png"><br>&nbsp;<br>如果不成功：<br><img data-src="https://ccomma-pic-storage.oss-cn-hangzhou.aliyuncs.com/img/70e18e9cba139ecd5b99730a9e11fc3e.png"><br>&nbsp;<br>这时可能是 my.ini 配置文件中的某些配置有问题。你可以修改 ini 文件内容，然后从头按步骤再试一遍。</p>
<h2 id="6-重新设置密码"><a href="#6-重新设置密码" class="headerlink" title="6. 重新设置密码"></a>6. 重新设置密码</h2><p>删除了 data 文件和服务之后，之前的密码就失效了，所以需要重新设置密码。</p>
<h3 id="6-1-登陆-mysql"><a href="#6-1-登陆-mysql" class="headerlink" title="6.1 登陆 mysql"></a>6.1 登陆 mysql</h3><p>命令：<br>这时密码为空，不需要填写，直接回车：<br><img data-src="https://ccomma-pic-storage.oss-cn-hangzhou.aliyuncs.com/img/b45fb44fead6edf175a976a634f44d9f.png"><br>如果这里没有登陆成功，请移步下一章” 重置 MySql 密码 “~</p>
<h3 id="6-2-修改-root-用户密码"><a href="#6-2-修改-root-用户密码" class="headerlink" title="6.2 修改 root 用户密码"></a>6.2 修改 root 用户密码</h3><p>（敲黑板）这里有个需要注意的地方，在 8.0 之后的版本，修改 root 用户密码的命令是：<br>‘root’’localhost’’你的密码’<br>&nbsp;之前的版本是：<br>set” 你的密码”where”root”<br>&nbsp;我这里安装的是 8.0.11，所以是第一个：<br><img data-src="https://ccomma-pic-storage.oss-cn-hangzhou.aliyuncs.com/img/05f4b146bb74f83635ad8951abf4cc07.png"></p>
<h3 id="6-3-退出-MySQL"><a href="#6-3-退出-MySQL" class="headerlink" title="6.3 退出 MySQL"></a>6.3 退出 MySQL</h3><p>命令：</p>
<h3 id="6-4-使用修改后的密码重新登陆"><a href="#6-4-使用修改后的密码重新登陆" class="headerlink" title="6.4 使用修改后的密码重新登陆"></a>6.4 使用修改后的密码重新登陆</h3><p>这里的命令和之前是一样的，就不写了，密码记得要填刚才设置的：<br><img data-src="https://ccomma-pic-storage.oss-cn-hangzhou.aliyuncs.com/img/af7c90061a5c0b9eae88372318325818.png"><br>&nbsp;<br>&nbsp;<br>现在已经成功绑定了 my.ini 配置文件了，如果需要自定义配置，可以打开文件进行相应的配置设置，修改后重启服务即可。<br>如果修改后，重启服务报错，如下图：<br><img data-src="https://ccomma-pic-storage.oss-cn-hangzhou.aliyuncs.com/img/e7bb3e3063f151fb192e70f6a4f20470.png"><br>&nbsp;<br>有一种可能：你修改的配置与服务初始化时的配置有冲突，这时只能从头开始，在初始化的时候绑定 my.ini 文件 。<br>下一章要讲的的 “设置 MySql 大小写敏感” 就是～</p>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="https://ccomma.cn/f5c90de53682/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/ccomma.png">
      <meta itemprop="name" content="CComma">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="CComma's Blog">
      <meta itemprop="description" content="下一个目标：改变世界！">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | CComma's Blog">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/f5c90de53682/" class="post-title-link" itemprop="url">Spring 配置多数据源</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>

      <time title="Created: 2019-07-02 23:03:58" itemprop="dateCreated datePublished" datetime="2019-07-02T23:03:58+08:00">2019-07-02</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">In</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/Spring/" itemprop="url" rel="index"><span itemprop="name">Spring</span></a>
        </span>
    </span>

  
  
  <span class="post-meta-item">
    
      <span class="post-meta-item-icon">
        <i class="far fa-comment"></i>
      </span>
      <span class="post-meta-item-text">Disqus: </span>
    
    <a title="disqus" href="/f5c90de53682/#disqus_thread" itemprop="discussionUrl">
      <span class="post-comments-count disqus-comment-count" data-disqus-identifier="f5c90de53682/" itemprop="commentCount"></span>
    </a>
  </span>
  
  
    <span class="post-meta-item" title="Reading time">
      <span class="post-meta-item-icon">
        <i class="far fa-clock"></i>
      </span>
      <span class="post-meta-item-text">Reading time &asymp;</span>
      <span>1 mins.</span>
    </span>
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h2 id="1-项目结构"><a href="#1-项目结构" class="headerlink" title="1. 项目结构"></a>1. 项目结构</h2><p><img data-src="https://ccomma-pic-storage.oss-cn-hangzhou.aliyuncs.com/img/36dae00c61d2e0b88d541ce04d03af8e.png" alt="image.png"></p>
<h2 id="2-启动文件"><a href="#2-启动文件" class="headerlink" title="2. 启动文件"></a>2. 启动文件</h2><p>禁止数据源自动配置</p>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@SpringBootApplication(exclude = {DataSourceAutoConfiguration.class})</span></span><br><span class="line"><span class="meta">@ServletComponentScan("com.chemyun.mall.api.filter")</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">OpenApiApplication</span> {</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> {</span><br><span class="line">        SpringApplication.run(OpenApiApplication.class, args);</span><br><span class="line">    }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<h2 id="3-Properties-文件"><a href="#3-Properties-文件" class="headerlink" title="3. Properties 文件"></a>3. Properties 文件</h2><p><strong><em>application.yml：</em></strong></p>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">spring:</span><br><span class="line">  datasource:</span><br><span class="line">    master:</span><br><span class="line">      url: jdbc:mysql:<span class="comment">//172.19.253.52:9527/chemme?autoCommit=true&amp;useUnicode=true&amp;autoReconnect=true&amp;allowMultiQueries=true</span></span><br><span class="line">      username: chemme</span><br><span class="line">      password: hEJpiLR162xRCBqYcNEwck4Ulr3A66OtfGUalzDAOMwvtB3RaPsfD0nylr7mOry8kOyd2BQiYIgNyzXF8q1T3A==</span><br><span class="line">      driver-class-name: com.mysql.jdbc.Driver</span><br><span class="line">      filters: stat,slf4j,config</span><br><span class="line">      initial-size: <span class="number">1</span></span><br><span class="line">      min-idle: <span class="number">1</span></span><br><span class="line">      max-active: <span class="number">10</span></span><br><span class="line">      max-wait: <span class="number">60000</span></span><br><span class="line">      use-global-data-source-stat: <span class="literal">true</span></span><br><span class="line">      connectProperties:</span><br><span class="line">        druid.stat.slowSqlMillis: <span class="number">5000</span></span><br><span class="line">        config.decrypt: <span class="literal">true</span></span><br><span class="line">        config.decrypt.key: MFwwDQYJKoZIhvcNAQEBBQADSwAwSAJBAJ3JZ3D6h+2OasZg1OMptc1KPKabNAp1IaqL9CeoLrsrDlQAdTpJZrRvKxISiWuwPb96KaW+vkOxfhWrWm9txukCAwEAAQ==</span><br><span class="line">    slave:</span><br><span class="line">      url: jdbc:sqlserver:<span class="comment">//124.160.116.211:1434;DatabaseName=chemcndata</span></span><br><span class="line">      username: chemme</span><br><span class="line">      password: chemme@<span class="number">20181121</span></span><br><span class="line">      driver-class-name: com.microsoft.sqlserver.jdbc.SQLServerDriver</span><br></pre></td></tr></tbody></table></figure>


<p><strong><em>AbstractDataBaseProperties：</em></strong></p>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Setter</span></span><br><span class="line"><span class="meta">@Getter</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="keyword">class</span> <span class="title class_">AbstractDataBaseProperties</span> {</span><br><span class="line">    <span class="keyword">private</span> String url;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> String username;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> String password;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> String driverClassName;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="type">String</span> <span class="variable">filters</span> <span class="operator">=</span> <span class="string">""</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="type">int</span> <span class="variable">initialSize</span> <span class="operator">=</span> <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="type">int</span> <span class="variable">minIdle</span> <span class="operator">=</span> <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="type">int</span> <span class="variable">maxActive</span> <span class="operator">=</span> <span class="number">8</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="type">int</span> <span class="variable">maxWait</span> <span class="operator">=</span> -<span class="number">1</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="type">boolean</span> <span class="variable">useGlobalDataSourceStat</span> <span class="operator">=</span> <span class="literal">false</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> Map&lt;String, String&gt; connectProperties;</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>


<p><strong><em>MasterDataBaseProperties：</em></strong></p>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@ConfigurationProperties(prefix = "spring.datasource.master")</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">MasterDataBaseProperties</span> <span class="keyword">extends</span> <span class="title class_">AbstractDataBaseProperties</span> {</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>


<p><strong><em>SlaveDataBaseProperties：</em></strong></p>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@ConfigurationProperties(prefix = "spring.datasource.slave")</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">SlaveDataBaseProperties</span> <span class="keyword">extends</span> <span class="title class_">AbstractDataBaseProperties</span> {</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<h2 id="4-数据源配置"><a href="#4-数据源配置" class="headerlink" title="4. 数据源配置"></a>4. 数据源配置</h2><p><strong><em>MasterDataSourceConfig：</em></strong></p>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="meta">@EnableConfigurationProperties(MasterDataBaseProperties.class)</span></span><br><span class="line"><span class="meta">@MapperScan(basePackages = MasterDataSourceConfig.PACKAGE, sqlSessionFactoryRef = "masterSqlSessionFactory")</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">MasterDataSourceConfig</span> {</span><br><span class="line">    <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">PACKAGE</span> <span class="operator">=</span> <span class="string">"com.chemyun.mall.api.dal.mapper"</span>;</span><br><span class="line">    <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">MAPPER_LOCATION</span> <span class="operator">=</span> <span class="string">"classpath:com/chemyun/mall/api/dal/mapper/*.xml"</span>;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> MasterDataBaseProperties masterDataBaseProperties;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Primary</span></span><br><span class="line">    <span class="meta">@Bean(name = "masterDataSource")</span></span><br><span class="line">    <span class="keyword">public</span> DataSource <span class="title function_">masterDataSource</span><span class="params">()</span> <span class="keyword">throws</span> SQLException {</span><br><span class="line">        <span class="type">DruidDataSource</span> <span class="variable">druidDataSource</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">DruidDataSource</span>();</span><br><span class="line">        druidDataSource.setDriverClassName(masterDataBaseProperties.getDriverClassName());</span><br><span class="line">        druidDataSource.setUrl(masterDataBaseProperties.getUrl());</span><br><span class="line">        druidDataSource.setUsername(masterDataBaseProperties.getUsername());</span><br><span class="line">        druidDataSource.setPassword(masterDataBaseProperties.getPassword());</span><br><span class="line"></span><br><span class="line">        druidDataSource.setFilters(masterDataBaseProperties.getFilters());</span><br><span class="line"></span><br><span class="line">        druidDataSource.setInitialSize(masterDataBaseProperties.getInitialSize());</span><br><span class="line">        druidDataSource.setMinIdle(masterDataBaseProperties.getMinIdle());</span><br><span class="line">        druidDataSource.setMaxActive(masterDataBaseProperties.getMaxActive());</span><br><span class="line">        druidDataSource.setMaxWait(masterDataBaseProperties.getMaxWait());</span><br><span class="line">        druidDataSource.setUseGlobalDataSourceStat(masterDataBaseProperties.isUseGlobalDataSourceStat());</span><br><span class="line"></span><br><span class="line">        <span class="comment">// connectProperties</span></span><br><span class="line">        Map&lt;String, String&gt; connectProperties = masterDataBaseProperties.getConnectProperties();</span><br><span class="line">        <span class="keyword">if</span> (!CollectionUtils.isEmpty(connectProperties)) {</span><br><span class="line">            <span class="type">Properties</span> <span class="variable">properties</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Properties</span>();</span><br><span class="line"></span><br><span class="line">            <span class="keyword">for</span> (Map.Entry&lt;String, String&gt; connectPropertie : connectProperties.entrySet()) {</span><br><span class="line">                properties.setProperty(connectPropertie.getKey(), connectPropertie.getValue());</span><br><span class="line">            }</span><br><span class="line">            druidDataSource.setConnectProperties(properties);</span><br><span class="line">        }</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> druidDataSource;</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Primary</span></span><br><span class="line">    <span class="meta">@Bean(name = "masterTransactionManager")</span></span><br><span class="line">    <span class="keyword">public</span> DataSourceTransactionManager <span class="title function_">masterTransactionManager</span><span class="params">()</span> <span class="keyword">throws</span> SQLException {</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">DataSourceTransactionManager</span>(masterDataSource());</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Primary</span></span><br><span class="line">    <span class="meta">@Bean(name = "masterSqlSessionFactory")</span></span><br><span class="line">    <span class="keyword">public</span> SqlSessionFactory <span class="title function_">masterSqlSessionFactory</span><span class="params">(<span class="meta">@Qualifier("masterDataSource")</span> DataSource masterDataSource)</span></span><br><span class="line">            <span class="keyword">throws</span> Exception {</span><br><span class="line">        <span class="keyword">final</span> <span class="type">SqlSessionFactoryBean</span> <span class="variable">sessionFactory</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">SqlSessionFactoryBean</span>();</span><br><span class="line">        sessionFactory.setDataSource(masterDataSource);</span><br><span class="line">        sessionFactory.setMapperLocations(</span><br><span class="line">                <span class="keyword">new</span> <span class="title class_">PathMatchingResourcePatternResolver</span>().getResources(MasterDataSourceConfig.MAPPER_LOCATION));</span><br><span class="line">        <span class="keyword">return</span> sessionFactory.getObject();</span><br><span class="line">    }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>


<p><strong><em>SlaveDataSourceConfig：</em></strong></p>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="meta">@EnableConfigurationProperties(SlaveDataBaseProperties.class)</span></span><br><span class="line"><span class="meta">@MapperScan(basePackages = SlaveDataSourceConfig.PACKAGE, sqlSessionFactoryRef = "slaveSqlSessionFactory")</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">SlaveDataSourceConfig</span> {</span><br><span class="line">    <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">PACKAGE</span> <span class="operator">=</span> <span class="string">"com.chemyun.mall.api.dal.slave"</span>;</span><br><span class="line">    <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">MAPPER_LOCATION</span> <span class="operator">=</span> <span class="string">"classpath:com/chemyun/mall/api/dal/slave/*.xml"</span>;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> SlaveDataBaseProperties slaveDataBaseProperties;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean(name = "slaveDataSource")</span></span><br><span class="line">    <span class="keyword">public</span> DataSource <span class="title function_">slaveDataSource</span><span class="params">()</span> {</span><br><span class="line">        <span class="type">DruidDataSource</span> <span class="variable">dataSource</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">DruidDataSource</span>();</span><br><span class="line">        dataSource.setDriverClassName(slaveDataBaseProperties.getDriverClassName());</span><br><span class="line">        dataSource.setUrl(slaveDataBaseProperties.getUrl());</span><br><span class="line">        dataSource.setUsername(slaveDataBaseProperties.getUsername());</span><br><span class="line">        dataSource.setPassword(slaveDataBaseProperties.getPassword());</span><br><span class="line">        <span class="keyword">return</span> dataSource;</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean(name = "slaveTransactionManager")</span></span><br><span class="line">    <span class="keyword">public</span> DataSourceTransactionManager <span class="title function_">slaveTransactionManager</span><span class="params">()</span> {</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">DataSourceTransactionManager</span>(slaveDataSource());</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean(name = "slaveSqlSessionFactory")</span></span><br><span class="line">    <span class="keyword">public</span> SqlSessionFactory <span class="title function_">slaveSqlSessionFactory</span><span class="params">(<span class="meta">@Qualifier("slaveDataSource")</span> DataSource slaveDataSource)</span></span><br><span class="line">            <span class="keyword">throws</span> Exception {</span><br><span class="line">        <span class="keyword">final</span> <span class="type">SqlSessionFactoryBean</span> <span class="variable">sessionFactory</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">SqlSessionFactoryBean</span>();</span><br><span class="line">        sessionFactory.setDataSource(slaveDataSource);</span><br><span class="line">        sessionFactory.setMapperLocations(</span><br><span class="line">                <span class="keyword">new</span> <span class="title class_">PathMatchingResourcePatternResolver</span>().getResources(SlaveDataSourceConfig.MAPPER_LOCATION));</span><br><span class="line">        <span class="keyword">return</span> sessionFactory.getObject();</span><br><span class="line">    }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="https://ccomma.cn/f8bf585b0820/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/ccomma.png">
      <meta itemprop="name" content="CComma">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="CComma's Blog">
      <meta itemprop="description" content="下一个目标：改变世界！">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | CComma's Blog">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/f8bf585b0820/" class="post-title-link" itemprop="url">Spring AOP 详解</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>

      <time title="Created: 2019-06-09 19:33:23" itemprop="dateCreated datePublished" datetime="2019-06-09T19:33:23+08:00">2019-06-09</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">In</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/Spring/" itemprop="url" rel="index"><span itemprop="name">Spring</span></a>
        </span>
    </span>

  
  
  <span class="post-meta-item">
    
      <span class="post-meta-item-icon">
        <i class="far fa-comment"></i>
      </span>
      <span class="post-meta-item-text">Disqus: </span>
    
    <a title="disqus" href="/f8bf585b0820/#disqus_thread" itemprop="discussionUrl">
      <span class="post-comments-count disqus-comment-count" data-disqus-identifier="f8bf585b0820/" itemprop="commentCount"></span>
    </a>
  </span>
  
  
    <span class="post-meta-item" title="Reading time">
      <span class="post-meta-item-icon">
        <i class="far fa-clock"></i>
      </span>
      <span class="post-meta-item-text">Reading time &asymp;</span>
      <span>6 mins.</span>
    </span>
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Aspect</span></span><br><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">MenuBalanceLogAspect</span> {</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">Logger</span> <span class="variable">BIZ_ERROR_LOG</span> <span class="operator">=</span> LoggerFactory.getLogger(<span class="string">"biz_error_log"</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// @Around("execution(public * com.dfire.soa.msstate.client.service.MenuBalanceClientServiceImpl..*(..))")</span></span><br><span class="line">    <span class="meta">@Around("bean(menuBalanceClientServiceImpl)")</span></span><br><span class="line">    <span class="keyword">public</span> Object <span class="title function_">aroundProviderService</span><span class="params">(ProceedingJoinPoint pjp)</span> <span class="keyword">throws</span> Throwable {</span><br><span class="line">        BIZ_ERROR_LOG.debug(<span class="string">"start MenuBalanceLogAspect"</span>);</span><br><span class="line">        <span class="type">String</span> <span class="variable">argJson</span> <span class="operator">=</span> StringUtils.EMPTY;</span><br><span class="line">        <span class="keyword">if</span> (ArrayUtils.isNotEmpty(pjp.getArgs())) {</span><br><span class="line">            List&lt;String&gt; argStringList = Arrays.stream(pjp.getArgs())</span><br><span class="line">                    .map(JSON::toJSONString)</span><br><span class="line">                    .collect(Collectors.toList());</span><br><span class="line">            argJson = String.join(<span class="string">","</span>, argStringList);</span><br><span class="line">        }</span><br><span class="line"></span><br><span class="line">        BIZ_ERROR_LOG.info(<span class="string">"access {}#{},{}"</span>, pjp.getTarget().getClass().getSimpleName(), pjp.getSignature().getName(), argJson);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> pjp.proceed();</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">}</span><br><span class="line"></span><br></pre></td></tr></tbody></table></figure>
<h1 id="一、概述"><a href="#一、概述" class="headerlink" title="一、概述"></a>一、概述</h1><p><strong>AOP:</strong><br>⾯向切⾯编程，让程序员关注于类中方法的某个切点上<br>在不改变原有业务逻辑情况下，增强横切逻辑代码，根本上解耦合，避免横切逻辑代码重复<br>默认情况下，Spring 会根据被代理对象是否实现接⼝来选择使⽤ JDK 还是 CGLIB。当被代理对象没有实现 任何接⼝时，Spring 会选择 CGLIB。当被代理对象实现了接⼝，Spring 会选择 JDK 官⽅的代理技术，不过 我们可以通过配置的⽅式，让 Spring 强制使⽤ CGLIB。</p>
<ul>
<li><strong>通知（Advice）：</strong>通知定义了切面是什么以及何时使用。除了描述切面要完成的工作，通知还解决了何时执行这个工作的问题<ul>
<li><strong>前置通知（@Before）：</strong>在目标方法被调用之前调用通知功能</li>
<li><strong>后置通知（@After）：</strong>在目标方法完成之后调用通知，此时不会关心方法的输出是什么</li>
<li><strong>返回通知（@AfterReturning）：</strong>在目标方法成功执行之后调用通知</li>
<li><strong>异常通知（@AfterThrowing）：</strong>在目标方法抛出异常后调用通知</li>
<li><strong>环绕通知（@Around）：</strong>通知包裹了被通知的方法，在被通知的方法调用之前和调用之后执行自定义的行为</li>
</ul>
</li>
<li><strong>连接点（Joinpoint）：</strong>要增强代码的地方（方法开始、结束、异常时等时机点）。只是候选点，最终是否增强代码得看后续逻辑</li>
<li><strong>切点（Pointcut）：</strong>已经把增强代码加入到业务主线之后的连接点</li>
<li><strong>引入：</strong>引入允许我们向现有的类添加新方法或属性</li>
<li><strong>织入（Weaving）：</strong>把增强应用到目标对象老创建新的代理对象的过程。Spring 采用动态代理织入，而 Aspect 采用编译期织入和类装载期织入</li>
<li><strong>切面（Aspect）：</strong>切面 = 通知 + 切点。通知和切点共同定义了切面的全部内容 </li>
</ul>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">&lt;dependency&gt;</span><br><span class="line">    &lt;groupId&gt;org.springframework&lt;/groupId&gt;</span><br><span class="line">    &lt;artifactId&gt;spring-aop&lt;/artifactId&gt;</span><br><span class="line">    &lt;version&gt;<span class="number">5.1</span><span class="number">.12</span>.RELEASE&lt;/version&gt;</span><br><span class="line">&lt;/dependency&gt;</span><br><span class="line">&lt;dependency&gt;</span><br><span class="line">    &lt;groupId&gt;org.aspectj&lt;/groupId&gt;</span><br><span class="line">    &lt;artifactId&gt;aspectjweaver&lt;/artifactId&gt;</span><br><span class="line">    &lt;version&gt;<span class="number">1.8</span><span class="number">.13</span>&lt;/version&gt;</span><br><span class="line">&lt;/dependency&gt;</span><br></pre></td></tr></tbody></table></figure>
<h1 id="二、切点"><a href="#二、切点" class="headerlink" title="二、切点"></a>二、切点</h1><p>Spring 借助 AspectJ 的切点表达式语言来定义 Spring 切面</p>
<table>
<thead>
<tr>
<th><strong>AspectJ 指示器</strong></th>
<th><strong>描述</strong></th>
</tr>
</thead>
<tbody><tr>
<td> arg()</td>
<td> 限制连接点匹配参数为指定类型的执行方法</td>
</tr>
<tr>
<td> @args()</td>
<td> 限制连接点匹配参数由指定注解标注的执行方法</td>
</tr>
<tr>
<td> execution()</td>
<td> 用于匹配是连接点的执行方法</td>
</tr>
<tr>
<td> this()</td>
<td> 限制连接点匹配 AOP 代理的 bean 引用为指定类型的类</td>
</tr>
<tr>
<td> target</td>
<td> 限制连接点匹配目标对象为指定类型的类</td>
</tr>
<tr>
<td> @target()</td>
<td> 限制连接点匹配特定的执行对象，这些对象对应的类要具有指定类型的注解</td>
</tr>
<tr>
<td> within()</td>
<td> 限制连接点匹配指定的类型</td>
</tr>
<tr>
<td> @within()</td>
<td> 限制连接点匹配指定注解锁标注的类型（当使用 Spring AOP 时，方法定义在由指定的注解所标注的类里）</td>
</tr>
<tr>
<td>@annotation</td>
<td> 限定匹配带有指定注解的连接点</td>
</tr>
</tbody></table>
<p><br><img data-src="https://ccomma-pic-storage.oss-cn-hangzhou.aliyuncs.com/img/3e50af79311608e8c1970b9f7411403b.png" alt="image.png"></p>
<h2 id="1-限定-Bean-的-ID"><a href="#1-限定-Bean-的-ID" class="headerlink" title="1. 限定 Bean 的 ID"></a>1. 限定 Bean 的 ID</h2><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">execution(* concert.Performance.perform()) and <span class="title function_">bean</span><span class="params">(<span class="string">'woodstock'</span>)</span></span><br></pre></td></tr></tbody></table></figure>
<h2 id="2-通过注解定义"><a href="#2-通过注解定义" class="headerlink" title="2. 通过注解定义"></a>2. 通过注解定义</h2><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Pointcut("execution(** concert.Performance.perform(..))")</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">performance</span><span class="params">()</span> {}</span><br><span class="line"></span><br><span class="line"><span class="meta">@Before("performance()")</span> </span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">silenceCellPhones</span><span class="params">()</span> {    </span><br><span class="line">    System.out.println(<span class="string">"Silencing cell phones"</span>); </span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<h2 id="3-使用参数化通知"><a href="#3-使用参数化通知" class="headerlink" title="3. 使用参数化通知"></a>3. 使用参数化通知</h2><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Player.play(int)：被通知方法的参数类型 </span></span><br><span class="line"><span class="comment">// args(trackNumber)：被通知方法参数传递给通知方法中的 trackNumber 形参，即 pointcut 方法中的 trackNumber </span></span><br><span class="line"><span class="meta">@Pointcut("execution(* com.san.spring.aop.Player.play(int)) &amp;&amp; args(trackNumber)")</span> </span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">pointcut</span><span class="params">(<span class="type">int</span> trackNumber)</span> {} </span><br><span class="line"></span><br><span class="line"><span class="meta">@Around("pointcut(trackNumber)")</span> </span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">countTrack</span><span class="params">(ProceedingJoinPoint pjp, <span class="type">int</span> trackNumber)</span> {    </span><br><span class="line">    <span class="keyword">try</span> {        </span><br><span class="line">        pjp.proceed();        </span><br><span class="line">        <span class="type">int</span> <span class="variable">currentCount</span> <span class="operator">=</span> getTrackCurrentCount(trackNumber);        </span><br><span class="line">        map.put(trackNumber, ++currentCount);    </span><br><span class="line">    } <span class="keyword">catch</span> (Throwable e) {        </span><br><span class="line">        ...    </span><br><span class="line">    } </span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<h1 id="三、创建切面"><a href="#三、创建切面" class="headerlink" title="三、创建切面"></a>三、创建切面</h1><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Aspect</span></span><br><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Audience</span> {</span><br><span class="line">    <span class="meta">@Before("execution(** cocert.Performance.perform(..))")</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">silenceCellPhones</span><span class="params">()</span> {</span><br><span class="line">        System.out.println(<span class="string">"Silencing cell phones"</span>);</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Before("execution(** concert.Performance.perform(..))")</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">takeSeats</span><span class="params">()</span> {</span><br><span class="line">        System.out.println(<span class="string">"Taking seats"</span>);</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="meta">@AfterReturning("execution(** concert.Performance.perform(..))")</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">applause</span><span class="params">()</span> {</span><br><span class="line">        System.out.println(<span class="string">"CLAP CLAP CLAP!!!"</span>);</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="meta">@AfterThrowing("execution(** concert.Performance.perform(..))")</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">demandRefund</span><span class="params">()</span> {</span><br><span class="line">        System.out.println(<span class="string">"Demanding a refund"</span>);</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Around("performance()")</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">watchPerformance</span><span class="params">(ProceedingJoinPoint jp)</span> {</span><br><span class="line">        <span class="keyword">try</span> {</span><br><span class="line">            System.out.println(<span class="string">"Silencing cell phones"</span>);</span><br><span class="line">            System.out.println(<span class="string">"Taking seats"</span>);</span><br><span class="line">            <span class="comment">// 执行目标方法</span></span><br><span class="line">            jp.proceed();</span><br><span class="line">            System.out.println(<span class="string">"CLAP CLAP CLAP!!!"</span>);</span><br><span class="line">        } <span class="keyword">catch</span> (Throwable e) {</span><br><span class="line">            System.out.println(<span class="string">"Demanding a refund"</span>);</span><br><span class="line">        }</span><br><span class="line">    }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<h2 id="1-使用自动代理"><a href="#1-使用自动代理" class="headerlink" title="1. 使用自动代理"></a>1. 使用自动代理</h2><p><strong>JavaConfig：</strong></p>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="meta">@EnableAspectJAutoProxy</span></span><br><span class="line"><span class="meta">@ComponentScan</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ConcertConfig</span> {</span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="keyword">public</span> Audience <span class="title function_">audience</span><span class="params">()</span> {</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">Audience</span>();    </span><br><span class="line">    }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>


<p><strong>XML：</strong></p>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">&lt;?xml version=<span class="string">"1.0"</span> encoding=<span class="string">"UTF-8"</span>?&gt;</span><br><span class="line">&lt;beans xmlns=<span class="string">"http://www.springframework.org/schema/beans"</span></span><br><span class="line">    xmlns:xsi=<span class="string">"http://www.w3.org/2001/XMLSchema-instance"</span></span><br><span class="line">    xmlns:context=<span class="string">"http://www.springframework.org/schema/aop"</span></span><br><span class="line">    xsi:schemaLocation=<span class="string">"http://www.springframework.org/schema/aop</span></span><br><span class="line"><span class="string">        http://www.springframework.org/schema/aop/spring-aop.xsd</span></span><br><span class="line"><span class="string">        http://www.springframework.org/schema/beans</span></span><br><span class="line"><span class="string">        http://www.springframework.org/schema/beans/spring-beans.xsd</span></span><br><span class="line"><span class="string">        http://www.springframework.org/schema/context</span></span><br><span class="line"><span class="string">        http://www.springframework.org/schema/context/spring-context.xsd"</span>&gt;</span><br><span class="line">        </span><br><span class="line">    &lt;context:component-scan base-<span class="keyword">package</span>=<span class="string">"concert"</span> /&gt;</span><br><span class="line">    &lt;aop:aspectj-autoproxy /&gt;</span><br><span class="line">    &lt;bean class=<span class="string">"concert.Audience"</span> /&gt;</span><br><span class="line">&lt;/beans&gt;</span><br></pre></td></tr></tbody></table></figure>
<h2 id="2-在-XML-中声名切面"><a href="#2-在-XML-中声名切面" class="headerlink" title="2. 在 XML 中声名切面"></a>2. 在 XML 中声名切面</h2><table>
<thead>
<tr>
<th><strong>AOP 配置元素</strong></th>
<th><strong>用途 </strong></th>
</tr>
</thead>
<tbody><tr>
<td><a href="aop:advisor">aop:advisor</a></td>
<td> 定义 AOP 通知器 </td>
</tr>
<tr>
<td><a href="aop:after">aop:after</a></td>
<td> 定义 AOP 后置通知 </td>
</tr>
<tr>
<td><a href="aop:after-returning">aop:after-returning</a></td>
<td> 定义 AOP 返回通知 </td>
</tr>
<tr>
<td><a href="aop:after-throwing">aop:after-throwing</a></td>
<td> 定义 AOP 异常通知 </td>
</tr>
<tr>
<td><a href="aop:around">aop:around</a></td>
<td> 定义 AOP 环绕通知 </td>
</tr>
<tr>
<td><a href="aop:aspect">aop:aspect</a></td>
<td> 定义一个切面 </td>
</tr>
<tr>
<td><a href="aop:aspectj-autoproxy">aop:aspectj-autoproxy</a></td>
<td> 启用 @AspectJ <br> 注解驱动的切面 </td>
</tr>
<tr>
<td><a href="aop:before">aop:before</a></td>
<td> 定义一个 AOP 前置通知 </td>
</tr>
<tr>
<td><a href="aop:config">aop:config</a></td>
<td> 顶级的 AOP 配置元素。大多数的 <a href="aop:*">aop:*</a> 元素必须包含在 <a href="aop:config">aop:config</a> 元素内 </td>
</tr>
<tr>
<td><a href="aop:declare-parents">aop:declare-parents</a></td>
<td> 以透明的方式为被通知的对象引入额外的接口 </td>
</tr>
<tr>
<td><a href="aop:pointcut">aop:pointcut</a></td>
<td> 定义一个切点</td>
</tr>
</tbody></table>
<p><em>具体方法：</em></p>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Audience</span> {    </span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">silenceCellPhones</span><span class="params">()</span> {        </span><br><span class="line">        System.out.println(<span class="string">"Silencing cell phones"</span>);    </span><br><span class="line">    }        </span><br><span class="line">    </span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">takeSeats</span><span class="params">()</span> {        </span><br><span class="line">        System.out.println(<span class="string">"Taking seats"</span>);    </span><br><span class="line">    }        </span><br><span class="line">    </span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">applause</span><span class="params">()</span> {        </span><br><span class="line">        System.out.println(<span class="string">"CLAP CLAP CLAP!!!"</span>);    </span><br><span class="line">    }        </span><br><span class="line">    </span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">demandRefund</span><span class="params">()</span> {        </span><br><span class="line">        System.out.println(<span class="string">"Demanding a refund"</span>);    </span><br><span class="line">    }        </span><br><span class="line">    </span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">watchPerformance</span><span class="params">(ProceedingJoinPoint jp)</span> {        </span><br><span class="line">        <span class="keyword">try</span> {            </span><br><span class="line">            System.out.println(<span class="string">"Silencing cell phones"</span>);            </span><br><span class="line">            System.out.println(<span class="string">"Taking seats"</span>);            </span><br><span class="line">            <span class="comment">// 执行目标方法            </span></span><br><span class="line">            jp.proceed();            </span><br><span class="line">            System.out.println(<span class="string">"CLAP CLAP CLAP!!!"</span>);        </span><br><span class="line">        } <span class="keyword">catch</span> (Throwable e) {            </span><br><span class="line">            System.out.println(<span class="string">"Demanding a refund"</span>);        </span><br><span class="line">        }    </span><br><span class="line">    } </span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<p><em>XML 配置：</em></p>
<figure class="highlight xml"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">aop:config</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">aop:aspect</span> <span class="attr">ref</span>=<span class="string">"audience"</span>&gt;</span></span><br><span class="line">        <span class="comment">&lt;!-- 切点 --&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">aop:pointcut</span> <span class="attr">id</span>=<span class="string">"performance"</span> <span class="attr">expression</span>=<span class="string">"execution(** concert.Performance.perform(..))"</span>/&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">aop:before</span> <span class="attr">pointcut-ref</span>=<span class="string">"performance"</span> <span class="attr">method</span>=<span class="string">"silenceCellPhones"</span>/&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">aop:before</span> <span class="attr">pointcut-ref</span>=<span class="string">"performance"</span> <span class="attr">method</span>=<span class="string">"takeSeats"</span>/&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">aop:after-returning</span> <span class="attr">pointcut</span>=<span class="string">"execution(** concert.Performance.perform(..))"</span> <span class="attr">method</span>=<span class="string">"applause"</span>/&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">aop:after-throwing</span> <span class="attr">pointcut</span>=<span class="string">"execution(** concert.Performance.perform(..))"</span> <span class="attr">method</span>=<span class="string">"demandRefund"</span>/&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">aop:around</span> <span class="attr">pointcut-ref</span>=<span class="string">"performance"</span> <span class="attr">method</span>=<span class="string">"watchPerformance"</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">aop:aspect</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">aop:config</span>&gt;</span></span><br></pre></td></tr></tbody></table></figure>

<h3 id="2-1-为通知传递参数-——-XML"><a href="#2-1-为通知传递参数-——-XML" class="headerlink" title="2.1. 为通知传递参数 —— XML"></a>2.1. 为通知传递参数 —— XML</h3><p><em>具体方法：</em></p>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">TrackCounter</span> {    </span><br><span class="line">    <span class="keyword">private</span> Map&lt;Integer, Integer&gt; trackCounts = <span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;&gt;();    </span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">countTrack</span><span class="params">(<span class="type">int</span> trackNumber)</span> {        </span><br><span class="line">        <span class="type">int</span> <span class="variable">currentCount</span> <span class="operator">=</span> getPlayCount(trackNumber);        </span><br><span class="line">        trackCounts.put(trackNumber, currentCount + <span class="number">1</span>);    </span><br><span class="line">    }    </span><br><span class="line">    <span class="keyword">public</span> <span class="type">int</span> <span class="title function_">getPlayCount</span><span class="params">(<span class="type">int</span> trackNumber)</span> {        </span><br><span class="line">        <span class="keyword">return</span> trackCounts.containsKey(trackNumber) ? trackCounts.get(trackNumber) : <span class="number">0</span>;    </span><br><span class="line">    } </span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<p><em>XML 配置：</em></p>
<figure class="highlight xml"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">aop:config</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">aop:aspect</span> <span class="attr">ref</span>=<span class="string">"trackCounter"</span>&gt;</span></span><br><span class="line">        <span class="comment">&lt;!-- 切点 --&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">aop:pointcut</span> <span class="attr">id</span>=<span class="string">"trackPlayed"</span> <span class="attr">expression</span>=<span class="string">"execution(* soundsystem.CompactDisc.playTrack(int)) </span></span></span><br><span class="line"><span class="string"><span class="tag">            and args(trackNumber)"</span>/&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">aop:before</span> <span class="attr">pointcut-ref</span>=<span class="string">"trackPlayed"</span> <span class="attr">method</span>=<span class="string">"countTrack"</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">aop:aspect</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">aop:config</span>&gt;</span></span><br></pre></td></tr></tbody></table></figure>

<h3 id="2-2-通过切面引入新的功能-——-XML"><a href="#2-2-通过切面引入新的功能-——-XML" class="headerlink" title="2.2. 通过切面引入新的功能 —— XML"></a>2.2. 通过切面引入新的功能 —— XML</h3><ul>
<li><strong>type-matching：</strong> 指定目标接口</li>
<li><strong> implement-interface：</strong> 指定要增加的方法所在的接口</li>
<li><strong> default-impl：</strong> 指定要增加的方法的实现，也可以由 delegate-ref=”beanID” 来代替从而导入 Spring 容器中的 Bean</li>
</ul>
<figure class="highlight xml"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">aop:aspect</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">aop:declare-parents</span> </span></span><br><span class="line"><span class="tag">        <span class="attr">types-matching</span>=<span class="string">"concert.Performance+"</span></span></span><br><span class="line"><span class="tag">        <span class="attr">implement-interface</span>=<span class="string">"concert.Encoreable"</span></span></span><br><span class="line"><span class="tag">        <span class="attr">default-impl</span>=<span class="string">"concert.DefaultEncoreable"</span>/&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">aop:aspect</span>&gt;</span></span><br></pre></td></tr></tbody></table></figure>
<h1 id="四、通过注解引入新功能"><a href="#四、通过注解引入新功能" class="headerlink" title="四、通过注解引入新功能"></a>四、通过注解引入新功能</h1><p><img data-src="https://ccomma-pic-storage.oss-cn-hangzhou.aliyuncs.com/img/c6f1f9cff941eeb554ecd0dd4ebac000.png"></p>
<p>通过建立一个代理类同时代理 A 和 B，调用者调用该代理时，就可以同时 A 和 B 中的方法了。</p>
<p><em>目标类：</em></p>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Women</span> <span class="keyword">implements</span> <span class="title class_">Person</span> {</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">likePerson</span><span class="params">()</span> {</span><br><span class="line">        System.out.println(<span class="string">"我是女生，我喜欢帅哥"</span>);</span><br><span class="line">    }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<p><em>被引入的类：</em></p>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">FemaleAnimal</span> <span class="keyword">implements</span> <span class="title class_">Animal</span> {</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">eat</span><span class="params">()</span> {</span><br><span class="line">        System.out.println(<span class="string">"我是雌性，我比雄性更喜欢吃零食"</span>);</span><br><span class="line">    }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<p><em>切面：</em></p>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Aspect</span></span><br><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">AspectConfig</span> {</span><br><span class="line">    <span class="comment">// "+"表示 person 的所有子类；defaultImpl 表示默认需要添加的新的类</span></span><br><span class="line">    <span class="meta">@DeclareParents(value = "com.ccomma.annotation.Person+", defaultImpl = FemaleAnimal.class)</span></span><br><span class="line">    <span class="keyword">public</span> Animal animal;</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<h1 id="五、源码"><a href="#五、源码" class="headerlink" title="五、源码"></a>五、源码</h1><ul>
<li>在 bean 的后初始化方法（后置处理器）applyBeanPostProcessorsAfterInitialization 中执行了 AbstractAutoProxyCreator#postProcessAfterInitialization 方法<ul>
<li>内部执行了 AbstractAutoProxyCreator#wrapIfNecessary 方法<ul>
<li> getAdvicesAndAdvisorsForBean：查找出和当前 bean 匹配的 advisor</li>
<li>AbstractAutoProxyCreator#createProxy：把委托对象的 aop 增强和通用拦截进行合并，最终给代理对象，内部通过代理工厂 ProxyFactory#getProxy 创建代理<ul>
<li>代理工厂内部最终调用 DefaultAopProxyFactory#createAopProxy 来依据情况创建 jdk 代理或 cglib 代理</li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
</ul>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="https://ccomma.cn/e3b16e356deb/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/ccomma.png">
      <meta itemprop="name" content="CComma">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="CComma's Blog">
      <meta itemprop="description" content="下一个目标：改变世界！">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | CComma's Blog">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/e3b16e356deb/" class="post-title-link" itemprop="url">Spring Boot 知识点</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>

      <time title="Created: 2019-06-09 19:33:23" itemprop="dateCreated datePublished" datetime="2019-06-09T19:33:23+08:00">2019-06-09</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">In</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/Spring/" itemprop="url" rel="index"><span itemprop="name">Spring</span></a>
        </span>
    </span>

  
  
  <span class="post-meta-item">
    
      <span class="post-meta-item-icon">
        <i class="far fa-comment"></i>
      </span>
      <span class="post-meta-item-text">Disqus: </span>
    
    <a title="disqus" href="/e3b16e356deb/#disqus_thread" itemprop="discussionUrl">
      <span class="post-comments-count disqus-comment-count" data-disqus-identifier="e3b16e356deb/" itemprop="commentCount"></span>
    </a>
  </span>
  
  
    <span class="post-meta-item" title="Reading time">
      <span class="post-meta-item-icon">
        <i class="far fa-clock"></i>
      </span>
      <span class="post-meta-item-text">Reading time &asymp;</span>
      <span>7 mins.</span>
    </span>
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h1 id="约定优于配置"><a href="#约定优于配置" class="headerlink" title="约定优于配置"></a>约定优于配置</h1><h1 id="Spring-和-SpringBoot"><a href="#Spring-和-SpringBoot" class="headerlink" title="Spring 和 SpringBoot"></a>Spring 和 SpringBoot</h1><p>Spring 缺点：重配置<br>Spring Boot 优点</p>
<ul>
<li>起步依赖：将多个 maven 包的坐标整合到一起，并提供一些默认的功能</li>
<li>自动配置：会自动将一些配置类的 bean 注册进 IoC 容器</li>
</ul>
<h1 id="单元测试"><a href="#单元测试" class="headerlink" title="单元测试"></a>单元测试</h1><ul>
<li>@SpringBootTest：标记该类为 SpringBoot 单元测试类，并加载 applicationContext 上下文环境</li>
<li> @RunWith (SpringRunner.class)：测试启动器，并加载 SpringBoot 测试注解</li>
</ul>
<h1 id="热部署"><a href="#热部署" class="headerlink" title="热部署"></a>热部署</h1><p>依赖</p>
<figure class="highlight xml"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-devtools<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></tbody></table></figure>
<ol>
<li>IDEA 开启自动编译</li>
<li> Ctrl + Shift + Alt + /-&gt; Registry -&gt; compiler.automake.allow.when.app.running √：用于指定 IDEA 在程序运行过程中自动编译</li>
</ol>
<h1 id="配置"><a href="#配置" class="headerlink" title="配置"></a>配置</h1><h2 id="5-1-ConfigurationProperties"><a href="#5-1-ConfigurationProperties" class="headerlink" title="5.1 ConfigurationProperties"></a>5.1 <a target="_blank" rel="noopener" href="https://blog.csdn.net/yusimiao/article/details/97622666">ConfigurationProperties</a></h2><p>依赖包</p>
<figure class="highlight xml"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-configuration-processor<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">optional</span>&gt;</span>true<span class="tag">&lt;/<span class="name">optional</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></tbody></table></figure>
<pre><code>  -  [@ConfigurationProperties(prefix ](/ConfigurationProperties(prefix ) = "person")：将配置文件中以 person 开头的属性注入到类中  
</code></pre>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="meta">@ConfigurationProperties(prefix = "person")</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Person</span> {</span><br><span class="line">    <span class="keyword">private</span> <span class="type">int</span> id;</span><br><span class="line">    <span class="comment">// set and get</span></span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<ul>
<li><p><a href="/Value">@Value </a>  </p>
<ul>
<li>无需 set 方法 </li>
<li>不支持 Map、对象及行内写法 <figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Person</span> {</span><br><span class="line">    <span class="meta">@Value("${person.id}")</span></span><br><span class="line">    <span class="keyword">private</span> <span class="type">int</span> id;</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure></li>
</ul>
</li>
<li><p>@PropertySource：加载配置文件 </p>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="meta">@PropertySource("classpath:text.properties")</span></span><br><span class="line"><span class="meta">@ConfigurationProperties(prefix = "person")</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Person</span> {</span><br><span class="line">    <span class="keyword">private</span> <span class="type">int</span> id;</span><br><span class="line">    <span class="comment">// set and get</span></span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

</li>
<li><p>随机值设置<br>使用 Spring Boot 内嵌的 RandomValuePropertySource 类 </p>
<figure class="highlight properties"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">my.secret</span>=<span class="string">${random.value}</span></span><br><span class="line"><span class="attr">my.number</span>=<span class="string">${random.int} </span></span><br><span class="line"><span class="attr">my.bignumber</span>=<span class="string">${random.long} </span></span><br><span class="line"><span class="attr">my.uuid</span>=<span class="string">${random.uuid}</span></span><br><span class="line"><span class="comment"># 配置小于 10 的随机整数</span></span><br><span class="line"><span class="attr">my.number.less.than.ten</span>=<span class="string">${random.int(10)}</span></span><br><span class="line"><span class="comment"># 配置范围在 [1024,65536] 之间的随机整数</span></span><br><span class="line"><span class="attr">my.number.in.range</span>=<span class="string">${random.int[1024,65536]}</span></span><br></pre></td></tr></tbody></table></figure>

</li>
<li><p>参数引用 </p>
<figure class="highlight properties"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">app.name</span>=<span class="string">MyApp </span></span><br><span class="line"><span class="attr">app.description</span>=<span class="string">${app.name} is a Spring Boot application</span></span><br></pre></td></tr></tbody></table></figure></li>
</ul>
<h1 id="SpringBootApplication-源码"><a href="#SpringBootApplication-源码" class="headerlink" title="@SpringBootApplication 源码"></a>@SpringBootApplication 源码</h1><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Target({ElementType.TYPE})</span></span><br><span class="line"><span class="meta">@Retention(RetentionPolicy.RUNTIME)</span></span><br><span class="line"><span class="meta">@Documented</span></span><br><span class="line"><span class="meta">@Inherited</span></span><br><span class="line"><span class="comment">// 表明该类为配置类</span></span><br><span class="line"><span class="meta">@SpringBootConfiguration</span> </span><br><span class="line"><span class="comment">// 启用自动配置功能</span></span><br><span class="line"><span class="meta">@EnableAutoConfiguration</span> </span><br><span class="line"><span class="comment">// 包扫描</span></span><br><span class="line"><span class="meta">@ComponentScan(</span></span><br><span class="line"><span class="meta">	excludeFilters = {</span></span><br><span class="line"><span class="meta">        @Filter(type = FilterType.CUSTOM, classes = {TypeExcludeFilter.class}), </span></span><br><span class="line"><span class="meta">        @Filter( type = FilterType.CUSTOM, classes = {AutoConfigurationExcludeFilter.class})</span></span><br><span class="line"><span class="meta">    })</span></span><br><span class="line"><span class="keyword">public</span> <span class="meta">@interface</span> SpringBootApplication {</span><br><span class="line">    ...</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<ul>
<li><p>@SpringBootConfiguration<br>组合了 @Configuration，配置类 </p>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Target({ElementType.TYPE})</span> </span><br><span class="line"><span class="meta">@Retention(RetentionPolicy.RUNTIME)</span> </span><br><span class="line"><span class="comment">// 配置 IoC 容器</span></span><br><span class="line"><span class="meta">@Documented</span> </span><br><span class="line"><span class="meta">@Configuration</span> </span><br><span class="line"><span class="keyword">public</span> <span class="meta">@interface</span> SpringBootConfiguration { </span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

</li>
<li><p>@EnableAutoConfiguration </p>
<ul>
<li>@AutoConfigurationPackage：将 AutoConfigurationPackages.Registrar 类导入到 IoC 容器中。拿到启动类所在的包名 </li>
<li>@Import (AutoConfigurationImportSelector.class) ：将 AutoConfigurationImportSelector 类导入到 IoC 容器中。 <ul>
<li>AutoConfigurationMetadataLoader#loadMetadata：加载 spring-boot-autoconfigure.jar 依赖包中 <code>spring-autoconfigure-metadata.properties</code> 文件中的属性，其定义了各个自动配置类及其加载条件。最终生成 AutoConfigurationMetadata 对象。 </li>
<li>AutoConfigurationImportSelector#getAutoConfigurationEntry： <ol>
<li>AutoConfigurationImportSelector#getAttributes：获得注解的属性 </li>
<li><strong>AutoConfigurationImportSelector#getCandidateConfigurations：</strong> 获取默认支持的自动配置类名列表<br>Spring Boot 在启动的时候，使用内部工具类 SpringFactoriesLoader 查找 classpath 上所有 jar 包中的 <code>META-INF/spring.factories</code> 文件。找到将 key 为 <code>org.springframework.boot.autoconfigure.EnableAutoConfiguration</code> 的键值对，其值为多个工厂类名称。取出生成 <code>自动配置类名列表</code>。 </li>
<li>AutoConfigurationImportSelector#removeDuplicates：对 <code>自动配置类名列表</code> 去重 </li>
<li>AutoConfigurationImportSelector#getExclusions：得到需排除的自动配置类，后续操作对列表集合进行排除 </li>
<li>AutoConfigurationImportSelector#filter：根据配置类的 <a href="/ConditionalXXX">@ConditionalXXX </a> 注解指定的条件对列表集合进行筛选，并对 AutoConfigurationMetadataLoader#loadMetadata 生成的 AutoConfigurationMetadata 对象进行筛选  </li>
<li>AutoConfigurationImportSelector#fireAutoConfigurationImportEvents：将自动配置导入事件通知监听器。<br>过滤完成后会自动加载类路径下 Jar 包中 <code>META-INF/spring.factories</code> 文件中 AutoConfigurationImportListener 的实现类，并触发 fireAutoConfigurationImportEvents 事件。进行自动配置类的加载创建 </li>
</ol>
</li>
</ul>
</li>
</ul>
</li>
</ul>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Target(ElementType.TYPE)</span></span><br><span class="line"><span class="meta">@Retention(RetentionPolicy.RUNTIME)</span></span><br><span class="line"><span class="meta">@Documented</span></span><br><span class="line"><span class="meta">@Inherited</span></span><br><span class="line"><span class="comment">// 自动配置包：会把 @SpringbootApplication 注解标注的类所在包名拿到，并且对该包及其子包进行扫描，将组件添加到容器中</span></span><br><span class="line"><span class="meta">@AutoConfigurationPackage</span></span><br><span class="line"><span class="comment">// 可以帮助springboot应用将所有符合条件的@Configuration配置都加载到当前SpringBoot创建并使用的IoC容器(ApplicationContext)中</span></span><br><span class="line"><span class="meta">@Import(AutoConfigurationImportSelector.class)</span>  </span><br><span class="line"><span class="keyword">public</span> <span class="meta">@interface</span> EnableAutoConfiguration {</span><br><span class="line"></span><br><span class="line">	<span class="type">String</span> <span class="variable">ENABLED_OVERRIDE_PROPERTY</span> <span class="operator">=</span> <span class="string">"spring.boot.enableautoconfiguration"</span>;</span><br><span class="line"></span><br><span class="line">	Class&lt;?&gt;[] exclude() <span class="keyword">default</span> {};</span><br><span class="line"></span><br><span class="line">	String[] excludeName() <span class="keyword">default</span> {};</span><br><span class="line"></span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<h1 id="自定义-starter"><a href="#自定义-starter" class="headerlink" title="自定义 starter"></a>自定义 starter</h1><ul>
<li><p>导入依赖 </p>
<figure class="highlight xml"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependencies</span>&gt;</span> </span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span> </span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span> </span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-autoconfigure<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span> </span><br><span class="line">        <span class="tag">&lt;<span class="name">version</span>&gt;</span>2.2.2.RELEASE<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;/<span class="name">dependency</span>&gt;</span> </span><br><span class="line"><span class="tag">&lt;/<span class="name">dependencies</span>&gt;</span></span><br></pre></td></tr></tbody></table></figure>

</li>
<li><p>SimpleBean </p>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@EnableConfigurationProperties(SimpleBean.class)</span> </span><br><span class="line"><span class="meta">@ConfigurationProperties(prefix = "simplebean")</span> </span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">SimpleBean</span> {</span><br><span class="line">	<span class="keyword">private</span> <span class="type">int</span> id; </span><br><span class="line">    <span class="keyword">private</span> String name;</span><br><span class="line">    <span class="comment">// setter and getter</span></span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

</li>
<li><p>MyAutoConfiguration<br>@ConditionalOnClass：当类路径 classpath 下有指定的类的情况下才进行自动配置 </p>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="meta">@ConditionalOnClass(SimpleBean.class)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">MyAutoConfiguration</span> {</span><br><span class="line">	<span class="keyword">static</span> { </span><br><span class="line">        System.out.println(<span class="string">"MyAutoConfiguration init...."</span>); </span><br><span class="line">    }</span><br><span class="line">	<span class="meta">@Bean</span> <span class="keyword">public</span> SimpleBean <span class="title function_">simpleBean</span><span class="params">()</span>{ </span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">SimpleBean</span>();</span><br><span class="line">	} </span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

</li>
<li><p>resources 下创建 /META-INF/spring.factories </p>
<figure class="highlight properties"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">org.springframework.boot.autoconfigure.EnableAutoConfiguration</span>=<span class="string">\ com.ccomma.config.MyAutoConfiguration</span></span><br></pre></td></tr></tbody></table></figure></li>
</ul>
<h1 id="SpringApplication-run-源码"><a href="#SpringApplication-run-源码" class="headerlink" title="SpringApplication#run 源码"></a>SpringApplication#run 源码</h1><ul>
<li>静态方法 SpringApplication#run <ul>
<li>创建 SpringApplication 实例：new SpringApplication (primarySources)，其中 primarySources 为启动类的 Class 对象 <ol>
<li>存储项目启动类的 Class 对象至属性字段中</li>
<li>设置应用类型是 SERVLET 应用（Spring 5 之前的传统 MVC 应用）还是 REACTIVE 应用（Spring 5 开始出现的 WebFlux 交互式应用）</li>
<li>SpringApplication#getSpringFactoriesInstances (ApplicationContextInitializer.class)：在 <code>spring.factories</code> 中获取以 ApplicationContextInitializer 全类名为键的所有值（值为初始化器的全类名），并创建实例返回。即返回了 ApplicationContextInitializer 这一类的所有初始化器实例。然后进行设置</li>
<li> SpringApplication#getSpringFactoriesInstances (ApplicationListener.class)：同上，获取 ApplicationListener 这一键下的所有监听器并进行设置</li>
<li>初始化 mainApplicationClass 属性：用于推断并设置项目 main () 方法启动的主程序启动类</li>
</ol>
</li>
<li>调用 SpringApplication 实例的 run 方法 <ol>
<li>获取并启动监听器：调用 SpringApplication#getRunListeners 方法从 <code>spring.factories</code> 中获取键为 SpringApplicationRunListener.class 的所有值（全类名），放入 SpringApplicationRunListeners 对象中，并调用其 starting 方法启动监听器</li>
<li>项目运行环境 Environment 的预配置：调用 SpringApplication#prepareEnvironment 方法创建并配置当前 SpringBoot 应用将要使用的 Environment，并遍历调用所有的 SpringApplicationRunListener 的 environmentPrepared () 方法。最后调用 SpringApplication#configureIgnoreBeanInfo 配置环境 <ol>
<li>SpringApplication#getOrCreateEnvironment：获取或创建环境</li>
<li> SpringApplication#configureEnvironment：配置环境。配置 PropertySources 和 Active Profiles</li>
<li>SpringApplicationRunListeners#environmentPrepared：Listeners 环境准备（广播 ApplicationEnvironmentPreparedEvent 事件）</li>
<li>SpringApplication#bindToSpringApplication：将环境绑定到 SpringApplication 中</li>
</ol>
</li>
<li>创建 Spring 容器：调用 SpringApplication#createApplicationContext 创建一个 AnnotationConfigServletWebServerApplicationContext 容器</li>
<li>获得异常报告器（SpringBootExceptionReporter 集合）：调用 SpringApplication#getSpringFactoriesInstances 从 <code>spring.factories</code> 中获取键为 BootExceptionReporter.class 的所有类，即所有异常报告器</li>
<li> Spring 容器前置处理：调用 SpringApplication#prepareContext 方法，在容器刷新之前的准备动作，比如触发监听器的响应事件、加载资源、设置上下文环境等。并将启动类注入容器为后续开启自动化配置奠定基础 <ol>
<li>SpringApplication#load：将启动类注入容器，为后续开启自动化配置奠定基础</li>
</ol>
</li>
<li>刷新容器：调用 SpringApplication#refreshContext <ol>
<li>SpringApplication#refresh：初始化 IoC 容器，包括 Bean 资源的定位、解析、注册等</li>
<li> ConfigurableApplicationContext#registerShutdownHook：注册 JVM 关闭钩子。在 JVM 关机时关闭这个上下文</li>
</ol>
</li>
<li> Spring 容器后置处理：钩子，无实现可拓展</li>
<li>发出结束执行的事件通知：调用 SpringApplicationRunListeners#started 方法执行所有监听器的 SpringApplicationRunListener#started 方法</li>
<li> SpringApplication#callRunners：获取并执行 ApplicationRunner 和 CommandLineRunner 的所有实现类。Runner 运行器用于在服务启动时进行一些业务初始化操作，这些操作只在服务启动后执行一次。Spring Boot 提供了 ApplicationRunner 和 CommandLineRunner 两种服务接口</li>
<li>发布应用上下文就绪事件：调用 SpringApplicationRunListeners#running 方法来持续运行配置好的应用上下文 ApplicationContext</li>
</ol>
</li>
</ul>
</li>
</ul>
<h1 id="缓存管理"><a href="#缓存管理" class="headerlink" title="缓存管理"></a>缓存管理</h1><ul>
<li>注解方式：未使用缓存管理器则默认使用 Simple 缓存组件进行缓存 <ul>
<li><p><a href="/EnableCaching">@EnableCaching </a>  </p>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@EnableCaching</span></span><br><span class="line"><span class="meta">@SpringBootApplication</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Springboot04CacheApplication</span> {</span><br><span class="line">  </span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> { </span><br><span class="line">        SpringApplication.run(Springboot04CacheApplication.class, args);</span><br><span class="line">    } </span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

</li>
<li><p>@Cacheable：缓存数据，用于查询方法</p>
</li>
</ul>
</li>
</ul>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Cacheable(cacheNames = "comment")</span> </span><br><span class="line"><span class="keyword">public</span> Comment <span class="title function_">findById</span><span class="params">(<span class="type">int</span> comment_id)</span>{ </span><br><span class="line">    Optional&lt;Comment&gt; optional = commentRepository.findCommentById(comment_id); </span><br><span class="line">    <span class="keyword">if</span>(optional.isPresent()){ </span><br><span class="line">        <span class="keyword">return</span> optional.get();</span><br><span class="line">    } </span><br><span class="line">    <span class="keyword">return</span> <span class="literal">null</span>; </span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<pre><code>  -  @CachePut：更新数据库后更新缓存，用于更新方法 
  -  @CacheEvict：删除数据库数据后删除缓存，用于删除方法 
</code></pre>
<ul>
<li><p>API 方式 </p>
<ul>
<li>RedisTemplate <figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Service</span> </span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ApiCommentService</span> {</span><br><span class="line">	<span class="meta">@Autowired</span> </span><br><span class="line">    <span class="keyword">private</span> CommentRepository commentRepository;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span> </span><br><span class="line">    <span class="keyword">private</span> RedisTemplate redisTemplate;</span><br><span class="line">    </span><br><span class="line">	<span class="keyword">public</span> Comment <span class="title function_">findCommentById</span><span class="params">(Integer id)</span> {</span><br><span class="line">		<span class="type">Object</span> <span class="variable">o</span> <span class="operator">=</span> redisTemplate.opsForValue().get(<span class="string">"comment_"</span> + id); </span><br><span class="line">    	<span class="keyword">if</span> (o != <span class="literal">null</span>) { </span><br><span class="line">            <span class="keyword">return</span> (Comment) o;</span><br><span class="line">		} <span class="keyword">else</span> { </span><br><span class="line">            <span class="comment">// 缓存中没有，从数据库中查询</span></span><br><span class="line">            Optional&lt;Comment&gt; byId = commentRepository.findById(id);</span><br><span class="line">            <span class="keyword">if</span> (byId.isPresent()) {</span><br><span class="line">                <span class="type">Comment</span> <span class="variable">comment</span> <span class="operator">=</span> byId.get();</span><br><span class="line">                <span class="comment">// 将查询结果存入到缓存中</span></span><br><span class="line">				redisTemplate.opsForValue().set(<span class="string">"comment_"</span>+id,comment,<span class="number">1</span>,TimeUnit.DAYS); </span><br><span class="line">                <span class="keyword">return</span> comment;</span><br><span class="line">			} <span class="keyword">else</span> { </span><br><span class="line">                <span class="keyword">return</span> <span class="literal">null</span>; </span><br><span class="line">            } </span><br><span class="line">        } </span><br><span class="line">    }</span><br><span class="line">    </span><br><span class="line">	<span class="keyword">public</span> Comment <span class="title function_">updateComment</span><span class="params">(Comment comment)</span> { </span><br><span class="line">        commentRepository.updateComment(comment.getAuthor(), comment.getaId()); </span><br><span class="line">        <span class="comment">// 更新数据后进行缓存更新</span></span><br><span class="line">        redisTemplate.opsForValue().set(<span class="string">"comment_"</span>+comment.getId(),comment); </span><br><span class="line">        <span class="keyword">return</span> comment;</span><br><span class="line">	} </span><br><span class="line">    </span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">deleteComment</span><span class="params">(<span class="type">int</span> comment_id)</span> {</span><br><span class="line">		commentRepository.deleteById(comment_id); </span><br><span class="line">        redisTemplate.delete(<span class="string">"comment_"</span>+comment_id);</span><br><span class="line">	}</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure></li>
</ul>
</li>
<li><p>自定义 Redis 缓存序列化机制 </p>
<ul>
<li>RedisTemplate#afterPropertiesSet 方法中判断如果默认序列化参数 defaultSerializer 为空，则指定 JdkSerializationRedisSerializer 为默认序列化方式，所以进行缓存的实体类必须实现 Serializable 接口 </li>
<li>RedisConfig <figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Configuration</span> </span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">RedisConfig</span> {</span><br><span class="line">	</span><br><span class="line">    <span class="meta">@Bean</span> </span><br><span class="line">    <span class="keyword">public</span> RedisTemplate&lt;Object, Object&gt; <span class="title function_">redisTemplate</span><span class="params">(RedisConnectionFactory redisConnectionFactory)</span> { </span><br><span class="line">        RedisTemplate&lt;Object, Object&gt; template = <span class="keyword">new</span> <span class="title class_">RedisTemplate</span>(); </span><br><span class="line">        template.setConnectionFactory(redisConnectionFactory); </span><br><span class="line">        <span class="comment">// 使用 Json 格式序列化对象，对缓存数据 key 和 value 进行转换</span></span><br><span class="line">        <span class="type">Jackson2JsonRedisSerializer</span> <span class="variable">jacksonSeial</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Jackson2JsonRedisSerializer</span>(Object.class);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 解决查询缓存转换异常的问题</span></span><br><span class="line">        <span class="type">ObjectMapper</span> <span class="variable">om</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ObjectMapper</span>(); </span><br><span class="line">        om.setVisibility(PropertyAccessor.ALL, JsonAutoDetect.Visibility.ANY); </span><br><span class="line">        om.enableDefaultTyping(ObjectMapper.DefaultTyping.NON_FINAL); </span><br><span class="line">        jacksonSeial.setObjectMapper(om); </span><br><span class="line">        <span class="comment">// 设置 RedisTemplate 模版 API 的序列化方式为 Jsonz</span></span><br><span class="line">        template.setDefaultSerializer(jacksonSeial); <span class="keyword">return</span> template;</span><br><span class="line">	}</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure></li>
</ul>
</li>
</ul>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




  <nav class="pagination">
    <a class="extend prev" rel="prev" title="Previous page" aria-label="Previous page" href="/page/10/"><i class="fa fa-angle-left"></i></a><a class="page-number" href="/">1</a><span class="space">&hellip;</span><a class="page-number" href="/page/10/">10</a><span class="page-number current">11</span><a class="page-number" href="/page/12/">12</a><a class="extend next" rel="next" title="Next page" aria-label="Next page" href="/page/12/"><i class="fa fa-angle-right"></i></a>
  </nav>

</div>
  </main>

  <footer class="footer">
    <div class="footer-inner">

  <div class="copyright">
    &copy; 
    <span itemprop="copyrightYear">2024</span>
    <span class="with-love">
      <i class="fa fa-heart"></i>
    </span>
    <span class="author" itemprop="copyrightHolder">CComma</span>
  </div>
<div class="busuanzi-count">
    <span class="post-meta-item" id="busuanzi_container_site_uv">
      <span class="post-meta-item-icon">
        <i class="fa fa-user"></i>
      </span>
      <span class="site-uv" title="Total Visitors">
        <span id="busuanzi_value_site_uv"></span>
      </span>
    </span>
    <span class="post-meta-item" id="busuanzi_container_site_pv">
      <span class="post-meta-item-icon">
        <i class="fa fa-eye"></i>
      </span>
      <span class="site-pv" title="Total Views">
        <span id="busuanzi_value_site_pv"></span>
      </span>
    </span>
</div>

    </div>
  </footer>

  
  <div class="toggle sidebar-toggle" role="button">
    <span class="toggle-line"></span>
    <span class="toggle-line"></span>
    <span class="toggle-line"></span>
  </div>
  <div class="sidebar-dimmer"></div>
  <div class="back-to-top" role="button" aria-label="Back to top">
    <i class="fa fa-arrow-up fa-lg"></i>
    <span>0%</span>
  </div>
  <div class="reading-progress-bar"></div>

  <a href="https://github.com/ccomma" class="github-corner" title="Follow me on GitHub" aria-label="Follow me on GitHub" rel="noopener" target="_blank"><svg width="80" height="80" viewBox="0 0 250 250" aria-hidden="true"><path d="M0,0 L115,115 L130,115 L142,142 L250,250 L250,0 Z"></path><path d="M128.3,109.0 C113.8,99.7 119.0,89.6 119.0,89.6 C122.0,82.7 120.5,78.6 120.5,78.6 C119.2,72.0 123.4,76.3 123.4,76.3 C127.3,80.9 125.5,87.3 125.5,87.3 C122.9,97.6 130.6,101.9 134.4,103.2" fill="currentColor" style="transform-origin: 130px 106px;" class="octo-arm"></path><path d="M115.0,115.0 C114.9,115.1 118.7,116.5 119.8,115.4 L133.7,101.6 C136.9,99.2 139.9,98.4 142.2,98.6 C133.8,88.0 127.5,74.4 143.8,58.0 C148.5,53.4 154.0,51.2 159.7,51.0 C160.3,49.4 163.2,43.6 171.4,40.1 C171.4,40.1 176.1,42.5 178.8,56.2 C183.1,58.6 187.2,61.8 190.9,65.4 C194.5,69.0 197.7,73.2 200.1,77.6 C213.8,80.2 216.3,84.9 216.3,84.9 C212.7,93.1 206.9,96.0 205.4,96.6 C205.1,102.4 203.0,107.8 198.3,112.5 C181.9,128.9 168.3,122.5 157.7,114.1 C157.9,116.9 156.7,120.9 152.7,124.9 L141.0,136.5 C139.8,137.7 141.6,141.9 141.8,141.8 Z" fill="currentColor" class="octo-body"></path></svg></a>

<noscript>
  <div class="noscript-warning">Theme NexT works best with JavaScript enabled</div>
</noscript>


  
  <script src="https://cdnjs.cloudflare.com/ajax/libs/animejs/3.2.1/anime.min.js" integrity="sha256-XL2inqUJaslATFnHdJOi9GfQ60on8Wx1C2H8DYiN1xY=" crossorigin="anonymous"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/next-theme-pjax/0.6.0/pjax.min.js" integrity="sha256-vxLn1tSKWD4dqbMRyv940UYw4sXgMtYcK6reefzZrao=" crossorigin="anonymous"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/medium-zoom/1.1.0/medium-zoom.min.js" integrity="sha256-ZgMyDAIYDYGxbcpJcfUnYwNevG/xi9OHKaR/8GK+jWc=" crossorigin="anonymous"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/lozad.js/1.16.0/lozad.min.js" integrity="sha256-mOFREFhqmHeQbXpK2lp4nA3qooVgACfh88fpJftLBbc=" crossorigin="anonymous"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/pangu/4.0.7/pangu.min.js" integrity="sha256-j+yj56cdEY2CwkVtGyz18fNybFGpMGJ8JxG3GSyO2+I=" crossorigin="anonymous"></script>
<script src="/js/comments.js"></script><script src="/js/utils.js"></script><script src="/js/motion.js"></script><script src="/js/schemes/muse.js"></script><script src="/js/next-boot.js"></script><script src="/js/pjax.js"></script>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/hexo-generator-searchdb/1.4.1/search.js" integrity="sha256-1kfA5uHPf65M5cphT2dvymhkuyHPQp5A53EGZOnOLmc=" crossorigin="anonymous"></script>
<script src="/js/third-party/search/local-search.js"></script>





  <script src="/js/third-party/pace.js"></script>


  
  <script data-pjax async src="https://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>




  <script src="https://cdnjs.cloudflare.com/ajax/libs/quicklink/2.3.0/quicklink.umd.js" integrity="sha256-yvJQOINiH9fWemHn0vCA5lsHWJaHs6/ZmO+1Ft04SvM=" crossorigin="anonymous"></script>
  <script class="next-config" data-name="quicklink" type="application/json">{"enable":true,"home":true,"archive":true,"delay":true,"timeout":3000,"priority":true,"url":"https://ccomma.cn/page/11/"}</script>
  <script src="/js/third-party/quicklink.js"></script>
<script class="next-config" data-name="disqus" type="application/json">{"enable":true,"shortname":"ccomma","count":true,"i18n":{"disqus":"disqus"}}</script>
<script src="/js/third-party/comments/disqus.js"></script>

</body>
</html>
