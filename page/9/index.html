<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width">
<meta name="theme-color" content="#222"><meta name="generator" content="Hexo 7.0.0">

  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16.png">
  <link rel="mask-icon" href="/images/safari-pinned-tab.svg" color="#222">
  <meta name="google-site-verification" content="5K7puGkNbKLWhZTmZZm6haOpSbJ-oOvUQFYJeMFBJSk">
  <meta name="baidu-site-verification" content="codeva-3O8Y6jTFCL">

<link rel="stylesheet" href="/css/main.css">

<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Monaco:300,300italic,400,400italic,700,700italic&display=swap&subset=latin,latin-ext">

<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" integrity="sha256-yIDrPSXHZdOZhAqiBP7CKzIwMQmRCJ8UeB8Jo17YC4o=" crossorigin="anonymous">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/3.1.1/animate.min.css" integrity="sha256-PR7ttpcvz8qrF57fur/yAx1qXMFJeJFiA6pSzWi0OIE=" crossorigin="anonymous">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/pace/1.2.4/themes/blue/pace-theme-minimal.css">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/pace/1.2.4/pace.min.js" integrity="sha256-gqd7YTjg/BtfqWSwsJOvndl0Bxc8gFImLEkXQT8+qj0=" crossorigin="anonymous"></script>

<script class="next-config" data-name="main" type="application/json">{"hostname":"ccomma.cn","root":"/","images":"/images","scheme":"Muse","darkmode":false,"version":"8.19.1","exturl":false,"sidebar":{"position":"left","display":"post","padding":18,"offset":12},"copycode":{"enable":true,"style":"mac"},"fold":{"enable":true,"height":500},"bookmark":{"enable":false,"color":"#222","save":"auto"},"mediumzoom":true,"lazyload":true,"pangu":true,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"stickytabs":false,"motion":{"enable":true,"async":false,"transition":{"menu_item":"fadeInDown","post_block":"fadeIn","post_header":"fadeInDown","post_body":"fadeInDown","coll_header":"fadeInLeft","sidebar":"fadeInUp"}},"prism":false,"i18n":{"placeholder":"Searching...","empty":"We didn't find any results for the search: ${query}","hits_time":"${hits} results found in ${time} ms","hits":"${hits} results found"},"path":"/search.xml","localsearch":{"enable":true,"trigger":"auto","top_n_per_article":1,"unescape":false,"preload":false}}</script><script src="/js/config.js"></script>

    <meta name="description" content="下一个目标：改变世界！">
<meta property="og:type" content="website">
<meta property="og:title" content="CComma&#39;s Blog">
<meta property="og:url" content="https://ccomma.cn/page/9/">
<meta property="og:site_name" content="CComma&#39;s Blog">
<meta property="og:description" content="下一个目标：改变世界！">
<meta property="og:locale" content="en_US">
<meta property="article:author" content="CComma">
<meta property="article:tag" content="编程技术、Java">
<meta name="twitter:card" content="summary">


<link rel="canonical" href="https://ccomma.cn/page/9/">



<script class="next-config" data-name="page" type="application/json">{"sidebar":"","isHome":true,"isPost":false,"lang":"en","comments":"","permalink":"","path":"page/9/index.html","title":""}</script>

<script class="next-config" data-name="calendar" type="application/json">""</script>
<title>CComma's Blog</title>
  
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-GS592DM662"></script>
  <script class="next-config" data-name="google_analytics" type="application/json">{"tracking_id":"G-GS592DM662","only_pageview":false,"measure_protocol_api_secret":null}</script>
  <script src="/js/third-party/analytics/google-analytics.js"></script>

  <script src="/js/third-party/analytics/baidu-analytics.js"></script>
  <script async src="https://hm.baidu.com/hm.js?152282c2c823c1e5ab34c577ba338801"></script>







  <noscript>
    <link rel="stylesheet" href="/css/noscript.css">
  </noscript>
<link rel="alternate" href="/atom.xml" title="CComma's Blog" type="application/atom+xml">
</head>

<body itemscope itemtype="http://schema.org/WebPage" class="use-motion">
  <div class="headband"></div>

  <main class="main">
    <div class="column">
      <header class="header" itemscope itemtype="http://schema.org/WPHeader"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="Toggle navigation bar" role="button">
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
    </div>
  </div>

  <div class="site-meta">
      <img class="custom-logo-image" src="/images/ccomma.png" alt="CComma's Blog">

    <a href="/" class="brand" rel="start">
      <i class="logo-line"></i>
      <h1 class="site-title">CComma's Blog</h1>
      <i class="logo-line"></i>
    </a>
      <p class="site-subtitle" itemprop="description">Connect the world</p>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger" aria-label="Search" role="button">
        <i class="fa fa-search fa-fw fa-lg"></i>
    </div>
  </div>
</div>



<nav class="site-nav">
  <ul class="main-menu menu"><li class="menu-item menu-item-home"><a href="/" rel="section"><i class="fa fa-home fa-fw"></i>Home</a></li><li class="menu-item menu-item-categories"><a href="/categories/" rel="section"><i class="fa fa-th fa-fw"></i>Categories<span class="badge">17</span></a></li><li class="menu-item menu-item-tags"><a href="/tags/" rel="section"><i class="fa fa-tags fa-fw"></i>Tags<span class="badge">15</span></a></li><li class="menu-item menu-item-archives"><a href="/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>Archives<span class="badge">97</span></a></li><li class="menu-item menu-item-about"><a href="/about/" rel="section"><i class="fa fa-user fa-fw"></i>About</a></li>
      <li class="menu-item menu-item-search">
        <a role="button" class="popup-trigger"><i class="fa fa-search fa-fw"></i>Search
        </a>
      </li>
  </ul>
</nav>



  <div class="search-pop-overlay">
    <div class="popup search-popup"><div class="search-header">
  <span class="search-icon">
    <i class="fa fa-search"></i>
  </span>
  <div class="search-input-container">
    <input autocomplete="off" autocapitalize="off" maxlength="80"
           placeholder="Searching..." spellcheck="false"
           type="search" class="search-input">
  </div>
  <span class="popup-btn-close" role="button">
    <i class="fa fa-times-circle"></i>
  </span>
</div>
<div class="search-result-container no-result">
  <div class="search-result-icon">
    <i class="fa fa-spinner fa-pulse fa-5x"></i>
  </div>
</div>

    </div>
  </div>

</header>
        
  
  <aside class="sidebar">

    <div class="sidebar-inner sidebar-overview-active">
      <ul class="sidebar-nav">
        <li class="sidebar-nav-toc">
          Table of Contents
        </li>
        <li class="sidebar-nav-overview">
          Overview
        </li>
      </ul>

      <div class="sidebar-panel-container">
        <!--noindex-->
        <div class="post-toc-wrap sidebar-panel">
        </div>
        <!--/noindex-->

        <div class="site-overview-wrap sidebar-panel">
          <div class="site-author animated" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <img class="site-author-image" itemprop="image" alt="CComma"
      src="/images/ccomma.png">
  <p class="site-author-name" itemprop="name">CComma</p>
  <div class="site-description" itemprop="description">下一个目标：改变世界！</div>
</div>
<div class="site-state-wrap animated">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
        <a href="/archives/">
          <span class="site-state-item-count">97</span>
          <span class="site-state-item-name">posts</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
          <a href="/categories/">
        <span class="site-state-item-count">17</span>
        <span class="site-state-item-name">categories</span></a>
      </div>
      <div class="site-state-item site-state-tags">
          <a href="/tags/">
        <span class="site-state-item-count">15</span>
        <span class="site-state-item-name">tags</span></a>
      </div>
  </nav>
</div>
  <div class="links-of-author animated">
      <span class="links-of-author-item">
        <a href="https://github.com/ccomma" title="GitHub → https:&#x2F;&#x2F;github.com&#x2F;ccomma" rel="noopener me" target="_blank"><i class="fab fa-github fa-fw"></i>GitHub</a>
      </span>
      <span class="links-of-author-item">
        <a href="https://twitter.com/ccomma_cat" title="Twitter → https:&#x2F;&#x2F;twitter.com&#x2F;ccomma_cat" rel="noopener me" target="_blank"><i class="fab fa-twitter fa-fw"></i>Twitter</a>
      </span>
      <span class="links-of-author-item">
        <a href="/atom.xml" title="RSS → &#x2F;atom.xml" rel="noopener me"><i class="fa fa-rss fa-fw"></i>RSS</a>
      </span>
  </div>
  <div class="cc-license animated" itemprop="license">
    <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/deed.zh" class="cc-opacity" rel="noopener" target="_blank"><img src="https://cdnjs.cloudflare.com/ajax/libs/creativecommons-vocabulary/2020.11.3/assets/license_badges/small/by_nc_sa.svg" alt="Creative Commons"></a>
  </div>

        </div>
      </div>
    </div>

    
        <div class="pjax">
        </div>
  </aside>


    </div>

    <div class="main-inner index posts-expand">

    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="https://ccomma.cn/fb02556d0484/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/ccomma.png">
      <meta itemprop="name" content="CComma">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="CComma's Blog">
      <meta itemprop="description" content="下一个目标：改变世界！">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | CComma's Blog">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/fb02556d0484/" class="post-title-link" itemprop="url">Java 并发详解 ③：Synchronized</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>

      <time title="Created: 2021-02-21 21:34:38" itemprop="dateCreated datePublished" datetime="2021-02-21T21:34:38+08:00">2021-02-21</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">In</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/Java/" itemprop="url" rel="index"><span itemprop="name">Java</span></a>
        </span>
          , 
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/Java/%E5%B9%B6%E5%8F%91/" itemprop="url" rel="index"><span itemprop="name">并发</span></a>
        </span>
    </span>

  
  
  <span class="post-meta-item">
    
      <span class="post-meta-item-icon">
        <i class="far fa-comment"></i>
      </span>
      <span class="post-meta-item-text">Disqus: </span>
    
    <a title="disqus" href="/fb02556d0484/#disqus_thread" itemprop="discussionUrl">
      <span class="post-comments-count disqus-comment-count" data-disqus-identifier="fb02556d0484/" itemprop="commentCount"></span>
    </a>
  </span>
  
  
    <span class="post-meta-item" title="Reading time">
      <span class="post-meta-item-icon">
        <i class="far fa-clock"></i>
      </span>
      <span class="post-meta-item-text">Reading time &asymp;</span>
      <span>7 mins.</span>
    </span>
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <p>synchronized 发生异常会释放锁<br>不能拿 String、Integer、Long 等基础类型做锁<br>synchronized 和 Lock 能保证同一时刻只有一个线程获取锁然后执行同步代码，并且在释放锁之前会将对变量的修改刷新到主存当中。因此可以保证可见性。但是同步块里的非原子操作依旧可能发生指令重排</p>
<h2 id="1-notify"><a href="#1-notify" class="headerlink" title="1. notify"></a>1. notify</h2><ul>
<li>wait ()：令当前资源挂起并放弃 CPU、同步资源，不再抢资源，除非唤醒</li>
<li> notify ()：当其他线程的运行使得这个条件满足时，其它线程会调用 notify () 唤醒正在排队等待同步资源的下城中优先级最高者结束等待</li>
<li> notifyAll ()：当其他线程的运行使得这个条件满足时，其它线程会调用 notifyAll () 唤醒正在排队等待资源的所有线程结束等待<br>这三个方法只有在 synchrozied 方法或 synchrozied 代码块中才能使用</li>
</ul>
<h2 id="2-使用"><a href="#2-使用" class="headerlink" title="2. 使用"></a>2. 使用</h2><p><strong>同步方法：</strong>锁为当前对象，即 this，所以不能用在继承方法的线程上</p>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Bank</span> {</span><br><span class="line">    <span class="keyword">private</span> <span class="type">double</span>[] accounts;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">synchronized</span> <span class="keyword">void</span> <span class="title function_">transfer</span><span class="params">(<span class="type">int</span> from, <span class="type">int</span> to, <span class="type">int</span> amount)</span> <span class="keyword">throws</span> InterruptedException {</span><br><span class="line">        <span class="keyword">while</span> (accounts[from] &lt; amount) {</span><br><span class="line">            wait();</span><br><span class="line">        }</span><br><span class="line">        accounts[from] -= amount;</span><br><span class="line">        accounts[to] += amount;</span><br><span class="line">        notifyAll();</span><br><span class="line">    }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<p><strong>同步阻塞：</strong></p>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Window2</span> <span class="keyword">implements</span> <span class="title class_">Runnable</span> {</span><br><span class="line">    <span class="comment">// 共享数据</span></span><br><span class="line">    <span class="type">int</span> <span class="variable">ticket</span> <span class="operator">=</span> <span class="number">100</span>;</span><br><span class="line">    <span class="comment">// 锁（同步监视器）</span></span><br><span class="line">    <span class="type">Object</span> <span class="variable">obj</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Object</span>();</span><br><span class="line">    <span class="comment">// 所有线程必须共用同一把锁</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">run</span><span class="params">()</span> {</span><br><span class="line">        <span class="keyword">while</span> (<span class="literal">true</span>) {</span><br><span class="line">            <span class="comment">// 若是静态方法可用当前类.class</span></span><br><span class="line">            <span class="keyword">synchronized</span> (obj) {</span><br><span class="line">                <span class="keyword">if</span> (ticket &gt; <span class="number">0</span>) {</span><br><span class="line">                    <span class="keyword">try</span> {</span><br><span class="line">                        Thread.currentThread().sleep(<span class="number">10</span>);</span><br><span class="line">                    }</span><br><span class="line">                    <span class="keyword">catch</span> (InterrupteException e) {</span><br><span class="line">                        e.printStackTrace();</span><br><span class="line">                    }</span><br><span class="line">                    System.out.println(...);</span><br><span class="line">                }</span><br><span class="line">            }</span><br><span class="line">        }</span><br><span class="line">    }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<h2 id="3-用户态与内核态"><a href="#3-用户态与内核态" class="headerlink" title="3. 用户态与内核态"></a>3. 用户态与内核态</h2><p>synchronized 加锁需要程序由用户态切换到内核态，效率低</p>
<p>Intel x86 架构的 CPU 来说一共有 0~3 四个特权级，0 级最高，3 级最低。</p>
<p>硬件上在执行每条指令时都会对指令所具有的特权级做相应的检查。相关的概念有 CPL、DPL 和 RPL。</p>
<p>Linux 中当程序运行在 3 级特权级上时称之运行在用户态，运行在 0 级特权级上时称之运行在内核态。</p>
<p>用户态通过申请外部资源（申请堆内存、读写磁盘文件。。。）切换至内核态</p>
<p><strong>用户态切换到内核态的 3 种方式：</strong></p>
<ul>
<li>系统调用</li>
<li>中断</li>
<li>异常</li>
</ul>
<p><strong>具体的切换操作：</strong> 以 open 函数调用为例<br>open 函数调用时，会通过中断陷入内核，从而调用 sys_open 函数。</p>
<p><img data-src="https://ccomma-pic-storage.oss-cn-hangzhou.aliyuncs.com/img/fe6975c6c94589bcdde8d46b8a9dc29f.png"></p>
<ol>
<li><strong>系统调用触发 0x80 中断：</strong> 并且将系统调用号存储在 eax 寄存器中，然后陷入内核，内核开始执行中断处理程序，在系统调用表中查找系统调用号对应的系统内核函数并且调用，执行完成后又将返回值通过 eax 寄存器返回给用户空间 </li>
<li><strong>中断机制：</strong> 中断处理程序（内核 ）<br>计算机处于执行期间，系统内发生了非寻常或非预期的急需处理事件，CPU 暂时中断当前正在执行的程序而转去执行相应的事件处理程序，处理完毕后返回原来被中断处继续执行 <blockquote>
<p>处理中断源的程序称为中断处理程序。中断的实现由软件和硬件综合完成，硬件部分叫做硬件装置，软件部分称为软件处理程序。</p>
</blockquote>
</li>
</ol>
<h2 id="4-锁升级"><a href="#4-锁升级" class="headerlink" title="4. 锁升级"></a>4. 锁升级</h2><p>对象头 markword 记录了<br><img data-src="https://ccomma-pic-storage.oss-cn-hangzhou.aliyuncs.com/img/d325ec9b4034693a353bc34160b7c15f.png"></p>
<p><strong>锁升级步骤：</strong><br><img data-src="https://ccomma-pic-storage.oss-cn-hangzhou.aliyuncs.com/img/9b99a7fd2e54ea4e9acd1e9898459c97.png"></p>
<h3 id="4-1-偏向锁"><a href="#4-1-偏向锁" class="headerlink" title="4.1. 偏向锁"></a>4.1. 偏向锁</h3><p>偏向锁假定将来只有第一个申请锁的线程会使用锁。因此，只需要在 Markword 中 CAS 记录 当前线程指针，如果记录成功，则偏向锁获取成功，记录锁状态为偏向锁。</p>
<p>以后当前线程记录的这个线程就可以零成本的直接获得锁；否则，说明有其他线程竞争，膨胀为轻量级锁</p>
<p><strong>源码：</strong> fast_enter 方法中在 safepoint 的时候上锁，失败则调用 slow_enter 方法升级为自旋锁。</p>
<blockquote>
<p>在明确知道会有多个线程竞争的情况下，偏向锁会涉及锁撤销，比自旋锁效率低，所以这时不会启用偏向锁</p>
<p>例如：JVM 启动过程会有很多线程竞争，所以默认情况启动时不打开偏向锁，过一段时间才会打开</p>
<p>-XX:BiasedLockingStartupDelay=4（默认 4 秒），刚开始未偏向任何一个线程，所以称为匿名偏向</p>
</blockquote>
<h3 id="4-2-自旋锁"><a href="#4-2-自旋锁" class="headerlink" title="4.2. 自旋锁"></a>4.2. 自旋锁</h3><p>轻量级锁是相对于传统的重量级锁而言，它使用 CAS 操作来避免重量级锁使用互斥量的开销。对于绝大部分的锁，在整个同步周期内都是不存在竞争的，因此也就不需要都使用互斥量进行同步。详情查看<a target="_blank" rel="noopener" href="https://www.yuque.com/ccomma/rzm7ab/pb3cim#%E8%87%AA%E6%97%8B%E9%94%81">自旋锁</a>。</p>
<p><strong>原理：</strong><br>每个线程在其线程栈内部生成一个 LockRecord，拿到锁后记录在 markword 中。即演化为多个 LockRecord 使用 CAS 竞争写入 markword 的场景。</p>
<p>对应 slow_enter 方法，首先进入自旋，自旋锁不行则调用 inflate 方法膨胀为重量级锁。</p>
<p><strong>升级：</strong></p>
<ul>
<li>1.6 之前，有线程超过 10 次自旋（-XX:PreBlockSpin），或者自旋线程数超过 CPU 核数的一半。则升级为重量级锁。</li>
<li>1.6 之后，加入自适应自旋 Adapative Self Spinning，由 JVM 自己控制何时升级成重量级锁。</li>
</ul>
<h3 id="4-3-重量级锁"><a href="#4-3-重量级锁" class="headerlink" title="4.3. 重量级锁"></a>4.3. 重量级锁</h3><p>synchronized 编译为字节码后代码由 <code>monitorenter</code> 和 <code>monitorexit</code> 包围，表示上锁和释放锁。</p>
<p>synchronized 加锁需要程序由用户态切换到内核态，效率低。</p>
<p>内核态 ObjectMonitor 对象中有 WaitSet 队列，抢锁的线程都会进入等待队列，不需要消耗 CPU 资源，由操作系统进程调度</p>
<h3 id="4-4-可重入锁"><a href="#4-4-可重入锁" class="headerlink" title="4.4. 可重入锁"></a>4.4. 可重入锁</h3><p>重入次数必须记录，因为加锁次数必须和解锁次数对应</p>
<ul>
<li>偏向锁 / 自旋锁：记录在线程栈中，每重入一次，LockRecord + 1。LockRecord 指向备份的 markword（displace head），里面记录了 HashCode，重入的 LockRecord 指向 null</li>
<li> 重量级锁：记录在 ObjectMonitor 一个字段上</li>
</ul>
<h2 id="5-锁优化"><a href="#5-锁优化" class="headerlink" title="5. 锁优化"></a>5. 锁优化</h2><h3 id="5-1-锁消除"><a href="#5-1-锁消除" class="headerlink" title="5.1. 锁消除"></a>5.1. 锁消除</h3><p>锁消除是指对于被检测出不可能存在竞争的共享数据的锁进行消除</p>
<p><strong>如下 concatString 方法：</strong></p>
<p>每个 append () 方法中都有一个 synchronized 同步块。虚拟机观察变量 sb，很快就会发现它的动态作用域被限制在 concatString () 方法内部。也就是说，sb 的所有引用永远不会逃逸到 concatString () 方法之外，其他线程无法访问到它，因此可以进行消除</p>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> String <span class="title function_">concatString</span><span class="params">(String s1, String s2, String s3)</span> {</span><br><span class="line">    <span class="type">StringBuffer</span> <span class="variable">sb</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">StringBuffer</span>();</span><br><span class="line">    sb.append(s1);</span><br><span class="line">    sb.append(s2);</span><br><span class="line">    sb.append(s3);</span><br><span class="line">    <span class="keyword">return</span> sb.toString();</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<p><strong>原理：</strong> 锁消除主要是通过逃逸分析来支持，如果堆上的共享数据不可能逃逸出去被其它线程访问到，那么就可以把它们当成私有数据对待，也就可以将它们的锁进行消除</p>
<h3 id="5-2-锁粗化"><a href="#5-2-锁粗化" class="headerlink" title="5.2. 锁粗化"></a>5.2. 锁粗化</h3><p>如果一系列的连续操作都对同一个对象反复加锁和解锁，频繁的加锁操作就会导致性能损耗</p>
<p>虚拟机探测到由这样的一串零碎的操作都对同一个对象加锁，则会把加锁的范围扩展（粗化）到整个操作序列的外部。</p>
<h2 id="6-Monitor"><a href="#6-Monitor" class="headerlink" title="6. Monitor"></a>6. Monitor</h2><p><img data-src="https://ccomma-pic-storage.oss-cn-hangzhou.aliyuncs.com/img/de3169fd89ed9876967ad2791a46716c.png"></p>
<ol>
<li>Monitor 是一种用来实现同步的工具 </li>
<li>与每个 java 对象相关联，所有的 Java 对象是天生携带 monitor </li>
<li>Monitor 是实现 Sychronized（内置锁）的基础 </li>
<li>Monitor 的本质是依赖于底层操作系统的 Mutex Lock 实现 </li>
</ol>
<figure class="highlight c"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">ObjectMonitor() {</span><br><span class="line">    <span class="comment">// 用来记录该对象被线程获取锁的次数</span></span><br><span class="line">    _count        = <span class="number">0</span>; </span><br><span class="line">    _waiters      = <span class="number">0</span>;</span><br><span class="line">    <span class="comment">// 锁的重入次数</span></span><br><span class="line">    _recursions   = <span class="number">0</span>; </span><br><span class="line">    <span class="comment">// 指向持有 ObjectMonitor 对象的线程 </span></span><br><span class="line">    _owner        = <span class="literal">NULL</span>; </span><br><span class="line">    <span class="comment">// 处于 wait 状态的线程，会被加入到 _WaitSet</span></span><br><span class="line">    _WaitSet      = <span class="literal">NULL</span>; </span><br><span class="line">    _WaitSetLock  = <span class="number">0</span> ;</span><br><span class="line">    <span class="comment">// 处于等待锁 block 状态的线程，会被加入到该列表</span></span><br><span class="line">    _EntryList    = <span class="literal">NULL</span> ; </span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>


      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="https://ccomma.cn/e27ad8b5a7cb/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/ccomma.png">
      <meta itemprop="name" content="CComma">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="CComma's Blog">
      <meta itemprop="description" content="下一个目标：改变世界！">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | CComma's Blog">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/e27ad8b5a7cb/" class="post-title-link" itemprop="url">JVM 常用指令</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>

      <time title="Created: 2020-12-05 20:22:51" itemprop="dateCreated datePublished" datetime="2020-12-05T20:22:51+08:00">2020-12-05</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">In</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/JVM/" itemprop="url" rel="index"><span itemprop="name">JVM</span></a>
        </span>
    </span>

  
  
  <span class="post-meta-item">
    
      <span class="post-meta-item-icon">
        <i class="far fa-comment"></i>
      </span>
      <span class="post-meta-item-text">Disqus: </span>
    
    <a title="disqus" href="/e27ad8b5a7cb/#disqus_thread" itemprop="discussionUrl">
      <span class="post-comments-count disqus-comment-count" data-disqus-identifier="e27ad8b5a7cb/" itemprop="commentCount"></span>
    </a>
  </span>
  
  
    <span class="post-meta-item" title="Reading time">
      <span class="post-meta-item-icon">
        <i class="far fa-clock"></i>
      </span>
      <span class="post-meta-item-text">Reading time &asymp;</span>
      <span>2 mins.</span>
    </span>
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h1 id="栈设置"><a href="#栈设置" class="headerlink" title="栈设置"></a>栈设置</h1><ul>
<li>-Xss: 栈大小</li>
</ul>
<h1 id="堆设置"><a href="#堆设置" class="headerlink" title="堆设置"></a>堆设置</h1><ul>
<li>-Xms: 初始堆大小</li>
<li> -Xmx: 最大堆大小</li>
<li> -Xmn: 新生代大小</li>
<li> -XX:NewSize=n: 设置年轻代大小</li>
<li> -XX:NewRatio=n: 设置年轻代和年老代的比值。如：为 3，表示年轻代与年老代比值为 1：3，年轻代占整个年轻代年老代和的 1/4</li>
<li>-XX:SurvivorRatio=n: 年轻代中 Eden 区与两个 Survivor 区的比值。注意 Survivor 区有两个。<ul>
<li>如：3，表示 Eden：Survivor=3：2，一个 Survivor 区占整个年轻代的 1/5</li>
</ul>
</li>
<li>-XX:PretenureSizeThreshold: 大于此值的对象直接在老年代分配</li>
<li> -XX:MaxTenuringThreshold: 定义年龄的阈值。在 Eden 中的对象经过 Minor GC 依然存活，将移动到 Survivor 中，年龄增加 1 岁，超过该年龄阈值将进入老年代</li>
</ul>
<h1 id="永久代设置"><a href="#永久代设置" class="headerlink" title="永久代设置"></a>永久代设置</h1><ul>
<li>-XX:PermSize: 初始化永久代大小</li>
<li> -XX:MaxPermSize=n: 永久代最大容量</li>
</ul>
<p><strong>元空间：</strong></p>
<ul>
<li><strong>-XX:MetaspaceSize ：</strong> 分配给类元数据空间的初始大小。<ul>
<li>MetaspaceSize 的值设置的过大会延长垃圾回收时间。</li>
<li>垃圾回收过后，引起下一次垃圾回收的类元数据空间的大小可能会变大。</li>
</ul>
</li>
<li><strong>-XX:MaxMetaspaceSize ：</strong>分配给类元数据空间的最大值<ul>
<li>超过此值就会触发 Full GC 。此值默认没有限制，但应取决于系统内存的大小，JVM 会动态地改变此值。</li>
</ul>
</li>
</ul>
<h1 id="收集器设置"><a href="#收集器设置" class="headerlink" title="收集器设置"></a>收集器设置</h1><ul>
<li>-XX:+UseSerialGC: 设置串行收集器</li>
<li> -XX:+UseParallelGC: 设置并行收集器</li>
<li> -XX:+UseParalledlOldGC: 设置并行年老代收集器</li>
<li> -XX:+UseConcMarkSweepGC: 设置并发收集器</li>
<li> -XX:ParallelCMSThreads: 并发标记扫描垃圾回收器 = 为使用的线程数量</li>
<li> -XX:+UseG1GC: G1 垃圾回收器</li>
</ul>
<p><strong>并行收集器配置：</strong></p>
<ul>
<li>-XX:ParallelGCThreads=n: 设置并行收集器收集时使用的 CPU 数和并行收集线程数。默认开启的线程数量与 CPU 数量相同</li>
<li> -XX:MaxGCPauseMillis=n: 设置并行收集最大暂停时间</li>
<li> -XX:GCTimeRatio=n: 设置垃圾回收时间占程序运行时间的百分比。公式为 1/(1+n)-XX:+CMSIncrementalMode: 设置为增量模式。适用于单 CPU 情况。</li>
<li>-XX:ParallelGCThreads=n: 设置并发收集器年轻代收集方式为并行收集时，使用的 CPU 数。并行收集线程数。</li>
</ul>
<h1 id="垃圾回收统计信息"><a href="#垃圾回收统计信息" class="headerlink" title="垃圾回收统计信息"></a>垃圾回收统计信息</h1><ul>
<li>-XX:+PrintGC</li>
<li>-XX:+PrintGCDetails</li>
<li>-XX:+PrintGCTimeStamps</li>
<li>-Xloggc:filename</li>
</ul>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="https://ccomma.cn/abfd88afec7e/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/ccomma.png">
      <meta itemprop="name" content="CComma">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="CComma's Blog">
      <meta itemprop="description" content="下一个目标：改变世界！">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | CComma's Blog">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/abfd88afec7e/" class="post-title-link" itemprop="url">性能调优监控工具</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>

      <time title="Created: 2020-12-03 12:31:01" itemprop="dateCreated datePublished" datetime="2020-12-03T12:31:01+08:00">2020-12-03</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">In</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/JVM/" itemprop="url" rel="index"><span itemprop="name">JVM</span></a>
        </span>
    </span>

  
  
  <span class="post-meta-item">
    
      <span class="post-meta-item-icon">
        <i class="far fa-comment"></i>
      </span>
      <span class="post-meta-item-text">Disqus: </span>
    
    <a title="disqus" href="/abfd88afec7e/#disqus_thread" itemprop="discussionUrl">
      <span class="post-comments-count disqus-comment-count" data-disqus-identifier="abfd88afec7e/" itemprop="commentCount"></span>
    </a>
  </span>
  
  
    <span class="post-meta-item" title="Reading time">
      <span class="post-meta-item-icon">
        <i class="far fa-clock"></i>
      </span>
      <span class="post-meta-item-text">Reading time &asymp;</span>
      <span>1 mins.</span>
    </span>
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h1 id="1-jps（Java-Virtual-Machine-Process-Status-Tool）"><a href="#1-jps（Java-Virtual-Machine-Process-Status-Tool）" class="headerlink" title="1. jps（Java Virtual Machine Process Status Tool）"></a><strong>1. jps（Java Virtual Machine Process Status Tool）</strong></h1><p><img data-src="https://ccomma-pic-storage.oss-cn-hangzhou.aliyuncs.com/img/3725340a4dc81fe9baf2250d63d3487b.png" alt="image.png"><br><strong><em>作用：</em></strong> 用来输出 JVM 中运行的进程状态信息<br><strong><em>指令：</em></strong> jps [options] [hostid]</p>
<ul>
<li>-q 不输出类名、Jar 名和传入 main 方法的参数</li>
<li> -m 输出传入 main 方法的参数</li>
<li> -l 输出 main 类或 Jar 的全限名</li>
<li> -v 输出传入 JVM 的参数</li>
</ul>
<h1 id="2-jstack"><a href="#2-jstack" class="headerlink" title="2. jstack"></a>2. jstack</h1><p><strong><em>作用：</em></strong> 用来查看某个 Java 进程内的线程堆栈信息<br>指令：<br>jstack [option] pid<br>jstack [option] executable core<br>jstack [option] [server-id@]remote-hostname-or-ip</p>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="https://ccomma.cn/279728ca8833/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/ccomma.png">
      <meta itemprop="name" content="CComma">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="CComma's Blog">
      <meta itemprop="description" content="下一个目标：改变世界！">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | CComma's Blog">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/279728ca8833/" class="post-title-link" itemprop="url">类加载机制详解</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>

      <time title="Created: 2020-11-29 19:58:17" itemprop="dateCreated datePublished" datetime="2020-11-29T19:58:17+08:00">2020-11-29</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">In</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/JVM/" itemprop="url" rel="index"><span itemprop="name">JVM</span></a>
        </span>
    </span>

  
  
  <span class="post-meta-item">
    
      <span class="post-meta-item-icon">
        <i class="far fa-comment"></i>
      </span>
      <span class="post-meta-item-text">Disqus: </span>
    
    <a title="disqus" href="/279728ca8833/#disqus_thread" itemprop="discussionUrl">
      <span class="post-comments-count disqus-comment-count" data-disqus-identifier="279728ca8833/" itemprop="commentCount"></span>
    </a>
  </span>
  
  
    <span class="post-meta-item" title="Reading time">
      <span class="post-meta-item-icon">
        <i class="far fa-clock"></i>
      </span>
      <span class="post-meta-item-text">Reading time &asymp;</span>
      <span>11 mins.</span>
    </span>
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <p>类是在 ** 运行期间第一次使用 ** 时动态加载的，而不是编译时期一次性加载。因为如果在编译时期一次性加载，那么会占用很多的内存</p>
<h1 id="1-类的生命周期"><a href="#1-类的生命周期" class="headerlink" title="1. 类的生命周期"></a>1. 类的生命周期</h1><p><img data-src="https://ccomma-pic-storage.oss-cn-hangzhou.aliyuncs.com/img/7d761e858b6b41b873e936793f188da9.png" alt="image.png"><br>包括以下 7 个阶段：</p>
<ul>
<li><strong>加载（Loading）</strong></li>
<li><strong>验证（Verification）</strong></li>
<li><strong>准备（Preparation）</strong></li>
<li><strong>解析（Resolution）</strong></li>
<li><strong>初始化（Initialization）</strong></li>
<li>使用（Using）</li>
<li>卸载（Unloading）</li>
</ul>
<h1 id="2-类加载过程"><a href="#2-类加载过程" class="headerlink" title="2. 类加载过程"></a>2. 类加载过程</h1><p>包含了加载、验证、准备、解析和初始化这 5 个阶段</p>
<h2 id="2-1-加载"><a href="#2-1-加载" class="headerlink" title="2.1. 加载"></a>2.1. 加载</h2><p>加载过程完成以下三件事：</p>
<ol>
<li><strong>获取二进制字节流：</strong> 通过一个类的全限定名来获取定义此类的 <strong>二进制字节流</strong><ol>
<li>从 ZIP 包读取，成为 JAR、EAR、WAR 格式的基础</li>
<li>由其他文件生成，例如由 JSP 文件生成对应的 Class 类</li>
<li>运行时计算生成，例如动态代理技术，在 java.lang.reflect.Proxy 使用 ProxyGenerator.generateProxyClass 的代理类的二进制字节流</li>
<li>从网络中获取，最典型的应用是 Applet</li>
</ol>
</li>
<li><strong> 存储结构转化：</strong> 将这个字节流所代表的 ** 静态存储结构 ** 转化为方法区的 <strong>运行时存储结构</strong></li>
<li><strong>生成 Class 对象：</strong> 在内存中生成一个代表这个类的 <strong>Class 对象</strong>，作为方法区这个类的各种数据的访问入口</li>
</ol>
<h2 id="2-2-验证"><a href="#2-2-验证" class="headerlink" title="2.2. 验证"></a>2.2. 验证</h2><p><strong><em>概述：</em></strong> 确保 Class 文件的字节流中包含的信息 <strong>符合当前虚拟机的要求（如 cafe babe）</strong>，并且不会危害虚拟机自身的安全</p>
<h2 id="2-3-准备"><a href="#2-3-准备" class="headerlink" title="2.3. 准备"></a>2.3. 准备</h2><p><strong><em>概述：</em></strong> 准备阶段为 ** 静态变量 ** 分配内存并 <strong>设置初始值</strong>，使用的是 ** 方法区 ** 的内存</p>
<ul>
<li><p>实例变量不会在这阶段分配内存，它将会在对象实例化时随着对象一起分配在堆中</p>
</li>
<li><p>初始值一般为 0 值，例如下面的静态变量 value 被初始化为 0 而不是 123</p>
<blockquote>
<p> public static int value = 123; </p>
</blockquote>
</li>
<li><p>如果静态变量是常量，那么会按照表达式来进行初始化，而不是赋值为 0</p>
<blockquote>
<p> public static final int value = 123;</p>
</blockquote>
</li>
</ul>
<h2 id="2-4-解析"><a href="#2-4-解析" class="headerlink" title="2.4. 解析"></a>2.4. 解析</h2><p><strong><em>概述：</em></strong><br>将常量池的符号引用替换为 <strong>直接引用 <strong>的过程<br>其中解析过程在某些情况下可以在初始化阶段之后再开始，这是为了支持 Java 的动态绑定<br></strong><em>符号引用：</em></strong> 符号引用与虚拟机实现的布局无关，引用的目标并不一定要已经加载到内存中。各种虚拟机实现的内存布局可以各不相同，但是它们能接受的符号引用必须是一致的，因为符号引用的字面量形式明确定义在 Java 虚拟机规范的 Class 文件格式中<br><strong><em>直接引用：</em></strong> 直接引用可以是指向目标的指针，相对偏移量或是一个能间接定位到目标的句柄。如果有了直接引用，那引用的目标必定已经在内存中存在</p>
<h2 id="2-5-初始化"><a href="#2-5-初始化" class="headerlink" title="2.5. 初始化"></a>2.5. 初始化</h2><p><strong><em>概述：</em></strong><br>初始化阶段即虚拟机执行 <strong>类构造器</strong> () 方法的过程<br>初始化阶段才真正开始执行类中定义的 Java 程序代码<br><strong><em>特点：</em></strong></p>
<ul>
<li><p><strong>静态初始化：</strong> 编译器自动收集类中所有 静态变量的赋值动作和静态语句块中的语句，由 class 类构造器对 ** 静态变量 <strong>、</strong>静态代码块 ** 进行 ** 初始化 **。编译器收集的顺序由语句在源文件中出现的顺序决定。</p>
<ul>
<li>如果一个类中不包含静态语句块，也没有对静态变量有赋值操作，编译器可以不为该类生成 () 方法。</li>
<li>静态语句块只能访问到定义在它之前的类变量，定义在它之后的类变量只能赋值，不能访问。例如以下代码：<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Test</span> {</span><br><span class="line">    <span class="keyword">static</span> {</span><br><span class="line">        	i = <span class="number">0</span>;                <span class="comment">// 给变量赋值可以正常编译通过</span></span><br><span class="line">        	System.out.print(i);  <span class="comment">// 这句编译器会提示“非法向前引用”</span></span><br><span class="line">	    }</span><br><span class="line">	    <span class="keyword">static</span> <span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">1</span>;</span><br><span class="line">	}</span><br></pre></td></tr></tbody></table></figure></li>
</ul>
</li>
<li><p><strong>先父后子：</strong> 与类的构造函数（或者说实例构造器 ()）不同，() 不需要显式的调用父类的构造器。<strong>虚拟机会自动保证在子类的 () 方法运行之前</strong>，父类的 () 方法已经执行结束。因此虚拟机中第一个执行 () 方法的类肯定为 java.lang.Object。这也意味着父类中定义的 <strong>静态语句块的执行要优先于子类</strong></p>
</li>
<li><p><strong>接口：</strong> 执行接口的 () 方法不需要先执行父接口的 () 方法。<strong>只有当父接口中定义的变量使用时</strong>，父接口才会初始化。另外，接口的实现类在初始化时也一样不会执行接口的 () 方法</p>
</li>
<li><p><strong>加锁等待：</strong> 如果多个线程同时初始化一个类，只会有 ** 一个线程执行 ** 这个类的 () 方法，其它线程都会阻塞等待，直到活动线程执行 () 方法完毕。如果在一个类的 () 方法中有耗时的操作，就可能造成多个线程阻塞，在实际过程中此种阻塞很隐蔽</p>
</li>
</ul>
<h1 id="3-类初始化时机"><a href="#3-类初始化时机" class="headerlink" title="3. 类初始化时机"></a>3. 类初始化时机</h1><h2 id="3-1-主动引用"><a href="#3-1-主动引用" class="headerlink" title="3.1. 主动引用"></a>3.1. 主动引用</h2><p>虚拟机规范中并没有强制约束何时进行加载，但是规范严格规定了有且只有下列五种情况必须对类进行初始化（加载、验证、准备都会随之发生）：</p>
<ul>
<li>当虚拟机启动时，用户需要指定一个要执行的 <strong>入口类</strong>（包含 main () 方法的那个类），虚拟机会先初始化这个主类</li>
<li>遇到 new、getstatic、putstatic、invokestatic 这四条字节码指令时，如果类没有进行过初始化，则必须先触发其初始化。最常见的生成这 4 条指令的场景是：<ul>
<li>使用 new 关键字实例化对象的时候</li>
<li>读取或设置一个类的静态字段（被 final 修饰、已在编译期把结果放入常量池的静态字段除外）的时候</li>
<li>以及调用一个类的静态方法的时候</li>
</ul>
</li>
<li>当初始化一个类的时候，如果发现其父类还没有进行过初始化，则需要 ** 先触发其父类 ** 的初始化</li>
<li>使用 java.lang.reflect 包的方法对类进行 ** 反射调用 ** 的时候，如果类没有进行初始化，则需要先触发其初始化</li>
<li>当使用 JDK 1.7 的 ** 动态语言 ** 支持时，如果一个 java.lang.invoke.MethodHandle 实例最后的解析结果为 REF_getStatic, REF_putStatic, REF_invokeStatic 的方法句柄，并且这个方法句柄所对应的类没有进行过初始化，则需要先触发其初始化</li>
</ul>
<h2 id="3-2-被动引用"><a href="#3-2-被动引用" class="headerlink" title="3.2. 被动引用"></a>3.2. 被动引用</h2><p>以上 5 种场景中的行为称为对一个类进行主动引用<br>除此之外，所有引用类的方式都不会触发初始化，称为被动引用。被动引用的常见例子包括：</p>
<ul>
<li><p>通过子类 <strong>引用父类的静态字段</strong>，不会导致子类初始化</p>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// value 字段在 SuperClass 中定义</span></span><br><span class="line">System.out.println(SubClass.value);</span><br></pre></td></tr></tbody></table></figure>
</li>
<li><p>通过 <strong>数组定义来引用类</strong>，不会触发此类的初始化。该过程会对数组类进行初始化，数组类是一个由虚拟机自动生成的、直接继承自 Object 的子类，其中包含了数组的属性和方法</p>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">SuperClass[] sca = <span class="keyword">new</span> <span class="title class_">SuperClass</span>[<span class="number">10</span>];</span><br></pre></td></tr></tbody></table></figure>
</li>
<li><p>** 常量 ** 在编译阶段会存入调用类的常量池中，本质上并没有直接引用到定义常量的类，因此不会触发定义常量的类的初始化</p>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">System.out.println(ConstClass.HELLOWORLD);</span><br></pre></td></tr></tbody></table></figure></li>
</ul>
<h1 id="4-类与类加载器"><a href="#4-类与类加载器" class="headerlink" title="4. 类与类加载器"></a>4. 类与类加载器</h1><p>两个类相等需要类本身相等，并且使用同一个类加载器进行加载。这是因为每一个类加载器都拥有一个独立的类名称空间<br>这里的相等，包括类的 Class 对象的 equals () 方法、isAssignableFrom () 方法、isInstance () 方法的返回结果为 true，也包括使用 instanceof 关键字做对象所属关系判定结果为 true</p>
<h2 id="4-1-类加载器分类"><a href="#4-1-类加载器分类" class="headerlink" title="4.1. 类加载器分类"></a>4.1. 类加载器分类</h2><p>从 Java 虚拟机的角度来讲，只存在以下两种不同的类加载器：</p>
<ul>
<li>** 启动类加载器（Bootstrap ClassLoader）： ** 这个类加载器用 C++ 实现，是虚拟机自身的一部分</li>
<li><strong>所有其他类的加载器：</strong> 这些类由 Java 实现，独立于虚拟机外部，并且全都继承自抽象类 java.lang.ClassLoader</li>
</ul>
<p>从 Java 开发人员的角度看，类加载器可以划分得更细致一些：</p>
<ul>
<li><strong>启动类加载器（Bootstrap ClassLoader）：</strong><ul>
<li>此类加载器负责将存放在 \lib 目录中的，或者被 -Xbootclasspath 参数所指定的路径中的，并且是虚拟机识别的（仅按照文件名识别，如 rt.jar，名字不符合的类库即使放在 lib 目录中也不会被加载）类库加载到虚拟机内存中</li>
<li>启动类加载器无法被 Java 程序直接引用，用户在编写自定义类加载器时，如果需要把加载请求委派给启动类加载器，直接使用 null 代替即可</li>
</ul>
</li>
<li><strong>扩展类加载器（Extension ClassLoader）：</strong><ul>
<li>这个类加载器是由 ExtClassLoader（sun.misc.Launcher$ExtClassLoader）实现的。它负责将 /lib/ext 或者被 java.ext.dir 系统变量所指定路径中的所有类库加载到内存中，开发者可以直接使用扩展类加载器</li>
</ul>
</li>
<li><strong>应用程序类加载器（Application ClassLoader）：</strong><ul>
<li>这个类加载器是由 AppClassLoader（sun.misc.Launcher$AppClassLoader）实现的。由于这个类加载器是 ClassLoader 中的 getSystemClassLoader () 方法的返回值，因此一般称为系统类加载器</li>
<li>它负责加载用户类路径（ClassPath）上所指定的类库，开发者可以直接使用这个类加载器，如果应用程序中没有自定义过自己的类加载器，一般情况下这个就是程序中默认的类加载器</li>
</ul>
</li>
</ul>
<h2 id="4-2-双亲委派模型"><a href="#4-2-双亲委派模型" class="headerlink" title="4.2. 双亲委派模型"></a>4.2. 双亲委派模型</h2><p>应用程序都是由三种类加载器相互配合进行加载的，如果有必要，还可以加入自己定义的类加载器<br>下图展示的类加载器之间的层次关系，称为类加载器的双亲委派模型（Parents Delegation Model）<br>该模型要求除了顶层的启动类加载器外，其余的类加载器都应 <strong>有自己的父类加载器 <strong>。这里类加载器之间的父子关系一般通过组合（Composition）关系来实现，而不是通过继承（Inheritance）的关系实现<br><img data-src="https://ccomma-pic-storage.oss-cn-hangzhou.aliyuncs.com/img/de5f150dd562209218479d94c4105e4e.png" alt="image.png"><br></strong><em>工作过程：</em></strong> 一个类加载器首先将类加载请求传送到父类加载器，<strong>只有当父类加载器无法完成类加载请求时才尝试加载</strong><br>** <em>优点：</em>** 使得 Java 类随着它的类加载器一起具有一种带有 <strong>优先级的层次关系</strong>，从而使得基础类得到 <strong>统一</strong></p>
<ul>
<li><strong>共享功能：</strong> 可以避免重复加载，当父亲已经加载了该类的时候，子类不需要再次加载，一些 Framework 层级的类一旦被顶层的 ClassLoader 加载过就缓存在内存里面，以后任何地方用到都不需要重新加载。</li>
<li><strong>隔离功能：</strong> 主要是为了安全性，避免用户自己编写的类动态替换 Java 的一些核心类，比如 String ，同时也避免了重复加载，因为 JVM 中区分不同类，不仅仅是根据类名，相同的 class 文件被不同的 ClassLoader 加载就是不同的两个类，如果相互转型的话会抛 java.lang.ClassCaseException 。</li>
</ul>
<p><strong><em>例：</em></strong> java.lang.Object 存放在 rt.jar（使用启动类加载器）中，如果编写另外一个 java.lang.Object 的类（应用程序类加载器）并放到 ClassPath 中。<br>由于双亲委派模型的存在，所以在 rt.jar 中的 Object 比在 ClassPath 中的 Object 优先级更高，那么程序中所有的 Object 都是这个 Object。<br><strong><em>实现：</em></strong><br>以下是抽象类 java.lang.ClassLoader 的代码片段，其中的 loadClass () 方法运行过程如下：<br>先检查类是否已经加载过，如果没有则让父类加载器去加载。当父类加载器加载失败时抛出 ClassNotFoundException，此时尝试自己去加载。</p>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="keyword">class</span> <span class="title class_">ClassLoader</span> {</span><br><span class="line">    <span class="comment">// The parent class loader for delegation</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> ClassLoader parent;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> Class&lt;?&gt; loadClass(String name) <span class="keyword">throws</span> ClassNotFoundException {</span><br><span class="line">        <span class="keyword">return</span> loadClass(name, <span class="literal">false</span>);</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="keyword">protected</span> Class&lt;?&gt; loadClass(String name, <span class="type">boolean</span> resolve) <span class="keyword">throws</span> ClassNotFoundException {</span><br><span class="line">        <span class="keyword">synchronized</span> (getClassLoadingLock(name)) {</span><br><span class="line">            <span class="comment">// First, check if the class has already been loaded</span></span><br><span class="line">            Class&lt;?&gt; c = findLoadedClass(name);</span><br><span class="line">            <span class="keyword">if</span> (c == <span class="literal">null</span>) {</span><br><span class="line">                <span class="keyword">try</span> {</span><br><span class="line">                    <span class="keyword">if</span> (parent != <span class="literal">null</span>) {</span><br><span class="line">                        c = parent.loadClass(name, <span class="literal">false</span>);</span><br><span class="line">                    } <span class="keyword">else</span> {</span><br><span class="line">                        c = findBootstrapClassOrNull(name);</span><br><span class="line">                    }</span><br><span class="line">                } <span class="keyword">catch</span> (ClassNotFoundException e) {</span><br><span class="line">                    <span class="comment">// ClassNotFoundException thrown if class not found</span></span><br><span class="line">                    <span class="comment">// from the non-null parent class loader</span></span><br><span class="line">                }</span><br><span class="line"></span><br><span class="line">                <span class="keyword">if</span> (c == <span class="literal">null</span>) {</span><br><span class="line">                    <span class="comment">// If still not found, then invoke findClass in order</span></span><br><span class="line">                    <span class="comment">// to find the class.</span></span><br><span class="line">                    c = findClass(name);</span><br><span class="line">                }</span><br><span class="line">            }</span><br><span class="line">            <span class="keyword">if</span> (resolve) {</span><br><span class="line">                resolveClass(c);</span><br><span class="line">            }</span><br><span class="line">            <span class="keyword">return</span> c;</span><br><span class="line">        }</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="keyword">protected</span> Class&lt;?&gt; findClass(String name) <span class="keyword">throws</span> ClassNotFoundException {</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">ClassNotFoundException</span>(name);</span><br><span class="line">    }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<h2 id="4-3-自定义类加载器实现"><a href="#4-3-自定义类加载器实现" class="headerlink" title="4.3. 自定义类加载器实现"></a>4.3. 自定义类加载器实现</h2><p>FileSystemClassLoader 是自定义类加载器，继承自 java.lang.ClassLoader，用于加载文件系统上的类。<br>它首先根据类的全名在文件系统上查找类的字节代码文件（.class 文件），然后读取该文件内容，最后通过 defineClass () 方法来把这些字节代码转换成 java.lang.Class 类的实例。</p>
<p>java.lang.ClassLoader 的 loadClass () 实现了双亲委派模型的逻辑，因此自定义类加载器一般不去重写它，但是需要重写 findClass () 方法。</p>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">FileSystemClassLoader</span> <span class="keyword">extends</span> <span class="title class_">ClassLoader</span> {</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> String rootDir;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">FileSystemClassLoader</span><span class="params">(String rootDir)</span> {</span><br><span class="line">        <span class="built_in">this</span>.rootDir = rootDir;</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="keyword">protected</span> Class&lt;?&gt; findClass(String name) <span class="keyword">throws</span> ClassNotFoundException {</span><br><span class="line">        <span class="type">byte</span>[] classData = getClassData(name);</span><br><span class="line">        <span class="keyword">if</span> (classData == <span class="literal">null</span>) {</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">ClassNotFoundException</span>();</span><br><span class="line">        } <span class="keyword">else</span> {</span><br><span class="line">            <span class="keyword">return</span> defineClass(name, classData, <span class="number">0</span>, classData.length);</span><br><span class="line">        }</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="type">byte</span>[] getClassData(String className) {</span><br><span class="line">        <span class="type">String</span> <span class="variable">path</span> <span class="operator">=</span> classNameToPath(className);</span><br><span class="line">        <span class="keyword">try</span> {</span><br><span class="line">            <span class="type">InputStream</span> <span class="variable">ins</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">FileInputStream</span>(path);</span><br><span class="line">            <span class="type">ByteArrayOutputStream</span> <span class="variable">baos</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ByteArrayOutputStream</span>();</span><br><span class="line">            <span class="type">int</span> <span class="variable">bufferSize</span> <span class="operator">=</span> <span class="number">4096</span>;</span><br><span class="line">            <span class="type">byte</span>[] buffer = <span class="keyword">new</span> <span class="title class_">byte</span>[bufferSize];</span><br><span class="line">            <span class="type">int</span> bytesNumRead;</span><br><span class="line">            <span class="keyword">while</span> ((bytesNumRead = ins.read(buffer)) != -<span class="number">1</span>) {</span><br><span class="line">                baos.write(buffer, <span class="number">0</span>, bytesNumRead);</span><br><span class="line">            }</span><br><span class="line">            <span class="keyword">return</span> baos.toByteArray();</span><br><span class="line">        } <span class="keyword">catch</span> (IOException e) {</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        }</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> String <span class="title function_">classNameToPath</span><span class="params">(String className)</span> {</span><br><span class="line">        <span class="keyword">return</span> rootDir + File.separatorChar</span><br><span class="line">                + className.replace(<span class="string">'.'</span>, File.separatorChar) + <span class="string">".class"</span>;</span><br><span class="line">    }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<p>new 关键字创建对象的过程：<br><img data-src="https://ccomma-pic-storage.oss-cn-hangzhou.aliyuncs.com/img/0f0b824d58ce871b1e380098f87dadb4.png" alt="image.png"></p>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="https://ccomma.cn/321db62aa323/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/ccomma.png">
      <meta itemprop="name" content="CComma">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="CComma's Blog">
      <meta itemprop="description" content="下一个目标：改变世界！">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | CComma's Blog">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/321db62aa323/" class="post-title-link" itemprop="url">git flow</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>

      <time title="Created: 2020-04-18 21:28:10" itemprop="dateCreated datePublished" datetime="2020-04-18T21:28:10+08:00">2020-04-18</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">In</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/git/" itemprop="url" rel="index"><span itemprop="name">git</span></a>
        </span>
    </span>

  
  
  <span class="post-meta-item">
    
      <span class="post-meta-item-icon">
        <i class="far fa-comment"></i>
      </span>
      <span class="post-meta-item-text">Disqus: </span>
    
    <a title="disqus" href="/321db62aa323/#disqus_thread" itemprop="discussionUrl">
      <span class="post-comments-count disqus-comment-count" data-disqus-identifier="321db62aa323/" itemprop="commentCount"></span>
    </a>
  </span>
  
  
    <span class="post-meta-item" title="Reading time">
      <span class="post-meta-item-icon">
        <i class="far fa-clock"></i>
      </span>
      <span class="post-meta-item-text">Reading time &asymp;</span>
      <span>1 mins.</span>
    </span>
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <p><img data-src="https://ccomma-pic-storage.oss-cn-hangzhou.aliyuncs.com/img/f388a58466a12a9126440b2257c9781a.png"></p>
<h2 id="1-Master"><a href="#1-Master" class="headerlink" title="1. Master"></a>1. Master</h2><p>线上</p>
<h2 id="2-Develop"><a href="#2-Develop" class="headerlink" title="2. Develop"></a>2. Develop</h2><p>开发</p>
<h2 id="3-Feature"><a href="#3-Feature" class="headerlink" title="3. Feature"></a>3. Feature</h2><p>Feature 分支做完后，必须合并回 Develop 分支<br>合并完分支后一般会删点这个 Feature 分支，但是也可以保留</p>
<h2 id="4-Release"><a href="#4-Release" class="headerlink" title="4. Release"></a>4. Release</h2><p><em><strong>概述：</strong></em> 基于 Develop 分支创建，用于测试，修改 Bug<br><em><strong>创建：</strong></em> 一旦创建了 Release 分支之后，不要再从 Develop 分支上合并新的改动到 Release 分支<br><em><strong>发布：</strong></em> 发布 Release 分支时，合并 Release 到 Master 和 Develop， 同时在 Master 分支上打个 Tag 记住 Release 版本号，然后删除 Release 分支</p>
<h2 id="5-Hotfix"><a href="#5-Hotfix" class="headerlink" title="5. Hotfix"></a>5. Hotfix</h2><p>基于 Master 分支创建，开发完后需要合并回 Master 和 Develop 分支，同时在 Master 上打一个 tag</p>
<p>若有收获，就点个赞吧</p>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="https://ccomma.cn/2cf460af3028/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/ccomma.png">
      <meta itemprop="name" content="CComma">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="CComma's Blog">
      <meta itemprop="description" content="下一个目标：改变世界！">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | CComma's Blog">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2cf460af3028/" class="post-title-link" itemprop="url">git 常用配置记录</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>

      <time title="Created: 2020-04-17 16:53:55" itemprop="dateCreated datePublished" datetime="2020-04-17T16:53:55+08:00">2020-04-17</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">In</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/git/" itemprop="url" rel="index"><span itemprop="name">git</span></a>
        </span>
    </span>

  
  
  <span class="post-meta-item">
    
      <span class="post-meta-item-icon">
        <i class="far fa-comment"></i>
      </span>
      <span class="post-meta-item-text">Disqus: </span>
    
    <a title="disqus" href="/2cf460af3028/#disqus_thread" itemprop="discussionUrl">
      <span class="post-comments-count disqus-comment-count" data-disqus-identifier="2cf460af3028/" itemprop="commentCount"></span>
    </a>
  </span>
  
  
    <span class="post-meta-item" title="Reading time">
      <span class="post-meta-item-icon">
        <i class="far fa-clock"></i>
      </span>
      <span class="post-meta-item-text">Reading time &asymp;</span>
      <span>1 mins.</span>
    </span>
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h2 id="1-配置用户名"><a href="#1-配置用户名" class="headerlink" title="1. 配置用户名"></a>1. 配置用户名</h2><p><code>git config --global user.name "username"</code></p>
<h2 id="2-配置邮箱"><a href="#2-配置邮箱" class="headerlink" title="2. 配置邮箱"></a>2. 配置邮箱</h2><p><code>git config --global user.email "xxxx@xxxx.xx"</code></p>
<h2 id="3-其他配置"><a href="#3-其他配置" class="headerlink" title="3. 其他配置"></a>3. 其他配置</h2><figure class="highlight shell"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">#</span><span class="language-bash">让 Git 不要管 Windows/Unix 换行符转换的事</span></span><br><span class="line">git config --global core.autocrlf false</span><br></pre></td></tr></tbody></table></figure>
<h2 id="4-编码配置"><a href="#4-编码配置" class="headerlink" title="4. 编码配置"></a>4. 编码配置</h2><figure class="highlight shell"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">#</span><span class="language-bash">避免 git gui 中的中文乱码</span></span><br><span class="line">git config --global gui.encoding utf-8</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">避免 git status 显示的中文文件名乱码</span></span><br><span class="line">git config --global core.quotepath off</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">让 git 对大小写敏感</span></span><br><span class="line">git config --global core.ignorecase false</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">配置别名</span></span><br><span class="line">git config --global alias.lg "log --color --graph --pretty=format:'%Cred%h%Creset -%C(yellow)%d%Creset %s %Cgreen(%cr) %C(bold blue)&lt;%an&gt;%Creset' --abbrev-commit"</span><br></pre></td></tr></tbody></table></figure>
<p><strong>5. ssh key pair 配置</strong><br>SSH 是建立在应用层和传输层基础上的安全协议，其目的是专为远程登录会话和其他网络服务提供安全性的保障<br>SSH 密钥对可以让我们方便的登录到 SSH 服务器，而无需输入密码</p>
<ol>
<li>Windows 上 Git Bash 命令行窗口中输入：ssh-keygen -t rsa -C “<a href="mailto:xxx@xxx.com">xxx@xxx.com</a>“</li>
<li>接着一直回车生成 ssh key pair</li>
<li><code>ssh-add ~/.ssh/id_rsa</code>    #把专用密钥添加到 ssh-agent 的高速缓存中，ssh-agent 能避免这种反复输入私钥的烦恼</li>
<li><code>cat ~/.ssh/id_rsa.pub</code></li>
</ol>
<p><img data-src="https://ccomma-pic-storage.oss-cn-hangzhou.aliyuncs.com/img/e1edcae107e0bcbb1f409d558e1434a1.png" alt="image.png"></p>
<h2 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h2><ul>
<li><a target="_blank" rel="noopener" href="https://blog.csdn.net/upshi/article/details/78327125">(10 条消息) Git 多 SSH 账号管理_一黑到底 - CSDN 博客_git 多 ssh</a></li>
<li><a target="_blank" rel="noopener" href="https://www.cnblogs.com/popfisher/p/5731232.html">Windows 下 Git 多账号配置，同一电脑多个 ssh-key 的管理 - popfisher - 博客园 (cnblogs.com)</a></li>
</ul>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="https://ccomma.cn/b5a35826dc8c/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/ccomma.png">
      <meta itemprop="name" content="CComma">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="CComma's Blog">
      <meta itemprop="description" content="下一个目标：改变世界！">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | CComma's Blog">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/b5a35826dc8c/" class="post-title-link" itemprop="url">git 常用命令</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>

      <time title="Created: 2020-04-17 14:56:10" itemprop="dateCreated datePublished" datetime="2020-04-17T14:56:10+08:00">2020-04-17</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">In</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/git/" itemprop="url" rel="index"><span itemprop="name">git</span></a>
        </span>
    </span>

  
  
  <span class="post-meta-item">
    
      <span class="post-meta-item-icon">
        <i class="far fa-comment"></i>
      </span>
      <span class="post-meta-item-text">Disqus: </span>
    
    <a title="disqus" href="/b5a35826dc8c/#disqus_thread" itemprop="discussionUrl">
      <span class="post-comments-count disqus-comment-count" data-disqus-identifier="b5a35826dc8c/" itemprop="commentCount"></span>
    </a>
  </span>
  
  
    <span class="post-meta-item" title="Reading time">
      <span class="post-meta-item-icon">
        <i class="far fa-clock"></i>
      </span>
      <span class="post-meta-item-text">Reading time &asymp;</span>
      <span>2 mins.</span>
    </span>
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h2 id="1-提交和拉取"><a href="#1-提交和拉取" class="headerlink" title="1. 提交和拉取"></a>1. 提交和拉取</h2><figure class="highlight shell"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">暂存所有文件</span></span><br><span class="line">git add .</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">暂存并提交</span></span><br><span class="line">git commit -am</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">push 到远程 git</span></span><br><span class="line">git push</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">从远程 git 下拉到本地 git</span></span><br><span class="line">git pull</span><br></pre></td></tr></tbody></table></figure>
<p><a target="_blank" rel="noopener" href="https://segmentfault.com/a/1190000002783245">Git push 与 pull 的默认行为</a></p>
<h2 id="2-查看"><a href="#2-查看" class="headerlink" title="2. 查看"></a>2. 查看</h2><figure class="highlight shell"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">git status</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">查看不同</span></span><br><span class="line">git diff</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">查看日志</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">git <span class="built_in">log</span> --pretty=oneline --abbrev-commit</span></span><br><span class="line">git log</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">查看你的每一次命令</span></span><br><span class="line">git reflog</span><br></pre></td></tr></tbody></table></figure>
<h2 id="3-回退"><a href="#3-回退" class="headerlink" title="3. 回退"></a>3. 回退</h2><figure class="highlight shell"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">回退上一次提交，保留暂存区</span></span><br><span class="line">git reset --soft HEAD^</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">回退到指定版本</span></span><br><span class="line">git reset HEAD &lt;file&gt;</span><br></pre></td></tr></tbody></table></figure>
<h2 id="4-检出"><a href="#4-检出" class="headerlink" title="4. 检出"></a>4. 检出</h2><figure class="highlight shell"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">拉取暂存区文件到工作区</span></span><br><span class="line">git checkout -- &lt;file&gt;</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">切换分支</span></span><br><span class="line">git checkout branchName</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">新建并检出分支</span></span><br><span class="line">git checkout -b dev  =&gt;  git branch dev   &amp;   git checkout dev</span><br></pre></td></tr></tbody></table></figure>
<h2 id="5-远程"><a href="#5-远程" class="headerlink" title="5. 远程"></a>5. 远程</h2><figure class="highlight shell"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">查看远程库的信息</span></span><br><span class="line">git remote</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">显示了可以抓取和推送的 origin 的地址</span></span><br><span class="line">git remote -v</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">添加远程地址</span></span><br><span class="line">git remote add origin git@github.com:xxxxx</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">从远程 git 上 <span class="built_in">clone</span> 项目</span></span><br><span class="line">git clone git@github.com:xxxxx</span><br></pre></td></tr></tbody></table></figure>
<h2 id="6-分支"><a href="#6-分支" class="headerlink" title="6. 分支"></a>6. 分支</h2><figure class="highlight shell"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">查看分支</span></span><br><span class="line">git branch</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">创建 dev 分支</span></span><br><span class="line">git branch dev</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">删除 dev 分支</span></span><br><span class="line">git branch -d dev</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">强行删除 dev 分支</span></span><br><span class="line">git branch -D dev</span><br></pre></td></tr></tbody></table></figure>
<h2 id="7-合并"><a href="#7-合并" class="headerlink" title="7. 合并"></a>7. 合并</h2><figure class="highlight shell"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">合并 dev 分支到当前分支</span></span><br><span class="line">git merge dev</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">强制禁用 Fast forward</span></span><br><span class="line">git merge --no-ff -m "merge branch 'dev' into master" dev</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">变基</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">比较 git merge 合并整合得到的结果没有任何区别，但是通过 git rebase 衍合能产生一个更为整洁的提交历史。</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">把解决分支补丁同最新主干代码之间的冲突的责任，划转给由提交补丁的人来解决</span></span><br><span class="line">git rebase</span><br></pre></td></tr></tbody></table></figure>
<p><a target="_blank" rel="noopener" href="https://www.jianshu.com/p/4a8f4af4e803">rebase 用法小结</a><br><a target="_blank" rel="noopener" href="https://blog.csdn.net/wh_19910525/article/details/7554489">merge&nbsp;和&nbsp;rebase&nbsp;间的区别</a></p>
<h2 id="8-暂存"><a href="#8-暂存" class="headerlink" title="8. 暂存"></a>8. 暂存</h2><figure class="highlight shell"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">git stash</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">添加注释</span></span><br><span class="line">git stash save "message"</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">存储列表</span></span><br><span class="line">git stash list</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">使用某个存储，不删除</span></span><br><span class="line">git stash apply</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">删除某个存储</span></span><br><span class="line">git stash drop</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">使用并删除某个存储</span></span><br><span class="line">git stash pop</span><br></pre></td></tr></tbody></table></figure>
<h2 id="9-标签"><a href="#9-标签" class="headerlink" title="9. 标签"></a>9. 标签</h2><figure class="highlight shell"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">建一个新的标签</span></span><br><span class="line">git tag v1.0</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">对 <span class="built_in">id</span> 为 f52c633 的 commit 打标签</span></span><br><span class="line">git tag v0.9 f52c633</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">删除标签</span></span><br><span class="line">git tag -d v0.1</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">推送标签</span></span><br><span class="line">git push origin v1.0</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">推送全部标签</span></span><br><span class="line">git push origin --tags</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">删除远程标签</span></span><br><span class="line">git push origin :refs/tags/v0.9</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">查看所有标签</span></span><br><span class="line">git tag</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">带有说明的标签</span></span><br><span class="line">git tag -a v0.1 -m "version 0.1 released" 1094adb</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">查看标签信息</span></span><br><span class="line">git show v0.9</span><br></pre></td></tr></tbody></table></figure>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="https://ccomma.cn/42e07de1eb46/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/ccomma.png">
      <meta itemprop="name" content="CComma">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="CComma's Blog">
      <meta itemprop="description" content="下一个目标：改变世界！">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | CComma's Blog">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/42e07de1eb46/" class="post-title-link" itemprop="url">一文搞懂 Mybatis</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>

      <time title="Created: 2019-09-19 20:22:20" itemprop="dateCreated datePublished" datetime="2019-09-19T20:22:20+08:00">2019-09-19</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">In</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/MyBatis/" itemprop="url" rel="index"><span itemprop="name">MyBatis</span></a>
        </span>
    </span>

  
  
  <span class="post-meta-item">
    
      <span class="post-meta-item-icon">
        <i class="far fa-comment"></i>
      </span>
      <span class="post-meta-item-text">Disqus: </span>
    
    <a title="disqus" href="/42e07de1eb46/#disqus_thread" itemprop="discussionUrl">
      <span class="post-comments-count disqus-comment-count" data-disqus-identifier="42e07de1eb46/" itemprop="commentCount"></span>
    </a>
  </span>
  
  
    <span class="post-meta-item" title="Reading time">
      <span class="post-meta-item-icon">
        <i class="far fa-clock"></i>
      </span>
      <span class="post-meta-item-text">Reading time &asymp;</span>
      <span>8 mins.</span>
    </span>
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h1 id="一、配置-MyBatis（XML-形式）"><a href="#一、配置-MyBatis（XML-形式）" class="headerlink" title="一、配置 MyBatis（XML 形式）"></a>一、配置 MyBatis（XML 形式）</h1><p>src/main/resources/mybatis-config.xml：</p>
<figure class="highlight xml"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version=<span class="string">"1.0"</span> encoding=<span class="string">"UTF-8"</span> ?&gt;</span></span><br><span class="line"><span class="meta">&lt;!DOCTYPE <span class="keyword">configuration</span></span></span><br><span class="line"><span class="meta">    <span class="keyword">PUBLIC</span> <span class="string">"-//mybatis.org//DTD Config 3.0//EN"</span></span></span><br><span class="line"><span class="meta">    <span class="string">"http://mybatis.org/dtd/mybatis-3-config.dtd"</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">configuration</span>&gt;</span></span><br><span class="line">    <span class="comment">&lt;!--加载外部的properties文件，使用 ${jdbc.driver} 等形式注入--&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">properties</span> <span class="attr">resource</span>=<span class="string">"jdbc.properties"</span>&gt;</span><span class="tag">&lt;/<span class="name">properties</span>&gt;</span></span><br><span class="line">    </span><br><span class="line">    <span class="tag">&lt;<span class="name">settings</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">setting</span> <span class="attr">name</span>=<span class="string">"logImpl"</span> <span class="attr">value</span>=<span class="string">"LOG4J"</span> /&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">settings</span>&gt;</span></span><br><span class="line">    </span><br><span class="line">    <span class="tag">&lt;<span class="name">typeAliases</span>&gt;</span></span><br><span class="line">        <span class="comment">&lt;!--给单独的实体起别名--&gt;</span></span><br><span class="line">        <span class="comment">&lt;!--  &lt;typeAlias type="com.lagou.pojo.User" alias="user"&gt;&lt;/typeAlias&gt;--&gt;</span></span><br><span class="line">        <span class="comment">&lt;!--批量起别名：该包下所有的类的本身的类名：别名还不区分大小写--&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">package</span> <span class="attr">name</span>=<span class="string">"tk.mybatis.simple.model"</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">typeAliases</span>&gt;</span></span><br><span class="line">    </span><br><span class="line">    <span class="tag">&lt;<span class="name">environments</span> <span class="attr">default</span>=<span class="string">"development"</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">environment</span> <span class="attr">id</span>=<span class="string">"development"</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">transactionManager</span> <span class="attr">type</span>=<span class="string">"JDBC"</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">""</span> <span class="attr">value</span>=<span class="string">""</span>/&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">transactionManager</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">dataSource</span> <span class="attr">type</span>=<span class="string">"UNPOOLED"</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"driver"</span> <span class="attr">value</span>=<span class="string">"${jdbc.driver}"</span>/&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"url"</span> <span class="attr">value</span>=<span class="string">"${jdbc.url}"</span>/&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"username"</span> <span class="attr">value</span>=<span class="string">"${jdbc.username}"</span>/&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"password"</span> <span class="attr">value</span>=<span class="string">"${jdbc.password}"</span>/&gt;</span></span><br><span class="line">                <span class="comment">&lt;!--&lt;property name="driver" value="com.mysql.jdbc.Driver"/&gt;--&gt;</span></span><br><span class="line">                <span class="comment">&lt;!--&lt;property name="url" value="jdbc:mysql://localhost:3306/mybatis"/&gt;--&gt;</span></span><br><span class="line">                <span class="comment">&lt;!--&lt;property name="username" value="root"/&gt;--&gt;</span></span><br><span class="line">                <span class="comment">&lt;!--&lt;property name="password" value=""/&gt;--&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">dataSource</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">environment</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">environments</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">mappers</span>&gt;</span></span><br><span class="line">        <span class="comment">&lt;!-- &lt;package name="tk.mybatis.simple.mapper"/&gt; --&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">mapper</span> <span class="attr">resource</span>=<span class="string">"tk/mybatis/simple/mapper/CountryMapper.xml"</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">mappers</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">configuration</span>&gt;</span></span><br></pre></td></tr></tbody></table></figure>

<h1 id="二、具体语句"><a href="#二、具体语句" class="headerlink" title="二、具体语句"></a>二、具体语句</h1><h2 id="1-Insert"><a href="#1-Insert" class="headerlink" title="1. Insert"></a>1. Insert</h2><p>insert 返回主键</p>
<h3 id="1-1-只适用于支持主键自增的数据库"><a href="#1-1-只适用于支持主键自增的数据库" class="headerlink" title="1.1. 只适用于支持主键自增的数据库"></a>1.1. 只适用于支持主键自增的数据库</h3><figure class="highlight xml"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">insert</span> <span class="attr">id</span>=<span class="string">"insert2"</span> <span class="attr">useGeneratedKeys</span>=<span class="string">"true"</span> <span class="attr">keyProperty</span>=<span class="string">"id"</span>&gt;</span></span><br><span class="line">    insert into sys_user(</span><br><span class="line">        user_name, user_password)</span><br><span class="line">    values(</span><br><span class="line">        #{userName}, #{userPassword})</span><br><span class="line"><span class="tag">&lt;/<span class="name">insert</span>&gt;</span></span><br></pre></td></tr></tbody></table></figure>

<h3 id="1-2-使用-selectKey-返回主键的值"><a href="#1-2-使用-selectKey-返回主键的值" class="headerlink" title="1.2. 使用 selectKey 返回主键的值"></a>1.2. 使用 selectKey 返回主键的值</h3><figure class="highlight xml"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">insert</span> <span class="attr">id</span>=<span class="string">"insert2"</span> <span class="attr">useGeneratedKeys</span>=<span class="string">"true"</span> <span class="attr">keyProperty</span>=<span class="string">"id"</span>&gt;</span></span><br><span class="line">    insert into sys_user(</span><br><span class="line">        user_name, user_password)</span><br><span class="line">    values(</span><br><span class="line">        #{userName}, #{userPassword})</span><br><span class="line">    <span class="tag">&lt;<span class="name">selectKey</span> <span class="attr">keyColumn</span>=<span class="string">"id"</span> <span class="attr">resultType</span>=<span class="string">"long"</span> <span class="attr">keyProperty</span>=<span class="string">"id"</span> <span class="attr">order</span>=<span class="string">"AFTER"</span>&gt;</span></span><br><span class="line">        SELECT LAST_INSERT_ID()</span><br><span class="line">    <span class="tag">&lt;/<span class="name">selectKey</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">insert</span>&gt;</span></span><br></pre></td></tr></tbody></table></figure>

<p>Oracle：</p>
<figure class="highlight xml"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">selectKey</span> <span class="attr">keyColumn</span>=<span class="string">"id"</span> <span class="attr">result</span>=<span class="string">"long"</span> <span class="attr">keyProperty</span>=<span class="string">"id"</span> <span class="attr">order</span>=<span class="string">"BEFORE"</span>&gt;</span></span><br><span class="line">    SELECT SEQ_ID.nextval from dual</span><br><span class="line"><span class="tag">&lt;/<span class="name">selectKey</span>&gt;</span></span><br></pre></td></tr></tbody></table></figure>

<h2 id="2-select"><a href="#2-select" class="headerlink" title="2. select"></a>2. select</h2><figure class="highlight xml"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">select</span> <span class="attr">id</span>=<span class="string">"selectAll"</span> <span class="attr">resultType</span>=<span class="string">"tk.mybatis.simple.model.SysUser"</span>&gt;</span></span><br><span class="line">    select id,</span><br><span class="line">        user_name userName,</span><br><span class="line">        user_password userPassword</span><br><span class="line">    from sys_user</span><br><span class="line"><span class="tag">&lt;/<span class="name">select</span>&gt;</span></span><br></pre></td></tr></tbody></table></figure>

<p>使用 resultType 需要设置别名来实现自动映射</p>
<h1 id="三、注解方式"><a href="#三、注解方式" class="headerlink" title="三、注解方式"></a>三、注解方式</h1><h2 id="1-Select-注解"><a href="#1-Select-注解" class="headerlink" title="1. @Select  注解"></a>1. @Select  注解</h2><h3 id="1-1-通过别名自动映射"><a href="#1-1-通过别名自动映射" class="headerlink" title="1.1. 通过别名自动映射"></a>1.1. 通过别名自动映射</h3><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Select({"select id, role_name roleName ",</span></span><br><span class="line"><span class="meta">         "from sys_role ",</span></span><br><span class="line"><span class="meta">         "where id = #{id}"})</span></span><br><span class="line">SysRole <span class="title function_">selectById</span><span class="params">(Long id)</span>;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Select({"select id, role_name roleName </span></span><br><span class="line"><span class="meta">          from sys_role </span></span><br><span class="line"><span class="meta">          where id = #{id}"})</span></span><br><span class="line">SysRole <span class="title function_">selectById</span><span class="params">(Long id)</span>;</span><br></pre></td></tr></tbody></table></figure>

<h3 id="1-2-使用-resultMap-方式"><a href="#1-2-使用-resultMap-方式" class="headerlink" title="1.2. 使用 resultMap 方式"></a>1.2. 使用 resultMap 方式</h3><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 定义 id，实现共用</span></span><br><span class="line"><span class="meta">@Results(id = "roleResultMap", value = {</span></span><br><span class="line"><span class="meta">    @Result(property = "id", column = "id", id = true),</span></span><br><span class="line"><span class="meta">    @Result(property = "roleName", column = "role_name")</span></span><br><span class="line"><span class="meta">})</span></span><br><span class="line"></span><br><span class="line"><span class="meta">@Results({</span></span><br><span class="line"><span class="meta">    @Result(property = "id", column = "id", id = true),</span></span><br><span class="line"><span class="meta">    @Result(property = "roleName", column = "role_name")</span></span><br><span class="line"><span class="meta">})</span></span><br><span class="line"><span class="meta">@Select("select id, role_name from sys_role where id = #{id}")</span></span><br><span class="line">SysRole <span class="title function_">selectById2</span><span class="params">(Long id)</span>;</span><br><span class="line"></span><br><span class="line"><span class="meta">@ResultMap("roleResultMap")</span></span><br><span class="line"><span class="meta">@Select("select * from sys_role")</span></span><br><span class="line">List&lt;SysRole&gt; <span class="title function_">selectAll</span><span class="params">()</span>;</span><br></pre></td></tr></tbody></table></figure>

<h2 id="2-insert-注解"><a href="#2-insert-注解" class="headerlink" title="2. @insert  注解"></a>2. <a href="/insert">@insert </a> 注解</h2><h3 id="2-1-返回自增主键"><a href="#2-1-返回自增主键" class="headerlink" title="2.1. 返回自增主键"></a>2.1. 返回自增主键</h3><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Insert({"insert into sys_role(role_name)",</span></span><br><span class="line"><span class="meta">         "values(#{roleName})"})</span></span><br><span class="line"><span class="meta">@Options(useGeneratedKeys = true, keyProperty = "id")</span></span><br><span class="line"><span class="type">int</span> <span class="title function_">insert2</span><span class="params">(SysRole sysRole)</span>;</span><br></pre></td></tr></tbody></table></figure>

<h3 id="2-2-返回非自增主键"><a href="#2-2-返回非自增主键" class="headerlink" title="2.2. 返回非自增主键"></a>2.2. 返回非自增主键</h3><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Insert({"insert into sys_role(role_name)",</span></span><br><span class="line"><span class="meta">         "values(#{roleName})"})</span></span><br><span class="line"><span class="meta">@SelectKey(statement = "SELECT LAST_INSERT_ID()",</span></span><br><span class="line"><span class="meta">           keyProperty = "id",</span></span><br><span class="line"><span class="meta">           resultType = Long.class,</span></span><br><span class="line"><span class="meta">           before = false)</span></span><br><span class="line"><span class="type">int</span> <span class="title function_">insert3</span><span class="params">(SysRole sysRole)</span>;</span><br></pre></td></tr></tbody></table></figure>

<h2 id="3-Provider-注解"><a href="#3-Provider-注解" class="headerlink" title="3. Provider 注解"></a>3. Provider 注解</h2><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@SelectProvider(type = PrivilegeProvider.class, metod = "selectById")</span></span><br><span class="line">SysPrivilege <span class="title function_">selectById</span><span class="params">(Long id)</span>;</span><br></pre></td></tr></tbody></table></figure>

<p><em>PrivilegeProvider：</em></p>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">PrivilegeProvider</span> {</span><br><span class="line">    <span class="comment">// 直接返回字符串 sql 也行</span></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">selectById</span><span class="params">(<span class="keyword">final</span> Long id)</span> {</span><br><span class="line">        result <span class="keyword">new</span> <span class="title class_">SQL</span>() {</span><br><span class="line">            {</span><br><span class="line">                SELECT(<span class="string">"id, privilege_name, privilege_url"</span>);</span><br><span class="line">                FROM(<span class="string">"sys_privilege"</span>);</span><br><span class="line">                WHERE(<span class="string">"id = #{id}"</span>);</span><br><span class="line">            }</span><br><span class="line">        }.toString();</span><br><span class="line">    }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<h1 id="四、动态SQL"><a href="#四、动态SQL" class="headerlink" title="四、动态SQL"></a>四、动态 SQL</h1><h2 id="1-if-用法"><a href="#1-if-用法" class="headerlink" title="1. if 用法"></a>1. if 用法</h2><figure class="highlight xml"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">if</span> <span class="attr">test</span>=<span class="string">"userName != null and userName != ''"</span>&gt;</span></span><br><span class="line">    and user_name like concat('%', #{userName}, '%')</span><br><span class="line"><span class="tag">&lt;/<span class="name">if</span>&gt;</span></span><br></pre></td></tr></tbody></table></figure>

<h2 id="2-choose-用法"><a href="#2-choose-用法" class="headerlink" title="2. choose 用法"></a>2. choose 用法</h2><figure class="highlight xml"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">choose</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">when</span> <span class="attr">test</span>=<span class="string">"userName != null"</span>&gt;</span></span><br><span class="line">    ...</span><br><span class="line">    <span class="tag">&lt;/<span class="name">when</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">otherwhise</span>&gt;</span><span class="tag">&lt;/<span class="name">otherwhise</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">choose</span>&gt;</span></span><br></pre></td></tr></tbody></table></figure>

<h2 id="3-where-set-trim-用法"><a href="#3-where-set-trim-用法" class="headerlink" title="3. where set trim 用法"></a>3. where set trim 用法</h2><h3 id="3-1-where-用法"><a href="#3-1-where-用法" class="headerlink" title="3.1. where 用法"></a>3.1. where 用法</h3><figure class="highlight xml"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">where</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">if</span> <span class="attr">test</span>=<span class="string">"userName != null and userName != ''"</span>&gt;</span></span><br><span class="line">        and user_name like concat('%', #{userName}, '%')</span><br><span class="line">    <span class="tag">&lt;/<span class="name">if</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">where</span>&gt;</span></span><br></pre></td></tr></tbody></table></figure>

<h3 id="3-2-set-用法"><a href="#3-2-set-用法" class="headerlink" title="3.2. set 用法"></a>3.2. set 用法</h3><figure class="highlight xml"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">update</span> <span class="attr">id</span>=<span class="string">"updateByIdSelective"</span>&gt;</span></span><br><span class="line">    update sys_user</span><br><span class="line">    <span class="tag">&lt;<span class="name">set</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">if</span> <span class="attr">test</span>=<span class="string">"userName != null and userName != ''"</span>&gt;</span></span><br><span class="line">            user_name = #{userName},</span><br><span class="line">        <span class="tag">&lt;/<span class="name">if</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">if</span> <span class="attr">test</span>=<span class="string">"userPassword != null and userPassword != ''"</span>&gt;</span></span><br><span class="line">            user_password = #{userPassword},</span><br><span class="line">        <span class="tag">&lt;/<span class="name">if</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">set</span>&gt;</span></span><br><span class="line">    where id = #{id}</span><br><span class="line"><span class="tag">&lt;/<span class="name">update</span>&gt;</span></span><br></pre></td></tr></tbody></table></figure>

<h3 id="3-3-trim-用法"><a href="#3-3-trim-用法" class="headerlink" title="3.3. trim 用法"></a>3.3. trim 用法</h3><p>where 标签对应 trim 的实现：</p>
<figure class="highlight xml"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">trim</span> <span class="attr">prefix</span>=<span class="string">"WHERE"</span> <span class="attr">prefixOverrides</span>=<span class="string">"AND |OR"</span>&gt;</span></span><br><span class="line">    ...</span><br><span class="line"><span class="tag">&lt;/<span class="name">trim</span>&gt;</span></span><br></pre></td></tr></tbody></table></figure>

<p>set 标签对应的 trim 实现：</p>
<figure class="highlight xml"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">trim</span> <span class="attr">prefix</span>=<span class="string">"SET"</span> <span class="attr">suffixOverrides</span>=<span class="string">","</span>&gt;</span></span><br><span class="line">    ...</span><br><span class="line"><span class="tag">&lt;/<span class="name">trim</span>&gt;</span></span><br></pre></td></tr></tbody></table></figure>

<ul>
<li>prefix： 给内容增加 prefix 指定的前缀</li>
<li> prefixOverrides： 把内容中匹配的前缀字符串去掉</li>
<li> suffix： 给内容增加 suffix 指定的后缀</li>
<li> suffixOverrides： 把内容中匹配的后缀字符串去掉</li>
</ul>
<h2 id="4-foreach-用法"><a href="#4-foreach-用法" class="headerlink" title="4. foreach 用法"></a>4. foreach 用法</h2><figure class="highlight xml"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">where id in</span><br><span class="line"><span class="tag">&lt;<span class="name">foreach</span> <span class="attr">collection</span>=<span class="string">"list"</span> <span class="attr">open</span>=<span class="string">"("</span> <span class="attr">separator</span>=<span class="string">","</span> <span class="attr">close</span>=<span class="string">")"</span> <span class="attr">item</span>=<span class="string">"id"</span> <span class="attr">index</span>=<span class="string">"i"</span>&gt;</span></span><br><span class="line">    #{id}</span><br><span class="line"><span class="tag">&lt;/<span class="name">foreach</span>&gt;</span></span><br></pre></td></tr></tbody></table></figure>

<h2 id="5-bind-用法"><a href="#5-bind-用法" class="headerlink" title="5. bind 用法"></a>5. bind 用法</h2><figure class="highlight xml"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">if</span> <span class="attr">test</span>=<span class="string">"userName != null and userName != ''"</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">bind</span> <span class="attr">name</span>=<span class="string">"userNameLike"</span> <span class="attr">value</span>=<span class="string">"'%' + userName + '%'"</span>/&gt;</span></span><br><span class="line">    and user_name like #{userNameLike}</span><br><span class="line"><span class="tag">&lt;/<span class="name">if</span>&gt;</span></span><br></pre></td></tr></tbody></table></figure>

<h1 id="五、高级结果映射"><a href="#五、高级结果映射" class="headerlink" title="五、高级结果映射"></a>五、高级结果映射</h1><h2 id="1-一对一映射"><a href="#1-一对一映射" class="headerlink" title="1. 一对一映射"></a>1. 一对一映射</h2><h3 id="1-1-使用自动映射"><a href="#1-1-使用自动映射" class="headerlink" title="1.1. 使用自动映射"></a>1.1. 使用自动映射</h3><figure class="highlight xml"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">select</span> <span class="attr">id</span>=<span class="string">"selectUserAndRoleById"</span> <span class="attr">resultType</span>=<span class="string">"tk.mybatis.simple.model.SysUser"</span>&gt;</span></span><br><span class="line">    select u.id, u.user_name as userName, u.user_password as userPassword, </span><br><span class="line">           r.id as "role.id", r.role_name as "role.roleName"</span><br><span class="line">    from sys_user u</span><br><span class="line">    inner join sys_user_role ur on u.id = ur.user_id</span><br><span class="line">    inner join sys_role r on ur.role_id = r.id</span><br><span class="line">    where u.id = #{id}</span><br><span class="line"><span class="tag">&lt;/<span class="name">select</span>&gt;</span></span><br></pre></td></tr></tbody></table></figure>

<h3 id="1-2-使用-resultMap-配置一对一映射"><a href="#1-2-使用-resultMap-配置一对一映射" class="headerlink" title="1.2. 使用 resultMap 配置一对一映射"></a>1.2. 使用 resultMap 配置一对一映射</h3><figure class="highlight xml"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">resultMap</span> <span class="attr">id</span>=<span class="string">"userRoleMap"</span> <span class="attr">type</span>=<span class="string">"tk.mybatis.simple.model.SysUser"</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">result</span> <span class="attr">property</span>=<span class="string">"id"</span> <span class="attr">column</span>=<span class="string">"id"</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">result</span> <span class="attr">property</span>=<span class="string">"userName"</span> <span class="attr">column</span>=<span class="string">"user_name"</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">result</span> <span class="attr">property</span>=<span class="string">"userPassword"</span> <span class="attr">column</span>=<span class="string">"user_password"</span>/&gt;</span></span><br><span class="line">    </span><br><span class="line">    <span class="tag">&lt;<span class="name">result</span> <span class="attr">property</span>=<span class="string">"role.id"</span> <span class="attr">column</span>=<span class="string">"role_id"</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">result</span> <span class="attr">property</span>=<span class="string">"role.roleName"</span> <span class="attr">column</span>=<span class="string">"role_name"</span>/&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">resultMap</span>&gt;</span></span><br></pre></td></tr></tbody></table></figure>

<h3 id="1-3-使用-resultMap-的-association-标签配置一对一映射"><a href="#1-3-使用-resultMap-的-association-标签配置一对一映射" class="headerlink" title="1.3. 使用 resultMap 的 association 标签配置一对一映射"></a>1.3. 使用 resultMap 的 association 标签配置一对一映射</h3><figure class="highlight xml"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">resultMap</span> <span class="attr">id</span>=<span class="string">"userRoleMap"</span> <span class="attr">type</span>=<span class="string">"tk.mybatis.simple.model.SysUser"</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">association</span> <span class="attr">property</span>=<span class="string">"role"</span> <span class="attr">columnPrefix</span>=<span class="string">"role_"</span> <span class="attr">javaType</span>=<span class="string">"tk.mybatis.simple.model.SysRole"</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">result</span> <span class="attr">property</span>=<span class="string">"id"</span> <span class="attr">column</span>=<span class="string">"id"</span>/&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">result</span> <span class="attr">property</span>=<span class="string">"roleName"</span> <span class="attr">column</span>=<span class="string">"role_name"</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">association</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">resultMap</span>&gt;</span></span><br></pre></td></tr></tbody></table></figure>

<h2 id="2-一对多映射"><a href="#2-一对多映射" class="headerlink" title="2. 一对多映射"></a>2. 一对多映射</h2><figure class="highlight xml"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">resultMap</span> <span class="attr">id</span>=<span class="string">"userRoleListMap"</span> <span class="attr">extends</span>=<span class="string">"userMap"</span> <span class="attr">type</span>=<span class="string">"tk.mybatis.simple.model.SysUser"</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">id</span> <span class="attr">property</span>=<span class="string">"id"</span> <span class="attr">column</span>=<span class="string">"id"</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">result</span> <span class="attr">property</span>=<span class="string">"userName"</span> <span class="attr">column</span>=<span class="string">"user_name"</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">result</span> <span class="attr">property</span>=<span class="string">"userPassword"</span> <span class="attr">column</span>=<span class="string">"user_password"</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">collection</span> <span class="attr">property</span>=<span class="string">"roleList"</span> <span class="attr">columnPrefix</span>=<span class="string">"role_"</span> <span class="attr">javaType</span>=<span class="string">"tk.mybatis.simple.model.SysRole"</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">id</span> <span class="attr">property</span>=<span class="string">"id"</span> <span class="attr">column</span>=<span class="string">"id"</span>/&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">result</span> <span class="attr">property</span>=<span class="string">"roleName"</span> <span class="attr">column</span>=<span class="string">"role_name"</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">collection</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">resultMap</span>&gt;</span></span><br></pre></td></tr></tbody></table></figure>

<h2 id="3-返回-Map"><a href="#3-返回-Map" class="headerlink" title="3.返回 Map"></a>3. 返回 Map</h2><h3 id="3-1-map-的-value-为-java-类"><a href="#3-1-map-的-value-为-java-类" class="headerlink" title="3.1. map 的 value 为 java 类"></a>3.1. map 的 value 为 java 类</h3><p>mapper.java</p>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@MapKey("id")</span></span><br><span class="line">Map&lt;Long, UserInfo&gt; <span class="title function_">getUserInfoMap</span><span class="params">()</span>;</span><br></pre></td></tr></tbody></table></figure>

<p>mapper.xml</p>
<figure class="highlight xml"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">resultMap</span> <span class="attr">id</span>=<span class="string">"UserResultMap"</span> <span class="attr">type</span>=<span class="string">"com.xixicat.domain.UserInfo"</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">result</span> <span class="attr">property</span>=<span class="string">"id"</span> <span class="attr">column</span>=<span class="string">"id"</span> /&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">result</span> <span class="attr">property</span>=<span class="string">"username"</span> <span class="attr">column</span>=<span class="string">"username"</span> /&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">result</span> <span class="attr">property</span>=<span class="string">"sex"</span> <span class="attr">column</span>=<span class="string">"sex"</span> /&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">resultMap</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">select</span> <span class="attr">id</span>=<span class="string">"getUserInfoMap"</span> <span class="attr">resultMap</span>=<span class="string">"UserResultMap"</span>&gt;</span></span><br><span class="line">   select id,username,sex from user_info</span><br><span class="line"><span class="tag">&lt;/<span class="name">select</span>&gt;</span></span><br></pre></td></tr></tbody></table></figure>

<h3 id="3-2-map-的-value-为-map"><a href="#3-2-map-的-value-为-map" class="headerlink" title="3.2. map 的 value 为 map"></a>3.2. map 的 value 为 map</h3><p>mapper.java</p>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@MapKey("id")</span></span><br><span class="line">Map&lt;Long, Map&lt;String,Object&gt;&gt; <span class="title function_">getUserValueMap</span><span class="params">()</span>;</span><br></pre></td></tr></tbody></table></figure>

<p>mapper.xml</p>
<figure class="highlight xml"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">select</span> <span class="attr">id</span>=<span class="string">"getUserValueMap"</span> <span class="attr">resultType</span>=<span class="string">"map"</span> &gt;</span></span><br><span class="line">        select id,username,sex from user_info</span><br><span class="line">        from user_info</span><br><span class="line"><span class="tag">&lt;/<span class="name">select</span>&gt;</span></span><br></pre></td></tr></tbody></table></figure>

<h3 id="3-3-返回-List"><a href="#3-3-返回-List" class="headerlink" title="3.3. 返回 List<Map<key, value>>"></a>3.3. 返回 List&lt;Map&lt;key, value&gt;&gt;</h3><p>mapper.java</p>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">List&lt;Map&lt;String, Object&gt;&gt; <span class="title function_">countInquireForMobile</span><span class="params">()</span>;</span><br></pre></td></tr></tbody></table></figure>

<p>mapper.xml</p>
<figure class="highlight xml"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">select</span> <span class="attr">id</span>=<span class="string">"countInquireForMobile"</span> <span class="attr">resultType</span>=<span class="string">"map"</span>&gt;</span></span><br><span class="line">    select o.status as `status`, count(mc.id) as `count`</span><br><span class="line">    from mall_contract mc</span><br><span class="line">    join mall_order o on o.contract_no = mc.contract_no</span><br><span class="line">    where o.archive = false and o.flag = 0</span><br><span class="line">    and o.status in ('SUBMITTED', 'PAID', 'SHIPPED', 'SUCCESS') and o.refund_status = 'CREATE'</span><br><span class="line">    <span class="tag">&lt;<span class="name">if</span> <span class="attr">test</span>=<span class="string">"params.opUserType == 'BUYER'"</span>&gt;</span></span><br><span class="line">        and o.buyer_id = #{params.operatorId,typeHandler=idHandler}</span><br><span class="line">    <span class="tag">&lt;/<span class="name">if</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">if</span> <span class="attr">test</span>=<span class="string">"params.opUserType == 'SELLER'"</span>&gt;</span></span><br><span class="line">        and o.seller_id = #{params.operatorId,typeHandler=idHandler}</span><br><span class="line">    <span class="tag">&lt;/<span class="name">if</span>&gt;</span></span><br><span class="line">    group by o.status</span><br><span class="line"><span class="tag">&lt;/<span class="name">select</span>&gt;</span></span><br></pre></td></tr></tbody></table></figure>

<h2 id="4-鉴别器映射"><a href="#4-鉴别器映射" class="headerlink" title="4. 鉴别器映射"></a>4. 鉴别器映射</h2><p>类似于 switch</p>
<figure class="highlight xml"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">resultMap</span> <span class="attr">id</span>=<span class="string">"rolePrivilegeListMapChoose"</span> <span class="attr">type</span>=<span class="string">"tk.mybatis.simple.model.SysRole"</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">discriminator</span> <span class="attr">column</span>=<span class="string">"enabled"</span> <span class="attr">javaType</span>=<span class="string">"int"</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">case</span> <span class="attr">value</span>=<span class="string">"1"</span> <span class="attr">resultMap</span>=<span class="string">"rolePrivilegeListMapSelect"</span>/&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">case</span> <span class="attr">value</span>=<span class="string">"0"</span> <span class="attr">resultMap</span>=<span class="string">"roleMap"</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">discriminator</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">resultMap</span>&gt;</span></span><br></pre></td></tr></tbody></table></figure>

<h2 id="5-枚举处理器"><a href="#5-枚举处理器" class="headerlink" title="5. 枚举处理器"></a>5. 枚举处理器</h2><p>在 mybatis-config.xml 中添加配置：使用枚举的索引进行处理</p>
<figure class="highlight xml"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">typeHandlers</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">typeHandler</span> <span class="attr">javaType</span>=<span class="string">"tk.mybatis.simple.type.Enabled"</span> </span></span><br><span class="line"><span class="tag">                 <span class="attr">handler</span>=<span class="string">"org.apache.ibatis.type.EnumOrdinalTypeHandler"</span>/&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">typeHandlers</span>&gt;</span></span><br></pre></td></tr></tbody></table></figure>

<h2 id="6-自定义处理器"><a href="#6-自定义处理器" class="headerlink" title="6. 自定义处理器"></a>6. 自定义处理器</h2><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">EnabledTypeHandler</span> <span class="keyword">implements</span> <span class="title class_">TypeHanlder</span>&lt;Enabled&gt; {</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> Map&lt;Integer, Enabled&gt; enabledMap = <span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;Integer, Enabled&gt;();</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">EnabledTypeHandler</span><span class="params">()</span> {</span><br><span class="line">        <span class="keyword">for</span> (Enabled enabled : Enabled.values()) {</span><br><span class="line">            enabledMap.put(enabled.getValue(), enabled);</span><br><span class="line">        }</span><br><span class="line">    }</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setParameter</span><span class="params">(PreparedStatement ps, <span class="type">int</span> i, </span></span><br><span class="line"><span class="params">        Enabled parameter, JdbcType jdbcType)</span> <span class="keyword">throws</span> SQLException {</span><br><span class="line"></span><br><span class="line">        ps.setInt(i, parameter.getValue());</span><br><span class="line">    }</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> Enabled <span class="title function_">getResult</span><span class="params">(ResultSet rs, <span class="type">int</span> columnIndex)</span> <span class="keyword">throws</span> SQLException {</span><br><span class="line">        <span class="type">Integer</span> <span class="variable">value</span> <span class="operator">=</span> rs.getInt(columnIndex);</span><br><span class="line">        <span class="keyword">return</span> enabledMap.get(value);</span><br><span class="line">    }</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> Enabled <span class="title function_">getResult</span><span class="params">(CallableStatement cs, <span class="type">int</span> columnIndex)</span> <span class="keyword">throws</span> SQLException {</span><br><span class="line">        <span class="type">Integer</span> <span class="variable">value</span> <span class="operator">=</span> cs.getInt(columnIndex);</span><br><span class="line">        <span class="keyword">return</span> enabledMap.get(value);</span><br><span class="line">    }</span><br><span class="line">    </span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<p>在 mybatis-config.xml 中配置：</p>
<figure class="highlight xml"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">typeHandlers</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">typeHandler</span> <span class="attr">javaType</span>=<span class="string">"tk.mybatis.simple.type.Enabled"</span></span></span><br><span class="line"><span class="tag">                 <span class="attr">handler</span>=<span class="string">"tk.mybatis.simple.type.EnabledTypeHandler"</span>/&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">typeHandlers</span>&gt;</span></span><br></pre></td></tr></tbody></table></figure>

<h1 id="六、缓存"><a href="#六、缓存" class="headerlink" title="六、缓存"></a>六、缓存</h1><h2 id="1-一级缓存"><a href="#1-一级缓存" class="headerlink" title="1. 一级缓存"></a>1. 一级缓存</h2><p><strong><em>范围：</em></strong> SqlSession</p>
<p><strong><em>概述：</em></strong><br>MyBatis 的一级缓存存在于 SqlSession 的生命周期中，默认开启<br>在同一个 SqlSession 中查询时，MyBatis 会把执行的方法和参数通过算法生成缓存的键值，将键值和查询结果存入一个 Map 对象中</p>
<p><strong><em>清空缓存：</em></strong> 更新或删除操作会清空缓存，或使用 SqlSession#clearCache () 方法进行手动刷新</p>
<p><strong><em>flushCache=”true”：</em></strong> 查询数据前清空当前的一级缓存</p>
<figure class="highlight xml"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">select</span> <span class="attr">id</span>=<span class="string">"selectById"</span> <span class="attr">flushCache</span>=<span class="string">"true"</span> <span class="attr">resultMap</span>=<span class="string">"userMap"</span>&gt;</span></span><br><span class="line">    select * from sys_user where id = #{id}</span><br><span class="line"><span class="tag">&lt;/<span class="name">select</span>&gt;</span></span><br></pre></td></tr></tbody></table></figure>

<h2 id="2-二级缓存"><a href="#2-二级缓存" class="headerlink" title="2. 二级缓存"></a>2. 二级缓存</h2><p><strong><em>范围：</em></strong> Mapper(namespace)</p>
<p><strong><em>概述：</em></strong><br>默认不开启<br>会重新创建一个对象进行 copy<br>无法实现分布式缓存</p>
<h3 id="2-1-在-mapper-xml-中配置"><a href="#2-1-在-mapper-xml-中配置" class="headerlink" title="2.1. 在 mapper.xml 中配置"></a>2.1. 在 mapper.xml 中配置</h3><p>二级缓存全局开关： 不必配置，默认已为 true<br>mybatis-config.xml：</p>
<figure class="highlight xml"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">settings</span>&gt;</span></span><br><span class="line">    <span class="comment">&lt;!-- 其他配置 --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">setting</span> <span class="attr">name</span>=<span class="string">"cacheEnabled"</span> <span class="attr">value</span>=<span class="string">"true"</span>/&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">settings</span>&gt;</span></span><br></pre></td></tr></tbody></table></figure>

<p>开启二级缓存：</p>
<figure class="highlight xml"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">mapper</span> <span class="attr">namespace</span>=<span class="string">"tk.mybatis.simple.mapper.RoleMapper"</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">cache</span>/&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">mapper</span>&gt;</span></span><br></pre></td></tr></tbody></table></figure>

<p>默认的二级缓存会有如下效果</p>
<ul>
<li>所有的 select 语句将会被缓存</li>
<li>所有的 insert、update、delete 语句将会刷新缓存</li>
<li>缓存会使用 LRU 算法来回收</li>
<li>根据时间表（刷新间隔），缓存不会以任何时间顺序刷新</li>
<li>缓存会存储集合或对象 1024 个引用</li>
<li>缓存会被视为 可读可写 的，所以返回的对象不是共享的，可以安全的修改</li>
</ul>
<p>cache 可配置的属性：</p>
<figure class="highlight xml"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">cache</span> <span class="attr">eviction</span>=<span class="string">"FIFO"</span> <span class="attr">flushInterval</span>=<span class="string">"60000"</span> <span class="attr">size</span>=<span class="string">"512"</span> <span class="attr">readOnly</span>=<span class="string">"true"</span>/&gt;</span></span><br></pre></td></tr></tbody></table></figure>

<ul>
<li>eviction：收回策略</li>
<li> LRU（最近最少使用）：移除最长时间不被使用的对象，默认</li>
<li> FIFO（先进先出）：按对象进入缓存的顺序来移除它们</li>
<li> SOFT（软引用）：移除基于垃圾回收器状态和弱引用规则的对象</li>
<li> WEAK（弱引用）：更积极地移除基于垃圾收集器状态和弱引用规则的对象</li>
<li> flushInterval：刷新间隔。毫秒，默认不设置（没有刷新间隔，缓存仅在调用 sql 时刷新）。</li>
<li>size：引用数目。默认 1024</li>
<li>readOnly：只读。只读的缓存会给所有调用者返回缓存对象的相同实例，不能修改。默认 false</li>
</ul>
<h3 id="2-2-在-Mapper-接口中配置二级缓存"><a href="#2-2-在-Mapper-接口中配置二级缓存" class="headerlink" title="2.2. 在 Mapper 接口中配置二级缓存"></a>2.2. 在 Mapper 接口中配置二级缓存</h3><p><strong><em>当只使用注解方式配置二级缓存时：</em></strong></p>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@CacheNamespace</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">RoleMapper</span> {</span><br><span class="line">    ...</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<p><strong><em>配置属性：</em></strong></p>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@CacheNamespace(</span></span><br><span class="line"><span class="meta">    eviction = FifoCache.class,</span></span><br><span class="line"><span class="meta">    flushInterval = 60000,</span></span><br><span class="line"><span class="meta">    size = 512,</span></span><br><span class="line"><span class="meta">    readWrite = true</span></span><br><span class="line"><span class="meta">)</span></span><br></pre></td></tr></tbody></table></figure>

<p><strong><em>当同时使用注解方式和 &nbsp;XML 映射文件时：</em></strong> 使用参照缓存<br>这样就会使用命名空间为 tk.mybatis.simple.mapperRoleMapper 的缓存配置，即 RoleMapper.xml 中配置的缓存</p>
<p>引用 Mapp 接口中配置的二级缓存</p>
<figure class="highlight xml"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">cache-ref</span> <span class="attr">namespace</span>=<span class="string">"tk.mybatis.simple.mapper.RoleMapper"</span>/&gt;</span></span><br></pre></td></tr></tbody></table></figure>

<h3 id="2-3-使用二级缓存"><a href="#2-3-使用二级缓存" class="headerlink" title="2.3. 使用二级缓存"></a>2.3. 使用二级缓存</h3><p>使用可读写缓存，通过序列化和反序列化来保证通过缓存获取数据时，得到的是一个 <strong>新的实例</strong>。</p>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">sqlSession = getSqlSession();</span><br><span class="line"><span class="keyword">try</span> {</span><br><span class="line">    <span class="comment">// 获取 RoleMapper 接口</span></span><br><span class="line">    <span class="type">RoleMapper</span> <span class="variable">roleMapper</span> <span class="operator">=</span> sqlSession.getMapper(RoleMapper.class);</span><br><span class="line">    <span class="comment">// 调用 selectById 方法，查询 id = 1 的用户</span></span><br><span class="line">    <span class="type">SysRole</span> <span class="variable">role2</span> <span class="operator">=</span> roleMapper.selectById(<span class="number">1L</span>);</span><br><span class="line">    <span class="comment">// 第二个 session 获取的用户名是 New Nam</span></span><br><span class="line">    Assert.assertEquals(<span class="string">"New Name"</span>, role2.getRoleName());</span><br><span class="line">    <span class="comment">// 这里的 role2 和前一个 session 查询的结果是两个不同的实例</span></span><br><span class="line">    Assert.assertNotEquals(role1, role2);</span><br><span class="line">    <span class="comment">// 获取 role3</span></span><br><span class="line">    <span class="type">SysRole</span> <span class="variable">role3</span> <span class="operator">=</span> roleMapper.selectById(<span class="number">1L</span>);</span><br><span class="line">    <span class="comment">// 这里的 role2 和 role3 是两个不同的实例</span></span><br><span class="line">    Assert.assertNotEquals(role2, role3);</span><br><span class="line">} <span class="keyword">finally</span> {</span><br><span class="line">    <span class="comment">// 关闭 sqlSession</span></span><br><span class="line">    sqlSession.close();</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<h3 id="2-4-二级缓存适用场景"><a href="#2-4-二级缓存适用场景" class="headerlink" title="2.4. 二级缓存适用场景"></a>2.4. 二级缓存适用场景</h3><ul>
<li>以查询为主的应用中，只有尽可能少的 curd</li>
<li> 绝大多数以单表操作存在时，由于很少存在互相关联的情况，因此不会出现脏数据</li>
<li>分布式场景不能使用，需要借助第三方缓存中间件</li>
</ul>
<h3 id="2-5-使用-redis-实现二级缓存"><a href="#2-5-使用-redis-实现二级缓存" class="headerlink" title="2.5. 使用 redis 实现二级缓存"></a>2.5. 使用 redis 实现二级缓存</h3><ol>
<li><p>加入依赖 </p>
<figure class="highlight xml"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.mybatis.caches<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>mybatis-redis<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.0.0-beta2<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></tbody></table></figure>

</li>
<li><p>使用缓存 </p>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@CacheNamespace(implementation = RedisCache.class)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">IUserMapper</span> {</span><br><span class="line">    ...</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure></li>
</ol>
<h1 id="七、插件"><a href="#七、插件" class="headerlink" title="七、插件"></a>七、插件</h1><h2 id="1-概述"><a href="#1-概述" class="headerlink" title="1. 概述"></a>1. 概述</h2><p>对 mybatis 的扩展，其原理是拦截器，在四大组件（<code>Executor</code>、<code>StatementHandler</code>、<code>ParamterHandler</code>、<code>ResultSetHandler</code>）使用时拦截处理</p>
<p><img data-src="https://ccomma-pic-storage.oss-cn-hangzhou.aliyuncs.com/img/e3bcdaa2f4207b968a1d3ad28bf5504a.png" alt="image.png"></p>
<p><strong><em>允许拦截的方法：</em></strong></p>
<ul>
<li>Executor（执行器）：update、query、commit、rollback</li>
<li>StatementHandler（SQL 语句构建器）：prepare、parameterize、batch、update、query</li>
<li>ParameterHandler（参数处理器）：getParameterObject、setParameters</li>
<li>ResultSetHandler（结果集处理器）：handleResultSets、handleOutputParameters</li>
</ul>
<p><strong><em>原理：</em></strong><br>在四大组件对象创建时遍历所有的拦截器，每个拦截器都使用 interceptor.plugin (target) 方法对目标类进行增强</p>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> ParameterHandler <span class="title function_">newParameterHandler</span><span class="params">(MappedStatement mappedStatement, Object object, BoundSql sql, InterceptorChain interceptorChain)</span> {</span><br><span class="line">    <span class="type">ParameterHandler</span> <span class="variable">parameterHandler</span> <span class="operator">=</span> mappedStatement.getLang().createParameterHandler(mappedStatement,object,sql); </span><br><span class="line">    parameterHandler = (ParameterHandler) interceptorChain.pluginAll(parameterHandler); </span><br><span class="line">    <span class="keyword">return</span> parameterHandler;</span><br><span class="line">}</span><br><span class="line"><span class="keyword">public</span> Object <span class="title function_">pluginAll</span><span class="params">(Object target)</span> { </span><br><span class="line">    <span class="keyword">for</span> (Interceptor interceptor : interceptors) { </span><br><span class="line">        target = interceptor.plugin(target);</span><br><span class="line">    } </span><br><span class="line">    <span class="keyword">return</span> target; </span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<h2 id="2-自定义插件"><a href="#2-自定义插件" class="headerlink" title="2. 自定义插件"></a>2. 自定义插件</h2><ol>
<li><p>实现 Interceptor 并添加注解</p>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Intercepts({</span></span><br><span class="line"><span class="meta">    @Signature(</span></span><br><span class="line"><span class="meta">        // 指定组件</span></span><br><span class="line"><span class="meta">        type = Executor.class,</span></span><br><span class="line"><span class="meta">        // 指定方法</span></span><br><span class="line"><span class="meta">        method = "query",</span></span><br><span class="line"><span class="meta">        // 指定参数确定方法</span></span><br><span class="line"><span class="meta">        args = {MapperStatement.class, Object.class, RowBounds.class, ResultHandler.class}</span></span><br><span class="line"><span class="meta">    )</span></span><br><span class="line"><span class="meta">})</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ExamplePlugin</span> <span class="keyword">implements</span> <span class="title class_">Interceptor</span> {</span><br><span class="line">    <span class="comment">// 每次操作都会进入该方法</span></span><br><span class="line">    <span class="meta">@Override</span> </span><br><span class="line">    <span class="keyword">public</span> Object <span class="title function_">intercept</span><span class="params">(Invocation invocation)</span> <span class="keyword">throws</span> Throwable {</span><br><span class="line">        System.out.println(<span class="string">"对方法进行了增强...."</span>); </span><br><span class="line">        <span class="keyword">return</span> invocation.proceed();</span><br><span class="line">    }</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 把这个拦截器生成一个代理放到拦截器链中</span></span><br><span class="line">    <span class="meta">@Override</span> </span><br><span class="line">    <span class="keyword">public</span> Object <span class="title function_">plugin</span><span class="params">(Object target)</span> { </span><br><span class="line">        System.out.println(<span class="string">"将要包装的目标对象"</span> + target);</span><br><span class="line">        <span class="keyword">return</span> Plugin.wrap(target, <span class="built_in">this</span>);</span><br><span class="line">    }</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 插件初始化时调用一次，获取配置的属性，如下：&lt;name, Bob&gt;</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setProperties</span><span class="params">(Properties properties)</span> { </span><br><span class="line">        System.out.println(<span class="string">"初始化参数"</span> + properties);</span><br><span class="line">    }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

</li>
<li><p>配置到配置文件中</p>
<figure class="highlight xml"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">plugins</span>&gt;</span> </span><br><span class="line">    <span class="tag">&lt;<span class="name">plugin</span> <span class="attr">interceptor</span>=<span class="string">"com.xxx.plugin.ExamplePlugin"</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"name"</span> <span class="attr">value</span>=<span class="string">"Bob"</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">plugin</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">plugins</span>&gt;</span></span><br></pre></td></tr></tbody></table></figure></li>
</ol>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="https://ccomma.cn/7f785420883c/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/ccomma.png">
      <meta itemprop="name" content="CComma">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="CComma's Blog">
      <meta itemprop="description" content="下一个目标：改变世界！">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | CComma's Blog">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/7f785420883c/" class="post-title-link" itemprop="url">Linux 安装 MySQL</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>

      <time title="Created: 2019-07-13 17:08:56" itemprop="dateCreated datePublished" datetime="2019-07-13T17:08:56+08:00">2019-07-13</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">In</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/MySQL/" itemprop="url" rel="index"><span itemprop="name">MySQL</span></a>
        </span>
          , 
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/MySQL/%E6%95%B0%E6%8D%AE%E5%BA%93/" itemprop="url" rel="index"><span itemprop="name">数据库</span></a>
        </span>
    </span>

  
  
  <span class="post-meta-item">
    
      <span class="post-meta-item-icon">
        <i class="far fa-comment"></i>
      </span>
      <span class="post-meta-item-text">Disqus: </span>
    
    <a title="disqus" href="/7f785420883c/#disqus_thread" itemprop="discussionUrl">
      <span class="post-comments-count disqus-comment-count" data-disqus-identifier="7f785420883c/" itemprop="commentCount"></span>
    </a>
  </span>
  
  
    <span class="post-meta-item" title="Reading time">
      <span class="post-meta-item-icon">
        <i class="far fa-clock"></i>
      </span>
      <span class="post-meta-item-text">Reading time &asymp;</span>
      <span>3 mins.</span>
    </span>
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <p><strong>1. 下载解压</strong><br><strong>1.1 下载</strong><br>wget mysql-5.7.21-linux-glibc2.12-x86_64.tar.gz<br><strong>1.2 解压到 /usr/local/ 下，并更名</strong><br>tar -zxvf /home/mysql-5.7.21-linux-glibc2.12-x86_64.tar.gz -C /usr/local<br>mv /usr/local/mysql-5.7.21-linux-glibc2.12-x86_64.tar.gz /usr/local/mysql<br><strong>1.3 创建 data 文件夹存放数据</strong><br>mkdir /usr/local/mysql/data<br><strong>2. 用户组</strong><br><strong>2.1 创建 用户 和 组</strong><br>groupadd mysql<br>useradd -r -g mysql mysql<br><strong>2.2 更改文件所属</strong><br>-R 表示递归<br>chown -R mysql:mysql /usr/local/mysql/<br>chown -R mysql:mysql /usr/local/mysql/data/<br>chown -R mysql /usr/local/mysql/<br>chown -R mysql /usr/local/mysql/data/<br><strong>2.3 更改权限</strong><br>755：rwxr-xr-x<br>chmod -R 755 /usr/local/mysql/<br><strong>3. 安装 libaio 依赖包</strong><br>yum install libaio<br><strong>4. 初始化</strong><br>cd /usr/local/mysql/bin<br>./mysqld –user=mysql –basedir=/usr/local/mysql –datadir=/usr/local/mysql/data –initialize<br>[Note] A temporary password is generated for root@localhost: o*s#gqh)F4Ck<br>得到随机的 初始密码<br><strong>5. 启动 mysql 服务</strong><br>sh /usr/local/mysql/support-files/mysql.server start<br><strong>6. 修改 my.cnf 文件</strong><br>cp /usr/local/mysql/support-files/mysql.server /etc/init.d/mysqld<br>chmod 755 /etc/init.d/mysqld<br>vim /etc/my.cnf<br>[client]<br>no-beep<br>socket =/usr/local/mysql/mysql.sock<br># pipe<br># socket=0.0<br>port=3306<br>[mysql]<br>default-character-set=utf8<br>[mysqld]<br>basedir=/usr/local/mysql<br>datadir=/usr/local/mysql/data<br>port=3306<br>pid-file=/usr/local/mysql/mysqld.pid<br>#skip-grant-tables<br>skip-name-resolve<br>socket = /usr/local/mysql/mysql.sock<br>character-set-server=utf8<br>default-storage-engine=INNODB<br>explicit_defaults_for_timestamp = true<br># Server Id.<br>server-id=1<br>max_connections=2000<br>query_cache_size=0<br>table_open_cache=2000<br>tmp_table_size=246M<br>thread_cache_size=300<br>#限定用于每个数据库线程的栈大小。默认设置足以满足大多数应用<br>thread_stack = 192k<br>key_buffer_size=512M<br>read_buffer_size=4M<br>read_rnd_buffer_size=32M<br>innodb_data_home_dir = /usr/local/mysql/data<br>innodb_flush_log_at_trx_commit=0<br>innodb_log_buffer_size=16M<br>innodb_buffer_pool_size=256M<br>innodb_log_file_size=128M<br>innodb_thread_concurrency=128<br>innodb_autoextend_increment=1000<br>innodb_buffer_pool_instances=8<br>innodb_concurrency_tickets=5000<br>innodb_old_blocks_time=1000<br>innodb_open_files=300<br>innodb_stats_on_metadata=0<br>innodb_file_per_table=1<br>innodb_checksum_algorithm=0<br>back_log=80<br>flush_time=0<br>join_buffer_size=128M<br>max_allowed_packet=1024M<br>max_connect_errors=2000<br>open_files_limit=4161<br>query_cache_type=0<br>sort_buffer_size=32M<br>table_definition_cache=1400<br>binlog_row_event_max_size=8K<br>sync_master_info=10000<br>sync_relay_log=10000<br>sync_relay_log_info=10000<br>#批量插入数据缓存大小，可以有效提高插入效率，默认为 8M<br>bulk_insert_buffer_size = 64M<br>interactive_timeout = 120<br>wait_timeout = 120<br>log-bin-trust-function-creators=1<br>sql_mode=NO_ENGINE_SUBSTITUTION,STRICT_TRANS_TABLES<br>#<br># include all files from the config directory<br>#<br>!includedir /etc/my.cnf.d<br><strong>7. 登录</strong><br>/usr/local/mysql/bin/mysql -u root –p</p>
<p>密码为之前的临时密码<br><strong>8. 修改密码 及 共享</strong><br>set password=password (‘密码’);<br>grant all privileges on 库名。表名 to ‘用户名‘@’IP 地址’ identified by ‘密码’ with grant option;<br>flush privileges;<br>库名：要远程访问的数据库名称，所有的数据库使用 “<em>” <br>表名：要远程访问的数据库下的表的名称，所有的表使用 “</em>” <br>用户名：要赋给远程访问权限的用户名称 <br>IP 地址：可以远程访问的电脑的 IP 地址，所有的地址使用 “%” <br>密码：要赋给远程访问权限的用户对应使用的密码<br><strong><em>例子：</em></strong><br># 所有的地址都可以使用 root 用户，密码为 lxh 远程访问所有的数据库<br>GRANT ALL PRIVILEGES ON <em>.</em> TO ‘root‘@’%’ IDENTIFIED BY ‘lxh’ WITH GRANT OPTION; <br># IP 为 172.16.52.225 的电脑可以使用 lxh 用户，密码为 lxh 远程访问数据库 testdb 的所有表<br>GRANT ALL PRIVILEGES ON testdb.* TO ‘lxh‘@’172.16.52.225’ IDENTIFIED BY ‘lxh’ WITH GRANT OPTION; <br><strong>9. 添加 环境变量</strong><br><strong>9.1 直接在命令行中设置 PATH</strong><br>PATH=$PATH:/usr/local/mysql/bin<br>使用这种方法，只对当前会话有效，也就是说每当登出或注销系统以后，PATH 设置就会失效。<br><strong>9.2 在 profile 中设置 PATH</strong><br>vim /etc/profile<br>export PATH=$PATH:/usr/local/apache/bin<br><strong>9.3 在当前用户的 profile 中设置 PATH</strong><br>vim ~/.bash_profile<br>PATH=$PATH:$HOME/bin:/usr/local/apache/bin<br>source ~/.bash_profile<br>这种方法只对当前用户起作用的，其他用户该修改无效。<br><strong>10. 阿里云设置安全组</strong><br><img data-src="https://ccomma-pic-storage.oss-cn-hangzhou.aliyuncs.com/img/3b66d3af9ad75ff18c49b57b367845a6.png" alt="image.png"><br><img data-src="https://ccomma-pic-storage.oss-cn-hangzhou.aliyuncs.com/img/acf9c36242e743914d261e0a63a9a15e.png" alt="image.png"></p>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="https://ccomma.cn/6a35083ca0bf/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/ccomma.png">
      <meta itemprop="name" content="CComma">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="CComma's Blog">
      <meta itemprop="description" content="下一个目标：改变世界！">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | CComma's Blog">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/6a35083ca0bf/" class="post-title-link" itemprop="url">Windows 安装 MySQL</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>

      <time title="Created: 2019-07-13 16:22:13" itemprop="dateCreated datePublished" datetime="2019-07-13T16:22:13+08:00">2019-07-13</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">In</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/MySQL/" itemprop="url" rel="index"><span itemprop="name">MySQL</span></a>
        </span>
          , 
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/MySQL/%E6%95%B0%E6%8D%AE%E5%BA%93/" itemprop="url" rel="index"><span itemprop="name">数据库</span></a>
        </span>
    </span>

  
  
  <span class="post-meta-item">
    
      <span class="post-meta-item-icon">
        <i class="far fa-comment"></i>
      </span>
      <span class="post-meta-item-text">Disqus: </span>
    
    <a title="disqus" href="/6a35083ca0bf/#disqus_thread" itemprop="discussionUrl">
      <span class="post-comments-count disqus-comment-count" data-disqus-identifier="6a35083ca0bf/" itemprop="commentCount"></span>
    </a>
  </span>
  
  
    <span class="post-meta-item" title="Reading time">
      <span class="post-meta-item-icon">
        <i class="far fa-clock"></i>
      </span>
      <span class="post-meta-item-text">Reading time &asymp;</span>
      <span>5 mins.</span>
    </span>
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <p><a target="_blank" rel="noopener" href="https://blog.csdn.net/qq_37350706/article/details/81707862">MySQL 8.0.18 安装教程 (windows 64 位)</a></p>
<p><a target="_blank" rel="noopener" href="https://www.cnblogs.com/xiaoran991/p/12343911.html">MySQL 5.7x 安装教程</a></p>
<p><strong>系列目录</strong><br>一、安装 MySql<br>二、安装并破解 Navicat<br>三、没有 my.in 配置文件怎么办<br>四、设置 MySql 的大小写敏感<br>五、重置 MySql 登陆密码</p>
<hr>
<p>&nbsp;<br>之前说过，Windows 操作系统中，我们安装 Mysql 有两个选择：一是下载 MSI 点击运行，利用 windows 系统安装程序的方法按部就班的来安装；二是下载 ZIP，解压出来就能立即使用。<br>在使用 ZIP 安装时，安装好之后默认是没有 my.ini 配置文件的：<br><img data-src="https://ccomma-pic-storage.oss-cn-hangzhou.aliyuncs.com/img/3c9424ffe1cccb3d4cf13cdf5fba1b12.png"><br> 当我们想修改数据库的配置信息如 wait_timeout、interactive_timeout、max_connections 或大小写敏感时，却找不到 my.ini 配置文件。<br>虽然这时，还可以通过命令行来修改配置信息，但重启 mysql 后修改会失效，配置会回归默认值，所以这种方式治标不治本。<br>这里提供了另一种方法，解决的基本思路是：先删除 Mysql 服务，然后自己新建一个 my.ini 文件，最后使用命令行重新初始化 mysql 服务，同时指定新建的 my.ini 作为服务默认的配置文件。<br>以下是详细步骤：</p>
<h2 id="1-删除-MySql-服务"><a href="#1-删除-MySql-服务" class="headerlink" title="1. 删除 MySql 服务"></a>1. 删除 MySql 服务</h2><p>打开 cmd（记得” 使用管理员身份 “打开），如果没有配置环境变量，请 cd（切换目录）到 mysql 程序下的 bin 文件夹下（详细步骤参见第一章～）：<br>运行命令：<br><img data-src="https://ccomma-pic-storage.oss-cn-hangzhou.aliyuncs.com/img/214e32b66097f62f2e6fcdc2a4d456c8.png"><br>“MySql” 为服务名称，你的 MysSql 服务不一定是这个名称，可以打开电脑的服务窗口查看。<br>删除完成之后，最好去电脑的服务窗口看下，如果找不到 MySql 服务，说明已经已经删除成功。<br>如果还能看到 MySql 服务，可以手动右击选择” 停止 “，服务停止之后就会自动消失了。</p>
<h2 id="2-新建-my-ini-配置文件"><a href="#2-新建-my-ini-配置文件" class="headerlink" title="2. 新建 my.ini 配置文件"></a>2. 新建 my.ini 配置文件</h2><p>在 mysql 程序的根目录下，新建一个 my.ini 空白文件，用记事本打开，将以下内容复制进去，保存：<br><img data-src="https://ccomma-pic-storage.oss-cn-hangzhou.aliyuncs.com/img/8f900a89c6347c561fdf2122f13be562.gif"><img data-src="https://ccomma-pic-storage.oss-cn-hangzhou.aliyuncs.com/img/961ddebeb323a10fe0623af514929fc1.gif"><img data-src="https://ccomma-pic-storage.oss-cn-hangzhou.aliyuncs.com/img/d2f7717359a727f8dee0391547dff4d1.gif"># For advice on how to change settings please see # <a target="_blank" rel="noopener" href="http://dev.mysql.com/doc/refman/5.6/en/server-configuration-defaults.html's">http://dev.mysql.com/doc/refman/5.6/en/server-configuration-defaults.html's</a> a template which will be copied to thedefaultif you #  upgrade to a newer version of MySQL. [client] defaultset utf8mb4 [mysql] defaultset utf8mb4 [mysqld] characterset FALSE characterset utf8mb4 collation utf8mb4_bin init_connect’SET NAMES utf8mb4’ # Remove leading # and setfor the most important data # cache in70forelse10. innodb_buffer_pool_size  128M # Remove leading # to turn on a very important data integrity option: logging # changes to the binary log between backups. # log_bin # These are commonly setsetas required. basedir  D:\MySQL datadir  D:\MySQL\data port 3306 # server_id  ….. # Remove leading # to setfor reporting servers. # The server defaults are faster for transactions and fast SELECTs. # Adjust sizes as needed, experiment to find the optimal values. join_buffer_size  128M sort_buffer_size  16M read_rnd_buffer_size  16M  sql_mode<img data-src="https://ccomma-pic-storage.oss-cn-hangzhou.aliyuncs.com/img/d2f7717359a727f8dee0391547dff4d1.gif">View Code<br><img data-src="https://ccomma-pic-storage.oss-cn-hangzhou.aliyuncs.com/img/d170ccbff7604b164f568b4f77f0cf3f.png"><br>其中 basedir 和 datadir 根据实际 MySql 安装的位置进行修改。</p>
<h2 id="3-重新生成-data-文件"><a href="#3-重新生成-data-文件" class="headerlink" title="3. 重新生成 data 文件"></a>3. 重新生成 data 文件</h2><p>删除之前生成的 data 文件，如果有重要的数据表，请先备份好。<br>回到 cmd，重新生成 data 文件。运行：<br>该命令需要执行大概一分钟左右，完成后会在 MySql 程序文件夹下重新生成名称为 data 的文件夹：<br><img data-src="https://ccomma-pic-storage.oss-cn-hangzhou.aliyuncs.com/img/2871ea1de0e1ea258bd39f113bf6302c.png"><br><img data-src="https://ccomma-pic-storage.oss-cn-hangzhou.aliyuncs.com/img/0c19aa129347bbc21afc48f5f809a79d.png"><br>&nbsp;</p>
<h2 id="4-重新安装-mysql-服务，同时绑定-my-ini-配置文件"><a href="#4-重新安装-mysql-服务，同时绑定-my-ini-配置文件" class="headerlink" title="4. 重新安装 mysql 服务，同时绑定 my.ini 配置文件"></a>4. 重新安装 mysql 服务，同时绑定 my.ini 配置文件</h2><p>安装 MySql 服务，同时设置绑定 my.ini 配置文件。命令：<br>“MySql80” –defaults-file=”d:/mysql/my.ini”<br>“MySql80” 是服务名称，80 表示 8.0 版本，当然，也可以自己取别的名字。<br>”..\my.ini“是新建的配置文件的位置，也可以写成绝对路径”D:\MySql\my.ini“。<br><img data-src="https://ccomma-pic-storage.oss-cn-hangzhou.aliyuncs.com/img/7c0eff842ce4139a3230795344806810.png"><br>如果提示安装成功，这时打开电脑的” 服务 “窗口，可以找到新添加的 MySql80 服务：<br><img data-src="https://ccomma-pic-storage.oss-cn-hangzhou.aliyuncs.com/img/b881a1e15afbadb0e900a9de4673de43.png"><br>&nbsp;</p>
<h2 id="5-启动服务"><a href="#5-启动服务" class="headerlink" title="5. 启动服务"></a>5. 启动服务</h2><p>这里有两种启动服务的方式：1）服务窗口启动；2）cmd 启动</p>
<h3 id="5-1-服务窗口启动"><a href="#5-1-服务窗口启动" class="headerlink" title="5.1 服务窗口启动"></a>5.1 服务窗口启动</h3><p>直接右击服务项，选择启动：<br><img data-src="https://ccomma-pic-storage.oss-cn-hangzhou.aliyuncs.com/img/95f42ae7e44b283aaf44eb616a0d73e6.png"><br>&nbsp;</p>
<h3 id="5-2-cmd-命令启动"><a href="#5-2-cmd-命令启动" class="headerlink" title="5.2 cmd 命令启动"></a>5.2 cmd 命令启动</h3><p>命令：<br>等待 20 秒左右，如果启动成功，是这样的：<br><img data-src="https://ccomma-pic-storage.oss-cn-hangzhou.aliyuncs.com/img/8b3f9d6c79a8350cfad64599feee15ee.png"><br>&nbsp;<br>如果不成功：<br><img data-src="https://ccomma-pic-storage.oss-cn-hangzhou.aliyuncs.com/img/70e18e9cba139ecd5b99730a9e11fc3e.png"><br>&nbsp;<br>这时可能是 my.ini 配置文件中的某些配置有问题。你可以修改 ini 文件内容，然后从头按步骤再试一遍。</p>
<h2 id="6-重新设置密码"><a href="#6-重新设置密码" class="headerlink" title="6. 重新设置密码"></a>6. 重新设置密码</h2><p>删除了 data 文件和服务之后，之前的密码就失效了，所以需要重新设置密码。</p>
<h3 id="6-1-登陆-mysql"><a href="#6-1-登陆-mysql" class="headerlink" title="6.1 登陆 mysql"></a>6.1 登陆 mysql</h3><p>命令：<br>这时密码为空，不需要填写，直接回车：<br><img data-src="https://ccomma-pic-storage.oss-cn-hangzhou.aliyuncs.com/img/b45fb44fead6edf175a976a634f44d9f.png"><br>如果这里没有登陆成功，请移步下一章” 重置 MySql 密码 “~</p>
<h3 id="6-2-修改-root-用户密码"><a href="#6-2-修改-root-用户密码" class="headerlink" title="6.2 修改 root 用户密码"></a>6.2 修改 root 用户密码</h3><p>（敲黑板）这里有个需要注意的地方，在 8.0 之后的版本，修改 root 用户密码的命令是：<br>‘root’’localhost’’你的密码’<br>&nbsp;之前的版本是：<br>set” 你的密码”where”root”<br>&nbsp;我这里安装的是 8.0.11，所以是第一个：<br><img data-src="https://ccomma-pic-storage.oss-cn-hangzhou.aliyuncs.com/img/05f4b146bb74f83635ad8951abf4cc07.png"></p>
<h3 id="6-3-退出-MySQL"><a href="#6-3-退出-MySQL" class="headerlink" title="6.3 退出 MySQL"></a>6.3 退出 MySQL</h3><p>命令：</p>
<h3 id="6-4-使用修改后的密码重新登陆"><a href="#6-4-使用修改后的密码重新登陆" class="headerlink" title="6.4 使用修改后的密码重新登陆"></a>6.4 使用修改后的密码重新登陆</h3><p>这里的命令和之前是一样的，就不写了，密码记得要填刚才设置的：<br><img data-src="https://ccomma-pic-storage.oss-cn-hangzhou.aliyuncs.com/img/af7c90061a5c0b9eae88372318325818.png"><br>&nbsp;<br>&nbsp;<br>现在已经成功绑定了 my.ini 配置文件了，如果需要自定义配置，可以打开文件进行相应的配置设置，修改后重启服务即可。<br>如果修改后，重启服务报错，如下图：<br><img data-src="https://ccomma-pic-storage.oss-cn-hangzhou.aliyuncs.com/img/e7bb3e3063f151fb192e70f6a4f20470.png"><br>&nbsp;<br>有一种可能：你修改的配置与服务初始化时的配置有冲突，这时只能从头开始，在初始化的时候绑定 my.ini 文件 。<br>下一章要讲的的 “设置 MySql 大小写敏感” 就是～</p>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




  <nav class="pagination">
    <a class="extend prev" rel="prev" title="Previous page" aria-label="Previous page" href="/page/8/"><i class="fa fa-angle-left"></i></a><a class="page-number" href="/">1</a><span class="space">&hellip;</span><a class="page-number" href="/page/8/">8</a><span class="page-number current">9</span><a class="page-number" href="/page/10/">10</a><a class="extend next" rel="next" title="Next page" aria-label="Next page" href="/page/10/"><i class="fa fa-angle-right"></i></a>
  </nav>

</div>
  </main>

  <footer class="footer">
    <div class="footer-inner">

  <div class="copyright">
    &copy; 
    <span itemprop="copyrightYear">2024</span>
    <span class="with-love">
      <i class="fa fa-heart"></i>
    </span>
    <span class="author" itemprop="copyrightHolder">CComma</span>
  </div>
<div class="busuanzi-count">
    <span class="post-meta-item" id="busuanzi_container_site_uv">
      <span class="post-meta-item-icon">
        <i class="fa fa-user"></i>
      </span>
      <span class="site-uv" title="Total Visitors">
        <span id="busuanzi_value_site_uv"></span>
      </span>
    </span>
    <span class="post-meta-item" id="busuanzi_container_site_pv">
      <span class="post-meta-item-icon">
        <i class="fa fa-eye"></i>
      </span>
      <span class="site-pv" title="Total Views">
        <span id="busuanzi_value_site_pv"></span>
      </span>
    </span>
</div>

    </div>
  </footer>

  
  <div class="toggle sidebar-toggle" role="button">
    <span class="toggle-line"></span>
    <span class="toggle-line"></span>
    <span class="toggle-line"></span>
  </div>
  <div class="sidebar-dimmer"></div>
  <div class="back-to-top" role="button" aria-label="Back to top">
    <i class="fa fa-arrow-up fa-lg"></i>
    <span>0%</span>
  </div>
  <div class="reading-progress-bar"></div>

  <a href="https://github.com/ccomma" class="github-corner" title="Follow me on GitHub" aria-label="Follow me on GitHub" rel="noopener" target="_blank"><svg width="80" height="80" viewBox="0 0 250 250" aria-hidden="true"><path d="M0,0 L115,115 L130,115 L142,142 L250,250 L250,0 Z"></path><path d="M128.3,109.0 C113.8,99.7 119.0,89.6 119.0,89.6 C122.0,82.7 120.5,78.6 120.5,78.6 C119.2,72.0 123.4,76.3 123.4,76.3 C127.3,80.9 125.5,87.3 125.5,87.3 C122.9,97.6 130.6,101.9 134.4,103.2" fill="currentColor" style="transform-origin: 130px 106px;" class="octo-arm"></path><path d="M115.0,115.0 C114.9,115.1 118.7,116.5 119.8,115.4 L133.7,101.6 C136.9,99.2 139.9,98.4 142.2,98.6 C133.8,88.0 127.5,74.4 143.8,58.0 C148.5,53.4 154.0,51.2 159.7,51.0 C160.3,49.4 163.2,43.6 171.4,40.1 C171.4,40.1 176.1,42.5 178.8,56.2 C183.1,58.6 187.2,61.8 190.9,65.4 C194.5,69.0 197.7,73.2 200.1,77.6 C213.8,80.2 216.3,84.9 216.3,84.9 C212.7,93.1 206.9,96.0 205.4,96.6 C205.1,102.4 203.0,107.8 198.3,112.5 C181.9,128.9 168.3,122.5 157.7,114.1 C157.9,116.9 156.7,120.9 152.7,124.9 L141.0,136.5 C139.8,137.7 141.6,141.9 141.8,141.8 Z" fill="currentColor" class="octo-body"></path></svg></a>

<noscript>
  <div class="noscript-warning">Theme NexT works best with JavaScript enabled</div>
</noscript>


  
  <script src="https://cdnjs.cloudflare.com/ajax/libs/animejs/3.2.1/anime.min.js" integrity="sha256-XL2inqUJaslATFnHdJOi9GfQ60on8Wx1C2H8DYiN1xY=" crossorigin="anonymous"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/next-theme-pjax/0.6.0/pjax.min.js" integrity="sha256-vxLn1tSKWD4dqbMRyv940UYw4sXgMtYcK6reefzZrao=" crossorigin="anonymous"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/medium-zoom/1.1.0/medium-zoom.min.js" integrity="sha256-ZgMyDAIYDYGxbcpJcfUnYwNevG/xi9OHKaR/8GK+jWc=" crossorigin="anonymous"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/lozad.js/1.16.0/lozad.min.js" integrity="sha256-mOFREFhqmHeQbXpK2lp4nA3qooVgACfh88fpJftLBbc=" crossorigin="anonymous"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/pangu/4.0.7/pangu.min.js" integrity="sha256-j+yj56cdEY2CwkVtGyz18fNybFGpMGJ8JxG3GSyO2+I=" crossorigin="anonymous"></script>
<script src="/js/comments.js"></script><script src="/js/utils.js"></script><script src="/js/motion.js"></script><script src="/js/schemes/muse.js"></script><script src="/js/next-boot.js"></script><script src="/js/pjax.js"></script>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/hexo-generator-searchdb/1.4.1/search.js" integrity="sha256-1kfA5uHPf65M5cphT2dvymhkuyHPQp5A53EGZOnOLmc=" crossorigin="anonymous"></script>
<script src="/js/third-party/search/local-search.js"></script>





  <script src="/js/third-party/pace.js"></script>


  
  <script data-pjax async src="https://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>




  <script src="https://cdnjs.cloudflare.com/ajax/libs/quicklink/2.3.0/quicklink.umd.js" integrity="sha256-yvJQOINiH9fWemHn0vCA5lsHWJaHs6/ZmO+1Ft04SvM=" crossorigin="anonymous"></script>
  <script class="next-config" data-name="quicklink" type="application/json">{"enable":true,"home":true,"archive":true,"delay":true,"timeout":3000,"priority":true,"url":"https://ccomma.cn/page/9/"}</script>
  <script src="/js/third-party/quicklink.js"></script>
<script class="next-config" data-name="disqus" type="application/json">{"enable":true,"shortname":"ccomma","count":true,"i18n":{"disqus":"disqus"}}</script>
<script src="/js/third-party/comments/disqus.js"></script>

</body>
</html>
