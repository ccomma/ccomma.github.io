<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width">
<meta name="theme-color" content="#222"><meta name="generator" content="Hexo 7.0.0">

  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16.png">
  <link rel="mask-icon" href="/images/safari-pinned-tab.svg" color="#222">
  <meta name="google-site-verification" content="5K7puGkNbKLWhZTmZZm6haOpSbJ-oOvUQFYJeMFBJSk">
  <meta name="baidu-site-verification" content="codeva-3O8Y6jTFCL">

<link rel="stylesheet" href="/css/main.css">

<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Monaco:300,300italic,400,400italic,700,700italic&display=swap&subset=latin,latin-ext">

<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" integrity="sha256-yIDrPSXHZdOZhAqiBP7CKzIwMQmRCJ8UeB8Jo17YC4o=" crossorigin="anonymous">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/3.1.1/animate.min.css" integrity="sha256-PR7ttpcvz8qrF57fur/yAx1qXMFJeJFiA6pSzWi0OIE=" crossorigin="anonymous">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/pace/1.2.4/themes/blue/pace-theme-minimal.css">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/pace/1.2.4/pace.min.js" integrity="sha256-gqd7YTjg/BtfqWSwsJOvndl0Bxc8gFImLEkXQT8+qj0=" crossorigin="anonymous"></script>

<script class="next-config" data-name="main" type="application/json">{"hostname":"ccomma.cn","root":"/","images":"/images","scheme":"Muse","darkmode":false,"version":"8.19.1","exturl":false,"sidebar":{"position":"left","display":"post","padding":18,"offset":12},"copycode":{"enable":true,"style":"mac"},"fold":{"enable":true,"height":500},"bookmark":{"enable":false,"color":"#222","save":"auto"},"mediumzoom":true,"lazyload":true,"pangu":true,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"stickytabs":false,"motion":{"enable":true,"async":false,"transition":{"menu_item":"fadeInDown","post_block":"fadeIn","post_header":"fadeInDown","post_body":"fadeInDown","coll_header":"fadeInLeft","sidebar":"fadeInUp"}},"prism":false,"i18n":{"placeholder":"Searching...","empty":"We didn't find any results for the search: ${query}","hits_time":"${hits} results found in ${time} ms","hits":"${hits} results found"},"path":"/search.xml","localsearch":{"enable":true,"trigger":"auto","top_n_per_article":1,"unescape":false,"preload":false}}</script><script src="/js/config.js"></script>

    <meta name="description" content="下一个目标：改变世界！">
<meta property="og:type" content="website">
<meta property="og:title" content="CComma&#39;s Blog">
<meta property="og:url" content="https://ccomma.cn/page/6/">
<meta property="og:site_name" content="CComma&#39;s Blog">
<meta property="og:description" content="下一个目标：改变世界！">
<meta property="og:locale" content="en_US">
<meta property="article:author" content="CComma">
<meta property="article:tag" content="编程技术、Java">
<meta name="twitter:card" content="summary">


<link rel="canonical" href="https://ccomma.cn/page/6/">



<script class="next-config" data-name="page" type="application/json">{"sidebar":"","isHome":true,"isPost":false,"lang":"en","comments":"","permalink":"","path":"page/6/index.html","title":""}</script>

<script class="next-config" data-name="calendar" type="application/json">""</script>
<title>CComma's Blog</title>
  
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-GS592DM662"></script>
  <script class="next-config" data-name="google_analytics" type="application/json">{"tracking_id":"G-GS592DM662","only_pageview":false,"measure_protocol_api_secret":null}</script>
  <script src="/js/third-party/analytics/google-analytics.js"></script>

  <script src="/js/third-party/analytics/baidu-analytics.js"></script>
  <script async src="https://hm.baidu.com/hm.js?152282c2c823c1e5ab34c577ba338801"></script>







  <noscript>
    <link rel="stylesheet" href="/css/noscript.css">
  </noscript>
<link rel="alternate" href="/atom.xml" title="CComma's Blog" type="application/atom+xml">
</head>

<body itemscope itemtype="http://schema.org/WebPage" class="use-motion">
  <div class="headband"></div>

  <main class="main">
    <div class="column">
      <header class="header" itemscope itemtype="http://schema.org/WPHeader"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="Toggle navigation bar" role="button">
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
    </div>
  </div>

  <div class="site-meta">
      <img class="custom-logo-image" src="/images/ccomma.png" alt="CComma's Blog">

    <a href="/" class="brand" rel="start">
      <i class="logo-line"></i>
      <h1 class="site-title">CComma's Blog</h1>
      <i class="logo-line"></i>
    </a>
      <p class="site-subtitle" itemprop="description">Connect the world</p>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger" aria-label="Search" role="button">
        <i class="fa fa-search fa-fw fa-lg"></i>
    </div>
  </div>
</div>



<nav class="site-nav">
  <ul class="main-menu menu"><li class="menu-item menu-item-home"><a href="/" rel="section"><i class="fa fa-home fa-fw"></i>Home</a></li><li class="menu-item menu-item-categories"><a href="/categories/" rel="section"><i class="fa fa-th fa-fw"></i>Categories<span class="badge">5</span></a></li><li class="menu-item menu-item-tags"><a href="/tags/" rel="section"><i class="fa fa-tags fa-fw"></i>Tags<span class="badge">8</span></a></li><li class="menu-item menu-item-archives"><a href="/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>Archives<span class="badge">58</span></a></li><li class="menu-item menu-item-about"><a href="/about/" rel="section"><i class="fa fa-user fa-fw"></i>About</a></li>
      <li class="menu-item menu-item-search">
        <a role="button" class="popup-trigger"><i class="fa fa-search fa-fw"></i>Search
        </a>
      </li>
  </ul>
</nav>



  <div class="search-pop-overlay">
    <div class="popup search-popup"><div class="search-header">
  <span class="search-icon">
    <i class="fa fa-search"></i>
  </span>
  <div class="search-input-container">
    <input autocomplete="off" autocapitalize="off" maxlength="80"
           placeholder="Searching..." spellcheck="false"
           type="search" class="search-input">
  </div>
  <span class="popup-btn-close" role="button">
    <i class="fa fa-times-circle"></i>
  </span>
</div>
<div class="search-result-container no-result">
  <div class="search-result-icon">
    <i class="fa fa-spinner fa-pulse fa-5x"></i>
  </div>
</div>

    </div>
  </div>

</header>
        
  
  <aside class="sidebar">

    <div class="sidebar-inner sidebar-overview-active">
      <ul class="sidebar-nav">
        <li class="sidebar-nav-toc">
          Table of Contents
        </li>
        <li class="sidebar-nav-overview">
          Overview
        </li>
      </ul>

      <div class="sidebar-panel-container">
        <!--noindex-->
        <div class="post-toc-wrap sidebar-panel">
        </div>
        <!--/noindex-->

        <div class="site-overview-wrap sidebar-panel">
          <div class="site-author animated" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <img class="site-author-image" itemprop="image" alt="CComma"
      src="/images/ccomma.png">
  <p class="site-author-name" itemprop="name">CComma</p>
  <div class="site-description" itemprop="description">下一个目标：改变世界！</div>
</div>
<div class="site-state-wrap animated">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
        <a href="/archives/">
          <span class="site-state-item-count">58</span>
          <span class="site-state-item-name">posts</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
          <a href="/categories/">
        <span class="site-state-item-count">5</span>
        <span class="site-state-item-name">categories</span></a>
      </div>
      <div class="site-state-item site-state-tags">
          <a href="/tags/">
        <span class="site-state-item-count">8</span>
        <span class="site-state-item-name">tags</span></a>
      </div>
  </nav>
</div>
  <div class="links-of-author animated">
      <span class="links-of-author-item">
        <a href="https://github.com/ccomma" title="GitHub → https:&#x2F;&#x2F;github.com&#x2F;ccomma" rel="noopener me" target="_blank"><i class="fab fa-github fa-fw"></i>GitHub</a>
      </span>
      <span class="links-of-author-item">
        <a href="https://twitter.com/ccomma_cat" title="Twitter → https:&#x2F;&#x2F;twitter.com&#x2F;ccomma_cat" rel="noopener me" target="_blank"><i class="fab fa-twitter fa-fw"></i>Twitter</a>
      </span>
      <span class="links-of-author-item">
        <a href="/atom.xml" title="RSS → &#x2F;atom.xml" rel="noopener me"><i class="fa fa-rss fa-fw"></i>RSS</a>
      </span>
  </div>
  <div class="cc-license animated" itemprop="license">
    <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/deed.zh" class="cc-opacity" rel="noopener" target="_blank"><img src="https://cdnjs.cloudflare.com/ajax/libs/creativecommons-vocabulary/2020.11.3/assets/license_badges/small/by_nc_sa.svg" alt="Creative Commons"></a>
  </div>

        </div>
      </div>
    </div>

    
        <div class="pjax">
        </div>
  </aside>


    </div>

    <div class="main-inner index posts-expand">

    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="https://ccomma.cn/09cb9486a3e4/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/ccomma.png">
      <meta itemprop="name" content="CComma">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="CComma's Blog">
      <meta itemprop="description" content="下一个目标：改变世界！">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | CComma's Blog">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/09cb9486a3e4/" class="post-title-link" itemprop="url">AOP</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>

      <time title="Created: 2022-05-13 14:41:34" itemprop="dateCreated datePublished" datetime="2022-05-13T14:41:34+08:00">2022-05-13</time>
    </span>

  
  
  <span class="post-meta-item">
    
      <span class="post-meta-item-icon">
        <i class="far fa-comment"></i>
      </span>
      <span class="post-meta-item-text">Disqus: </span>
    
    <a title="disqus" href="/09cb9486a3e4/#disqus_thread" itemprop="discussionUrl">
      <span class="post-comments-count disqus-comment-count" data-disqus-identifier="09cb9486a3e4/" itemprop="commentCount"></span>
    </a>
  </span>
  
  
    <span class="post-meta-item" title="Reading time">
      <span class="post-meta-item-icon">
        <i class="far fa-clock"></i>
      </span>
      <span class="post-meta-item-text">Reading time &asymp;</span>
      <span>6 mins.</span>
    </span>
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Aspect</span></span><br><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">MenuBalanceLogAspect</span> {</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">Logger</span> <span class="variable">BIZ_ERROR_LOG</span> <span class="operator">=</span> LoggerFactory.getLogger(<span class="string">"biz_error_log"</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// @Around("execution(public * com.dfire.soa.msstate.client.service.MenuBalanceClientServiceImpl..*(..))")</span></span><br><span class="line">    <span class="meta">@Around("bean(menuBalanceClientServiceImpl)")</span></span><br><span class="line">    <span class="keyword">public</span> Object <span class="title function_">aroundProviderService</span><span class="params">(ProceedingJoinPoint pjp)</span> <span class="keyword">throws</span> Throwable {</span><br><span class="line">        BIZ_ERROR_LOG.debug(<span class="string">"start MenuBalanceLogAspect"</span>);</span><br><span class="line">        <span class="type">String</span> <span class="variable">argJson</span> <span class="operator">=</span> StringUtils.EMPTY;</span><br><span class="line">        <span class="keyword">if</span> (ArrayUtils.isNotEmpty(pjp.getArgs())) {</span><br><span class="line">            List&lt;String&gt; argStringList = Arrays.stream(pjp.getArgs())</span><br><span class="line">                    .map(JSON::toJSONString)</span><br><span class="line">                    .collect(Collectors.toList());</span><br><span class="line">            argJson = String.join(<span class="string">","</span>, argStringList);</span><br><span class="line">        }</span><br><span class="line"></span><br><span class="line">        BIZ_ERROR_LOG.info(<span class="string">"access {}#{},{}"</span>, pjp.getTarget().getClass().getSimpleName(), pjp.getSignature().getName(), argJson);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> pjp.proceed();</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">}</span><br><span class="line"></span><br></pre></td></tr></tbody></table></figure>
<h1 id="一、概述"><a href="#一、概述" class="headerlink" title="一、概述"></a>一、概述</h1><p><strong>AOP:</strong><br>⾯向切⾯编程，让程序员关注于类中方法的某个切点上<br>在不改变原有业务逻辑情况下，增强横切逻辑代码，根本上解耦合，避免横切逻辑代码重复<br>默认情况下，Spring 会根据被代理对象是否实现接⼝来选择使⽤ JDK 还是 CGLIB。当被代理对象没有实现 任何接⼝时，Spring 会选择 CGLIB。当被代理对象实现了接⼝，Spring 会选择 JDK 官⽅的代理技术，不过 我们可以通过配置的⽅式，让 Spring 强制使⽤ CGLIB。</p>
<ul>
<li><strong>通知（Advice）：</strong>通知定义了切面是什么以及何时使用。除了描述切面要完成的工作，通知还解决了何时执行这个工作的问题<ul>
<li><strong>前置通知（@Before）：</strong>在目标方法被调用之前调用通知功能</li>
<li><strong>后置通知（@After）：</strong>在目标方法完成之后调用通知，此时不会关心方法的输出是什么</li>
<li><strong>返回通知（@AfterReturning）：</strong>在目标方法成功执行之后调用通知</li>
<li><strong>异常通知（@AfterThrowing）：</strong>在目标方法抛出异常后调用通知</li>
<li><strong>环绕通知（@Around）：</strong>通知包裹了被通知的方法，在被通知的方法调用之前和调用之后执行自定义的行为</li>
</ul>
</li>
<li><strong>连接点（Joinpoint）：</strong>要增强代码的地方（方法开始、结束、异常时等时机点）。只是候选点，最终是否增强代码得看后续逻辑</li>
<li><strong>切点（Pointcut）：</strong>已经把增强代码加入到业务主线之后的连接点</li>
<li><strong>引入：</strong>引入允许我们向现有的类添加新方法或属性</li>
<li><strong>织入（Weaving）：</strong>把增强应用到目标对象老创建新的代理对象的过程。Spring 采用动态代理织入，而 Aspect 采用编译期织入和类装载期织入</li>
<li><strong>切面（Aspect）：</strong>切面 = 通知 + 切点。通知和切点共同定义了切面的全部内容 </li>
</ul>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">&lt;dependency&gt;</span><br><span class="line">    &lt;groupId&gt;org.springframework&lt;/groupId&gt;</span><br><span class="line">    &lt;artifactId&gt;spring-aop&lt;/artifactId&gt;</span><br><span class="line">    &lt;version&gt;<span class="number">5.1</span><span class="number">.12</span>.RELEASE&lt;/version&gt;</span><br><span class="line">&lt;/dependency&gt;</span><br><span class="line">&lt;dependency&gt;</span><br><span class="line">    &lt;groupId&gt;org.aspectj&lt;/groupId&gt;</span><br><span class="line">    &lt;artifactId&gt;aspectjweaver&lt;/artifactId&gt;</span><br><span class="line">    &lt;version&gt;<span class="number">1.8</span><span class="number">.13</span>&lt;/version&gt;</span><br><span class="line">&lt;/dependency&gt;</span><br></pre></td></tr></tbody></table></figure>
<h1 id="二、切点"><a href="#二、切点" class="headerlink" title="二、切点"></a>二、切点</h1><p>Spring 借助 AspectJ 的切点表达式语言来定义 Spring 切面</p>
<table>
<thead>
<tr>
<th><strong>AspectJ 指示器</strong></th>
<th><strong>描述</strong></th>
</tr>
</thead>
<tbody><tr>
<td> arg()</td>
<td> 限制连接点匹配参数为指定类型的执行方法</td>
</tr>
<tr>
<td> @args()</td>
<td> 限制连接点匹配参数由指定注解标注的执行方法</td>
</tr>
<tr>
<td> execution()</td>
<td> 用于匹配是连接点的执行方法</td>
</tr>
<tr>
<td> this()</td>
<td> 限制连接点匹配 AOP 代理的 bean 引用为指定类型的类</td>
</tr>
<tr>
<td> target</td>
<td> 限制连接点匹配目标对象为指定类型的类</td>
</tr>
<tr>
<td> @target()</td>
<td> 限制连接点匹配特定的执行对象，这些对象对应的类要具有指定类型的注解</td>
</tr>
<tr>
<td> within()</td>
<td> 限制连接点匹配指定的类型</td>
</tr>
<tr>
<td> @within()</td>
<td> 限制连接点匹配指定注解锁标注的类型（当使用 Spring AOP 时，方法定义在由指定的注解所标注的类里）</td>
</tr>
<tr>
<td>@annotation</td>
<td> 限定匹配带有指定注解的连接点</td>
</tr>
</tbody></table>
<p><br><img data-src="https://ccomma-pic-storage.oss-cn-hangzhou.aliyuncs.com/img/3e50af79311608e8c1970b9f7411403b.png" alt="image.png"></p>
<h2 id="1-限定-Bean-的-ID"><a href="#1-限定-Bean-的-ID" class="headerlink" title="1. 限定 Bean 的 ID"></a>1. 限定 Bean 的 ID</h2><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">execution(* concert.Performance.perform()) and <span class="title function_">bean</span><span class="params">(<span class="string">'woodstock'</span>)</span></span><br></pre></td></tr></tbody></table></figure>
<h2 id="2-通过注解定义"><a href="#2-通过注解定义" class="headerlink" title="2. 通过注解定义"></a>2. 通过注解定义</h2><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Pointcut("execution(** concert.Performance.perform(..))")</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">performance</span><span class="params">()</span> {}</span><br><span class="line"></span><br><span class="line"><span class="meta">@Before("performance()")</span> </span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">silenceCellPhones</span><span class="params">()</span> {    </span><br><span class="line">    System.out.println(<span class="string">"Silencing cell phones"</span>); </span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<h2 id="3-使用参数化通知"><a href="#3-使用参数化通知" class="headerlink" title="3. 使用参数化通知"></a>3. 使用参数化通知</h2><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Player.play(int)：被通知方法的参数类型 </span></span><br><span class="line"><span class="comment">// args(trackNumber)：被通知方法参数传递给通知方法中的 trackNumber 形参，即 pointcut 方法中的 trackNumber </span></span><br><span class="line"><span class="meta">@Pointcut("execution(* com.san.spring.aop.Player.play(int)) &amp;&amp; args(trackNumber)")</span> </span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">pointcut</span><span class="params">(<span class="type">int</span> trackNumber)</span> {} </span><br><span class="line"></span><br><span class="line"><span class="meta">@Around("pointcut(trackNumber)")</span> </span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">countTrack</span><span class="params">(ProceedingJoinPoint pjp, <span class="type">int</span> trackNumber)</span> {    </span><br><span class="line">    <span class="keyword">try</span> {        </span><br><span class="line">        pjp.proceed();        </span><br><span class="line">        <span class="type">int</span> <span class="variable">currentCount</span> <span class="operator">=</span> getTrackCurrentCount(trackNumber);        </span><br><span class="line">        map.put(trackNumber, ++currentCount);    </span><br><span class="line">    } <span class="keyword">catch</span> (Throwable e) {        </span><br><span class="line">        ...    </span><br><span class="line">    } </span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<h1 id="三、创建切面"><a href="#三、创建切面" class="headerlink" title="三、创建切面"></a>三、创建切面</h1><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Aspect</span></span><br><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Audience</span> {</span><br><span class="line">    <span class="meta">@Before("execution(** cocert.Performance.perform(..))")</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">silenceCellPhones</span><span class="params">()</span> {</span><br><span class="line">        System.out.println(<span class="string">"Silencing cell phones"</span>);</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Before("execution(** concert.Performance.perform(..))")</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">takeSeats</span><span class="params">()</span> {</span><br><span class="line">        System.out.println(<span class="string">"Taking seats"</span>);</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="meta">@AfterReturning("execution(** concert.Performance.perform(..))")</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">applause</span><span class="params">()</span> {</span><br><span class="line">        System.out.println(<span class="string">"CLAP CLAP CLAP!!!"</span>);</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="meta">@AfterThrowing("execution(** concert.Performance.perform(..))")</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">demandRefund</span><span class="params">()</span> {</span><br><span class="line">        System.out.println(<span class="string">"Demanding a refund"</span>);</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Around("performance()")</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">watchPerformance</span><span class="params">(ProceedingJoinPoint jp)</span> {</span><br><span class="line">        <span class="keyword">try</span> {</span><br><span class="line">            System.out.println(<span class="string">"Silencing cell phones"</span>);</span><br><span class="line">            System.out.println(<span class="string">"Taking seats"</span>);</span><br><span class="line">            <span class="comment">// 执行目标方法</span></span><br><span class="line">            jp.proceed();</span><br><span class="line">            System.out.println(<span class="string">"CLAP CLAP CLAP!!!"</span>);</span><br><span class="line">        } <span class="keyword">catch</span> (Throwable e) {</span><br><span class="line">            System.out.println(<span class="string">"Demanding a refund"</span>);</span><br><span class="line">        }</span><br><span class="line">    }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<h2 id="1-使用自动代理"><a href="#1-使用自动代理" class="headerlink" title="1. 使用自动代理"></a>1. 使用自动代理</h2><p><strong>JavaConfig：</strong></p>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="meta">@EnableAspectJAutoProxy</span></span><br><span class="line"><span class="meta">@ComponentScan</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ConcertConfig</span> {</span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="keyword">public</span> Audience <span class="title function_">audience</span><span class="params">()</span> {</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">Audience</span>();    </span><br><span class="line">    }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>


<p><strong>XML：</strong></p>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">&lt;?xml version=<span class="string">"1.0"</span> encoding=<span class="string">"UTF-8"</span>?&gt;</span><br><span class="line">&lt;beans xmlns=<span class="string">"http://www.springframework.org/schema/beans"</span></span><br><span class="line">    xmlns:xsi=<span class="string">"http://www.w3.org/2001/XMLSchema-instance"</span></span><br><span class="line">    xmlns:context=<span class="string">"http://www.springframework.org/schema/aop"</span></span><br><span class="line">    xsi:schemaLocation=<span class="string">"http://www.springframework.org/schema/aop</span></span><br><span class="line"><span class="string">        http://www.springframework.org/schema/aop/spring-aop.xsd</span></span><br><span class="line"><span class="string">        http://www.springframework.org/schema/beans</span></span><br><span class="line"><span class="string">        http://www.springframework.org/schema/beans/spring-beans.xsd</span></span><br><span class="line"><span class="string">        http://www.springframework.org/schema/context</span></span><br><span class="line"><span class="string">        http://www.springframework.org/schema/context/spring-context.xsd"</span>&gt;</span><br><span class="line">        </span><br><span class="line">    &lt;context:component-scan base-<span class="keyword">package</span>=<span class="string">"concert"</span> /&gt;</span><br><span class="line">    &lt;aop:aspectj-autoproxy /&gt;</span><br><span class="line">    &lt;bean class=<span class="string">"concert.Audience"</span> /&gt;</span><br><span class="line">&lt;/beans&gt;</span><br></pre></td></tr></tbody></table></figure>
<h2 id="2-在-XML-中声名切面"><a href="#2-在-XML-中声名切面" class="headerlink" title="2. 在 XML 中声名切面"></a>2. 在 XML 中声名切面</h2><table>
<thead>
<tr>
<th><strong>AOP 配置元素</strong></th>
<th><strong>用途 </strong></th>
</tr>
</thead>
<tbody><tr>
<td><a href="aop:advisor">aop:advisor</a></td>
<td> 定义 AOP 通知器 </td>
</tr>
<tr>
<td><a href="aop:after">aop:after</a></td>
<td> 定义 AOP 后置通知 </td>
</tr>
<tr>
<td><a href="aop:after-returning">aop:after-returning</a></td>
<td> 定义 AOP 返回通知 </td>
</tr>
<tr>
<td><a href="aop:after-throwing">aop:after-throwing</a></td>
<td> 定义 AOP 异常通知 </td>
</tr>
<tr>
<td><a href="aop:around">aop:around</a></td>
<td> 定义 AOP 环绕通知 </td>
</tr>
<tr>
<td><a href="aop:aspect">aop:aspect</a></td>
<td> 定义一个切面 </td>
</tr>
<tr>
<td><a href="aop:aspectj-autoproxy">aop:aspectj-autoproxy</a></td>
<td> 启用 @AspectJ <br> 注解驱动的切面 </td>
</tr>
<tr>
<td><a href="aop:before">aop:before</a></td>
<td> 定义一个 AOP 前置通知 </td>
</tr>
<tr>
<td><a href="aop:config">aop:config</a></td>
<td> 顶级的 AOP 配置元素。大多数的 <a href="aop:*">aop:*</a> 元素必须包含在 <a href="aop:config">aop:config</a> 元素内 </td>
</tr>
<tr>
<td><a href="aop:declare-parents">aop:declare-parents</a></td>
<td> 以透明的方式为被通知的对象引入额外的接口 </td>
</tr>
<tr>
<td><a href="aop:pointcut">aop:pointcut</a></td>
<td> 定义一个切点</td>
</tr>
</tbody></table>
<p><em>具体方法：</em></p>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Audience</span> {    </span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">silenceCellPhones</span><span class="params">()</span> {        </span><br><span class="line">        System.out.println(<span class="string">"Silencing cell phones"</span>);    </span><br><span class="line">    }        </span><br><span class="line">    </span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">takeSeats</span><span class="params">()</span> {        </span><br><span class="line">        System.out.println(<span class="string">"Taking seats"</span>);    </span><br><span class="line">    }        </span><br><span class="line">    </span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">applause</span><span class="params">()</span> {        </span><br><span class="line">        System.out.println(<span class="string">"CLAP CLAP CLAP!!!"</span>);    </span><br><span class="line">    }        </span><br><span class="line">    </span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">demandRefund</span><span class="params">()</span> {        </span><br><span class="line">        System.out.println(<span class="string">"Demanding a refund"</span>);    </span><br><span class="line">    }        </span><br><span class="line">    </span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">watchPerformance</span><span class="params">(ProceedingJoinPoint jp)</span> {        </span><br><span class="line">        <span class="keyword">try</span> {            </span><br><span class="line">            System.out.println(<span class="string">"Silencing cell phones"</span>);            </span><br><span class="line">            System.out.println(<span class="string">"Taking seats"</span>);            </span><br><span class="line">            <span class="comment">// 执行目标方法            </span></span><br><span class="line">            jp.proceed();            </span><br><span class="line">            System.out.println(<span class="string">"CLAP CLAP CLAP!!!"</span>);        </span><br><span class="line">        } <span class="keyword">catch</span> (Throwable e) {            </span><br><span class="line">            System.out.println(<span class="string">"Demanding a refund"</span>);        </span><br><span class="line">        }    </span><br><span class="line">    } </span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<p><em>XML 配置：</em></p>
<figure class="highlight xml"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">aop:config</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">aop:aspect</span> <span class="attr">ref</span>=<span class="string">"audience"</span>&gt;</span></span><br><span class="line">        <span class="comment">&lt;!-- 切点 --&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">aop:pointcut</span> <span class="attr">id</span>=<span class="string">"performance"</span> <span class="attr">expression</span>=<span class="string">"execution(** concert.Performance.perform(..))"</span>/&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">aop:before</span> <span class="attr">pointcut-ref</span>=<span class="string">"performance"</span> <span class="attr">method</span>=<span class="string">"silenceCellPhones"</span>/&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">aop:before</span> <span class="attr">pointcut-ref</span>=<span class="string">"performance"</span> <span class="attr">method</span>=<span class="string">"takeSeats"</span>/&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">aop:after-returning</span> <span class="attr">pointcut</span>=<span class="string">"execution(** concert.Performance.perform(..))"</span> <span class="attr">method</span>=<span class="string">"applause"</span>/&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">aop:after-throwing</span> <span class="attr">pointcut</span>=<span class="string">"execution(** concert.Performance.perform(..))"</span> <span class="attr">method</span>=<span class="string">"demandRefund"</span>/&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">aop:around</span> <span class="attr">pointcut-ref</span>=<span class="string">"performance"</span> <span class="attr">method</span>=<span class="string">"watchPerformance"</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">aop:aspect</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">aop:config</span>&gt;</span></span><br></pre></td></tr></tbody></table></figure>

<h3 id="2-1-为通知传递参数-——-XML"><a href="#2-1-为通知传递参数-——-XML" class="headerlink" title="2.1. 为通知传递参数 —— XML"></a>2.1. 为通知传递参数 —— XML</h3><p><em>具体方法：</em></p>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">TrackCounter</span> {    </span><br><span class="line">    <span class="keyword">private</span> Map&lt;Integer, Integer&gt; trackCounts = <span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;&gt;();    </span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">countTrack</span><span class="params">(<span class="type">int</span> trackNumber)</span> {        </span><br><span class="line">        <span class="type">int</span> <span class="variable">currentCount</span> <span class="operator">=</span> getPlayCount(trackNumber);        </span><br><span class="line">        trackCounts.put(trackNumber, currentCount + <span class="number">1</span>);    </span><br><span class="line">    }    </span><br><span class="line">    <span class="keyword">public</span> <span class="type">int</span> <span class="title function_">getPlayCount</span><span class="params">(<span class="type">int</span> trackNumber)</span> {        </span><br><span class="line">        <span class="keyword">return</span> trackCounts.containsKey(trackNumber) ? trackCounts.get(trackNumber) : <span class="number">0</span>;    </span><br><span class="line">    } </span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<p><em>XML 配置：</em></p>
<figure class="highlight xml"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">aop:config</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">aop:aspect</span> <span class="attr">ref</span>=<span class="string">"trackCounter"</span>&gt;</span></span><br><span class="line">        <span class="comment">&lt;!-- 切点 --&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">aop:pointcut</span> <span class="attr">id</span>=<span class="string">"trackPlayed"</span> <span class="attr">expression</span>=<span class="string">"execution(* soundsystem.CompactDisc.playTrack(int)) </span></span></span><br><span class="line"><span class="string"><span class="tag">            and args(trackNumber)"</span>/&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">aop:before</span> <span class="attr">pointcut-ref</span>=<span class="string">"trackPlayed"</span> <span class="attr">method</span>=<span class="string">"countTrack"</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">aop:aspect</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">aop:config</span>&gt;</span></span><br></pre></td></tr></tbody></table></figure>

<h3 id="2-2-通过切面引入新的功能-——-XML"><a href="#2-2-通过切面引入新的功能-——-XML" class="headerlink" title="2.2. 通过切面引入新的功能 —— XML"></a>2.2. 通过切面引入新的功能 —— XML</h3><ul>
<li><strong>type-matching：</strong> 指定目标接口</li>
<li><strong> implement-interface：</strong> 指定要增加的方法所在的接口</li>
<li><strong> default-impl：</strong> 指定要增加的方法的实现，也可以由 delegate-ref=”beanID” 来代替从而导入 Spring 容器中的 Bean</li>
</ul>
<figure class="highlight xml"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">aop:aspect</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">aop:declare-parents</span> </span></span><br><span class="line"><span class="tag">        <span class="attr">types-matching</span>=<span class="string">"concert.Performance+"</span></span></span><br><span class="line"><span class="tag">        <span class="attr">implement-interface</span>=<span class="string">"concert.Encoreable"</span></span></span><br><span class="line"><span class="tag">        <span class="attr">default-impl</span>=<span class="string">"concert.DefaultEncoreable"</span>/&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">aop:aspect</span>&gt;</span></span><br></pre></td></tr></tbody></table></figure>
<h1 id="四、通过注解引入新功能"><a href="#四、通过注解引入新功能" class="headerlink" title="四、通过注解引入新功能"></a>四、通过注解引入新功能</h1><p><img data-src="https://ccomma-pic-storage.oss-cn-hangzhou.aliyuncs.com/img/c6f1f9cff941eeb554ecd0dd4ebac000.png"></p>
<p>通过建立一个代理类同时代理 A 和 B，调用者调用该代理时，就可以同时 A 和 B 中的方法了。</p>
<p><em>目标类：</em></p>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Women</span> <span class="keyword">implements</span> <span class="title class_">Person</span> {</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">likePerson</span><span class="params">()</span> {</span><br><span class="line">        System.out.println(<span class="string">"我是女生，我喜欢帅哥"</span>);</span><br><span class="line">    }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<p><em>被引入的类：</em></p>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">FemaleAnimal</span> <span class="keyword">implements</span> <span class="title class_">Animal</span> {</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">eat</span><span class="params">()</span> {</span><br><span class="line">        System.out.println(<span class="string">"我是雌性，我比雄性更喜欢吃零食"</span>);</span><br><span class="line">    }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<p><em>切面：</em></p>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Aspect</span></span><br><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">AspectConfig</span> {</span><br><span class="line">    <span class="comment">// "+"表示 person 的所有子类；defaultImpl 表示默认需要添加的新的类</span></span><br><span class="line">    <span class="meta">@DeclareParents(value = "com.ccomma.annotation.Person+", defaultImpl = FemaleAnimal.class)</span></span><br><span class="line">    <span class="keyword">public</span> Animal animal;</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<h1 id="五、源码"><a href="#五、源码" class="headerlink" title="五、源码"></a>五、源码</h1><ul>
<li>在 bean 的后初始化方法（后置处理器）applyBeanPostProcessorsAfterInitialization 中执行了 AbstractAutoProxyCreator#postProcessAfterInitialization 方法<ul>
<li>内部执行了 AbstractAutoProxyCreator#wrapIfNecessary 方法<ul>
<li> getAdvicesAndAdvisorsForBean：查找出和当前 bean 匹配的 advisor</li>
<li>AbstractAutoProxyCreator#createProxy：把委托对象的 aop 增强和通用拦截进行合并，最终给代理对象，内部通过代理工厂 ProxyFactory#getProxy 创建代理<ul>
<li>代理工厂内部最终调用 DefaultAopProxyFactory#createAopProxy 来依据情况创建 jdk 代理或 cglib 代理</li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
</ul>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="https://ccomma.cn/f5f86795b0f8/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/ccomma.png">
      <meta itemprop="name" content="CComma">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="CComma's Blog">
      <meta itemprop="description" content="下一个目标：改变世界！">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | CComma's Blog">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/f5f86795b0f8/" class="post-title-link" itemprop="url">Spring</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>

      <time title="Created: 2022-05-13 14:41:23" itemprop="dateCreated datePublished" datetime="2022-05-13T14:41:23+08:00">2022-05-13</time>
    </span>

  
  
  <span class="post-meta-item">
    
      <span class="post-meta-item-icon">
        <i class="far fa-comment"></i>
      </span>
      <span class="post-meta-item-text">Disqus: </span>
    
    <a title="disqus" href="/f5f86795b0f8/#disqus_thread" itemprop="discussionUrl">
      <span class="post-comments-count disqus-comment-count" data-disqus-identifier="f5f86795b0f8/" itemprop="commentCount"></span>
    </a>
  </span>
  
  
    <span class="post-meta-item" title="Reading time">
      <span class="post-meta-item-icon">
        <i class="far fa-clock"></i>
      </span>
      <span class="post-meta-item-text">Reading time &asymp;</span>
      <span>1 mins.</span>
    </span>
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h1 id="测试"><a href="#测试" class="headerlink" title="测试"></a>测试</h1><figure class="highlight xml"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-test<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">scope</span>&gt;</span>test<span class="tag">&lt;/<span class="name">scope</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></tbody></table></figure>

<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// &gt;&gt;&gt; spring boot 1.4.0 版本之后使用以下两个配置</span></span><br><span class="line"><span class="meta">@RunWith(SpringRunner.class)</span></span><br><span class="line"><span class="meta">@SpringBootTest</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// &gt;&gt;&gt; spring boot 1.4.0 版本之前使用以下三个配置</span></span><br><span class="line"><span class="comment">//@RunWith(SpringJUnit4ClassRunner.class)</span></span><br><span class="line"><span class="comment">//classes 需要指定 spring boot 的启动类如：DemoApplication.class 不然 WebApplicationContext 不被实例化</span></span><br><span class="line"><span class="comment">//@SpringApplicationConfiguration(classes = DemoApplication.class)</span></span><br><span class="line"><span class="comment">//@WebAppConfiguration</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">IndexControllerTests</span> {</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">* mock api 模拟http请求</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line">    <span class="keyword">private</span> MockMvc mockMvc;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Resource</span></span><br><span class="line">    <span class="keyword">private</span> WebApplicationContext webApplicationContext;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//初始化工作</span></span><br><span class="line">    <span class="meta">@Before</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setUp</span><span class="params">()</span> {</span><br><span class="line">        <span class="comment">// 独立安装测试</span></span><br><span class="line">        <span class="comment">// mockMvc = MockMvcBuilders.standaloneSetup(new ReserveManageController()).build();</span></span><br><span class="line">        <span class="comment">// 集成Web环境测试（此种方式并不会集成真正的web环境，而是通过相应的Mock API进行模拟测试，无须启动服务器）</span></span><br><span class="line">        mockMvc = MockMvcBuilders.webAppContextSetup(webApplicationContext).build();</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="comment">//测试</span></span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">index</span><span class="params">()</span> <span class="keyword">throws</span> Exception {</span><br><span class="line">        <span class="comment">// 构建请求</span></span><br><span class="line">        <span class="type">MockHttpServletRequestBuilder</span> <span class="variable">requestBuilder</span> <span class="operator">=</span> MockMvcRequestBuilders.post(<span class="string">"/reserve_manage/v1/get_sms_template?s_eid=00604049"</span>)</span><br><span class="line">            <span class="comment">// .param("pageNum", "10")</span></span><br><span class="line">            .accept(MediaType.APPLICATION_JSON);</span><br><span class="line">        <span class="comment">// 返回结果</span></span><br><span class="line">        <span class="type">MvcResult</span> <span class="variable">mvcResult</span> <span class="operator">=</span> mockMvc.perform(requestBuilder)</span><br><span class="line">            <span class="comment">// 等同于Assert.assertEquals(200,status);</span></span><br><span class="line">            .andExpect(MockMvcResultMatchers.status().isOk())</span><br><span class="line">            <span class="comment">//  等同于 Assert.assertEquals("hello lvgang",content);</span></span><br><span class="line">            <span class="comment">// .andExpect(MockMvcResultMatchers.content().string(""))</span></span><br><span class="line">            <span class="comment">// 添加一个结果处理器，表示要对结果做点什么事情</span></span><br><span class="line">            .andDo(MockMvcResultHandlers.print())</span><br><span class="line">            <span class="comment">// 执行完成后返回相应的结果</span></span><br><span class="line">            .andReturn();</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 得到返回状态</span></span><br><span class="line">        <span class="type">int</span> <span class="variable">status</span> <span class="operator">=</span> mvcResult.getResponse().getStatus();</span><br><span class="line">        <span class="comment">// 得到返回结果</span></span><br><span class="line">        Assert.assertEquals(<span class="number">200</span>, status);</span><br><span class="line">        <span class="type">String</span> <span class="variable">content</span> <span class="operator">=</span> mvcResult.getResponse().getContentAsString();</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<h1 id="SpringFactoryUtil"><a href="#SpringFactoryUtil" class="headerlink" title="SpringFactoryUtil"></a>SpringFactoryUtil</h1><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Order(Ordered.HIGHEST_PRECEDENCE)</span></span><br><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">SpringFactoryUtil</span> <span class="keyword">implements</span> <span class="title class_">ApplicationContextAware</span> {</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> ApplicationContext applicationContext;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setApplicationContext</span><span class="params">(ApplicationContext applicationContext)</span> <span class="keyword">throws</span> BeansException {</span><br><span class="line">        SpringFactoryUtil.applicationContext = applicationContext;</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> Object <span class="title function_">getBean</span><span class="params">(String name)</span> {</span><br><span class="line">        <span class="keyword">return</span> applicationContext.getBean(name);</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> &lt;T&gt; T <span class="title function_">getBean</span><span class="params">(Class&lt;T&gt; requiredType)</span> {</span><br><span class="line">        <span class="keyword">return</span> applicationContext.getBean(requiredType);</span><br><span class="line">    }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="https://ccomma.cn/fd84f239d2d2/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/ccomma.png">
      <meta itemprop="name" content="CComma">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="CComma's Blog">
      <meta itemprop="description" content="下一个目标：改变世界！">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | CComma's Blog">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/fd84f239d2d2/" class="post-title-link" itemprop="url">git flow</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>

      <time title="Created: 2022-05-13 09:59:37" itemprop="dateCreated datePublished" datetime="2022-05-13T09:59:37+08:00">2022-05-13</time>
    </span>

  
  
  <span class="post-meta-item">
    
      <span class="post-meta-item-icon">
        <i class="far fa-comment"></i>
      </span>
      <span class="post-meta-item-text">Disqus: </span>
    
    <a title="disqus" href="/fd84f239d2d2/#disqus_thread" itemprop="discussionUrl">
      <span class="post-comments-count disqus-comment-count" data-disqus-identifier="fd84f239d2d2/" itemprop="commentCount"></span>
    </a>
  </span>
  
  
    <span class="post-meta-item" title="Reading time">
      <span class="post-meta-item-icon">
        <i class="far fa-clock"></i>
      </span>
      <span class="post-meta-item-text">Reading time &asymp;</span>
      <span>1 mins.</span>
    </span>
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <p><a target="_blank" rel="noopener" href="https://www.yuque.com/attachments/yuque/0/2022/pdf/12939765/1652406645058-0b412afc-2599-455e-93ae-2750f2cd6951.pdf">📎代码分支策略・语雀.pdf</a><br><img data-src="https://ccomma-pic-storage.oss-cn-hangzhou.aliyuncs.com/img/f388a58466a12a9126440b2257c9781a.png"></p>
<h2 id="1-Master"><a href="#1-Master" class="headerlink" title="1. Master"></a>1. Master</h2><p>线上</p>
<h2 id="2-Develop"><a href="#2-Develop" class="headerlink" title="2. Develop"></a>2. Develop</h2><p>开发</p>
<h2 id="3-Feature"><a href="#3-Feature" class="headerlink" title="3. Feature"></a>3. Feature</h2><p>Feature 分支做完后，必须合并回 Develop 分支<br>合并完分支后一般会删点这个 Feature 分支，但是也可以保留</p>
<h2 id="4-Release"><a href="#4-Release" class="headerlink" title="4. Release"></a>4. Release</h2><p><em><strong>概述：</strong></em> 基于 Develop 分支创建，用于测试，修改 Bug<br><em><strong>创建：</strong></em> 一旦创建了 Release 分支之后，不要再从 Develop 分支上合并新的改动到 Release 分支<br><em><strong>发布：</strong></em> 发布 Release 分支时，合并 Release 到 Master 和 Develop， 同时在 Master 分支上打个 Tag 记住 Release 版本号，然后删除 Release 分支</p>
<h2 id="5-Hotfix"><a href="#5-Hotfix" class="headerlink" title="5. Hotfix"></a>5. Hotfix</h2><p>基于 Master 分支创建，开发完后需要合并回 Master 和 Develop 分支，同时在 Master 上打一个 tag</p>
<p>若有收获，就点个赞吧</p>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="https://ccomma.cn/6c08649469df/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/ccomma.png">
      <meta itemprop="name" content="CComma">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="CComma's Blog">
      <meta itemprop="description" content="下一个目标：改变世界！">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | CComma's Blog">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/6c08649469df/" class="post-title-link" itemprop="url">git 常用命令</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>

      <time title="Created: 2022-05-13 09:58:52" itemprop="dateCreated datePublished" datetime="2022-05-13T09:58:52+08:00">2022-05-13</time>
    </span>

  
  
  <span class="post-meta-item">
    
      <span class="post-meta-item-icon">
        <i class="far fa-comment"></i>
      </span>
      <span class="post-meta-item-text">Disqus: </span>
    
    <a title="disqus" href="/6c08649469df/#disqus_thread" itemprop="discussionUrl">
      <span class="post-comments-count disqus-comment-count" data-disqus-identifier="6c08649469df/" itemprop="commentCount"></span>
    </a>
  </span>
  
  
    <span class="post-meta-item" title="Reading time">
      <span class="post-meta-item-icon">
        <i class="far fa-clock"></i>
      </span>
      <span class="post-meta-item-text">Reading time &asymp;</span>
      <span>2 mins.</span>
    </span>
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h2 id="1-提交和拉取"><a href="#1-提交和拉取" class="headerlink" title="1. 提交和拉取"></a>1. 提交和拉取</h2><figure class="highlight shell"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">暂存所有文件</span></span><br><span class="line">git add .</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">暂存并提交</span></span><br><span class="line">git commit -am</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">push 到远程 git</span></span><br><span class="line">git push</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">从远程 git 下拉到本地 git</span></span><br><span class="line">git pull</span><br></pre></td></tr></tbody></table></figure>
<p><a target="_blank" rel="noopener" href="https://segmentfault.com/a/1190000002783245">Git push 与 pull 的默认行为</a></p>
<h2 id="2-查看"><a href="#2-查看" class="headerlink" title="2. 查看"></a>2. 查看</h2><figure class="highlight shell"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">git status</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">查看不同</span></span><br><span class="line">git diff</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">查看日志</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">git <span class="built_in">log</span> --pretty=oneline --abbrev-commit</span></span><br><span class="line">git log</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">查看你的每一次命令</span></span><br><span class="line">git reflog</span><br></pre></td></tr></tbody></table></figure>
<h2 id="3-回退"><a href="#3-回退" class="headerlink" title="3. 回退"></a>3. 回退</h2><figure class="highlight shell"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">回退上一次提交，保留暂存区</span></span><br><span class="line">git reset --soft HEAD^</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">回退到指定版本</span></span><br><span class="line">git reset HEAD &lt;file&gt;</span><br></pre></td></tr></tbody></table></figure>
<h2 id="4-检出"><a href="#4-检出" class="headerlink" title="4. 检出"></a>4. 检出</h2><figure class="highlight shell"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">拉取暂存区文件到工作区</span></span><br><span class="line">git checkout -- &lt;file&gt;</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">切换分支</span></span><br><span class="line">git checkout branchName</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">新建并检出分支</span></span><br><span class="line">git checkout -b dev  =&gt;  git branch dev   &amp;   git checkout dev</span><br></pre></td></tr></tbody></table></figure>
<h2 id="5-远程"><a href="#5-远程" class="headerlink" title="5. 远程"></a>5. 远程</h2><figure class="highlight shell"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">查看远程库的信息</span></span><br><span class="line">git remote</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">显示了可以抓取和推送的 origin 的地址</span></span><br><span class="line">git remote -v</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">添加远程地址</span></span><br><span class="line">git remote add origin git@github.com:xxxxx</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">从远程 git 上 <span class="built_in">clone</span> 项目</span></span><br><span class="line">git clone git@github.com:xxxxx</span><br></pre></td></tr></tbody></table></figure>
<h2 id="6-分支"><a href="#6-分支" class="headerlink" title="6. 分支"></a>6. 分支</h2><figure class="highlight shell"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">查看分支</span></span><br><span class="line">git branch</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">创建 dev 分支</span></span><br><span class="line">git branch dev</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">删除 dev 分支</span></span><br><span class="line">git branch -d dev</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">强行删除 dev 分支</span></span><br><span class="line">git branch -D dev</span><br></pre></td></tr></tbody></table></figure>
<h2 id="7-合并"><a href="#7-合并" class="headerlink" title="7. 合并"></a>7. 合并</h2><figure class="highlight shell"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">合并 dev 分支到当前分支</span></span><br><span class="line">git merge dev</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">强制禁用 Fast forward</span></span><br><span class="line">git merge --no-ff -m "merge branch 'dev' into master" dev</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">变基</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">比较 git merge 合并整合得到的结果没有任何区别，但是通过 git rebase 衍合能产生一个更为整洁的提交历史。</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">把解决分支补丁同最新主干代码之间的冲突的责任，划转给由提交补丁的人来解决</span></span><br><span class="line">git rebase</span><br></pre></td></tr></tbody></table></figure>
<p><a target="_blank" rel="noopener" href="https://www.jianshu.com/p/4a8f4af4e803">rebase 用法小结</a><br><a target="_blank" rel="noopener" href="https://blog.csdn.net/wh_19910525/article/details/7554489">merge&nbsp;和&nbsp;rebase&nbsp;间的区别</a></p>
<h2 id="8-暂存"><a href="#8-暂存" class="headerlink" title="8. 暂存"></a>8. 暂存</h2><figure class="highlight shell"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">git stash</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">添加注释</span></span><br><span class="line">git stash save "message"</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">存储列表</span></span><br><span class="line">git stash list</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">使用某个存储，不删除</span></span><br><span class="line">git stash apply</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">删除某个存储</span></span><br><span class="line">git stash drop</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">使用并删除某个存储</span></span><br><span class="line">git stash pop</span><br></pre></td></tr></tbody></table></figure>
<h2 id="9-标签"><a href="#9-标签" class="headerlink" title="9. 标签"></a>9. 标签</h2><figure class="highlight shell"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">建一个新的标签</span></span><br><span class="line">git tag v1.0</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">对 <span class="built_in">id</span> 为 f52c633 的 commit 打标签</span></span><br><span class="line">git tag v0.9 f52c633</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">删除标签</span></span><br><span class="line">git tag -d v0.1</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">推送标签</span></span><br><span class="line">git push origin v1.0</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">推送全部标签</span></span><br><span class="line">git push origin --tags</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">删除远程标签</span></span><br><span class="line">git push origin :refs/tags/v0.9</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">查看所有标签</span></span><br><span class="line">git tag</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">带有说明的标签</span></span><br><span class="line">git tag -a v0.1 -m "version 0.1 released" 1094adb</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">查看标签信息</span></span><br><span class="line">git show v0.9</span><br></pre></td></tr></tbody></table></figure>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="https://ccomma.cn/d59b3a8193b0/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/ccomma.png">
      <meta itemprop="name" content="CComma">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="CComma's Blog">
      <meta itemprop="description" content="下一个目标：改变世界！">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | CComma's Blog">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/d59b3a8193b0/" class="post-title-link" itemprop="url">git 配置</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>

      <time title="Created: 2022-05-13 09:57:31" itemprop="dateCreated datePublished" datetime="2022-05-13T09:57:31+08:00">2022-05-13</time>
    </span>

  
  
  <span class="post-meta-item">
    
      <span class="post-meta-item-icon">
        <i class="far fa-comment"></i>
      </span>
      <span class="post-meta-item-text">Disqus: </span>
    
    <a title="disqus" href="/d59b3a8193b0/#disqus_thread" itemprop="discussionUrl">
      <span class="post-comments-count disqus-comment-count" data-disqus-identifier="d59b3a8193b0/" itemprop="commentCount"></span>
    </a>
  </span>
  
  
    <span class="post-meta-item" title="Reading time">
      <span class="post-meta-item-icon">
        <i class="far fa-clock"></i>
      </span>
      <span class="post-meta-item-text">Reading time &asymp;</span>
      <span>1 mins.</span>
    </span>
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h2 id="1-配置用户名"><a href="#1-配置用户名" class="headerlink" title="1. 配置用户名"></a>1. 配置用户名</h2><p><code>git config --global user.name "username"</code></p>
<h2 id="2-配置邮箱"><a href="#2-配置邮箱" class="headerlink" title="2. 配置邮箱"></a>2. 配置邮箱</h2><p><code>git config --global user.email "xxxx@xxxx.xx"</code></p>
<h2 id="3-其他配置"><a href="#3-其他配置" class="headerlink" title="3. 其他配置"></a>3. 其他配置</h2><figure class="highlight shell"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">#</span><span class="language-bash">让 Git 不要管 Windows/Unix 换行符转换的事</span></span><br><span class="line">git config --global core.autocrlf false</span><br></pre></td></tr></tbody></table></figure>
<h2 id="4-编码配置"><a href="#4-编码配置" class="headerlink" title="4. 编码配置"></a>4. 编码配置</h2><figure class="highlight shell"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">#</span><span class="language-bash">避免 git gui 中的中文乱码</span></span><br><span class="line">git config --global gui.encoding utf-8</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">避免 git status 显示的中文文件名乱码</span></span><br><span class="line">git config --global core.quotepath off</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">让 git 对大小写敏感</span></span><br><span class="line">git config --global core.ignorecase false</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">配置别名</span></span><br><span class="line">git config --global alias.lg "log --color --graph --pretty=format:'%Cred%h%Creset -%C(yellow)%d%Creset %s %Cgreen(%cr) %C(bold blue)&lt;%an&gt;%Creset' --abbrev-commit"</span><br></pre></td></tr></tbody></table></figure>
<p><strong>5. ssh key pair 配置</strong><br><a target="_blank" rel="noopener" href="https://blog.csdn.net/upshi/article/details/78327125">(10 条消息) Git 多 SSH 账号管理_一黑到底 - CSDN 博客_git 多 ssh</a><br><a target="_blank" rel="noopener" href="https://www.cnblogs.com/popfisher/p/5731232.html">Windows 下 Git 多账号配置，同一电脑多个 ssh-key 的管理 - popfisher - 博客园 (cnblogs.com)</a><br>SSH 是建立在应用层和传输层基础上的安全协议，其目的是专为远程登录会话和其他网络服务提供安全性的保障<br>SSH 密钥对可以让我们方便的登录到 SSH 服务器，而无需输入密码</p>
<ol>
<li>Windows 上 Git Bash 命令行窗口中输入：ssh-keygen -t rsa -C “<a href="mailto:xxx@xxx.com">xxx@xxx.com</a>“</li>
<li>接着一直回车生成 ssh key pair</li>
<li><code>ssh-add ~/.ssh/id_rsa</code>    #把专用密钥添加到 ssh-agent 的高速缓存中，ssh-agent 能避免这种反复输入私钥的烦恼</li>
<li><code>cat ~/.ssh/id_rsa.pub</code></li>
</ol>
<p><img data-src="https://ccomma-pic-storage.oss-cn-hangzhou.aliyuncs.com/img/e1edcae107e0bcbb1f409d558e1434a1.png" alt="image.png"></p>
<h1 id=""><a href="#" class="headerlink" title=""></a><br></h1>
      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="https://ccomma.cn/cd58652eb14b/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/ccomma.png">
      <meta itemprop="name" content="CComma">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="CComma's Blog">
      <meta itemprop="description" content="下一个目标：改变世界！">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | CComma's Blog">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/cd58652eb14b/" class="post-title-link" itemprop="url">Git</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>

      <time title="Created: 2022-05-12 22:59:00" itemprop="dateCreated datePublished" datetime="2022-05-12T22:59:00+08:00">2022-05-12</time>
    </span>

  
  
  <span class="post-meta-item">
    
      <span class="post-meta-item-icon">
        <i class="far fa-comment"></i>
      </span>
      <span class="post-meta-item-text">Disqus: </span>
    
    <a title="disqus" href="/cd58652eb14b/#disqus_thread" itemprop="discussionUrl">
      <span class="post-comments-count disqus-comment-count" data-disqus-identifier="cd58652eb14b/" itemprop="commentCount"></span>
    </a>
  </span>
  
  
    <span class="post-meta-item" title="Reading time">
      <span class="post-meta-item-icon">
        <i class="far fa-clock"></i>
      </span>
      <span class="post-meta-item-text">Reading time &asymp;</span>
      <span>1 mins.</span>
    </span>
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <p><a target="_blank" rel="noopener" href="https://www.yuque.com/attachments/yuque/0/2022/pdf/12939765/1652407285001-fab2c18e-81c0-4748-bdca-10cf3e727610.pdf?_lake_card=%7B%22src%22:%22https://www.yuque.com/attachments/yuque/0/2022/pdf/12939765/1652407285001-fab2c18e-81c0-4748-bdca-10cf3e727610.pdf%22,%22name%22:%22%E5%88%AB%E4%B9%B1%E6%8F%90%E4%BA%A4%E4%BB%A3%E7%A0%81%E4%BA%86%EF%BC%8C%E7%9C%8B%E4%B8%8B%E5%A4%A7%E5%8E%82%20Git%20%E6%8F%90%E4%BA%A4%E8%A7%84%E8%8C%83%E6%98%AF%E6%80%8E%E4%B9%88%E5%81%9A%E7%9A%84%EF%BC%81.pdf%22,%22size%22:1610472,%22ext%22:%22pdf%22,%22source%22:%22%22,%22status%22:%22done%22,%22download%22:true,%22type%22:%22application/pdf%22,%22taskId%22:%22u37544941-f41e-4c9f-972d-237495d4b11%22,%22taskType%22:%22upload%22,%22mode%22:%22title%22,%22id%22:%22u16e3b7e8%22,%22card%22:%22file%22%7D">别乱提交代码了，看下大厂 Git 提交规范是怎么做的！.pdf</a><br><a target="_blank" rel="noopener" href="http://iissnan.com/progit/">Pro Git 简体中文版 (iissnan.com)</a><br><a target="_blank" rel="noopener" href="https://github.com/zurawiki/gptcommit">gptcommit</a></p>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="https://ccomma.cn/fd6d81abe0b0/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/ccomma.png">
      <meta itemprop="name" content="CComma">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="CComma's Blog">
      <meta itemprop="description" content="下一个目标：改变世界！">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | CComma's Blog">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/fd6d81abe0b0/" class="post-title-link" itemprop="url">操作系统从入门到入土⑤：输入 / 输出</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>

      <time title="Created: 2021-11-08 11:06:41" itemprop="dateCreated datePublished" datetime="2021-11-08T11:06:41+08:00">2021-11-08</time>
    </span>

  
  
  <span class="post-meta-item">
    
      <span class="post-meta-item-icon">
        <i class="far fa-comment"></i>
      </span>
      <span class="post-meta-item-text">Disqus: </span>
    
    <a title="disqus" href="/fd6d81abe0b0/#disqus_thread" itemprop="discussionUrl">
      <span class="post-comments-count disqus-comment-count" data-disqus-identifier="fd6d81abe0b0/" itemprop="commentCount"></span>
    </a>
  </span>
  
  
    <span class="post-meta-item" title="Reading time">
      <span class="post-meta-item-icon">
        <i class="far fa-clock"></i>
      </span>
      <span class="post-meta-item-text">Reading time &asymp;</span>
      <span>14 mins.</span>
    </span>
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h1 id="1-I-O-硬件原理"><a href="#1-I-O-硬件原理" class="headerlink" title="1. I/O 硬件原理"></a>1. I/O 硬件原理</h1><h2 id="1-1-I-O-设备"><a href="#1-1-I-O-设备" class="headerlink" title="1.1. I/O 设备"></a>1.1. I/O 设备</h2><p>I/O 设备大致可以分为 <strong>块设备（block device）</strong>和 <strong>字符设备（character device）</strong>。</p>
<p><strong>块设备：</strong><br>块设备把信息存储在固定大小的块中，大小在 512 字节至 65536 字节之间。所有传输以一个或多个完整的连续块为单位。<br>块设备的基本特征是每个块都能独立于其他块而读写。硬盘、蓝光光盘和 USB 是最常见的块设备。</p>
<p><strong>字符设备：</strong><br>字符设备以字符为单位发送或接收一个字符流，而不考虑任何块结构。<br>字符设备是不可寻址的，也没有任何寻道操作。打印机、网络接口、鼠标 (用作指点设备)、以及大多数与磁盘不同的设备都可看作字符设备。</p>
<h2 id="1-2-设备控制器"><a href="#1-2-设备控制器" class="headerlink" title="1.2. 设备控制器"></a>1.2. 设备控制器</h2><p>I/O 设备一般由机械部件和电子部件两部分组成。机械部件则是设备本身；而电子部件又称作 ** 设备控制器（device controller）** 或 <strong>适配器（adapter）</strong>。通常是个人计算机主板上的芯片，或是（PCI）扩展槽中的印刷电路板。</p>
<p><strong>作用：</strong><br>控制一个或多个 I/O 设备，以实现 I/O 设备和计算机之间的数据交换。<br>控制器把串行的位流转换为字节块，并进行必要的错误校正工作。<br>字节块通常首先在控制器内部的一个缓冲区中按位进行组装，然后进行校验再将它复制到主存中。</p>
<blockquote>
<p>LCD 显示器的控制器也是一个位串行设备。它从内存中读入包含待显示字符的字节，产生信号以便使相应的像素改变背光的极化方式，从而将其写到屏幕上。</p>
</blockquote>
<h2 id="1-3-内存映射-I-O"><a href="#1-3-内存映射-I-O" class="headerlink" title="1.3. 内存映射 I/O"></a>1.3. 内存映射 I/O</h2><p><strong>寄存器：</strong><br>每个控制器有几个寄存器用来与 CPU 进行通信。</p>
<ul>
<li>通过写入这些寄存器，操作系统可以命令设备发送数据、接收数据、开启或关闭，或者执行某些其他操作。</li>
<li>通过读取这些寄存器，操作系统可以了解设备的状态，是否准备好接收一个新的命令等。</li>
</ul>
<p><strong>数据缓冲区：</strong><br>许多设备还有一个操作系统可以读写的数据缓冲区。</p>
<blockquote>
<p>例如，在屏幕上显示像素的常规方法是使用一个视频 RAM，这一 RAM 基本上只是一个数据缓冲区，可供程序或操作系统写入数据。</p>
</blockquote>
<p><strong>寻址控制器方案：</strong><br>CPU 如何与寄存器和数据缓冲区通信？</p>
<ol>
<li><strong>I/O 端口号（I/O port）：</strong></li>
</ol>
<p>每个控制寄存器被分配一个 I/O 端口号（8 位或 16 位整数），所有 I/O 端口形成 I/O 端口空间，只有操作系统可以访问。<br>在这一方案中，内存地址空间和 I/O 地址空间是不同的。可以使用一条特殊的 I/O 指令，例如 <code>IN REG, PORT</code>，CPU 可以读取控制寄存器 PORT 的内容并将结果存入到 CPU 寄存器 REG 中。<br><img data-src="https://ccomma-pic-storage.oss-cn-hangzhou.aliyuncs.com/img/eb708a7c4a526a72448ac5116e88786f.png" alt="image.png"></p>
<ol start="2">
<li><strong>内存映射 I/O（memory-mapped I/O）：</strong></li>
</ol>
<p>将所有控制寄存器映射到内存空间中，每个控制寄存器被分配唯一的一个内存地址，这样的系统称为内存映射 I/O。<br><img data-src="https://ccomma-pic-storage.oss-cn-hangzhou.aliyuncs.com/img/1539db73122c168692b655dac119b9e2.png" alt="image.png"></p>
<p><strong>内存映射 I/O 优点：</strong></p>
<ol>
<li>I/O 指令读写设备控制寄存器，需要使用汇编代码，这增加了控制 I/O 的开销。而对于内存映射 I/O，I/O 设备驱动程序可以用 C 语言编写。</li>
<li>不需要特殊的保护机制来阻止用户进程执行 I/O 操作。</li>
<li>可以引用内存的每一条指令也可以引用控制寄存器。</li>
</ol>
<p>例如，如果存在一条指令 TEST 可以测试一个内存字是否为 0，那么它也可以用来测试一个控制寄存器是否为 0。<br>如果不是内存映射 I/O，必须首先将控制寄存器读入 CPU，然后再测试。</p>
<p><strong>实际工作原理：</strong><br>当 CPU 想要读入一个字的时候，将需要的地址放到总线的地址线上，然后在总线的一条控制线上置起一个 READ 信号。<br>还要用到第二条信号线来表明需要的是 I/O 空间还是内存空间。如果是内存空间，内存将响应请求。如果是 I/O 空间，I/O 设备将响应请求。</p>
<h2 id="1-4-直接存储器存取"><a href="#1-4-直接存储器存取" class="headerlink" title="1.4. 直接存储器存取"></a>1.4. 直接存储器存取</h2><p><strong>非 DMA 数据交换过程：</strong><br>CPU 需要寻址设备控制器以便与它们交换数据，在没有使用 DMA 时磁盘读取数据效率不高，过程如下：</p>
<ol>
<li>首先控制器从磁盘驱动器串行地、一位一位地读一个块（一个或多个扇区），直到将整块信息放入控制器的内部缓冲区中。</li>
<li>接着再计算校验和，以保证没有读错误发生。</li>
<li>然后控制器产生一个中断。当操作系统开始运行时，它重复地从控制器的缓冲区中一次一个字节或一个字地读取该块的信息，并将其存人内存中。</li>
</ol>
<p><strong>DMA 数据交换过程：</strong><br><img data-src="https://ccomma-pic-storage.oss-cn-hangzhou.aliyuncs.com/img/279ce57ad3eea8c671e2c9cffc98140e.png" alt="image.png"><br>DMA 控制器能独立于 CPU 访问系统总线，使用 DMA 时的过程：</p>
<ol>
<li>CPU 对 DMA 控制器进行编程，设置其的寄存器，以便让 DMA 控制器知道将什么数据传送到什么地方。</li>
</ol>
<p>DMA 控制器还要向磁盘控制器发送命令让它从磁盘读数据到其内部的缓冲区中，必要性：</p>
<ol>
<li>磁盘控制器可以在传送之前检验校验和。如果校验和是错误的，那么将发出一个表明错误的信号并且不会进行传送。</li>
<li>如果控制器要将数据直接写到内存，则它必须为要传送的每个字取得系统总线的控制权，会导致总线忙。</li>
</ol>
<p>如果块被放入内部缓冲区，则在 DMA 启动前不需要使用总线。</p>
<ol start="2">
<li>DMA 控制器通过在总线上发出一个读请求到磁盘控制器而发起 DMA 传送。</li>
<li>磁盘控制器从内部缓冲区中读取字写到内存，这是另一个标准总线周期。</li>
<li>当写操作完成时，磁盘控制器在总线上发出一个应答信号到 DMA 控制器。</li>
</ol>
<p>随后 DMA 控制器增加要使用的内存地址，并且减少字节计数。<br>如果字节计数仍然大于 0，则重复第 2 步到第 4 步，直到字节计数到达 0。<br>然后 DMA 控制器将中断 CPU 以便让 CPU 知道传送现在已经完成了。当操作系统开始工作时，用不着将磁盘块复制到内存中，因为它已经在内存中了。</p>
<p><strong>DMA 硬件集成方案：</strong><br>DMA 需要硬件的支持。DMA 控制器可以集成到磁盘控制器和其他控制器之中，这就要求每个设备有一个单独的 DMA 控制器。也可以将 DMA 控制器集成到主板上，由它调控到多个设备的数据传送。</p>
<p><strong>传输模式：</strong><br>许多总线能够以两种模式操作：每次一字模式和块模式。某些 DMA 控制器也能够以这两种模式操作。</p>
<ul>
<li><strong>周期窃取（eycle stealing）：</strong>每次一字模式下，DMA 控制器请求传送一个字并且得到这个字，传送多次。</li>
</ul>
<p>该模式下设备控制器会偶尔从 CPU 偷走一个临时的总线周期，从而轻微地延迟 CPU。这一机制称为周期窃取。</p>
<ul>
<li><strong>突发模式（burst mode）：</strong>在块模式中，DMA 控制器通知设备获得总线，发起一连串的传送，然后释放总线。这操作形式称为突发模式。</li>
</ul>
<p>它比周期窃取效率更高，因为获得总线占用了时间，并且以一次总线获得的代价能够传送多个字。<br>突发模式的缺点是，如果正在进行的是长时间突发传送，有可能将 CPU 和其他设备阻塞相当长的周期。</p>
<blockquote>
<p>联想：与 JVM 垃圾回收器串行收集与并行收集的区别类似。并行会暂停用户线程，专注于垃圾回收，吞吐量大，但也会加大用户响应时间，类似这里的突发模式。</p>
</blockquote>
<blockquote>
<p>某些 DMA 控制器是让设备控制器将字发送给 DMA 控制器，然后发起第 2 个总线请求将该字写到它应该去的任何地方。<br>采用这种方案，每传送一个字需要一个额外的总线周期，但是更加灵活，因为它可以执行设备到设备的复制甚至是内存到内存的复制（通过首先发起一个到内存的读，然后发起一个到不同内存地址的写）。</p>
</blockquote>
<h2 id="1-5-中断"><a href="#1-5-中断" class="headerlink" title="1.5. 中断"></a>1.5. 中断</h2><p><img data-src="https://ccomma-pic-storage.oss-cn-hangzhou.aliyuncs.com/img/848bd15e88456466d8d893cb2b556aa3.png" alt="image.png"><br><strong>产生中断信号：</strong><br>当一个 I/O 设备完成交给它的工作时，其通过在分配给它的一条总线信号线上置起信号从而产生中断。该信号被主板上的中断控制器芯片检测到，由中断控制器芯片决定做什么。<br>为了处理中断，中断控制器在地址线上放置一个数字表明哪个设备需要关注，并且置起一个中断 CPU 的信号。<br>如果有另一个中断正在处理中，该设备将继续在总线上置起中断信号，直到得到 CPU 的服务才被继续处理。</p>
<p>中断信号导致 CPU 停止当前正在做的工作去做其他的事情。<br>地址线上的数字是一个指向 ** 中断向量（interrupt vector）** 表格的索引，用于读取指向中断服务过程开始位置的程序计数器。</p>
<p><strong>服务开始前保存：</strong><br>在开始服务程序之前，硬件总是要保存一定的信息。必须保存程序计数器，这样被中断的进程才能够重新开<br>始。另一个极端是所有可见的寄存器和很多内部寄存器或许也要保存。</p>
<p>将这些信息保存到什么地方是一个问题：</p>
<ul>
<li>在内部寄存器中保存信息。在需要时操作系统可以读出这些内部寄存器。</li>
</ul>
<p>其缺点是，为避免第二个中断重写寄存器，以致在相关信息被读出前中断控制器无法得到应答。<br>这一策略在中断被禁止时将导致长时间的死机，并且可能丢失中断和丢失数据。</p>
<ul>
<li>在堆栈中保存信息。</li>
</ul>
<p>其带来的问题：</p>
<ul>
<li>如果使用当前堆栈，则它很可能是用户进程的堆栈，其堆栈指针甚至可能不是合法的，当硬件在其所指的地址写入时将导致致命错误。</li>
</ul>
<p>另外，若它指向一个页面的末端，那么在若干次内存写之后，页面边界可能被超出并且产生页面故障。这将会引起更大的问题：在何处保存状态以处理页面故障？</p>
<ul>
<li>如果使用内核堆栈，堆栈指针是合法的并且指向一个固定的页面。</li>
</ul>
<p>但是，切换到核心态可能要求改变 MMU 上下文，并且可能使高速缓存和 TLB 的大部分或全部失效。静态地或动态地重新装载所有这些东西将增加处理一个中断的时间，因而浪费 CPU 的时间。</p>
<p><strong>采用应答避免竞争：</strong><br>中断服务过程开始运行后，立刻通过将一个确定值写到中断控制器的某个 I/O 端口来对中断做出应答，来告诉中断控制器可以发出另一个中断。通过这种方式来避免多个同时发生的中断相互竞争。</p>
<h1 id="2-I-O-软件原理"><a href="#2-I-O-软件原理" class="headerlink" title="2. I/O 软件原理"></a>2. I/O 软件原理</h1><h2 id="2-1-I-O-软件的目标"><a href="#2-1-I-O-软件的目标" class="headerlink" title="2.1. I/O 软件的目标"></a>2.1. I/O 软件的目标</h2><p><strong>设备独立性（device independence）</strong>：设计的程序应该可以访问任意 I/O 设备。例如，读取一个文件作为输入的程序应该能够在硬盘、DVD 或者 USB 盘上读取文件，无需为每一种不同的设备修改程序。</p>
<p><strong>统一命名（uniform naming）</strong>：一个文件或一个设备的名字应该是一个简单的字符串或一个整数，它不应依赖于设备。用这种方法，所有文件和设备都采用相同的方式一路径名进行寻址。</p>
<blockquote>
<p>例如，一个 USB 盘可以安装到目录 /usr/ast/backup 下，这样复制一个文件到 /usr/ast/backup/monday 就是将文件复制到 USB 盘上。</p>
</blockquote>
<p><strong>错误处理（error handling）：</strong>一般来说，错误应该尽可能地在接近硬件的层面（低层）得到处理，只有低层软件处理不了才将错误上交高层处理。<br>当控制器发现了一个读错误时，如果它能够处理那么就应该自已设法纠正这一错误。如果控制器处理不了，则交给设备驱动程序处理，可能只需重读一次这块数据就正确了。</p>
<p><strong>同步传输（阻塞）和异步传输（中断驱动）：</strong></p>
<ul>
<li>异步：CPU 启动传输后便转去做其他工作，直到中断发生。</li>
<li>阻塞：在 read 系统调用之后，程序将自动被挂起，直到缓冲区中的数据准备好。</li>
</ul>
<p><strong>缓冲（buffering）：</strong><br>数据离开一个设备之后通常并不能直接存放到其最终的目的地。数据必须预先放置到输出缓冲区之中，从而消除缓冲区填满速率和缓冲区清空速率之间的相互影响，以避免缓冲区欠载。缓冲涉及大量的复制工作，并且经常对 I/O 性能有重大影响。</p>
<blockquote>
<p>例如，从网络上进来一个数据包时，直到将该数据包存放在某个地方并对其进行检查，操作系统才知道要将其置于何处。此外，某些设备具有严格的实时约束（如数字音频设备）。</p>
</blockquote>
<p><strong>共享设备和独占设备：</strong><br>有些 I/O 设备（磁盘）能够同时让多个用户使用。多个用户同时在同一磁盘上打开文件不会引起什么问题。<br>有些设备（磁带机）则必须由单个用户独占使用，直到该用户使用完，另一个用户才能拥有该磁带机。让多个用户随机将混杂的数据块写入同一磁带，这样是不能工作的。</p>
<h2 id="2-2-程序通知-I-O"><a href="#2-2-程序通知-I-O" class="headerlink" title="2.2. 程序通知 I/O"></a>2.2. 程序通知 I/O</h2><p>I/O 可以采用三种方式来实现。程序控制 I/O、中断驱动 I/O 和使用 DMA 的 I/O。</p>
<p><strong>程序控制 I/O（programmed I/O）：</strong>让 CPU 做全部工作。<br><img data-src="https://ccomma-pic-storage.oss-cn-hangzhou.aliyuncs.com/img/6be16f108e5804a39fedcd6ff2634e2e.png" alt="image.png"><br>例如一个用户进程想通过串行接口在打印机上打印 8 个字符的字符串”ABCDEFGH“。</p>
<ol>
<li>软件首先要在用户空间的一个缓冲区中组装字符串，如 a) 所示。</li>
<li>然后，用户进程调用打开打印机之类的系统调用来获得打印机。</li>
</ol>
<p>如果打印机当前被另一个进程占用，该系统调用将失败并返回一个错误代码，或者将阻塞直到打印机可用。<br>成功获取打印机后，用户进程就发出一个系统调用打印字符串。</p>
<ol start="3">
<li>然后，操作系统将字符串缓冲区复制到内核空间中的一个数组中。</li>
<li>若打印机可用，操作系统就复制第一个字符到打印机的数据寄存器中，在这个例子中使用了内存映射 I/O。</li>
</ol>
<p>这一操作将激活打印机。字符也许还不会出现在打印机上，因为某些打印机在打印任何东西之前要先缓冲一行或一页。</p>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="https://ccomma.cn/da53cb8a00c9/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/ccomma.png">
      <meta itemprop="name" content="CComma">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="CComma's Blog">
      <meta itemprop="description" content="下一个目标：改变世界！">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | CComma's Blog">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/da53cb8a00c9/" class="post-title-link" itemprop="url">操作系统从入门到入土①：概述</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>

      <time title="Created: 2021-08-23 21:28:05" itemprop="dateCreated datePublished" datetime="2021-08-23T21:28:05+08:00">2021-08-23</time>
    </span>

  
  
  <span class="post-meta-item">
    
      <span class="post-meta-item-icon">
        <i class="far fa-comment"></i>
      </span>
      <span class="post-meta-item-text">Disqus: </span>
    
    <a title="disqus" href="/da53cb8a00c9/#disqus_thread" itemprop="discussionUrl">
      <span class="post-comments-count disqus-comment-count" data-disqus-identifier="da53cb8a00c9/" itemprop="commentCount"></span>
    </a>
  </span>
  
  
    <span class="post-meta-item" title="Reading time">
      <span class="post-meta-item-icon">
        <i class="far fa-clock"></i>
      </span>
      <span class="post-meta-item-text">Reading time &asymp;</span>
      <span>28 mins.</span>
    </span>
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <p>深入理解计算机系统使用指南：<a target="_blank" rel="noopener" href="https://book.douban.com/review/5627139/">https://book.douban.com/review/5627139/</a></p>
<h1 id="1-什么是操作系统"><a href="#1-什么是操作系统" class="headerlink" title="1. 什么是操作系统"></a>1. 什么是操作系统</h1><p>操作系统所处的位置<br><img data-src="https://ccomma-pic-storage.oss-cn-hangzhou.aliyuncs.com/img/590b181ef083493161a55fbaf2fdc3c3.png" alt="image.png"><br>硬件包括芯片、电路板、磁盘、键盘、显示器以及类似的设备。</p>
<p><strong>用户态和内核态</strong><br>多数计算机有两种运行模式：内核态和用户态。</p>
<ul>
<li>内核态：操作系统运行在内核态，具有对所有硬件的完全访问权，可以执行机器能够运行的任何指令。内核态的程序由硬件保护，防止用户试图对其进行修改。</li>
<li>用户态：软件的其余部分运行在用户态，只使用了机器指令中的一个子集。</li>
</ul>
<h2 id="1-1-操作系统分类"><a href="#1-1-操作系统分类" class="headerlink" title="1.1. 操作系统分类"></a>1.1. 操作系统分类</h2><ul>
<li><strong>单用户操作系统：</strong>单用户操作系统一次只能支持一个用户程序的运行。单用户操作系统向用户提供联机交互式的工作环境，比如 MS-DOS 就是一个经典的单用户操作系统。</li>
<li><strong>批处理操作系统：</strong>早期的一种大型机用操作系统。可对用户作业成批处理，期间无需用户干预，分为单道批处理系统和多道批处理系统。</li>
<li><strong>分时操作系统：</strong>利用分时技术的一种联机的多用户交互式操作系统，每个用户可以通过自己的终端向系统发出各种操作控制命令，完成作业的运行。分时是指把处理机的运行时间分成很短的时间片，按时间片轮流把处理机分配给各联机作业使用。</li>
<li><strong>实时操作系统：</strong>一个能够在指定或者确定的时间内完成系统功能以及对外部或内部事件在同步或异步时间内做出响应的系统，实时意思就是对响应时间有严格要求，要以足够快的速度进行处理。分为硬实时和软实时两种。</li>
<li><strong>通用操作系统：</strong>同时兼有多道批处理、分时、实时处理的功能，或者其中两种以上功能的操作系统。</li>
<li><strong>网络操作系统：</strong>一种在通常操作系统功能的基础上提供网络通信和网络服务功能的操作系统。</li>
<li><strong>分布式操作系统：</strong>一种以计算机网络为基础的，将物理上分布的具有自治功能的数据处理系统或计算机系统互联起来的操作系统。分布式系统中各台计算机无主次之分，系统中若干台计算机可以并行运行同一个程序，分布式操作系统用于管理分布式系统资源。</li>
<li><strong>嵌入式操作系统：</strong>一种运行在嵌入式智能芯片环境中，对整个智能芯片以及它所操作、控制的各种部件装置等资源进行统一协调、处理、指挥和控制的系统软件。</li>
</ul>
<h2 id="1-2-操作系统接口"><a href="#1-2-操作系统接口" class="headerlink" title="1.2. 操作系统接口"></a>1.2. 操作系统接口</h2><p><img data-src="https://ccomma-pic-storage.oss-cn-hangzhou.aliyuncs.com/img/902ce2a4b8fbf79f5a078c45d91c759a.png" alt="image.png"><br>分为系统调用接口、POSIX 接口和领域应用接口</p>
<h3 id="1-2-1-系统调用接口"><a href="#1-2-1-系统调用接口" class="headerlink" title="1.2.1. 系统调用接口"></a>1.2.1. 系统调用接口</h3><p>应用程序通过操作系统内核提供的接口（例如系统调用）向内核申请服务。<br><img data-src="https://ccomma-pic-storage.oss-cn-hangzhou.aliyuncs.com/img/f4de6dbc1320586c69e548b30db936f0.png" alt="image.png"><br>printf -&gt; lib 中的 write -&gt; svc 下陷到内核 -&gt; 下陷处理函数 sys_syscall 找到内核对应中对应的函数 -&gt; sys_write</p>
<h3 id="1-2-2-POSIX-接口"><a href="#1-2-2-POSIX-接口" class="headerlink" title="1.2.2. POSIX 接口"></a>1.2.2. POSIX 接口</h3><p>为了同一个应用程序在不同操作系统上的可移植性，逐渐形成了一些可移植操作系统接口标准。<br>POSIX（Portable Operating System Interface for uniX，可移植操作系统接口）。POSIX 标准通常通过 C library（libc）来实现，常见的 libc 包括 glibc、musl、eglibc。 Android 也实现了一个名为 bionic 的 libc。<br>应用程序只需要调用 libc 提供的接口就可以实现对操作系统功能的调用。</p>
<h3 id="1-2-3-领域应用接口"><a href="#1-2-3-领域应用接口" class="headerlink" title="1.2.3. 领域应用接口"></a>1.2.3. 领域应用接口</h3><p>在 POSIX 或操作系统调用的基础上还可以封装面向不同领域的领域应用接口。</p>
<h1 id="2-硬件"><a href="#2-硬件" class="headerlink" title="2. 硬件"></a>2. 硬件</h1><h2 id="2-1-CPU"><a href="#2-1-CPU" class="headerlink" title="2.1. CPU"></a>2.1. CPU</h2><p>指令集架构（Instruction Set Architecture, ISA）是 CPU 和软件之间的桥梁。ISA 包含指令集、特权级、寄存器、执行模式、安全扩展、性能加速扩展等诸多方面。</p>
<h3 id="2-1-1-指令集"><a href="#2-1-1-指令集" class="headerlink" title="2.1.1. 指令集"></a>2.1.1. 指令集</h3><p>每个 CPU 都有一套可执行的专门 ** 指令集 **。所以，x86 处理器不能执行 ARM 程序，而 ARM 处理器也不能执行 x86 程序。</p>
<h3 id="2-1-2-特权级"><a href="#2-1-2-特权级" class="headerlink" title="2.1.2. 特权级"></a>2.1.2. 特权级</h3><p>AArch64（首款 64 位架构的 ARM 处理器）中的特权级被称为异常级别（Exception Level，EL）<br><img data-src="https://ccomma-pic-storage.oss-cn-hangzhou.aliyuncs.com/img/ed211bcc7bcc01fc8becc25b4b24223b.png" alt="image.png"></p>
<ul>
<li>EL0：最低的特权级，应用程序通常运行在该特权级，也称为 <strong>用户态</strong>。</li>
<li>EL1：操作系统通常运行在该特权级，也称为 ** 内核态 **。</li>
<li>EL2：在虚拟化场景下需要，虚拟机监控器（Virtual Machine Monitor，VMM）通常运行在该特权级。</li>
<li>EL3：TrustZone 是从 ARMv6 体系结构开始引入的安全特性，其从逻辑上将整个系统分为安全世界（能访问所有资源）和普通世界（不能访问安全世界的资源）。</li>
</ul>
<p>EL3 和安全特性 TrustZone 相关，负责普通世界和安全世界之间的切换。</p>
<p><strong>用户态切换至内核态的场景：</strong><br><img data-src="https://ccomma-pic-storage.oss-cn-hangzhou.aliyuncs.com/img/5daa365ab39433c1f7f95ea9d561b540.png" alt="image.png"></p>
<ol>
<li>应用程序执行 svc（特权调用，supervisor call）指令切换。</li>
<li>指令触发异常切换，如缺页异常。</li>
<li>CPU 收到来自外设的中断。</li>
</ol>
<p><strong>用户态切换至内核态过程：</strong><br>操作系统可以在异常向量表中为不同的异常类型配置相应的异常处理函数。</p>
<ol>
<li>发生特权级切换时，CPU 会读取 VBAR_EL1（向量基地址寄存器，Vector Base Address Register）来获得 <strong>异常向量表（exception vector table）</strong>的基地址。</li>
<li>然后根据异常原因（ESR_EL1 中保存的内容）调用操作系统设置的相应异常处理函数。</li>
<li>该函数通常会先保存应用程序的上下文（如通用寄存器），然后会根据异常原因进行相应的处理。</li>
</ol>
<p>例如，若特权级切换是应用程序执行 svc 指令导致的，则执行相应的系统调用；<br>若特权级切换是访存过程中缺页异常导致的，则执行相应的缺页异常处理函数。</p>
<ol start="4">
<li>异常处理完成之后，操作系统会恢复应用程序的上下文，然后执行 eret（异常返回，Exception Return）指令恢复 CPU 自动保存的 EL0 状态，并切回到 EL0，使应用程序从被中断处继续执行。</li>
</ol>
<p><strong>pipeline</strong><br>为了改善性能，CPU 设计师早就放弃了同时读取、解码和执行一条指令的简单模型。许多现代 CPU 具有同时 ** 取出多条指令 ** 的机制。这样的机制称为 <strong>流水线（pipeline）</strong>。<br>例如，一个 CPU 可以有单独的取指单元、解码单元和执行单元，于是当它执行指令 n 时，还可以对指令 n ＋1 解码，并且读取指令 n +2。<br><img data-src="https://ccomma-pic-storage.oss-cn-hangzhou.aliyuncs.com/img/0cab757be7497b7484eb81ea077f99a6.png" alt="image.png"></p>
<p><strong>超标量 CPU</strong><br>超标量 CPU，有多个执行单元。两个或更多的指令被同时取出、解码并装入暂存缓冲区中，直至它们执行完毕。只要有一个执行单元空闲，就检查保持缓冲区中是否还有可处理的指令，如果有，就把指令从缓冲区中移出并执行之。<br>有指令不按顺序执行的隐患。</p>
<blockquote>
<p>例如，一个 CPU 用于整数算术运算，一个 CPU 用于浮点算术运算，一个 CPU 用于布尔运算。</p>
</blockquote>
<p><img data-src="https://ccomma-pic-storage.oss-cn-hangzhou.aliyuncs.com/img/5e547a976ceee90d436a019295be0c8f.png" alt="image.png"></p>
<h3 id="2-1-3-寄存器"><a href="#2-1-3-寄存器" class="headerlink" title="2.1.3. 寄存器"></a>2.1.3. 寄存器</h3><p>用与 CPU 相同的材料制成，所以和 CPU 一样快。</p>
<h2 id="2-2-存储器"><a href="#2-2-存储器" class="headerlink" title="2.2. 存储器"></a>2.2. 存储器</h2><p>存储器分层结构<br><img data-src="https://ccomma-pic-storage.oss-cn-hangzhou.aliyuncs.com/img/869cb1408042650ad093b5f8b9e5ea52.png" alt="image.png"></p>
<h3 id="2-2-2-高速缓存"><a href="#2-2-2-高速缓存" class="headerlink" title="2.2.2. 高速缓存"></a>2.2.2. 高速缓存</h3><p><strong>L1 缓存：</strong>总是在 CPU 中，用来将已解码的指令调入 CPU 的执行引擎，不存在任何延时。</p>
<p><strong>L2 缓存：</strong>用来存放近来使用过的若干兆字节的内存字，延时 1 或 2 个时钟周期。</p>
<ul>
<li>带有共享 L2 缓存的 4 核芯片（Intel）：</li>
</ul>
<p><img data-src="https://ccomma-pic-storage.oss-cn-hangzhou.aliyuncs.com/img/fdaffb91f95605d5f515bf1c43744278.png" alt="image.png"></p>
<ul>
<li>带有分离 L2 缓存的 4 核芯片（AMD）：</li>
</ul>
<p><img data-src="https://ccomma-pic-storage.oss-cn-hangzhou.aliyuncs.com/img/a96f844f844d6460c884f87fdb5fa325.png" alt="image.png"></p>
<p><strong>缓存行：</strong><br>CPU 缓存是由若干个缓存行（cache line）组成的。物理内存与 CPU 缓存之间的数据传输以缓存行为单位，一般为 64 字节。这比单个字节读取要快得多。<br>每个缓存行有一个用于表示其是否有效的有效位（valid bit）和一个用于标识其对应的物理地址的标记地址（tag address）。</p>
<p><strong>缓存命中：</strong><br>当某个程序需要读一个存储字时，高速缓存硬件检查所需要的高速缓存行是否在高速缓存中。</p>
<ul>
<li>命中，就不需要访问主存，命中通常需要两个时钟周期。</li>
<li>未命中就必须访问内存，这将花费大量时间。<blockquote>
<p>存储器读取某一个位置，接下来访问这个位置的概率非常高，尤其是紧随其后的内存位置。</p>
</blockquote>
</li>
</ul>
<p><strong>缓存结构：</strong><br><img data-src="https://ccomma-pic-storage.oss-cn-hangzhou.aliyuncs.com/img/f5410bebb3a5c861935545799d24673a.png" alt="image.png"><br><img data-src="https://ccomma-pic-storage.oss-cn-hangzhou.aliyuncs.com/img/4819fdb071292e7a1b549a75762fa5b3.png" alt="image.png"><br>物理地址在逻辑上分为 Tag、Set（也称为 Index）以及 Offset 三段。</p>
<blockquote>
<p>类似三维坐标中的 xyz 坐标</p>
</blockquote>
<p>组（Set）与路（Way）是 CPU 缓存的经典概念。</p>
<ul>
<li>物理地址中的 Set 段能表示的最大数目称为组。</li>
<li>同一组（即 Set 段相等）下，支持的最大 Tag 数则称为路，即同一组下的缓存行数目，该 CPU 缓存被称为 4 路组相联（4-Way Set Associative）。</li>
</ul>
<h3 id="2-2-3-主存"><a href="#2-2-3-主存" class="headerlink" title="2.2.3. 主存"></a>2.2.3. 主存</h3><ul>
<li>随机访问存储器（RAM）</li>
<li>只读存储器（ROM）：用于启动计算机的引导加载模块</li>
<li>电可擦除可编程 ROM（EEPROM） 和闪存：与 ROM 相比可以擦除和重写</li>
</ul>
<h3 id="2-2-4-磁盘"><a href="#2-2-4-磁盘" class="headerlink" title="2.2.4. 磁盘"></a>2.2.4. 磁盘</h3><p><img data-src="https://ccomma-pic-storage.oss-cn-hangzhou.aliyuncs.com/img/e2dd668189cb0c4710403d1fe3578022.png" alt="image.png"><br><strong>概念：</strong></p>
<ul>
<li>在任意一个给定臂的位置，每个磁头可以读取一段环形区域，称为 <strong>磁道</strong>（track）。</li>
<li>把一个给定臂的位置上的所有磁道合并起来，组成了一个 <strong>柱面</strong>（cylinder）。外部的柱面比内部的柱面有更多的扇区。</li>
</ul>
<p><strong>过程：</strong></p>
<ol>
<li>机械臂从一个柱面移到相邻的柱面大约需要 1ms。而随机移到一个柱面的典型时间为 5ms 至 10ms，其具体时间取决于驱动器。</li>
<li>一旦磁臂到达正确的磁道上，驱动器必须等待所需的扇区旋转到磁头之下，这就增加了 5ms 至 10ms 的时延，其具体延时取决于驱动器的转速。</li>
<li>一旦所需要的扇区移到磁头之下，就开始读写，低端硬盘的速率是 50MB/s，而高速磁盘的速率是 160 MB/s。</li>
</ol>
<h3 id="2-2-5-I-O-设备"><a href="#2-2-5-I-O-设备" class="headerlink" title="2.2.5. I/O 设备"></a>2.2.5. I/O 设备</h3><ul>
<li><strong>实际设备：</strong>如 SATA（串行高级技术附件），标准化后任何一个 SATA 磁盘控制器就可以适配任一种 SATA 磁盘。</li>
<li><strong>设备控制器：</strong></li>
</ul>
<p>设备控制器是插在电路板上的一块芯片或一组芯片。它从操作系统接收命令，物理地控制设备。</p>
<blockquote>
<p>例如，从设备读数据，并且完成数据的处理。</p>
</blockquote>
<p>控制器的任务是为操作系统提供一个简单的接口（不过还是很复杂）。</p>
<blockquote>
<p>例如，磁盘控制器可以接受一个命令从磁盘 2 读出 11206 号扇区，然后，控制器把这个线性扇区号转化为柱面、扇区和磁头。</p>
</blockquote>
<ul>
<li><strong>设备驱动程序：</strong>与设备控制器交互的软件。每个控制器厂家必须为所支持的操作系统提供相应的设备驱动程序。<blockquote>
<p>例如，一台扫描仪会配有用于 OS X、Windows 7、Windows 8 以及 Linux 的设备驱动程序。</p>
</blockquote>
</li>
</ul>
<p>设备驱动器装入操作系统的三个途径：</p>
<ol>
<li>将内核与设备驱动程序重新链接，然后重启动系统。许多 UNIX 系统以这种方式工作。</li>
<li>在一个操作系统文件中设置一个入口，并通知该文件需要一个设备驱动程序，然后重启动系统。在系统启动时，操作系统去找寻所需的设备驱动程序并装载之。Windows 就是以这种方式工作。</li>
<li>操作系统能够在运行时接受新的设备驱动程序并且立即将其安装好，无须重启动系统。热插拔设备，像 USB 之类需要动态可装载设备驱动程序。</li>
</ol>
<ul>
<li><strong>I/O 端口空间：</strong></li>
</ul>
<p>每个设备控制器都有少量用于通信的寄存器。<br>要激活控制器，设备驱动程序从操作系统获得一条命令，然后翻译成对应的值，并写进设备寄存器中。所有设备寄存器的集合构成了 I/O 端口空间。</p>
<blockquote>
<p>例如，一个最小的磁盘控制器也会有用于指定磁盘地址、内存地址、扇区计数和方向（读或写）的寄存器。</p>
</blockquote>
<p><strong>内存映射 I/O（Memory-Mapped I/O MMIO）</strong><br>把输人输出设备和物理内存放到同一个地址空间，为设备内部的内存和寄存器也分配相应的地址。<br>CPU 可以使用和访问物理内存一样的指令去读写这些属于设备的地址。</p>
<p><strong>实现输入输出的三种方式：</strong></p>
<ul>
<li>忙等待（轮询）：</li>
</ul>
<p>用户程序发出一个系统调用，内核对设备驱动程序进行过程调用，然后设备驱动程序启动 I/O 并循环检查该设备是否完成了工作。<br>当 I/O 结束后，设备驱动程序把数据送到指定的地方并返回，然后操作系统将控制返回给调用者。<br>其缺点是要占据 CPU，CPU 一直轮询设备直到对应的 I/O 操作完成。</p>
<ul>
<li>中断：</li>
</ul>
<p>设备驱动程序启动设备，让该设备在操作完成时发出一个中断，设备驱动程序在这个时刻返回。<br>当设备驱动程序检测到该设备的操作完毕时，它发出一个中断通知操作完成，操作系统接着在需要时阻塞调用者并安排其他工作进行。</p>
<ul>
<li>直接存储器访问（DMA）芯片：</li>
</ul>
<p>可以控制在内存和某些控制器之间的位流，而无须持续的 CPU 干预。CPU 对 DMA 芯片进行设置，说明需要传送的字节数、有关的设备和内存地址以及操作方向，接着启动 DMA。当 DMA 芯片完成时，它引发一个中断。</p>
<p>MMIO 使得 CPU 可以主动地访问设备，中断使得设备能够主动地通知 CPU，这两种机制是 CPU 与设备之间交互的重要方式。</p>
<h3 id="2-2-6-总线"><a href="#2-2-6-总线" class="headerlink" title="2.2.6. 总线"></a>2.2.6. 总线</h3><p><img data-src="https://ccomma-pic-storage.oss-cn-hangzhou.aliyuncs.com/img/751efc320e7e6078af3fddf32b2bd3e3.png" alt="image.png"><br><strong>概述：</strong><br>系统有很多总线（例如高速缓存、内存、PCle、PCI、USB、SATA 和 DMI)，每条总线的传输速度和功能都不同。操作系统必须了解所有总线的配置和管理。其中主要的总线是 PCIe 总线。</p>
<p><strong>USB（Universal Serial Bus）：</strong><br>将所有慢速 I/O 设备（如键盘和鼠标）与计算机连接。USB 是一种集中式总线，其根设备每 1ms 轮询一次 IO 设备，看是否有信息收发。USB 1.0 可以处理总计 12Mb/s 的负载，USB 2.0 总线提速到 480 Mb/s，而 USB 3.0 能达到不小于 5Gb/s 的速率。</p>
<p><strong>SCSI（Small Computer System Interface）：</strong><br>是一种高速总线，用在高速硬盘、扫描仪和其他需要较大带宽的设备上。主要用在服务器和工作站中，速度可以达到 640MB/s。</p>
<h3 id="2-2-7-启动计算机"><a href="#2-2-7-启动计算机" class="headerlink" title="2.2.7. 启动计算机"></a>2.2.7. 启动计算机</h3><p><strong>BIOS：</strong><br>基本输入输出系统（Basic Input Output System，BIOS）。<br>在 BIOS 内有底层 I/O 软件，包括读键盘、写屏幕、进行磁盘 IO 以及其他过程。<br>现在这个程序存放在一块闪速 RAM 中，它是非易失性的，但是在发现 BIOS 中有错时可以通过操作系统对它进行更新。</p>
<p><strong>BIOS 的运行过程：</strong><br>在计算机启动时，BIOS 开始运行。</p>
<ol>
<li>首先检查所安装的 RAM 数量，键盘和其他基本设备是否已安装并正常响应。</li>
<li>接着，开始扫描 PCIe 和 PCI 总线并找出连在上面的所有设备。</li>
</ol>
<p>也会记录即插即用设备。如果现有的设备和系统上一次启动时的设备不同，则新的设备将被配置。</p>
<ol start="3">
<li>根据存储在 CMOS 存储器中的设备清单决定启动设备。用户可以在系统刚启动之后进入一个 BIOS 配置程序，对设备清单进行修改。</li>
</ol>
<p>如果存在 CD-ROM（有时是 USB），则系统试图从中启动，如果失败，系统将从硬盘启动。</p>
<ol start="5">
<li>启动设备上的第一个扇区，被读入内存并执行。这个扇区中包含一个检查分区表的程序，以确定哪个分区是活动的。</li>
<li>然后，从该分区读入第二个启动装载模块。来自活动分区的这个装载模块被读入操作系统，并启动。</li>
<li>然后，操作系统询问 BIOS，以获得配置信息。系统检查每个设备对应的设备驱动程序是否存在。如果没有，系统要求用户插入含有该设备驱动程序的 CD-ROM。</li>
<li>一旦有了全部的设备驱动程序，操作系统就将它们调入内核。然后初始化有关表格，创建需要的任何背景进程，并在每个终端上启动登录程序或 GUI。</li>
</ol>
<p><strong>即插即用（plug and play）：</strong><br>每块 I/O 卡有一个固定的中断请求级别和用于其 I/O 寄存器的固定地址。</p>
<blockquote>
<p>例如，键盘的中断级别是 1，并使用 0x60 至 0x64 的 I/O 地址，<br>软盘控制器是中断 6 级并使用 Ox3F0 至 0x3F7 的 I/O 地址，<br>而打印机是中断 7 级并使用 0x378 至 0x37A 的 I/O 地址等。</p>
</blockquote>
<p>如果有一块声卡和调制解调卡，都是使用中断 4，它们就会冲突。必须得在每块 I/O 卡上提供 DIP 开关或跳接器，并指导用户对其进行设置去选择中断级别和 I/O 地址才能解决冲突。</p>
<p>即插即用让系统能自动地收集有关 I/O 设备的信息，集中赋予中断级别和 I/O 地址，然后通知每块卡所使用的数值。计算机启动时 BIOS 会记录所有的设备，如果现有的设备和系统上一次启动时的设备不同，则新的设备将被配置。</p>
<h1 id="3-系统相关"><a href="#3-系统相关" class="headerlink" title="3. 系统相关"></a>3. 系统相关</h1><h2 id="3-1-文件系统"><a href="#3-1-文件系统" class="headerlink" title="3.1. 文件系统"></a>3.1. 文件系统</h2><p><img data-src="https://ccomma-pic-storage.oss-cn-hangzhou.aliyuncs.com/img/7be685d0842f095478c4a8ec5d133368.png" alt="image.png"><br><strong>进程树和文件树的区别：</strong></p>
<ul>
<li>一般进程的树状结构层次不深（很少超过三层），而文件树状结构的层次常常多达四层、五层或更多层。</li>
<li>进程树层次结构是暂时的，通常最多存在几分钟，而目录层次则可能存在数年之久。</li>
<li>所有权及保护：只有父进程能控制和访问子进程，而在文件和目录能使其他用户也可以访问。</li>
</ul>
<p><strong>文件描述符：</strong><br>在读写文件之前，首先要打开文件，检查其访问权限。若权限许可，系统将返回一个小整数，称作 <strong>文件描述符（file descriptor）</strong>，供后续操作使用。若禁止访问，系统则返回一个错误码。</p>
<p><strong>安装文件系统：</strong><br>UNIX 允许把光盘上的文件系统接到主文件树上。mount 系统调用允许把在 CD-ROM 上的文件系统连接到程序所希望的根文件系统上。<br><img data-src="https://ccomma-pic-storage.oss-cn-hangzhou.aliyuncs.com/img/e3bd18a1e7aeb83e60b48cac26d32224.png" alt="image.png"></p>
<p>装配文件系统将使得装配目录中已有的任何文件都不可访问，因此装配点通常都是空的。<br>但是，系统管理人员可能需要将某些位于被装配目录中的非常重要的文件复制到装配点，使得他们在进行设备检查或修理时，可以在紧急事件中的普通路径上找到这些文件。</p>
<p><strong>特殊文件：</strong><br>提供特殊文件是为了使 I/O 设备看起来像文件一般。I/O 设备也可通过同样的系统调用进行读写。<br>按照惯例，特殊文件保存在 <code>/dev</code> 目录中。例如， <code>/dev/lp</code> 是打印机。</p>
<ul>
<li><strong>块特殊文件：</strong>指那些由可随机存取的块组成的设备，如磁盘等。比如打开一个块特殊文件，然后读第 4 块，程序可以直接访问设备的第 4 块而不必考虑存放该文件的文件系统结构。</li>
<li><strong>字符特殊文件：</strong>用于打印机、调制解调器和其他接收或输出字符流的设备。</li>
</ul>
<p><strong>管道：</strong><br><img data-src="https://ccomma-pic-storage.oss-cn-hangzhou.aliyuncs.com/img/4db296dab3b41db38c8ce5363f902b6b.png" alt="image.png"><br>管道（pipe）是一种虚文件，它可连接两个进程。如果进程 A 和 B 希望通过管道对话，它们必须提前设置该管道。</p>
<p>当进程 A 想对进程 B 发送数据时，它把数据写到管道上，进程 B 可以通过读该管道而得到数据。这样，在 UNIX 中两个进程之间的通信就非常类似于普通文件的读写了。</p>
<p>若进程想发现它所写入的输出文件不是真正的文件而是管道，则需要使用特殊的系统调用。</p>
<h1 id="4-系统调用"><a href="#4-系统调用" class="headerlink" title="4. 系统调用"></a>4. 系统调用</h1><p><strong>read 系统调用：</strong><br>它的调用由 C 程序完成，方法是调用一个与该系统调用名称相同的库过程 read。</p>
<figure class="highlight c"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">count = read(fd, buffer,nbytes);</span><br></pre></td></tr></tbody></table></figure>
<p>调用过程如下<br><img data-src="https://ccomma-pic-storage.oss-cn-hangzhou.aliyuncs.com/img/8b9c383ffb4292b3281fd9169719d85d.png" alt="image.png"></p>
<h2 id="4-1-进程管理"><a href="#4-1-进程管理" class="headerlink" title="4.1. 进程管理"></a>4.1. 进程管理</h2><table>
<thead>
<tr>
<th><strong>进程管理</strong></th>
<th></th>
</tr>
</thead>
<tbody><tr>
<td><strong>调用</strong></td>
<td><strong>说明</strong></td>
</tr>
<tr>
<td> pid = fork()</td>
<td> 创建与父进程相同的子进程</td>
</tr>
<tr>
<td> pid = waitpid(pid, &amp;statloc, options)</td>
<td> 等待一个子进程终止</td>
</tr>
<tr>
<td> s = execve(name, argv, environp)</td>
<td>execve () 系统调用的作用是运行另外一个指定的程序。它会把新程序加载到当前进程的内存空间内，当前的进程会被丢弃，它的堆、栈和所有的段数据都会被新进程相应的部分代替，然后会从新程序的初始化代码和 main 函数开始运行。同时，进程的 ID 将保持不变。<br><br>execve () 系统调用通常与 fork () 系统调用配合使用。从一个进程中启动另一个程序时，通常是先 fork () 一个子进程，然后在子进程中使用 execve () 变身为运行指定程序的进程。</td>
</tr>
<tr>
<td>exit(status)</td>
<td> 终止进程执行并返回状态</td>
</tr>
</tbody></table>
<p>pid：进程的 id</p>
<p><strong>fork：</strong></p>
<figure class="highlight shell"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">#</span><span class="language-bash">define TRUE 1</span></span><br><span class="line"></span><br><span class="line">/*一直循环下去*/</span><br><span class="line">while (TRUE) {</span><br><span class="line">    /*在屏幕上显示提示符*/</span><br><span class="line">    type_prompt();</span><br><span class="line">    /*从终端读取输入*/</span><br><span class="line">    read_command(command, parameters);</span><br><span class="line">    </span><br><span class="line">    /* 派生子进程 */</span><br><span class="line">    if(fork() != 0) {</span><br><span class="line">        /* 父代码 */</span><br><span class="line">        /*等待子进程退出*/</span><br><span class="line">        waitpid(-1, &amp;status, 0);</span><br><span class="line">    } else {</span><br><span class="line">        /* 子代码 */</span><br><span class="line">        /* 执行其他命令 */</span><br><span class="line">        execve(command, parameters, 0)</span><br><span class="line">    }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<p>父进程从终端读取命令，创建一个子进程，等待该子进程执行命令。</p>
<ol>
<li>父进程执行 waitpid 系统调用来等待子进程结束，直至子进程终止。</li>
</ol>
<p>waitpid 参数：</p>
<ul>
<li>waitpid 可以等待一个特定的子进程，或者通过将第一个参数设为 -1 的方式，等待任何一个老的子进程。</li>
<li>在 waitpid 完成之后，将把第二个参数 statloc 所指向的地址设置为子进程的退出状态（正常或异常终止以及退出值）。</li>
<li>有各种可使用的选项，它们由第三个参数确定。例如，如果没有已经退出的子进程则立即返回。</li>
</ul>
<ol start="2">
<li>子进程通过使用 execve 系统调用执行用户的命令。这个系统调用会引起其整个核心映像被一个文件所替代，该文件由第一个参数给定。</li>
</ol>
<p>execve 参数：</p>
<ul>
<li>name：要执行的文件名称。如 <code>cp</code></li>
<li>argv：指向变量数组的指针。传入命令的参数</li>
<li> environp：指向环境数组的指针</li>
</ul>
<p><strong>进程存储空间：</strong><br><img data-src="https://ccomma-pic-storage.oss-cn-hangzhou.aliyuncs.com/img/c4e8e2382c2444687c3d06817d09d4e6.png" alt="image.png"><br>在 UNIX 中的进程将其存储空间划分为三段：<strong>正文段</strong>（如程序代码）、<strong>数据段</strong>（如变量）以及 <strong>堆栈段</strong>。数据向上增长而堆栈向下增长。</p>
<h2 id="4-2-文件管理"><a href="#4-2-文件管理" class="headerlink" title="4.2. 文件管理"></a>4.2. 文件管理</h2><table>
<thead>
<tr>
<th><strong>文件管理</strong></th>
<th></th>
</tr>
</thead>
<tbody><tr>
<td><strong>调用</strong></td>
<td><strong>说明</strong></td>
</tr>
<tr>
<td> fd = open(file, how, …)</td>
<td> 打开一个文件供读、写或两者</td>
</tr>
<tr>
<td> s = close(fd)</td>
<td> 关闭一个打开的文件</td>
</tr>
<tr>
<td> n = read(fd, buffer, bnytes)</td>
<td> 把数据从一个文件读到缓冲区中</td>
</tr>
<tr>
<td> n= write(fd, buffer, nbytes)</td>
<td> 把数据从缓冲区写到一个文件中</td>
</tr>
<tr>
<td> position = lseek(fd, offset, whence)</td>
<td> 移动文件指针</td>
</tr>
<tr>
<td> s = stat(name, &amp;buf)</td>
<td> 取得文件的状态信息</td>
</tr>
</tbody></table>
<p>fd：文件描述符<br>n：字节数<br>position：在文件中的偏移量</p>
<p><strong>open：</strong><br>使用 open 打开文件返回文件描述符，然后可使用返回的文件描述符进行读写操作。接着可以用 close 关闭文件。</p>
<p><strong>lseek：</strong><br>每个文件有一个指向文件当前位置的指针。在顺序读（写）时，该指针通常指向要读出（写入）的下一个字节。<br>lseek 调用可以改变该位置指针的值，这样后续的 read 或 write 调用就可以在文件的任何地方开始。</p>
<h2 id="4-3-目录管理"><a href="#4-3-目录管理" class="headerlink" title="4.3. 目录管理"></a>4.3. 目录管理</h2><table>
<thead>
<tr>
<th><strong>目录和文件系统管理</strong></th>
<th></th>
</tr>
</thead>
<tbody><tr>
<td><strong>调用</strong></td>
<td><strong>说明</strong></td>
</tr>
<tr>
<td> s = mkdir(name, mode)</td>
<td> 创建一个新目录</td>
</tr>
<tr>
<td> s = rmdir(name)</td>
<td> 删去一个空目录</td>
</tr>
<tr>
<td> s = link(name1, name2)</td>
<td> 创建 — 个新目录项 name2，并指向 name1</td>
</tr>
<tr>
<td>s = unlink(name)</td>
<td> 删去一个目录项</td>
</tr>
<tr>
<td> s = mount(special, name, flag)</td>
<td> 安装一个文件系统</td>
</tr>
<tr>
<td> s = umount(special)</td>
<td> 卸载一个文件系统</td>
</tr>
</tbody></table>
<p><strong>link：</strong><br>允许同一个文件以两个或多个名称出现</p>
<p>在 UNIX 中，每个文件都有唯一的编号，即 <strong>i - 编号</strong>，用以标识文件。该 i - 编号是对 i - 节点表格的一个引用，它们一一对应，说明该文件的拥有者、磁盘块的位置等。</p>
<p>目录就是一个包含了（i - 编号，ASCII 名称）集合的文件。link 所做的只是利用某个已有文件的 i - 编号，创建一个新目录项（也许用一个新名称）。</p>
<p><img data-src="https://ccomma-pic-storage.oss-cn-hangzhou.aliyuncs.com/img/13120eed179bb298fadd9b6213436b73.png" alt="image.png"><br>上图两个目录项有相同的 i - 编号（70)，从而指向同一个文件。如果使用 unlink 系统调用将其中一个文件移走了，可以保留另一个。</p>
<p>如果两个都被移走了，UNIX 00 看到尚且存在的文件没有目录项，就会把该文件从磁盘中移去。</p>
<h2 id="4-4-其他"><a href="#4-4-其他" class="headerlink" title="4.4. 其他"></a>4.4. 其他</h2><table>
<thead>
<tr>
<th><strong>杂项</strong></th>
<th></th>
</tr>
</thead>
<tbody><tr>
<td><strong>调用</strong></td>
<td><strong>说明</strong></td>
</tr>
<tr>
<td> s = chdir(dirname)</td>
<td> 改变工作目录</td>
</tr>
<tr>
<td> s = chmod(name, mode)</td>
<td> 修改一个文件的保护位</td>
</tr>
<tr>
<td> s = kill(pid, signal)</td>
<td> 发送信号给一个进程</td>
</tr>
<tr>
<td> seconds =time(&amp;seconds)</td>
<td> 自 1970 年 1 月 1 日起的流逝时间</td>
</tr>
</tbody></table>
<p>seconds：流逝时间</p>
<h1 id="5-操作系统结构"><a href="#5-操作系统结构" class="headerlink" title="5. 操作系统结构"></a>5. 操作系统结构</h1><h2 id="5-1-策略和机制"><a href="#5-1-策略和机制" class="headerlink" title="5.1. 策略和机制"></a>5.1. 策略和机制</h2><p>策略表示要做什么，机制表示该怎么做。<br>有时会出现一个进程有多个子进程，每个子进程可能实现不同的功能（计算分析，访问磁盘等），并具有不同的优先级。这就要求调度程序需要从用户进程中获取调度决策信息。</p>
<p>将调度算法以某种形式参数化，而参数可以由用户进程填写。这样便使得策略和机制分离，算法由底层实现，而用户进程可以设置参数来对其进行调整。<br>假设内核使用优先级调度算法，并提供一条可供进程设置优先级的系统调用，尽管父进程本身并不参与调度，但它可以控制如何调度子进程的细节。</p>
<h2 id="5-2-内核结构"><a href="#5-2-内核结构" class="headerlink" title="5.2. 内核结构"></a>5.2. 内核结构</h2><p><img data-src="https://ccomma-pic-storage.oss-cn-hangzhou.aliyuncs.com/img/312f99ce48aa5ad6ba301199402cc63f.png" alt="image.png"></p>
<h3 id="5-2-1-简要结构（单体）"><a href="#5-2-1-简要结构（单体）" class="headerlink" title="5.2.1. 简要结构（单体）"></a>5.2.1. 简要结构（单体）</h3><p>整个操作系统在内核态以单一程序的方式运行。整个操作系统以过程集合的方式编写，链接成一个大型可执行二进制程序。</p>
<p>使用这种技术，系统中每个过程可以自由调用其他过程，只要后者提供了前者所需要的一些有用的计算工作。调用任何一个你所需要的过程或许会非常高效。</p>
<p>但上千个可以不受限制地彼此调用的过程常常导致系统笨拙且难于理解。并且，任何一个过程的崩溃都会连累整个系统。</p>
<p><strong>结构：</strong><br><img data-src="https://ccomma-pic-storage.oss-cn-hangzhou.aliyuncs.com/img/cd380e424a2d459ac19ceab59d67fa32.png" alt="image.png"><br>对于这类操作系统的基本结构，需要如下结构：</p>
<ol>
<li>需要一个主程序，用来处理服务过程请求。</li>
<li>需要一套服务过程，用来执行系统调用。</li>
<li>需要一套实用过程，用来辅助服务过程。</li>
</ol>
<p>每一个系统调用都通过一个服务过程为其工作并运行之。要有一组实用程序来完成一些服务过程所需要用到的功能，如从用户程序取数据等。</p>
<h3 id="5-2-2-宏内核"><a href="#5-2-2-宏内核" class="headerlink" title="5.2.2. 宏内核"></a>5.2.2. 宏内核</h3><p><img data-src="https://ccomma-pic-storage.oss-cn-hangzhou.aliyuncs.com/img/491287cf15c1f944680853bd043f4d52.png" alt="image.png"><br><img data-src="https://ccomma-pic-storage.oss-cn-hangzhou.aliyuncs.com/img/84bad2763dcb858b305543c2b2542986.png" alt="image.png"><br>THE 操作系统结构，底层保证基础功能，上层依赖底层</p>
<blockquote>
<p>注：让我想起了七层网络模型</p>
</blockquote>
<h3 id="5-2-3-微内核"><a href="#5-2-3-微内核" class="headerlink" title="5.2.3. 微内核"></a>5.2.3. 微内核</h3><p>在宏内核架构下，所有内核模块均运行在特权空间，一个单点的错误就可能会导致整个系统崩溃或者被攻破。<br>为了实现高可靠性，将操作系统划分成小的、良好定义的模块，只有微内核运行在内核态，其余的模块由于功能相对弱些，则作为普通用户进程运行。</p>
<p><strong>优点：</strong><br>由于把每个设备驱动和文件系统分别作为普通用户进程，这些模块中的错误虽然会使这些模块崩溃，但是不会使得整个系统死机。所以，音频驱动中的错误会使声音断续或停止，但是不会使整个计算机垮掉。</p>
<p><strong>使用场景：</strong><br>通常桌面操作系统并不使用微内核。微内核在实时、工业、航空以及军事应用中特别流行，这些领域都是关键任务，需要有高度的可靠性。</p>
<h3 id="5-2-4-客户端-服务器模式"><a href="#5-2-4-客户端-服务器模式" class="headerlink" title="5.2.4. 客户端-服务器模式"></a>5.2.4. 客户端 - 服务器模式</h3><p>客户端 - 服务器模式将进程划分为两类</p>
<ul>
<li><strong>服务器：</strong>每个服务器提供某种服务</li>
<li><strong>客户端：</strong>使用这些服务。</li>
</ul>
<p>通常，在系统最底层是微内核，但并不是必须这样。客户端 - 服务器模式的本质是存在客户端进程和服务器进程。</p>
<p><strong>消息通信：</strong><br>客户端和服务器之间的通信是消息传递。为了获得一个服务，客户端进程构造段消息，并将其发给合适的服务器。该服务器完成工作，发送回应。</p>
<p><img data-src="https://ccomma-pic-storage.oss-cn-hangzhou.aliyuncs.com/img/f2d774d2e4a167de32b95d9501fb6175.png" alt="image.png"><br>一个普遍方式是运行在不同计算机上的客户端和服务器，通过局域网或广域网连接。<br>其内部细节对客户端来说是屏蔽的。所以，客户端 - 服务器模式是一种可以应用在单机或者网络机器上的抽象。</p>
<h3 id="5-2-5-虚拟机"><a href="#5-2-5-虚拟机" class="headerlink" title="5.2.5. 虚拟机"></a>5.2.5. 虚拟机</h3><p><strong>虚拟机监控程序：</strong><br>VM/370 系统<br><img data-src="https://ccomma-pic-storage.oss-cn-hangzhou.aliyuncs.com/img/b48fee8fcee4ccbc80d43fc246d00625.png" alt="image.png"><br>这个系统的核心被称为 <strong>虚拟机监控程序（virtual machine monitor）</strong>，它在裸机上运行并且具备了多道程序功能<br>该系统向上层提供了若干台虚拟机。每台虚拟机都与裸机相同，所以不同的虛拟机可以运行不同的操作系统。</p>
<p><em>CMS：</em><br>在早期的 VM/370 系统上，有一些系统运行 OS/360 或者其他大型批处理或事务处理操作系统，而另一些虚拟机运行单用户、交互式系统供分时用户使用，这个系统称为 <strong>会话监控系统（Conversational Monitor System,CMS）</strong>。</p>
<p><em>系统调用：</em><br>当一个 CMS 程序执行系统调用时，该调用被陷入到其虚拟机的操作系统上。<br>CMS 然后发出硬件 I/O 指令读出虛拟磁盘或其他需要执行的调用。这些 I/O 指令由 VM/370 陷入并完成指令。通过对多道程序功能和提供扩展机器二者的完全分离，每个部分都变得非常简单、非常灵活且容易维护。</p>
<p><strong>第一类与第二类虚拟机管理程序：</strong><br><img data-src="https://ccomma-pic-storage.oss-cn-hangzhou.aliyuncs.com/img/a5e7937f43820fcebaf697e622ad0f7d.png" alt="image.png"><br><em>区别：</em><br>第二类虚拟机管理程序利用 <strong>宿主操作系统（host operatingsystem）</strong>并通过其文件系统创建进程、存储文件等。它从 CD-ROM 安装盘中读入供选择的 <strong>客户操作系统（guestoperating system）</strong>，并安装在一个虚拟盘上，该盘实际上只是宿主操作系统的文件系统中的一个大文件。</p>
<p>第一类虚拟机管理程序没有底层（宿主操作系统）支持，所以必须在原始的硬盘分区上自行管理储存。</p>
<h3 id="5-2-6-外壳"><a href="#5-2-6-外壳" class="headerlink" title="5.2.6. 外壳"></a>5.2.6. 外壳</h3><p>与虚拟机克隆真实机器不同，另一种策略是对机器进行分区，即给每个用户整个资源的一个子集。</p>
<p>外核的任务是为虚拟机分配资源，确保没有机器会使用他人的资源。每个用户层的虚拟机可以运行自己的操作系统。</p>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




  <nav class="pagination">
    <a class="extend prev" rel="prev" title="Previous page" aria-label="Previous page" href="/page/5/"><i class="fa fa-angle-left"></i></a><a class="page-number" href="/">1</a><span class="space">&hellip;</span><a class="page-number" href="/page/5/">5</a><span class="page-number current">6</span>
  </nav>

</div>
  </main>

  <footer class="footer">
    <div class="footer-inner">

  <div class="copyright">
    &copy; 
    <span itemprop="copyrightYear">2024</span>
    <span class="with-love">
      <i class="fa fa-heart"></i>
    </span>
    <span class="author" itemprop="copyrightHolder">CComma</span>
  </div>
<div class="busuanzi-count">
    <span class="post-meta-item" id="busuanzi_container_site_uv">
      <span class="post-meta-item-icon">
        <i class="fa fa-user"></i>
      </span>
      <span class="site-uv" title="Total Visitors">
        <span id="busuanzi_value_site_uv"></span>
      </span>
    </span>
    <span class="post-meta-item" id="busuanzi_container_site_pv">
      <span class="post-meta-item-icon">
        <i class="fa fa-eye"></i>
      </span>
      <span class="site-pv" title="Total Views">
        <span id="busuanzi_value_site_pv"></span>
      </span>
    </span>
</div>

    </div>
  </footer>

  
  <div class="toggle sidebar-toggle" role="button">
    <span class="toggle-line"></span>
    <span class="toggle-line"></span>
    <span class="toggle-line"></span>
  </div>
  <div class="sidebar-dimmer"></div>
  <div class="back-to-top" role="button" aria-label="Back to top">
    <i class="fa fa-arrow-up fa-lg"></i>
    <span>0%</span>
  </div>
  <div class="reading-progress-bar"></div>

  <a href="https://github.com/ccomma" class="github-corner" title="Follow me on GitHub" aria-label="Follow me on GitHub" rel="noopener" target="_blank"><svg width="80" height="80" viewBox="0 0 250 250" aria-hidden="true"><path d="M0,0 L115,115 L130,115 L142,142 L250,250 L250,0 Z"></path><path d="M128.3,109.0 C113.8,99.7 119.0,89.6 119.0,89.6 C122.0,82.7 120.5,78.6 120.5,78.6 C119.2,72.0 123.4,76.3 123.4,76.3 C127.3,80.9 125.5,87.3 125.5,87.3 C122.9,97.6 130.6,101.9 134.4,103.2" fill="currentColor" style="transform-origin: 130px 106px;" class="octo-arm"></path><path d="M115.0,115.0 C114.9,115.1 118.7,116.5 119.8,115.4 L133.7,101.6 C136.9,99.2 139.9,98.4 142.2,98.6 C133.8,88.0 127.5,74.4 143.8,58.0 C148.5,53.4 154.0,51.2 159.7,51.0 C160.3,49.4 163.2,43.6 171.4,40.1 C171.4,40.1 176.1,42.5 178.8,56.2 C183.1,58.6 187.2,61.8 190.9,65.4 C194.5,69.0 197.7,73.2 200.1,77.6 C213.8,80.2 216.3,84.9 216.3,84.9 C212.7,93.1 206.9,96.0 205.4,96.6 C205.1,102.4 203.0,107.8 198.3,112.5 C181.9,128.9 168.3,122.5 157.7,114.1 C157.9,116.9 156.7,120.9 152.7,124.9 L141.0,136.5 C139.8,137.7 141.6,141.9 141.8,141.8 Z" fill="currentColor" class="octo-body"></path></svg></a>

<noscript>
  <div class="noscript-warning">Theme NexT works best with JavaScript enabled</div>
</noscript>


  
  <script src="https://cdnjs.cloudflare.com/ajax/libs/animejs/3.2.1/anime.min.js" integrity="sha256-XL2inqUJaslATFnHdJOi9GfQ60on8Wx1C2H8DYiN1xY=" crossorigin="anonymous"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/next-theme-pjax/0.6.0/pjax.min.js" integrity="sha256-vxLn1tSKWD4dqbMRyv940UYw4sXgMtYcK6reefzZrao=" crossorigin="anonymous"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/medium-zoom/1.1.0/medium-zoom.min.js" integrity="sha256-ZgMyDAIYDYGxbcpJcfUnYwNevG/xi9OHKaR/8GK+jWc=" crossorigin="anonymous"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/lozad.js/1.16.0/lozad.min.js" integrity="sha256-mOFREFhqmHeQbXpK2lp4nA3qooVgACfh88fpJftLBbc=" crossorigin="anonymous"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/pangu/4.0.7/pangu.min.js" integrity="sha256-j+yj56cdEY2CwkVtGyz18fNybFGpMGJ8JxG3GSyO2+I=" crossorigin="anonymous"></script>
<script src="/js/comments.js"></script><script src="/js/utils.js"></script><script src="/js/motion.js"></script><script src="/js/schemes/muse.js"></script><script src="/js/next-boot.js"></script><script src="/js/pjax.js"></script>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/hexo-generator-searchdb/1.4.1/search.js" integrity="sha256-1kfA5uHPf65M5cphT2dvymhkuyHPQp5A53EGZOnOLmc=" crossorigin="anonymous"></script>
<script src="/js/third-party/search/local-search.js"></script>





  <script src="/js/third-party/pace.js"></script>


  
  <script data-pjax async src="https://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>




  <script src="https://cdnjs.cloudflare.com/ajax/libs/quicklink/2.3.0/quicklink.umd.js" integrity="sha256-yvJQOINiH9fWemHn0vCA5lsHWJaHs6/ZmO+1Ft04SvM=" crossorigin="anonymous"></script>
  <script class="next-config" data-name="quicklink" type="application/json">{"enable":true,"home":true,"archive":true,"delay":true,"timeout":3000,"priority":true,"url":"https://ccomma.cn/page/6/"}</script>
  <script src="/js/third-party/quicklink.js"></script>
<script class="next-config" data-name="disqus" type="application/json">{"enable":true,"shortname":"ccomma","count":true,"i18n":{"disqus":"disqus"}}</script>
<script src="/js/third-party/comments/disqus.js"></script>

</body>
</html>
